<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Ganeti/Utils/AsyncWorker.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE FlexibleContexts #-}</span>
<a name="line-2"></a>
<a name="line-3"></a><span class='hs-comment'>{-| Provides a general functionality for workers that run on the background
<a name="line-4"></a>and perform some task when triggered.
<a name="line-5"></a>
<a name="line-6"></a>Each task can process multiple triggers, if they're coming faster than the
<a name="line-7"></a>tasks are being processed.
<a name="line-8"></a>
<a name="line-9"></a>Properties:
<a name="line-10"></a>
<a name="line-11"></a>- If a worked is triggered, it will perform its action eventually.
<a name="line-12"></a>  (i.e. it won't miss a trigger).
<a name="line-13"></a>
<a name="line-14"></a>- If the worker is busy, the new action will start immediately when it finishes
<a name="line-15"></a>  the current one.
<a name="line-16"></a>
<a name="line-17"></a>- If the worker is idle, it'll start the action immediately.
<a name="line-18"></a>
<a name="line-19"></a>- If the caller uses 'triggerAndWait', the call will return just after the
<a name="line-20"></a>  earliest action following the trigger is finished.
<a name="line-21"></a>
<a name="line-22"></a>- If the caller uses 'triggerWithResult', it will recive an 'Async' value that
<a name="line-23"></a>  can be used to wait for the result (which will be available once the earliest
<a name="line-24"></a>  action following the trigger finishes).
<a name="line-25"></a>
<a name="line-26"></a>- If the worker finishes an action and there are no pending triggers since the
<a name="line-27"></a>  start of the last action, it becomes idle and waits for a new trigger.
<a name="line-28"></a>
<a name="line-29"></a>-}</span>
<a name="line-30"></a>
<a name="line-31"></a><span class='hs-comment'>{-
<a name="line-32"></a>
<a name="line-33"></a>Copyright (C) 2014 Google Inc.
<a name="line-34"></a>All rights reserved.
<a name="line-35"></a>
<a name="line-36"></a>Redistribution and use in source and binary forms, with or without
<a name="line-37"></a>modification, are permitted provided that the following conditions are
<a name="line-38"></a>met:
<a name="line-39"></a>
<a name="line-40"></a>1. Redistributions of source code must retain the above copyright notice,
<a name="line-41"></a>this list of conditions and the following disclaimer.
<a name="line-42"></a>
<a name="line-43"></a>2. Redistributions in binary form must reproduce the above copyright
<a name="line-44"></a>notice, this list of conditions and the following disclaimer in the
<a name="line-45"></a>documentation and/or other materials provided with the distribution.
<a name="line-46"></a>
<a name="line-47"></a>THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
<a name="line-48"></a>IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
<a name="line-49"></a>TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
<a name="line-50"></a>PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR
<a name="line-51"></a>CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
<a name="line-52"></a>EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
<a name="line-53"></a>PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
<a name="line-54"></a>PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
<a name="line-55"></a>LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
<a name="line-56"></a>NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
<a name="line-57"></a>SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
<a name="line-58"></a>
<a name="line-59"></a>-}</span>
<a name="line-60"></a>
<a name="line-61"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Ganeti</span><span class='hs-varop'>.</span><span class='hs-conid'>Utils</span><span class='hs-varop'>.</span><span class='hs-conid'>AsyncWorker</span>
<a name="line-62"></a>  <span class='hs-layout'>(</span> <span class='hs-conid'>AsyncWorker</span>
<a name="line-63"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>mkAsyncWorker</span>
<a name="line-64"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>mkAsyncWorker_</span>
<a name="line-65"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>trigger</span>
<a name="line-66"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>trigger_</span>
<a name="line-67"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>triggerWithResult</span>
<a name="line-68"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>triggerWithResult_</span>
<a name="line-69"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>triggerWithResultMany</span>
<a name="line-70"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>triggerWithResultMany_</span>
<a name="line-71"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>triggerAndWait</span>
<a name="line-72"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>triggerAndWait_</span>
<a name="line-73"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>triggerAndWaitMany</span>
<a name="line-74"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>triggerAndWaitMany_</span>
<a name="line-75"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Async</span>
<a name="line-76"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>wait</span>
<a name="line-77"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>waitMany</span>
<a name="line-78"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-79"></a>
<a name="line-80"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-81"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Base</span>
<a name="line-82"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Trans</span><span class='hs-varop'>.</span><span class='hs-conid'>Control</span>
<a name="line-83"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Concurrent</span> <span class='hs-layout'>(</span><span class='hs-conid'>ThreadId</span><span class='hs-layout'>)</span>
<a name="line-84"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Concurrent</span><span class='hs-varop'>.</span><span class='hs-conid'>Lifted</span> <span class='hs-layout'>(</span><span class='hs-varid'>fork</span><span class='hs-layout'>,</span> <span class='hs-varid'>yield</span><span class='hs-layout'>)</span>
<a name="line-85"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Concurrent</span><span class='hs-varop'>.</span><span class='hs-conid'>MVar</span><span class='hs-varop'>.</span><span class='hs-conid'>Lifted</span>
<a name="line-86"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Monoid</span>
<a name="line-87"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Traversable</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>T</span>
<a name="line-88"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IORef</span><span class='hs-varop'>.</span><span class='hs-conid'>Lifted</span>
<a name="line-89"></a>
<a name="line-90"></a><span class='hs-comment'>-- * The definition and construction of asynchronous workers</span>
<a name="line-91"></a>
<a name="line-92"></a><a name="TriggerState"></a><span class='hs-comment'>-- Represents the state of the requests to the worker. The worker is either</span>
<a name="line-93"></a><a name="TriggerState"></a><span class='hs-comment'>-- 'Idle', or has 'Pending' triggers to process. After the corresponding</span>
<a name="line-94"></a><a name="TriggerState"></a><span class='hs-comment'>-- action is run, all the 'MVar's in the list are notified with the result.</span>
<a name="line-95"></a><a name="TriggerState"></a><span class='hs-comment'>-- Note that the action needs to be run even if the list is empty, as it</span>
<a name="line-96"></a><a name="TriggerState"></a><span class='hs-comment'>-- means that there are pending requests, only nobody needs to be notified of</span>
<a name="line-97"></a><a name="TriggerState"></a><span class='hs-comment'>-- their results.</span>
<a name="line-98"></a><a name="TriggerState"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>TriggerState</span> <span class='hs-varid'>i</span> <span class='hs-varid'>a</span>
<a name="line-99"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Idle</span>
<a name="line-100"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Pending</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MVar</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span>
<a name="line-101"></a>
<a name="line-102"></a>
<a name="line-103"></a><a name="addTrigger"></a><span class='hs-comment'>-- | Adds a new trigger to the current state (therefore the result is always</span>
<a name="line-104"></a><span class='hs-comment'>-- 'Pending'), optionally adding a 'MVar' that will receive the output.</span>
<a name="line-105"></a><span class='hs-definition'>addTrigger</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Monoid</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-106"></a>           <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>MVar</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TriggerState</span> <span class='hs-varid'>i</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TriggerState</span> <span class='hs-varid'>i</span> <span class='hs-varid'>a</span>
<a name="line-107"></a><span class='hs-definition'>addTrigger</span> <span class='hs-varid'>i</span> <span class='hs-varid'>mmvar</span> <span class='hs-varid'>state</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>rs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>recipients</span> <span class='hs-varid'>state</span>
<a name="line-108"></a>                           <span class='hs-keyword'>in</span> <span class='hs-conid'>Pending</span> <span class='hs-layout'>(</span><span class='hs-varid'>input</span> <span class='hs-varid'>state</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-109"></a>                                      <span class='hs-layout'>(</span><span class='hs-varid'>maybe</span> <span class='hs-varid'>rs</span> <span class='hs-layout'>(</span><span class='hs-conop'>:</span> <span class='hs-varid'>rs</span><span class='hs-layout'>)</span> <span class='hs-varid'>mmvar</span><span class='hs-layout'>)</span>
<a name="line-110"></a>  <span class='hs-keyword'>where</span>
<a name="line-111"></a>    <span class='hs-varid'>recipients</span> <span class='hs-conid'>Idle</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-112"></a>    <span class='hs-varid'>recipients</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pending</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>rs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rs</span>
<a name="line-113"></a>    <span class='hs-varid'>input</span> <span class='hs-conid'>Idle</span>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mempty</span>
<a name="line-114"></a>    <span class='hs-varid'>input</span> <span class='hs-layout'>(</span><span class='hs-conid'>Pending</span> <span class='hs-varid'>j</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>j</span>
<a name="line-115"></a>
<a name="line-116"></a><a name="AsyncWorker"></a><span class='hs-comment'>-- | Represent an asynchronous worker whose single action execution returns a</span>
<a name="line-117"></a><a name="AsyncWorker"></a><span class='hs-comment'>-- value of type @a@.</span>
<a name="line-118"></a><a name="AsyncWorker"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>AsyncWorker</span> <span class='hs-varid'>i</span> <span class='hs-varid'>a</span>
<a name="line-119"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>AsyncWorker</span> <span class='hs-conid'>ThreadId</span> <span class='hs-layout'>(</span><span class='hs-conid'>IORef</span> <span class='hs-layout'>(</span><span class='hs-conid'>TriggerState</span> <span class='hs-varid'>i</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>MVar</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span>
<a name="line-120"></a>
<a name="line-121"></a><a name="mkAsyncWorker"></a><span class='hs-comment'>-- | Given an action, construct an 'AsyncWorker'.</span>
<a name="line-122"></a><span class='hs-definition'>mkAsyncWorker</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Monoid</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadBaseControl</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-123"></a>              <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>AsyncWorker</span> <span class='hs-varid'>i</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-124"></a><span class='hs-definition'>mkAsyncWorker</span> <span class='hs-varid'>act</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-125"></a>    <span class='hs-varid'>trig</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMVar</span> <span class='hs-conid'>()</span>
<a name="line-126"></a>    <span class='hs-varid'>ref</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newIORef</span> <span class='hs-conid'>Idle</span>
<a name="line-127"></a>    <span class='hs-varid'>thId</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fork</span> <span class='hs-varop'>.</span> <span class='hs-varid'>forever</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-128"></a>        <span class='hs-varid'>takeMVar</span> <span class='hs-varid'>trig</span>           <span class='hs-comment'>-- wait for a trigger</span>
<a name="line-129"></a>        <span class='hs-varid'>state</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>swap</span> <span class='hs-varid'>ref</span> <span class='hs-conid'>Idle</span>  <span class='hs-comment'>-- check the state of pending requests</span>
<a name="line-130"></a>        <span class='hs-comment'>-- if there are pending requests, run the action and send them results</span>
<a name="line-131"></a>        <span class='hs-keyword'>case</span> <span class='hs-varid'>state</span> <span class='hs-keyword'>of</span>
<a name="line-132"></a>          <span class='hs-conid'>Idle</span>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span> <span class='hs-comment'>-- all trigers have been processed, we've</span>
<a name="line-133"></a>                                     <span class='hs-comment'>-- been woken up by a trigger that has been</span>
<a name="line-134"></a>                                     <span class='hs-comment'>-- already included in the last run</span>
<a name="line-135"></a>          <span class='hs-conid'>Pending</span> <span class='hs-varid'>i</span> <span class='hs-varid'>rs</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>act</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>forM_</span> <span class='hs-varid'>rs</span> <span class='hs-varop'>.</span> <span class='hs-varid'>flip</span> <span class='hs-varid'>tryPutMVar</span>
<a name="line-136"></a>        <span class='hs-comment'>-- Give other threads a chance to do work while we're waiting for</span>
<a name="line-137"></a>        <span class='hs-comment'>-- something to happen.</span>
<a name="line-138"></a>        <span class='hs-varid'>yield</span>
<a name="line-139"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>AsyncWorker</span> <span class='hs-varid'>thId</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>trig</span>
<a name="line-140"></a>  <span class='hs-keyword'>where</span>
<a name="line-141"></a>    <span class='hs-varid'>swap</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>MonadBase</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>IORef</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-142"></a>    <span class='hs-varid'>swap</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>atomicModifyIORef</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>(</span><span class='hs-conid'>(,)</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span>
<a name="line-143"></a>
<a name="line-144"></a><a name="mkAsyncWorker_"></a><span class='hs-comment'>-- | Given an action, construct an 'AsyncWorker' with no input.</span>
<a name="line-145"></a><span class='hs-definition'>mkAsyncWorker_</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>MonadBaseControl</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-146"></a>               <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>AsyncWorker</span> <span class='hs-conid'>()</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-147"></a><span class='hs-definition'>mkAsyncWorker_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkAsyncWorker</span> <span class='hs-varop'>.</span> <span class='hs-varid'>const</span>
<a name="line-148"></a>
<a name="line-149"></a><span class='hs-comment'>-- * Triggering workers and obtaining their results</span>
<a name="line-150"></a>
<a name="line-151"></a><a name="Async"></a><span class='hs-comment'>-- | An asynchronous result that will eventually yield a value.</span>
<a name="line-152"></a><a name="Async"></a><span class='hs-keyword'>newtype</span> <span class='hs-conid'>Async</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Async</span> <span class='hs-layout'>{</span> <span class='hs-varid'>asyncResult</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>MVar</span> <span class='hs-varid'>a</span> <span class='hs-layout'>}</span>
<a name="line-153"></a>
<a name="line-154"></a><a name="wait"></a><span class='hs-comment'>-- | Waits for an asynchronous result to finish and yield a value.</span>
<a name="line-155"></a><span class='hs-definition'>wait</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>MonadBase</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Async</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-156"></a><span class='hs-definition'>wait</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>readMVar</span> <span class='hs-varop'>.</span> <span class='hs-varid'>asyncResult</span>
<a name="line-157"></a>
<a name="line-158"></a><a name="waitMany"></a><span class='hs-comment'>-- | Waits for all asynchronous results in a collection to finish and yield a</span>
<a name="line-159"></a><span class='hs-comment'>-- value.</span>
<a name="line-160"></a><span class='hs-definition'>waitMany</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>MonadBase</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-conid'>Traversable</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-conid'>Async</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-161"></a><span class='hs-definition'>waitMany</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-varid'>mapM</span> <span class='hs-varid'>wait</span>
<a name="line-162"></a>
<a name="line-163"></a><a name="triggerInternal"></a><span class='hs-comment'>-- An internal function for triggering a worker, optionally registering</span>
<a name="line-164"></a><span class='hs-comment'>-- a callback 'MVar'</span>
<a name="line-165"></a><span class='hs-definition'>triggerInternal</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>MonadBase</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Monoid</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-166"></a>                <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>MVar</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AsyncWorker</span> <span class='hs-varid'>i</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-167"></a><span class='hs-definition'>triggerInternal</span> <span class='hs-varid'>i</span> <span class='hs-varid'>mmvar</span> <span class='hs-layout'>(</span><span class='hs-conid'>AsyncWorker</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>ref</span> <span class='hs-varid'>trig</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-168"></a>    <span class='hs-varid'>atomicModifyIORef</span> <span class='hs-varid'>ref</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>ts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>addTrigger</span> <span class='hs-varid'>i</span> <span class='hs-varid'>mmvar</span> <span class='hs-varid'>ts</span><span class='hs-layout'>,</span> <span class='hs-conid'>()</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-169"></a>    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tryPutMVar</span> <span class='hs-varid'>trig</span> <span class='hs-conid'>()</span>
<a name="line-170"></a>    <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-171"></a>
<a name="line-172"></a><a name="trigger"></a><span class='hs-comment'>-- | Trigger a worker, letting it run its action asynchronously, but do not</span>
<a name="line-173"></a><span class='hs-comment'>-- wait for the result.</span>
<a name="line-174"></a><span class='hs-definition'>trigger</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>MonadBase</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Monoid</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AsyncWorker</span> <span class='hs-varid'>i</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-175"></a><span class='hs-definition'>trigger</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flip</span> <span class='hs-varid'>triggerInternal</span> <span class='hs-conid'>Nothing</span>
<a name="line-176"></a>
<a name="line-177"></a><a name="trigger_"></a><span class='hs-comment'>-- | Trigger a worker with no input, letting it run its action asynchronously,</span>
<a name="line-178"></a><span class='hs-comment'>-- but do not wait for the result.</span>
<a name="line-179"></a><span class='hs-definition'>trigger_</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>MonadBase</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>AsyncWorker</span> <span class='hs-conid'>()</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-180"></a><span class='hs-definition'>trigger_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>trigger</span> <span class='hs-conid'>()</span>
<a name="line-181"></a>
<a name="line-182"></a><a name="triggerWithResult"></a><span class='hs-comment'>-- | Trigger a worker and wait until the action following this trigger</span>
<a name="line-183"></a><span class='hs-comment'>-- finishes. The returned `Async` value can be used to wait for the result of</span>
<a name="line-184"></a><span class='hs-comment'>-- the action.</span>
<a name="line-185"></a><span class='hs-definition'>triggerWithResult</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>MonadBase</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Monoid</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-186"></a>                  <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AsyncWorker</span> <span class='hs-varid'>i</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Async</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-187"></a><span class='hs-definition'>triggerWithResult</span> <span class='hs-varid'>i</span> <span class='hs-varid'>worker</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-188"></a>    <span class='hs-varid'>result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newEmptyMVar</span>
<a name="line-189"></a>    <span class='hs-varid'>triggerInternal</span> <span class='hs-varid'>i</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-varid'>worker</span>
<a name="line-190"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Async</span> <span class='hs-varid'>result</span>
<a name="line-191"></a>
<a name="line-192"></a><a name="triggerWithResult_"></a><span class='hs-comment'>-- | Trigger a worker and wait until the action following this trigger</span>
<a name="line-193"></a><span class='hs-comment'>-- finishes.</span>
<a name="line-194"></a><span class='hs-comment'>--</span>
<a name="line-195"></a><span class='hs-comment'>-- See 'triggerWithResult'.</span>
<a name="line-196"></a><span class='hs-definition'>triggerWithResult_</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>MonadBase</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>AsyncWorker</span> <span class='hs-conid'>()</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Async</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-197"></a><span class='hs-definition'>triggerWithResult_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>triggerWithResult</span> <span class='hs-conid'>()</span>
<a name="line-198"></a>
<a name="line-199"></a><a name="triggerWithResultMany"></a><span class='hs-comment'>-- | Trigger a list of workers and wait until all the actions following these</span>
<a name="line-200"></a><span class='hs-comment'>-- triggers finish. The returned collection of `Async` values can be used to</span>
<a name="line-201"></a><span class='hs-comment'>-- wait for the results of the actions.</span>
<a name="line-202"></a><span class='hs-definition'>triggerWithResultMany</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-conid'>Traversable</span> <span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadBase</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Monoid</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-203"></a>                      <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-conid'>AsyncWorker</span> <span class='hs-varid'>i</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-conid'>Async</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-204"></a><span class='hs-definition'>triggerWithResultMany</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>triggerWithResult</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-205"></a><a name="triggerWithResultMany_"></a><span class='hs-comment'>--</span>
<a name="line-206"></a><span class='hs-comment'>-- | Trigger a list of workers with no inputs and wait until all the actions</span>
<a name="line-207"></a><span class='hs-comment'>-- following these triggers finish.</span>
<a name="line-208"></a><span class='hs-comment'>--</span>
<a name="line-209"></a><span class='hs-comment'>-- See 'triggerWithResultMany'.</span>
<a name="line-210"></a><span class='hs-definition'>triggerWithResultMany_</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-conid'>Traversable</span> <span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadBase</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-211"></a>                       <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-conid'>AsyncWorker</span> <span class='hs-conid'>()</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-conid'>Async</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-212"></a><span class='hs-definition'>triggerWithResultMany_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>triggerWithResultMany</span> <span class='hs-conid'>()</span>
<a name="line-213"></a>
<a name="line-214"></a><span class='hs-comment'>-- * Helper functions for waiting for results just after triggering workers</span>
<a name="line-215"></a>
<a name="line-216"></a><a name="triggerAndWaitMany"></a><span class='hs-comment'>-- | Trigger a list of workers and wait until all the actions following these</span>
<a name="line-217"></a><span class='hs-comment'>-- triggers finish. Returns the results of the actions.</span>
<a name="line-218"></a><span class='hs-comment'>--</span>
<a name="line-219"></a><span class='hs-comment'>-- Note that there is a significant difference between 'triggerAndWaitMany'</span>
<a name="line-220"></a><span class='hs-comment'>-- and @mapM triggerAndWait@. The latter runs all the actions of the workers</span>
<a name="line-221"></a><span class='hs-comment'>-- sequentially, while the former runs them in parallel.</span>
<a name="line-222"></a><span class='hs-definition'>triggerAndWaitMany</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-conid'>Traversable</span> <span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadBase</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Monoid</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-223"></a>                   <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-conid'>AsyncWorker</span> <span class='hs-varid'>i</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-224"></a><span class='hs-definition'>triggerAndWaitMany</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>waitMany</span> <span class='hs-varop'>&lt;=&lt;</span> <span class='hs-varid'>triggerWithResultMany</span> <span class='hs-varid'>i</span>
<a name="line-225"></a>
<a name="line-226"></a><a name="triggerAndWaitMany_"></a><span class='hs-comment'>-- See 'triggetAndWaitMany'.</span>
<a name="line-227"></a><span class='hs-definition'>triggerAndWaitMany_</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>T</span><span class='hs-varop'>.</span><span class='hs-conid'>Traversable</span> <span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadBase</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-228"></a>                    <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-conid'>AsyncWorker</span> <span class='hs-conid'>()</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-229"></a><span class='hs-definition'>triggerAndWaitMany_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>triggerAndWaitMany</span> <span class='hs-conid'>()</span>
<a name="line-230"></a>
<a name="line-231"></a><a name="triggerAndWait"></a><span class='hs-comment'>-- | Trigger a worker and wait until the action following this trigger</span>
<a name="line-232"></a><span class='hs-comment'>-- finishes. Return the result of the action.</span>
<a name="line-233"></a><span class='hs-definition'>triggerAndWait</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>MonadBase</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>Monoid</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>AsyncWorker</span> <span class='hs-varid'>i</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-234"></a><span class='hs-definition'>triggerAndWait</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wait</span> <span class='hs-varop'>&lt;=&lt;</span> <span class='hs-varid'>triggerWithResult</span> <span class='hs-varid'>i</span>
<a name="line-235"></a>
<a name="line-236"></a><a name="triggerAndWait_"></a><span class='hs-comment'>-- | Trigger a worker with no input and wait until the action following this</span>
<a name="line-237"></a><span class='hs-comment'>-- trigger finishes. Return the result of the action.</span>
<a name="line-238"></a><span class='hs-definition'>triggerAndWait_</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>MonadBase</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>AsyncWorker</span> <span class='hs-conid'>()</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-varid'>a</span>
<a name="line-239"></a><span class='hs-definition'>triggerAndWait_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>triggerAndWait</span> <span class='hs-conid'>()</span>
</pre></body>
</html>
