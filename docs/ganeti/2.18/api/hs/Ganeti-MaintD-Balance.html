<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Ganeti.MaintD.Balance</title><link href="ocean.css" rel="stylesheet" type="text/css" title="Ocean" /><script src="haddock-util.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
window.onload = function () {pageLoad();setSynopsis("mini_Ganeti-MaintD-Balance.html");};
//]]>
</script></head><body><div id="package-header"><ul class="links" id="page-menu"><li><a href="Ganeti/MaintD/Balance.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul><p class="caption">ganeti</p></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>Safe-Infered</td></tr></table><p class="caption">Ganeti.MaintD.Balance</p></div><div id="table-of-contents"><p class="caption">Contents</p><ul><li><a href="#g:1">Collection of dynamic load data
</a></li><li><a href="#g:2">Balancing
</a></li><li><a href="#g:3">Memory balancing
</a></li><li><a href="#g:4">Interface function
</a></li></ul></div><div id="description"><p class="caption">Description</p><div class="doc"><p>Balancing task of the maintenance daemon.
</p><p>This module carries out the automated balancing done by the
maintenance daemon. The actual balancing algorithm is imported
from htools.
</p></div></div><div id="synopsis"><p id="control.syn" class="caption expander" onclick="toggleSection('syn')">Synopsis</p><ul id="section.syn" class="hide" onclick="toggleSection('syn')"><li class="src short"><span class="keyword">data</span>  <a href="#t:AllReports">AllReports</a>  = <a href="#v:AllReports">AllReports</a> {<ul class="subs"><li><a href="#v:rTotal">rTotal</a> :: <a href="Ganeti-HTools-Backend-MonD.html#t:Report">Report</a></li><li><a href="#v:rIndividual">rIndividual</a> :: <a href="Ganeti-HTools-Backend-MonD.html#t:Report">Report</a></li><li><a href="#v:rMem">rMem</a> :: <a href="Ganeti-HTools-Backend-MonD.html#t:Report">Report</a></li></ul>}</li><li class="src short"><a href="#v:emptyReports">emptyReports</a> :: <a href="Ganeti-MaintD-Balance.html#t:AllReports">AllReports</a></li><li class="src short"><a href="#v:queryNode">queryNode</a> :: <a href="Ganeti-HTools-Node.html#t:Node">Node</a> -&gt; <a href="Ganeti-BasicTypes.html#t:ResultT">ResultT</a> String IO <a href="Ganeti-MaintD-Balance.html#t:AllReports">AllReports</a></li><li class="src short"><a href="#v:queryLoad">queryLoad</a> :: <a href="Ganeti-HTools-Node.html#t:List">List</a> -&gt; <a href="Ganeti-BasicTypes.html#t:ResultT">ResultT</a> String IO (<a href="Ganeti-HTools-Container.html#t:Container">Container</a> <a href="Ganeti-MaintD-Balance.html#t:AllReports">AllReports</a>)</li><li class="src short"><a href="#v:getXenInstances">getXenInstances</a> :: <a href="Ganeti-BasicTypes.html#t:ResultT">ResultT</a> String IO (Set String)</li><li class="src short"><a href="#v:findInstanceLoad">findInstanceLoad</a> :: String -&gt; <a href="Ganeti-MaintD-Balance.html#t:AllReports">AllReports</a> -&gt; Maybe Double</li><li class="src short"><a href="#v:updateCPUInstance">updateCPUInstance</a> :: <a href="Ganeti-HTools-Node.html#t:List">List</a> -&gt; <a href="Ganeti-HTools-Container.html#t:Container">Container</a> <a href="Ganeti-MaintD-Balance.html#t:AllReports">AllReports</a> -&gt; Set String -&gt; [String] -&gt; <a href="Ganeti-HTools-Instance.html#t:Instance">Instance</a> -&gt; <a href="Ganeti-BasicTypes.html#t:Result">Result</a> <a href="Ganeti-HTools-Instance.html#t:Instance">Instance</a></li><li class="src short"><a href="#v:updateCPULoad">updateCPULoad</a> :: (<a href="Ganeti-HTools-Node.html#t:List">List</a>, <a href="Ganeti-HTools-Instance.html#t:List">List</a>) -&gt; <a href="Ganeti-HTools-Container.html#t:Container">Container</a> <a href="Ganeti-MaintD-Balance.html#t:AllReports">AllReports</a> -&gt; Set String -&gt; [String] -&gt; <a href="Ganeti-BasicTypes.html#t:Result">Result</a> (<a href="Ganeti-HTools-Node.html#t:List">List</a>, <a href="Ganeti-HTools-Instance.html#t:List">List</a>)</li><li class="src short"><a href="#v:cleanUpEvacuation">cleanUpEvacuation</a> :: IORef <a href="Ganeti-MaintD-MemoryState.html#t:MemoryState">MemoryState</a> -&gt; <a href="Ganeti-HTools-Instance.html#t:List">List</a> -&gt; <a href="Ganeti-HTools-Container.html#t:Container">Container</a> <a href="Ganeti-MaintD-Balance.html#t:AllReports">AllReports</a> -&gt; String -&gt; IO ()</li><li class="src short"><a href="#v:moveToJob">moveToJob</a> :: <a href="Ganeti-JQueue-Objects.html#t:Timestamp">Timestamp</a> -&gt; (<a href="Ganeti-HTools-Node.html#t:List">List</a>, <a href="Ganeti-HTools-Instance.html#t:List">List</a>) -&gt; <a href="Ganeti-HTools-Types.html#t:MoveJob">MoveJob</a> -&gt; [<a href="Ganeti-OpCodes.html#t:MetaOpCode">MetaOpCode</a>]</li><li class="src short"><a href="#v:iterateBalance">iterateBalance</a> :: <a href="Ganeti-HTools-AlgorithmParams.html#t:AlgorithmOptions">AlgorithmOptions</a> -&gt; <a href="Ganeti-HTools-Cluster.html#t:Table">Table</a> -&gt; [<a href="Ganeti-HTools-Types.html#t:MoveJob">MoveJob</a>] -&gt; [<a href="Ganeti-HTools-Types.html#t:MoveJob">MoveJob</a>]</li><li class="src short"><a href="#v:evacuatedInsts">evacuatedInsts</a> :: (<a href="Ganeti-HTools-Node.html#t:List">List</a>, <a href="Ganeti-HTools-Instance.html#t:List">List</a>) -&gt; <a href="Ganeti-HTools-Types.html#t:MoveJob">MoveJob</a> -&gt; [String]</li><li class="src short"><a href="#v:balanceGroup">balanceGroup</a> :: IORef <a href="Ganeti-MaintD-MemoryState.html#t:MemoryState">MemoryState</a> -&gt; Set String -&gt; <a href="Ganeti-UDSServer.html#t:Client">Client</a> -&gt; Set Int -&gt; Double -&gt; (Int, (<a href="Ganeti-HTools-Node.html#t:List">List</a>, <a href="Ganeti-HTools-Instance.html#t:List">List</a>)) -&gt; <a href="Ganeti-BasicTypes.html#t:ResultT">ResultT</a> String IO [<a href="Ganeti-Types.html#t:JobId">JobId</a>]</li><li class="src short"><a href="#v:weightFromMemRatio">weightFromMemRatio</a> :: Double -&gt; Double</li><li class="src short"><a href="#v:useMemData">useMemData</a> :: Double -&gt; <a href="Ganeti-HTools-Container.html#t:Container">Container</a> <a href="Ganeti-MaintD-Balance.html#t:AllReports">AllReports</a> -&gt; (<a href="Ganeti-HTools-Node.html#t:List">List</a>, <a href="Ganeti-HTools-Instance.html#t:List">List</a>) -&gt; <a href="Ganeti-BasicTypes.html#t:ResultT">ResultT</a> String IO (<a href="Ganeti-HTools-Node.html#t:List">List</a>, <a href="Ganeti-HTools-Instance.html#t:List">List</a>)</li><li class="src short"><a href="#v:balanceTask">balanceTask</a> :: IORef <a href="Ganeti-MaintD-MemoryState.html#t:MemoryState">MemoryState</a> -&gt; (<a href="Ganeti-HTools-Node.html#t:List">List</a>, <a href="Ganeti-HTools-Instance.html#t:List">List</a>) -&gt; Set Int -&gt; Double -&gt; <a href="Ganeti-BasicTypes.html#t:ResultT">ResultT</a> String IO [<a href="Ganeti-Types.html#t:JobId">JobId</a>]</li></ul></div><div id="interface"><h1 id="g:1">Collection of dynamic load data
</h1><div class="top"><p class="src"><span class="keyword">data</span>  <a name="t:AllReports" class="def">AllReports</a>  <a href="Ganeti/MaintD/Balance.html#AllReports" class="link">Source</a></p><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a name="v:AllReports" class="def">AllReports</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><dl><dt class="src"><a name="v:rTotal" class="def">rTotal</a> :: <a href="Ganeti-HTools-Backend-MonD.html#t:Report">Report</a></dt><dd class="doc empty">&nbsp;</dd><dt class="src"><a name="v:rIndividual" class="def">rIndividual</a> :: <a href="Ganeti-HTools-Backend-MonD.html#t:Report">Report</a></dt><dd class="doc empty">&nbsp;</dd><dt class="src"><a name="v:rMem" class="def">rMem</a> :: <a href="Ganeti-HTools-Backend-MonD.html#t:Report">Report</a></dt><dd class="doc empty">&nbsp;</dd></dl><div class="clear"></div></div></td></tr></table></div></div><div class="top"><p class="src"><a name="v:emptyReports" class="def">emptyReports</a> :: <a href="Ganeti-MaintD-Balance.html#t:AllReports">AllReports</a><a href="Ganeti/MaintD/Balance.html#emptyReports" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:queryNode" class="def">queryNode</a> :: <a href="Ganeti-HTools-Node.html#t:Node">Node</a> -&gt; <a href="Ganeti-BasicTypes.html#t:ResultT">ResultT</a> String IO <a href="Ganeti-MaintD-Balance.html#t:AllReports">AllReports</a><a href="Ganeti/MaintD/Balance.html#queryNode" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:queryLoad" class="def">queryLoad</a> :: <a href="Ganeti-HTools-Node.html#t:List">List</a> -&gt; <a href="Ganeti-BasicTypes.html#t:ResultT">ResultT</a> String IO (<a href="Ganeti-HTools-Container.html#t:Container">Container</a> <a href="Ganeti-MaintD-Balance.html#t:AllReports">AllReports</a>)<a href="Ganeti/MaintD/Balance.html#queryLoad" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:getXenInstances" class="def">getXenInstances</a> :: <a href="Ganeti-BasicTypes.html#t:ResultT">ResultT</a> String IO (Set String)<a href="Ganeti/MaintD/Balance.html#getXenInstances" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:findInstanceLoad" class="def">findInstanceLoad</a> :: String -&gt; <a href="Ganeti-MaintD-Balance.html#t:AllReports">AllReports</a> -&gt; Maybe Double<a href="Ganeti/MaintD/Balance.html#findInstanceLoad" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:updateCPUInstance" class="def">updateCPUInstance</a> :: <a href="Ganeti-HTools-Node.html#t:List">List</a> -&gt; <a href="Ganeti-HTools-Container.html#t:Container">Container</a> <a href="Ganeti-MaintD-Balance.html#t:AllReports">AllReports</a> -&gt; Set String -&gt; [String] -&gt; <a href="Ganeti-HTools-Instance.html#t:Instance">Instance</a> -&gt; <a href="Ganeti-BasicTypes.html#t:Result">Result</a> <a href="Ganeti-HTools-Instance.html#t:Instance">Instance</a><a href="Ganeti/MaintD/Balance.html#updateCPUInstance" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:updateCPULoad" class="def">updateCPULoad</a> :: (<a href="Ganeti-HTools-Node.html#t:List">List</a>, <a href="Ganeti-HTools-Instance.html#t:List">List</a>) -&gt; <a href="Ganeti-HTools-Container.html#t:Container">Container</a> <a href="Ganeti-MaintD-Balance.html#t:AllReports">AllReports</a> -&gt; Set String -&gt; [String] -&gt; <a href="Ganeti-BasicTypes.html#t:Result">Result</a> (<a href="Ganeti-HTools-Node.html#t:List">List</a>, <a href="Ganeti-HTools-Instance.html#t:List">List</a>)<a href="Ganeti/MaintD/Balance.html#updateCPULoad" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:cleanUpEvacuation" class="def">cleanUpEvacuation</a> :: IORef <a href="Ganeti-MaintD-MemoryState.html#t:MemoryState">MemoryState</a> -&gt; <a href="Ganeti-HTools-Instance.html#t:List">List</a> -&gt; <a href="Ganeti-HTools-Container.html#t:Container">Container</a> <a href="Ganeti-MaintD-Balance.html#t:AllReports">AllReports</a> -&gt; String -&gt; IO ()<a href="Ganeti/MaintD/Balance.html#cleanUpEvacuation" class="link">Source</a></p></div><h1 id="g:2">Balancing
</h1><div class="top"><p class="src"><a name="v:moveToJob" class="def">moveToJob</a> :: <a href="Ganeti-JQueue-Objects.html#t:Timestamp">Timestamp</a> -&gt; (<a href="Ganeti-HTools-Node.html#t:List">List</a>, <a href="Ganeti-HTools-Instance.html#t:List">List</a>) -&gt; <a href="Ganeti-HTools-Types.html#t:MoveJob">MoveJob</a> -&gt; [<a href="Ganeti-OpCodes.html#t:MetaOpCode">MetaOpCode</a>]<a href="Ganeti/MaintD/Balance.html#moveToJob" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:iterateBalance" class="def">iterateBalance</a> :: <a href="Ganeti-HTools-AlgorithmParams.html#t:AlgorithmOptions">AlgorithmOptions</a> -&gt; <a href="Ganeti-HTools-Cluster.html#t:Table">Table</a> -&gt; [<a href="Ganeti-HTools-Types.html#t:MoveJob">MoveJob</a>] -&gt; [<a href="Ganeti-HTools-Types.html#t:MoveJob">MoveJob</a>]<a href="Ganeti/MaintD/Balance.html#iterateBalance" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:evacuatedInsts" class="def">evacuatedInsts</a> :: (<a href="Ganeti-HTools-Node.html#t:List">List</a>, <a href="Ganeti-HTools-Instance.html#t:List">List</a>) -&gt; <a href="Ganeti-HTools-Types.html#t:MoveJob">MoveJob</a> -&gt; [String]<a href="Ganeti/MaintD/Balance.html#evacuatedInsts" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:balanceGroup" class="def">balanceGroup</a> :: IORef <a href="Ganeti-MaintD-MemoryState.html#t:MemoryState">MemoryState</a> -&gt; Set String -&gt; <a href="Ganeti-UDSServer.html#t:Client">Client</a> -&gt; Set Int -&gt; Double -&gt; (Int, (<a href="Ganeti-HTools-Node.html#t:List">List</a>, <a href="Ganeti-HTools-Instance.html#t:List">List</a>)) -&gt; <a href="Ganeti-BasicTypes.html#t:ResultT">ResultT</a> String IO [<a href="Ganeti-Types.html#t:JobId">JobId</a>]<a href="Ganeti/MaintD/Balance.html#balanceGroup" class="link">Source</a></p></div><h1 id="g:3">Memory balancing
</h1><div class="top"><p class="src"><a name="v:weightFromMemRatio" class="def">weightFromMemRatio</a> :: Double -&gt; Double<a href="Ganeti/MaintD/Balance.html#weightFromMemRatio" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:useMemData" class="def">useMemData</a> :: Double -&gt; <a href="Ganeti-HTools-Container.html#t:Container">Container</a> <a href="Ganeti-MaintD-Balance.html#t:AllReports">AllReports</a> -&gt; (<a href="Ganeti-HTools-Node.html#t:List">List</a>, <a href="Ganeti-HTools-Instance.html#t:List">List</a>) -&gt; <a href="Ganeti-BasicTypes.html#t:ResultT">ResultT</a> String IO (<a href="Ganeti-HTools-Node.html#t:List">List</a>, <a href="Ganeti-HTools-Instance.html#t:List">List</a>)<a href="Ganeti/MaintD/Balance.html#useMemData" class="link">Source</a></p></div><h1 id="g:4">Interface function
</h1><div class="top"><p class="src"><a name="v:balanceTask" class="def">balanceTask</a><a href="Ganeti/MaintD/Balance.html#balanceTask" class="link">Source</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: IORef <a href="Ganeti-MaintD-MemoryState.html#t:MemoryState">MemoryState</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">-&gt; (<a href="Ganeti-HTools-Node.html#t:List">List</a>, <a href="Ganeti-HTools-Instance.html#t:List">List</a>)</td><td class="doc"><p>current cluster configuration
</p></td></tr><tr><td class="src">-&gt; Set Int</td><td class="doc"><p>node indices on which actions may be taken
</p></td></tr><tr><td class="src">-&gt; Double</td><td class="doc"><p>threshold for improvement
</p></td></tr><tr><td class="src">-&gt; <a href="Ganeti-BasicTypes.html#t:ResultT">ResultT</a> String IO [<a href="Ganeti-Types.html#t:JobId">JobId</a>]</td><td class="doc"><p>jobs submitted
</p></td></tr></table></div><div class="doc"><p>Carry out all the needed balancing, based on live CPU data, only touching
 the available nodes. Only carry out balancing steps where the gain is above
 the threshold.
</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.10.0</p></div></body></html>