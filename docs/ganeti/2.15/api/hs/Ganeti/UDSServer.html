<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Ganeti/UDSServer.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE TemplateHaskell #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# LANGUAGE FlexibleContexts #-}</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-comment'>{-| Implementation of the Ganeti Unix Domain Socket JSON server interface.
<a name="line-5"></a>
<a name="line-6"></a>-}</span>
<a name="line-7"></a>
<a name="line-8"></a><span class='hs-comment'>{-
<a name="line-9"></a>
<a name="line-10"></a>Copyright (C) 2013 Google Inc.
<a name="line-11"></a>All rights reserved.
<a name="line-12"></a>
<a name="line-13"></a>Redistribution and use in source and binary forms, with or without
<a name="line-14"></a>modification, are permitted provided that the following conditions are
<a name="line-15"></a>met:
<a name="line-16"></a>
<a name="line-17"></a>1. Redistributions of source code must retain the above copyright notice,
<a name="line-18"></a>this list of conditions and the following disclaimer.
<a name="line-19"></a>
<a name="line-20"></a>2. Redistributions in binary form must reproduce the above copyright
<a name="line-21"></a>notice, this list of conditions and the following disclaimer in the
<a name="line-22"></a>documentation and/or other materials provided with the distribution.
<a name="line-23"></a>
<a name="line-24"></a>THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
<a name="line-25"></a>IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
<a name="line-26"></a>TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
<a name="line-27"></a>PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR
<a name="line-28"></a>CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
<a name="line-29"></a>EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
<a name="line-30"></a>PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
<a name="line-31"></a>PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
<a name="line-32"></a>LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
<a name="line-33"></a>NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
<a name="line-34"></a>SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
<a name="line-35"></a>
<a name="line-36"></a>-}</span>
<a name="line-37"></a>
<a name="line-38"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Ganeti</span><span class='hs-varop'>.</span><span class='hs-conid'>UDSServer</span>
<a name="line-39"></a>  <span class='hs-layout'>(</span> <span class='hs-conid'>ConnectConfig</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-40"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>ServerConfig</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-41"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Client</span>
<a name="line-42"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Server</span>
<a name="line-43"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>RecvResult</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-44"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>MsgKeys</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-45"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>strOfKey</span>
<a name="line-46"></a>  <span class='hs-comment'>-- * Unix sockets</span>
<a name="line-47"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>openClientSocket</span>
<a name="line-48"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>closeClientSocket</span>
<a name="line-49"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>openServerSocket</span>
<a name="line-50"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>closeServerSocket</span>
<a name="line-51"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>acceptSocket</span>
<a name="line-52"></a>  <span class='hs-comment'>-- * Client and server</span>
<a name="line-53"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>connectClient</span>
<a name="line-54"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>connectServer</span>
<a name="line-55"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>pipeClient</span>
<a name="line-56"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>acceptClient</span>
<a name="line-57"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>closeClient</span>
<a name="line-58"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>clientToFd</span>
<a name="line-59"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>closeServer</span>
<a name="line-60"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>buildResponse</span>
<a name="line-61"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>parseResponse</span>
<a name="line-62"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>buildCall</span>
<a name="line-63"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>parseCall</span>
<a name="line-64"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>recvMsg</span>
<a name="line-65"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>recvMsgExt</span>
<a name="line-66"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>sendMsg</span>
<a name="line-67"></a>  <span class='hs-comment'>-- * Client handler</span>
<a name="line-68"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>Handler</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span>
<a name="line-69"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>HandlerResult</span>
<a name="line-70"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>listener</span>
<a name="line-71"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-72"></a>
<a name="line-73"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Applicative</span>
<a name="line-74"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Concurrent</span><span class='hs-varop'>.</span><span class='hs-conid'>Lifted</span> <span class='hs-layout'>(</span><span class='hs-varid'>fork</span><span class='hs-layout'>,</span> <span class='hs-varid'>yield</span><span class='hs-layout'>)</span>
<a name="line-75"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Base</span>
<a name="line-76"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>Trans</span><span class='hs-varop'>.</span><span class='hs-conid'>Control</span>
<a name="line-77"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Exception</span> <span class='hs-layout'>(</span><span class='hs-varid'>catch</span><span class='hs-layout'>)</span>
<a name="line-78"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-79"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>B</span>
<a name="line-80"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span><span class='hs-varop'>.</span><span class='hs-conid'>UTF8</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>UTF8</span>
<a name="line-81"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>IORef</span>
<a name="line-82"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
<a name="line-83"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Word</span> <span class='hs-layout'>(</span><span class='hs-conid'>Word8</span><span class='hs-layout'>)</span>
<a name="line-84"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Network</span><span class='hs-varop'>.</span><span class='hs-conid'>Socket</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>S</span>
<a name="line-85"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Directory</span> <span class='hs-layout'>(</span><span class='hs-varid'>removeFile</span><span class='hs-layout'>)</span>
<a name="line-86"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-varid'>hClose</span><span class='hs-layout'>,</span> <span class='hs-varid'>hFlush</span><span class='hs-layout'>,</span> <span class='hs-varid'>hWaitForInput</span><span class='hs-layout'>,</span> <span class='hs-conid'>Handle</span><span class='hs-layout'>,</span> <span class='hs-conid'>IOMode</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-87"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span><span class='hs-varop'>.</span><span class='hs-conid'>Error</span> <span class='hs-layout'>(</span><span class='hs-varid'>isEOFError</span><span class='hs-layout'>)</span>
<a name="line-88"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Posix</span><span class='hs-varop'>.</span><span class='hs-conid'>Types</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fd</span><span class='hs-layout'>)</span>
<a name="line-89"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Posix</span><span class='hs-varop'>.</span><span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-varid'>createPipe</span><span class='hs-layout'>,</span> <span class='hs-varid'>fdToHandle</span><span class='hs-layout'>,</span> <span class='hs-varid'>handleToFd</span><span class='hs-layout'>)</span>
<a name="line-90"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>System</span><span class='hs-varop'>.</span><span class='hs-conid'>Timeout</span>
<a name="line-91"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Text</span><span class='hs-varop'>.</span><span class='hs-conid'>JSON</span> <span class='hs-layout'>(</span><span class='hs-varid'>encodeStrict</span><span class='hs-layout'>,</span> <span class='hs-varid'>decodeStrict</span><span class='hs-layout'>)</span>
<a name="line-92"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Text</span><span class='hs-varop'>.</span><span class='hs-conid'>JSON</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>J</span>
<a name="line-93"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Text</span><span class='hs-varop'>.</span><span class='hs-conid'>JSON</span><span class='hs-varop'>.</span><span class='hs-conid'>Types</span>
<a name="line-94"></a>
<a name="line-95"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Ganeti</span><span class='hs-varop'>.</span><span class='hs-conid'>BasicTypes</span>
<a name="line-96"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Ganeti</span><span class='hs-varop'>.</span><span class='hs-conid'>Errors</span> <span class='hs-layout'>(</span><span class='hs-conid'>GanetiException</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>..</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>ErrorResult</span><span class='hs-layout'>)</span>
<a name="line-97"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Ganeti</span><span class='hs-varop'>.</span><span class='hs-conid'>JSON</span>
<a name="line-98"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Ganeti</span><span class='hs-varop'>.</span><span class='hs-conid'>Logging</span>
<a name="line-99"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Ganeti</span><span class='hs-varop'>.</span><span class='hs-conid'>THH</span>
<a name="line-100"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Ganeti</span><span class='hs-varop'>.</span><span class='hs-conid'>Utils</span>
<a name="line-101"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Ganeti</span><span class='hs-varop'>.</span><span class='hs-conid'>Constants</span> <span class='hs-layout'>(</span><span class='hs-varid'>privateParametersBlacklist</span><span class='hs-layout'>)</span>
<a name="line-102"></a>
<a name="line-103"></a><span class='hs-comment'>-- * Utility functions</span>
<a name="line-104"></a>
<a name="line-105"></a><a name="withTimeout"></a><span class='hs-comment'>-- | Wrapper over System.Timeout.timeout that fails in the IO monad.</span>
<a name="line-106"></a><span class='hs-definition'>withTimeout</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>a</span>
<a name="line-107"></a><span class='hs-definition'>withTimeout</span> <span class='hs-varid'>secs</span> <span class='hs-varid'>descr</span> <span class='hs-varid'>action</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-108"></a>  <span class='hs-varid'>result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>timeout</span> <span class='hs-layout'>(</span><span class='hs-varid'>secs</span> <span class='hs-varop'>*</span> <span class='hs-num'>1000000</span><span class='hs-layout'>)</span> <span class='hs-varid'>action</span>
<a name="line-109"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>result</span> <span class='hs-keyword'>of</span>
<a name="line-110"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>fail</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Timeout in "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>descr</span>
<a name="line-111"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>v</span>
<a name="line-112"></a>
<a name="line-113"></a>
<a name="line-114"></a><span class='hs-comment'>-- * Generic protocol functionality</span>
<a name="line-115"></a>
<a name="line-116"></a><a name="RecvResult"></a><span class='hs-comment'>-- | Result of receiving a message from the socket.</span>
<a name="line-117"></a><a name="RecvResult"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>RecvResult</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>RecvConnClosed</span>    <span class='hs-comment'>-- ^ Connection closed</span>
<a name="line-118"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RecvError</span> <span class='hs-conid'>String</span>  <span class='hs-comment'>-- ^ Any other error</span>
<a name="line-119"></a>                <span class='hs-keyglyph'>|</span> <span class='hs-conid'>RecvOk</span> <span class='hs-conid'>String</span>     <span class='hs-comment'>-- ^ Successfull receive</span>
<a name="line-120"></a>                  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Show</span><span class='hs-layout'>,</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>)</span>
<a name="line-121"></a>
<a name="line-122"></a>
<a name="line-123"></a><a name="eOM"></a><span class='hs-comment'>-- | The end-of-message separator.</span>
<a name="line-124"></a><span class='hs-definition'>eOM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Word8</span>
<a name="line-125"></a><span class='hs-definition'>eOM</span> <span class='hs-keyglyph'>=</span> <span class='hs-num'>3</span>
<a name="line-126"></a>
<a name="line-127"></a><a name="bEOM"></a><span class='hs-comment'>-- | The end-of-message encoded as a ByteString.</span>
<a name="line-128"></a><span class='hs-definition'>bEOM</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span>
<a name="line-129"></a><span class='hs-definition'>bEOM</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>singleton</span> <span class='hs-varid'>eOM</span>
<a name="line-130"></a>
<a name="line-131"></a><a name="MsgKeys"></a><span class='hs-comment'>-- | Valid keys in the requests and responses.</span>
<a name="line-132"></a><a name="MsgKeys"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>MsgKeys</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Method</span>
<a name="line-133"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Args</span>
<a name="line-134"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Success</span>
<a name="line-135"></a>             <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Result</span>
<a name="line-136"></a>
<a name="line-137"></a><span class='hs-comment'>-- | The serialisation of MsgKeys into strings in messages.</span>
<a name="line-138"></a><span class='hs-varop'>$</span><span class='hs-layout'>(</span><span class='hs-varid'>genStrOfKey</span> <span class='hs-chr'>'</span><span class='hs-chr'>'</span><span class='hs-conid'>MsgKeys</span> <span class='hs-str'>"strOfKey"</span><span class='hs-layout'>)</span>
<a name="line-139"></a>
<a name="line-140"></a>
<a name="line-141"></a><a name="ServerConfig"></a><span class='hs-comment'>-- Information required for creating a server connection.</span>
<a name="line-142"></a><a name="ServerConfig"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ServerConfig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ServerConfig</span>
<a name="line-143"></a>                    <span class='hs-layout'>{</span> <span class='hs-varid'>connPermissions</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePermissions</span>
<a name="line-144"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>connConfig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ConnectConfig</span>
<a name="line-145"></a>                    <span class='hs-layout'>}</span>
<a name="line-146"></a>
<a name="line-147"></a><a name="ConnectConfig"></a><span class='hs-comment'>-- Information required for creating a client or server connection.</span>
<a name="line-148"></a><a name="ConnectConfig"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ConnectConfig</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ConnectConfig</span>
<a name="line-149"></a>                     <span class='hs-layout'>{</span> <span class='hs-varid'>recvTmo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-150"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>sendTmo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>
<a name="line-151"></a>                     <span class='hs-layout'>}</span>
<a name="line-152"></a>
<a name="line-153"></a><a name="Client"></a><span class='hs-comment'>-- | A client encapsulation. Note that it has separate read and write handle.</span>
<a name="line-154"></a><a name="Client"></a><span class='hs-comment'>-- For sockets it is the same handle. It is required for bi-directional</span>
<a name="line-155"></a><a name="Client"></a><span class='hs-comment'>-- inter-process pipes though.</span>
<a name="line-156"></a><a name="Client"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Client</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Client</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rsocket</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Handle</span>          <span class='hs-comment'>-- ^ The read part of</span>
<a name="line-157"></a>                                                  <span class='hs-comment'>-- the client socket</span>
<a name="line-158"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>wsocket</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Handle</span>          <span class='hs-comment'>-- ^ The write part of</span>
<a name="line-159"></a>                                                  <span class='hs-comment'>-- the client socket</span>
<a name="line-160"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>rbuf</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>IORef</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span> <span class='hs-comment'>-- ^ Already received buffer</span>
<a name="line-161"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>clientConfig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ConnectConfig</span>
<a name="line-162"></a>                     <span class='hs-layout'>}</span>
<a name="line-163"></a>
<a name="line-164"></a><a name="Server"></a><span class='hs-comment'>-- | A server encapsulation.</span>
<a name="line-165"></a><a name="Server"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Server</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Server</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sSocket</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-conid'>Socket</span>        <span class='hs-comment'>-- ^ The bound server socket</span>
<a name="line-166"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>sPath</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span>          <span class='hs-comment'>-- ^ The scoket's path</span>
<a name="line-167"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>serverConfig</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ConnectConfig</span>
<a name="line-168"></a>                     <span class='hs-layout'>}</span>
<a name="line-169"></a>
<a name="line-170"></a><span class='hs-comment'>-- * Unix sockets</span>
<a name="line-171"></a>
<a name="line-172"></a><a name="openClientSocket"></a><span class='hs-comment'>-- | Creates a Unix socket and connects it to the specified @path@,</span>
<a name="line-173"></a><span class='hs-comment'>-- where @timeout@ specifies the connection timeout.</span>
<a name="line-174"></a><span class='hs-definition'>openClientSocket</span>
<a name="line-175"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span>              <span class='hs-comment'>-- ^ connection timeout</span>
<a name="line-176"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>         <span class='hs-comment'>-- ^ socket path</span>
<a name="line-177"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Handle</span>
<a name="line-178"></a><span class='hs-definition'>openClientSocket</span> <span class='hs-varid'>tmo</span> <span class='hs-varid'>path</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-179"></a>  <span class='hs-varid'>sock</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-varid'>socket</span> <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-conid'>AF_UNIX</span> <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-conid'>Stream</span> <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-varid'>defaultProtocol</span>
<a name="line-180"></a>  <span class='hs-varid'>withTimeout</span> <span class='hs-varid'>tmo</span> <span class='hs-str'>"creating a connection"</span> <span class='hs-varop'>$</span>
<a name="line-181"></a>              <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-varid'>connect</span> <span class='hs-varid'>sock</span> <span class='hs-layout'>(</span><span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-conid'>SockAddrUnix</span> <span class='hs-varid'>path</span><span class='hs-layout'>)</span>
<a name="line-182"></a>  <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-varid'>socketToHandle</span> <span class='hs-varid'>sock</span> <span class='hs-conid'>ReadWriteMode</span>
<a name="line-183"></a>
<a name="line-184"></a><a name="closeClientSocket"></a><span class='hs-comment'>-- | Closes the handle.</span>
<a name="line-185"></a><span class='hs-comment'>-- Performing the operation on a handle that has already been closed has no</span>
<a name="line-186"></a><span class='hs-comment'>-- effect; doing so is not an error.</span>
<a name="line-187"></a><span class='hs-comment'>-- All other operations on a closed handle will fail.</span>
<a name="line-188"></a><span class='hs-definition'>closeClientSocket</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-189"></a><span class='hs-definition'>closeClientSocket</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hClose</span>
<a name="line-190"></a>
<a name="line-191"></a><a name="openServerSocket"></a><span class='hs-comment'>-- | Creates a Unix socket and binds it to the specified @path@.</span>
<a name="line-192"></a><span class='hs-definition'>openServerSocket</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-conid'>Socket</span>
<a name="line-193"></a><span class='hs-definition'>openServerSocket</span> <span class='hs-varid'>path</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-194"></a>  <span class='hs-varid'>sock</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-varid'>socket</span> <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-conid'>AF_UNIX</span> <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-conid'>Stream</span> <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-varid'>defaultProtocol</span>
<a name="line-195"></a>  <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-varid'>bindSocket</span> <span class='hs-varid'>sock</span> <span class='hs-layout'>(</span><span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-conid'>SockAddrUnix</span> <span class='hs-varid'>path</span><span class='hs-layout'>)</span>
<a name="line-196"></a>  <span class='hs-varid'>return</span> <span class='hs-varid'>sock</span>
<a name="line-197"></a>
<a name="line-198"></a><a name="closeServerSocket"></a><span class='hs-definition'>closeServerSocket</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-conid'>Socket</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-199"></a><span class='hs-definition'>closeServerSocket</span> <span class='hs-varid'>sock</span> <span class='hs-varid'>path</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-200"></a>  <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-varid'>sClose</span> <span class='hs-varid'>sock</span>
<a name="line-201"></a>  <span class='hs-varid'>removeFile</span> <span class='hs-varid'>path</span>
<a name="line-202"></a>
<a name="line-203"></a><a name="acceptSocket"></a><span class='hs-definition'>acceptSocket</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-conid'>Socket</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Handle</span>
<a name="line-204"></a><span class='hs-definition'>acceptSocket</span> <span class='hs-varid'>sock</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-205"></a>  <span class='hs-comment'>-- ignore client socket address</span>
<a name="line-206"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>clientSock</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-varid'>accept</span> <span class='hs-varid'>sock</span>
<a name="line-207"></a>  <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-varid'>socketToHandle</span> <span class='hs-varid'>clientSock</span> <span class='hs-conid'>ReadWriteMode</span>
<a name="line-208"></a>
<a name="line-209"></a><span class='hs-comment'>-- * Client and server</span>
<a name="line-210"></a>
<a name="line-211"></a><a name="connectClient"></a><span class='hs-comment'>-- | Connects to the master daemon and returns a Client.</span>
<a name="line-212"></a><span class='hs-definition'>connectClient</span>
<a name="line-213"></a>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ConnectConfig</span>    <span class='hs-comment'>-- ^ configuration for the client</span>
<a name="line-214"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Int</span>              <span class='hs-comment'>-- ^ connection timeout</span>
<a name="line-215"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span>         <span class='hs-comment'>-- ^ socket path</span>
<a name="line-216"></a>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Client</span>
<a name="line-217"></a><span class='hs-definition'>connectClient</span> <span class='hs-varid'>conf</span> <span class='hs-varid'>tmo</span> <span class='hs-varid'>path</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-218"></a>  <span class='hs-varid'>h</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>openClientSocket</span> <span class='hs-varid'>tmo</span> <span class='hs-varid'>path</span>
<a name="line-219"></a>  <span class='hs-varid'>rf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newIORef</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-220"></a>  <span class='hs-varid'>return</span> <span class='hs-conid'>Client</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rsocket</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>h</span><span class='hs-layout'>,</span> <span class='hs-varid'>wsocket</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>h</span><span class='hs-layout'>,</span> <span class='hs-varid'>rbuf</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>rf</span><span class='hs-layout'>,</span> <span class='hs-varid'>clientConfig</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>conf</span> <span class='hs-layout'>}</span>
<a name="line-221"></a>
<a name="line-222"></a><a name="connectServer"></a><span class='hs-comment'>-- | Creates and returns a server endpoint.</span>
<a name="line-223"></a><span class='hs-definition'>connectServer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ServerConfig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FilePath</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Server</span>
<a name="line-224"></a><span class='hs-definition'>connectServer</span> <span class='hs-varid'>sconf</span> <span class='hs-varid'>setOwner</span> <span class='hs-varid'>path</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-225"></a>  <span class='hs-varid'>s</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>openServerSocket</span> <span class='hs-varid'>path</span>
<a name="line-226"></a>  <span class='hs-varid'>when</span> <span class='hs-varid'>setOwner</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-227"></a>    <span class='hs-varid'>res</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ensurePermissions</span> <span class='hs-varid'>path</span> <span class='hs-layout'>(</span><span class='hs-varid'>connPermissions</span> <span class='hs-varid'>sconf</span><span class='hs-layout'>)</span>
<a name="line-228"></a>    <span class='hs-varid'>exitIfBad</span> <span class='hs-str'>"Error - could not set socket properties"</span> <span class='hs-varid'>res</span>
<a name="line-229"></a>
<a name="line-230"></a>  <span class='hs-conid'>S</span><span class='hs-varop'>.</span><span class='hs-varid'>listen</span> <span class='hs-varid'>s</span> <span class='hs-num'>5</span> <span class='hs-comment'>-- 5 is the max backlog</span>
<a name="line-231"></a>  <span class='hs-varid'>return</span> <span class='hs-conid'>Server</span> <span class='hs-layout'>{</span> <span class='hs-varid'>sSocket</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s</span><span class='hs-layout'>,</span> <span class='hs-varid'>sPath</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>path</span><span class='hs-layout'>,</span> <span class='hs-varid'>serverConfig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>connConfig</span> <span class='hs-varid'>sconf</span> <span class='hs-layout'>}</span>
<a name="line-232"></a>
<a name="line-233"></a><a name="pipeClient"></a><span class='hs-comment'>-- | Creates a new bi-directional client pipe. The two returned clients</span>
<a name="line-234"></a><span class='hs-comment'>-- talk to each other through the pipe.</span>
<a name="line-235"></a><span class='hs-definition'>pipeClient</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ConnectConfig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Client</span><span class='hs-layout'>,</span> <span class='hs-conid'>Client</span><span class='hs-layout'>)</span>
<a name="line-236"></a><span class='hs-definition'>pipeClient</span> <span class='hs-varid'>conf</span> <span class='hs-keyglyph'>=</span>
<a name="line-237"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>newClient</span> <span class='hs-varid'>r</span> <span class='hs-varid'>w</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-238"></a>        <span class='hs-varid'>rf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newIORef</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-239"></a>        <span class='hs-varid'>rh</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fdToHandle</span> <span class='hs-varid'>r</span>
<a name="line-240"></a>        <span class='hs-varid'>wh</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fdToHandle</span> <span class='hs-varid'>w</span>
<a name="line-241"></a>        <span class='hs-varid'>return</span> <span class='hs-conid'>Client</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rsocket</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rh</span><span class='hs-layout'>,</span> <span class='hs-varid'>wsocket</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wh</span>
<a name="line-242"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>rbuf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rf</span><span class='hs-layout'>,</span> <span class='hs-varid'>clientConfig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>conf</span> <span class='hs-layout'>}</span>
<a name="line-243"></a>  <span class='hs-keyword'>in</span> <span class='hs-keyword'>do</span>
<a name="line-244"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>r1</span><span class='hs-layout'>,</span> <span class='hs-varid'>w1</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>createPipe</span>
<a name="line-245"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>r2</span><span class='hs-layout'>,</span> <span class='hs-varid'>w2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>createPipe</span>
<a name="line-246"></a>    <span class='hs-conid'>(,)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>newClient</span> <span class='hs-varid'>r1</span> <span class='hs-varid'>w2</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>newClient</span> <span class='hs-varid'>r2</span> <span class='hs-varid'>w1</span>
<a name="line-247"></a>
<a name="line-248"></a><a name="closeServer"></a><span class='hs-comment'>-- | Closes a server endpoint.</span>
<a name="line-249"></a><span class='hs-definition'>closeServer</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>MonadBase</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Server</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-250"></a><span class='hs-definition'>closeServer</span> <span class='hs-varid'>server</span> <span class='hs-keyglyph'>=</span>
<a name="line-251"></a>  <span class='hs-varid'>liftBase</span> <span class='hs-varop'>$</span> <span class='hs-varid'>closeServerSocket</span> <span class='hs-layout'>(</span><span class='hs-varid'>sSocket</span> <span class='hs-varid'>server</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>sPath</span> <span class='hs-varid'>server</span><span class='hs-layout'>)</span>
<a name="line-252"></a>
<a name="line-253"></a><a name="acceptClient"></a><span class='hs-comment'>-- | Accepts a client</span>
<a name="line-254"></a><span class='hs-definition'>acceptClient</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Server</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>Client</span>
<a name="line-255"></a><span class='hs-definition'>acceptClient</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-256"></a>  <span class='hs-varid'>handle</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>acceptSocket</span> <span class='hs-layout'>(</span><span class='hs-varid'>sSocket</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-257"></a>  <span class='hs-varid'>new_buffer</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newIORef</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>empty</span>
<a name="line-258"></a>  <span class='hs-varid'>return</span> <span class='hs-conid'>Client</span> <span class='hs-layout'>{</span> <span class='hs-varid'>rsocket</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>handle</span>
<a name="line-259"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>wsocket</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>handle</span>
<a name="line-260"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>rbuf</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>new_buffer</span>
<a name="line-261"></a>                <span class='hs-layout'>,</span> <span class='hs-varid'>clientConfig</span><span class='hs-keyglyph'>=</span><span class='hs-varid'>serverConfig</span> <span class='hs-varid'>s</span>
<a name="line-262"></a>                <span class='hs-layout'>}</span>
<a name="line-263"></a>
<a name="line-264"></a><a name="closeClient"></a><span class='hs-comment'>-- | Closes the client socket.</span>
<a name="line-265"></a><span class='hs-comment'>-- Performing the operation on a client that has already been closed has no</span>
<a name="line-266"></a><span class='hs-comment'>-- effect; doing so is not an error.</span>
<a name="line-267"></a><span class='hs-comment'>-- All other operations on a closed client will fail with an exception.</span>
<a name="line-268"></a><span class='hs-definition'>closeClient</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Client</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-269"></a><span class='hs-definition'>closeClient</span> <span class='hs-varid'>client</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-270"></a>  <span class='hs-varid'>closeClientSocket</span> <span class='hs-varop'>.</span> <span class='hs-varid'>wsocket</span> <span class='hs-varop'>$</span> <span class='hs-varid'>client</span>
<a name="line-271"></a>  <span class='hs-varid'>closeClientSocket</span> <span class='hs-varop'>.</span> <span class='hs-varid'>rsocket</span> <span class='hs-varop'>$</span> <span class='hs-varid'>client</span>
<a name="line-272"></a>
<a name="line-273"></a><a name="clientToFd"></a><span class='hs-comment'>-- | Extracts the read (the first) and the write (the second) file descriptor</span>
<a name="line-274"></a><span class='hs-comment'>-- of a client. This closes the underlying 'Handle's, therefore the original</span>
<a name="line-275"></a><span class='hs-comment'>-- client is closed and unusable after the call.</span>
<a name="line-276"></a><span class='hs-comment'>--</span>
<a name="line-277"></a><span class='hs-comment'>-- The purpose of this function is to keep the communication channel open,</span>
<a name="line-278"></a><span class='hs-comment'>-- while replacing a 'Client' with some other means.</span>
<a name="line-279"></a><span class='hs-definition'>clientToFd</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Client</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>Fd</span><span class='hs-layout'>,</span> <span class='hs-conid'>Fd</span><span class='hs-layout'>)</span>
<a name="line-280"></a><span class='hs-definition'>clientToFd</span> <span class='hs-varid'>client</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>rh</span> <span class='hs-varop'>==</span> <span class='hs-varid'>wh</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>join</span> <span class='hs-conid'>(,)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>handleToFd</span> <span class='hs-varid'>rh</span>
<a name="line-281"></a>                  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>(,)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>handleToFd</span> <span class='hs-varid'>rh</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>handleToFd</span> <span class='hs-varid'>wh</span>
<a name="line-282"></a>  <span class='hs-keyword'>where</span>
<a name="line-283"></a>    <span class='hs-varid'>rh</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>rsocket</span> <span class='hs-varid'>client</span>
<a name="line-284"></a>    <span class='hs-varid'>wh</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wsocket</span> <span class='hs-varid'>client</span>
<a name="line-285"></a>
<a name="line-286"></a><a name="sendMsg"></a><span class='hs-comment'>-- | Sends a message over a transport.</span>
<a name="line-287"></a><span class='hs-definition'>sendMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Client</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>()</span>
<a name="line-288"></a><span class='hs-definition'>sendMsg</span> <span class='hs-varid'>s</span> <span class='hs-varid'>buf</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>withTimeout</span> <span class='hs-layout'>(</span><span class='hs-varid'>sendTmo</span> <span class='hs-varop'>$</span> <span class='hs-varid'>clientConfig</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-str'>"sending a message"</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-289"></a>  <span class='hs-varid'>t1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCurrentTimeUSec</span>
<a name="line-290"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>encoded</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>UTF8</span><span class='hs-varop'>.</span><span class='hs-varid'>fromString</span> <span class='hs-varid'>buf</span>
<a name="line-291"></a>      <span class='hs-varid'>handle</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wsocket</span> <span class='hs-varid'>s</span>
<a name="line-292"></a>  <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>hPut</span> <span class='hs-varid'>handle</span> <span class='hs-varid'>encoded</span>
<a name="line-293"></a>  <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>hPut</span> <span class='hs-varid'>handle</span> <span class='hs-varid'>bEOM</span>
<a name="line-294"></a>  <span class='hs-varid'>hFlush</span> <span class='hs-varid'>handle</span>
<a name="line-295"></a>  <span class='hs-varid'>t2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getCurrentTimeUSec</span>
<a name="line-296"></a>  <span class='hs-varid'>logDebug</span> <span class='hs-varop'>$</span> <span class='hs-str'>"sendMsg: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>t2</span> <span class='hs-comment'>-</span> <span class='hs-varid'>t1</span><span class='hs-layout'>)</span> <span class='hs-varop'>`div`</span> <span class='hs-num'>1000</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-str'>"ms"</span>
<a name="line-297"></a>
<a name="line-298"></a><a name="recvUpdate"></a><span class='hs-comment'>-- | Given a current buffer and the handle, it will read from the</span>
<a name="line-299"></a><span class='hs-comment'>-- network until we get a full message, and it will return that</span>
<a name="line-300"></a><span class='hs-comment'>-- message and the leftover buffer contents.</span>
<a name="line-301"></a><span class='hs-definition'>recvUpdate</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ConnectConfig</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Handle</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span>
<a name="line-302"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-layout'>(</span><span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span><span class='hs-layout'>,</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-conid'>ByteString</span><span class='hs-layout'>)</span>
<a name="line-303"></a><span class='hs-definition'>recvUpdate</span> <span class='hs-varid'>conf</span> <span class='hs-varid'>handle</span> <span class='hs-varid'>obuf</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-304"></a>  <span class='hs-varid'>nbuf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>withTimeout</span> <span class='hs-layout'>(</span><span class='hs-varid'>recvTmo</span> <span class='hs-varid'>conf</span><span class='hs-layout'>)</span> <span class='hs-str'>"reading a response"</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>do</span>
<a name="line-305"></a>            <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hWaitForInput</span> <span class='hs-varid'>handle</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-306"></a>            <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>hGetNonBlocking</span> <span class='hs-varid'>handle</span> <span class='hs-num'>4096</span>
<a name="line-307"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>msg</span><span class='hs-layout'>,</span> <span class='hs-varid'>remaining</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>break</span> <span class='hs-layout'>(</span><span class='hs-varid'>eOM</span> <span class='hs-varop'>==</span><span class='hs-layout'>)</span> <span class='hs-varid'>nbuf</span>
<a name="line-308"></a>      <span class='hs-varid'>newbuf</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>append</span> <span class='hs-varid'>obuf</span> <span class='hs-varid'>msg</span>
<a name="line-309"></a>  <span class='hs-keyword'>if</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>null</span> <span class='hs-varid'>remaining</span>
<a name="line-310"></a>    <span class='hs-keyword'>then</span> <span class='hs-varid'>recvUpdate</span> <span class='hs-varid'>conf</span> <span class='hs-varid'>handle</span> <span class='hs-varid'>newbuf</span>
<a name="line-311"></a>    <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>newbuf</span><span class='hs-layout'>,</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>copy</span> <span class='hs-layout'>(</span><span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>tail</span> <span class='hs-varid'>remaining</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-312"></a>
<a name="line-313"></a><a name="recvMsg"></a><span class='hs-comment'>-- | Waits for a message over a transport.</span>
<a name="line-314"></a><span class='hs-definition'>recvMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Client</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>String</span>
<a name="line-315"></a><span class='hs-definition'>recvMsg</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-316"></a>  <span class='hs-varid'>cbuf</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>readIORef</span> <span class='hs-varop'>$</span> <span class='hs-varid'>rbuf</span> <span class='hs-varid'>s</span>
<a name="line-317"></a>  <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>imsg</span><span class='hs-layout'>,</span> <span class='hs-varid'>ibuf</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>break</span> <span class='hs-layout'>(</span><span class='hs-varid'>eOM</span> <span class='hs-varop'>==</span><span class='hs-layout'>)</span> <span class='hs-varid'>cbuf</span>
<a name="line-318"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>msg</span><span class='hs-layout'>,</span> <span class='hs-varid'>nbuf</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span>
<a name="line-319"></a>    <span class='hs-keyword'>if</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>null</span> <span class='hs-varid'>ibuf</span>      <span class='hs-comment'>-- if old buffer didn't contain a full message</span>
<a name="line-320"></a>                        <span class='hs-comment'>-- then we read from network:</span>
<a name="line-321"></a>      <span class='hs-keyword'>then</span> <span class='hs-varid'>recvUpdate</span> <span class='hs-layout'>(</span><span class='hs-varid'>clientConfig</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>rsocket</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-varid'>cbuf</span>
<a name="line-322"></a>      <span class='hs-comment'>-- else we return data from our buffer, copying it so that the whole</span>
<a name="line-323"></a>      <span class='hs-comment'>-- message isn't retained and can be garbage collected</span>
<a name="line-324"></a>      <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>imsg</span><span class='hs-layout'>,</span> <span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>copy</span> <span class='hs-layout'>(</span><span class='hs-conid'>B</span><span class='hs-varop'>.</span><span class='hs-varid'>tail</span> <span class='hs-varid'>ibuf</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-325"></a>  <span class='hs-varid'>writeIORef</span> <span class='hs-layout'>(</span><span class='hs-varid'>rbuf</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-varid'>nbuf</span>
<a name="line-326"></a>  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>UTF8</span><span class='hs-varop'>.</span><span class='hs-varid'>toString</span> <span class='hs-varid'>msg</span>
<a name="line-327"></a>
<a name="line-328"></a><a name="recvMsgExt"></a><span class='hs-comment'>-- | Extended wrapper over recvMsg.</span>
<a name="line-329"></a><span class='hs-definition'>recvMsgExt</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Client</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-conid'>RecvResult</span>
<a name="line-330"></a><span class='hs-definition'>recvMsgExt</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span>
<a name="line-331"></a>  <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Exception</span><span class='hs-varop'>.</span><span class='hs-varid'>catch</span> <span class='hs-layout'>(</span><span class='hs-varid'>liftM</span> <span class='hs-conid'>RecvOk</span> <span class='hs-layout'>(</span><span class='hs-varid'>recvMsg</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span> <span class='hs-keyglyph'>\</span><span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-332"></a>    <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isEOFError</span> <span class='hs-varid'>e</span>
<a name="line-333"></a>               <span class='hs-keyword'>then</span> <span class='hs-conid'>RecvConnClosed</span>
<a name="line-334"></a>               <span class='hs-keyword'>else</span> <span class='hs-conid'>RecvError</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-335"></a>
<a name="line-336"></a>
<a name="line-337"></a><a name="buildCall"></a><span class='hs-comment'>-- | Serialize a request to String.</span>
<a name="line-338"></a><span class='hs-definition'>buildCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-conid'>JSON</span> <span class='hs-varid'>mth</span><span class='hs-layout'>,</span> <span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-conid'>JSON</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-339"></a>          <span class='hs-keyglyph'>=&gt;</span> <span class='hs-varid'>mth</span>    <span class='hs-comment'>-- ^ The method</span>
<a name="line-340"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>args</span>   <span class='hs-comment'>-- ^ The arguments</span>
<a name="line-341"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span> <span class='hs-comment'>-- ^ The serialized form</span>
<a name="line-342"></a><span class='hs-definition'>buildCall</span> <span class='hs-varid'>mth</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span>
<a name="line-343"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>keyToObj</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-conid'>JSON</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>MsgKeys</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-conid'>JSValue</span><span class='hs-layout'>)</span>
<a name="line-344"></a>      <span class='hs-varid'>keyToObj</span> <span class='hs-varid'>k</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>strOfKey</span> <span class='hs-varid'>k</span><span class='hs-layout'>,</span> <span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-varid'>showJSON</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span>
<a name="line-345"></a>  <span class='hs-keyword'>in</span> <span class='hs-varid'>encodeStrict</span> <span class='hs-varop'>$</span> <span class='hs-varid'>toJSObject</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>keyToObj</span> <span class='hs-conid'>Method</span> <span class='hs-varid'>mth</span><span class='hs-layout'>,</span> <span class='hs-varid'>keyToObj</span> <span class='hs-conid'>Args</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>]</span>
<a name="line-346"></a>
<a name="line-347"></a><a name="parseCall"></a><span class='hs-comment'>-- | Parse the required keys out of a call.</span>
<a name="line-348"></a><span class='hs-definition'>parseCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-conid'>JSON</span> <span class='hs-varid'>mth</span><span class='hs-layout'>,</span> <span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-conid'>JSON</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Result</span> <span class='hs-layout'>(</span><span class='hs-varid'>mth</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-349"></a><span class='hs-definition'>parseCall</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-350"></a>  <span class='hs-varid'>arr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fromJResult</span> <span class='hs-str'>"parsing top-level JSON message"</span> <span class='hs-varop'>$</span>
<a name="line-351"></a>           <span class='hs-varid'>decodeStrict</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Result</span> <span class='hs-layout'>(</span><span class='hs-conid'>JSObject</span> <span class='hs-conid'>JSValue</span><span class='hs-layout'>)</span>
<a name="line-352"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>keyFromObj</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-conid'>JSON</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>MsgKeys</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Result</span> <span class='hs-varid'>a</span>
<a name="line-353"></a>      <span class='hs-varid'>keyFromObj</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>fromObj</span> <span class='hs-layout'>(</span><span class='hs-varid'>fromJSObject</span> <span class='hs-varid'>arr</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>strOfKey</span>
<a name="line-354"></a>  <span class='hs-conid'>(,)</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>keyFromObj</span> <span class='hs-conid'>Method</span> <span class='hs-varop'>&lt;*&gt;</span> <span class='hs-varid'>keyFromObj</span> <span class='hs-conid'>Args</span>
<a name="line-355"></a>
<a name="line-356"></a>
<a name="line-357"></a><a name="buildResponse"></a><span class='hs-comment'>-- | Serialize the response to String.</span>
<a name="line-358"></a><span class='hs-definition'>buildResponse</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>    <span class='hs-comment'>-- ^ Success</span>
<a name="line-359"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>JSValue</span> <span class='hs-comment'>-- ^ The arguments</span>
<a name="line-360"></a>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>  <span class='hs-comment'>-- ^ The serialized form</span>
<a name="line-361"></a><span class='hs-definition'>buildResponse</span> <span class='hs-varid'>success</span> <span class='hs-varid'>args</span> <span class='hs-keyglyph'>=</span>
<a name="line-362"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>ja</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>strOfKey</span> <span class='hs-conid'>Success</span><span class='hs-layout'>,</span> <span class='hs-conid'>JSBool</span> <span class='hs-varid'>success</span><span class='hs-layout'>)</span>
<a name="line-363"></a>           <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>strOfKey</span> <span class='hs-conid'>Result</span><span class='hs-layout'>,</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-364"></a>      <span class='hs-varid'>jo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toJSObject</span> <span class='hs-varid'>ja</span>
<a name="line-365"></a>  <span class='hs-keyword'>in</span> <span class='hs-varid'>encodeStrict</span> <span class='hs-varid'>jo</span>
<a name="line-366"></a>
<a name="line-367"></a><a name="decodeError"></a><span class='hs-comment'>-- | Try to decode an error from the server response. This function</span>
<a name="line-368"></a><span class='hs-comment'>-- will always fail, since it's called only on the error path (when</span>
<a name="line-369"></a><span class='hs-comment'>-- status is False).</span>
<a name="line-370"></a><span class='hs-definition'>decodeError</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>JSValue</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ErrorResult</span> <span class='hs-conid'>JSValue</span>
<a name="line-371"></a><span class='hs-definition'>decodeError</span> <span class='hs-varid'>val</span> <span class='hs-keyglyph'>=</span>
<a name="line-372"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>fromJVal</span> <span class='hs-varid'>val</span> <span class='hs-keyword'>of</span>
<a name="line-373"></a>    <span class='hs-conid'>Ok</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bad</span> <span class='hs-varid'>e</span>
<a name="line-374"></a>    <span class='hs-conid'>Bad</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bad</span> <span class='hs-varop'>$</span> <span class='hs-conid'>GenericError</span> <span class='hs-varid'>msg</span>
<a name="line-375"></a>
<a name="line-376"></a><a name="parseResponse"></a><span class='hs-comment'>-- | Check that luxi responses contain the required keys and that the</span>
<a name="line-377"></a><span class='hs-comment'>-- call was successful.</span>
<a name="line-378"></a><span class='hs-definition'>parseResponse</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ErrorResult</span> <span class='hs-conid'>JSValue</span>
<a name="line-379"></a><span class='hs-definition'>parseResponse</span> <span class='hs-varid'>s</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-380"></a>  <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-conid'>UTF8</span><span class='hs-varop'>.</span><span class='hs-varid'>replacement_char</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-381"></a>      <span class='hs-varid'>failError</span> <span class='hs-str'>"Failed to decode UTF-8,\
<a name="line-382"></a>                \ detected replacement char after decoding"</span>
<a name="line-383"></a>  <span class='hs-varid'>oarr</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fromJResultE</span> <span class='hs-str'>"Parsing LUXI response"</span> <span class='hs-layout'>(</span><span class='hs-varid'>decodeStrict</span> <span class='hs-varid'>s</span><span class='hs-layout'>)</span>
<a name="line-384"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>arr</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-varid'>fromJSObject</span> <span class='hs-varid'>oarr</span>
<a name="line-385"></a>  <span class='hs-varid'>status</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fromObj</span> <span class='hs-varid'>arr</span> <span class='hs-layout'>(</span><span class='hs-varid'>strOfKey</span> <span class='hs-conid'>Success</span><span class='hs-layout'>)</span>
<a name="line-386"></a>  <span class='hs-varid'>result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fromObj</span> <span class='hs-varid'>arr</span> <span class='hs-layout'>(</span><span class='hs-varid'>strOfKey</span> <span class='hs-conid'>Result</span><span class='hs-layout'>)</span>
<a name="line-387"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>status</span>
<a name="line-388"></a>    <span class='hs-keyword'>then</span> <span class='hs-varid'>return</span> <span class='hs-varid'>result</span>
<a name="line-389"></a>    <span class='hs-keyword'>else</span> <span class='hs-varid'>decodeError</span> <span class='hs-varid'>result</span>
<a name="line-390"></a>
<a name="line-391"></a><a name="logMsg"></a><span class='hs-comment'>-- | Logs an outgoing message.</span>
<a name="line-392"></a><span class='hs-definition'>logMsg</span>
<a name="line-393"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Show</span> <span class='hs-varid'>e</span><span class='hs-layout'>,</span> <span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-conid'>JSON</span> <span class='hs-varid'>e</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadLog</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-394"></a>    <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Handler</span> <span class='hs-varid'>i</span> <span class='hs-varid'>m</span> <span class='hs-varid'>o</span>
<a name="line-395"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>i</span>                          <span class='hs-comment'>-- ^ the received request (used for logging)</span>
<a name="line-396"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GenericResult</span> <span class='hs-varid'>e</span> <span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-conid'>JSValue</span>  <span class='hs-comment'>-- ^ A message to be sent</span>
<a name="line-397"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-398"></a><span class='hs-definition'>logMsg</span> <span class='hs-varid'>handler</span> <span class='hs-varid'>req</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bad</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-399"></a>  <span class='hs-varid'>logWarning</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Failed to execute request "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>hInputLogLong</span> <span class='hs-varid'>handler</span> <span class='hs-varid'>req</span> <span class='hs-varop'>++</span> <span class='hs-str'>": "</span>
<a name="line-400"></a>               <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>err</span>
<a name="line-401"></a><span class='hs-definition'>logMsg</span> <span class='hs-varid'>handler</span> <span class='hs-varid'>req</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ok</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-402"></a>  <span class='hs-comment'>-- only log the first 2,000 chars of the result</span>
<a name="line-403"></a>  <span class='hs-varid'>logDebug</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Result (truncated): "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>take</span> <span class='hs-num'>2000</span> <span class='hs-layout'>(</span><span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-varid'>encode</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-404"></a>  <span class='hs-varid'>logDebug</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Successfully handled "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>hInputLogShort</span> <span class='hs-varid'>handler</span> <span class='hs-varid'>req</span>
<a name="line-405"></a>
<a name="line-406"></a><a name="prepareMsg"></a><span class='hs-comment'>-- | Prepares an outgoing message.</span>
<a name="line-407"></a><span class='hs-definition'>prepareMsg</span>
<a name="line-408"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-conid'>JSON</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-409"></a>    <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>GenericResult</span> <span class='hs-varid'>e</span> <span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-conid'>JSValue</span>  <span class='hs-comment'>-- ^ A message to be sent</span>
<a name="line-410"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-conid'>JSValue</span><span class='hs-layout'>)</span>
<a name="line-411"></a><span class='hs-definition'>prepareMsg</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bad</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span>   <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-varid'>showJSON</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span>
<a name="line-412"></a><span class='hs-definition'>prepareMsg</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ok</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>result</span><span class='hs-layout'>)</span>
<a name="line-413"></a>
<a name="line-414"></a>
<a name="line-415"></a><span class='hs-comment'>-- * Processing client requests</span>
<a name="line-416"></a>
<a name="line-417"></a><a name="HandlerResult"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>HandlerResult</span> <span class='hs-varid'>m</span> <span class='hs-varid'>o</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-conid'>GenericResult</span> <span class='hs-conid'>GanetiException</span> <span class='hs-varid'>o</span><span class='hs-layout'>)</span>
<a name="line-418"></a>
<a name="line-419"></a><a name="Handler"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>Handler</span> <span class='hs-varid'>i</span> <span class='hs-varid'>m</span> <span class='hs-varid'>o</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Handler</span>
<a name="line-420"></a>  <span class='hs-layout'>{</span> <span class='hs-varid'>hParse</span>         <span class='hs-keyglyph'>::</span> <span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-conid'>JSValue</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-conid'>JSValue</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Result</span> <span class='hs-varid'>i</span>
<a name="line-421"></a>    <span class='hs-comment'>-- ^ parses method and its arguments into the input type</span>
<a name="line-422"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>hInputLogShort</span> <span class='hs-keyglyph'>::</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-423"></a>    <span class='hs-comment'>-- ^ short description of an input, for the INFO logging level</span>
<a name="line-424"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>hInputLogLong</span>  <span class='hs-keyglyph'>::</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-425"></a>    <span class='hs-comment'>-- ^ long description of an input, for the DEBUG logging level</span>
<a name="line-426"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>hExec</span>          <span class='hs-keyglyph'>::</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HandlerResult</span> <span class='hs-varid'>m</span> <span class='hs-varid'>o</span>
<a name="line-427"></a>    <span class='hs-comment'>-- ^ executes the handler on an input</span>
<a name="line-428"></a>  <span class='hs-layout'>}</span>
<a name="line-429"></a>
<a name="line-430"></a>
<a name="line-431"></a><a name="handleJsonMessage"></a><span class='hs-definition'>handleJsonMessage</span>
<a name="line-432"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-conid'>JSON</span> <span class='hs-varid'>o</span><span class='hs-layout'>,</span> <span class='hs-conid'>Monad</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-433"></a>    <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Handler</span> <span class='hs-varid'>i</span> <span class='hs-varid'>m</span> <span class='hs-varid'>o</span>            <span class='hs-comment'>-- ^ handler</span>
<a name="line-434"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>i</span>                        <span class='hs-comment'>-- ^ parsed input</span>
<a name="line-435"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HandlerResult</span> <span class='hs-varid'>m</span> <span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-conid'>JSValue</span>
<a name="line-436"></a><span class='hs-definition'>handleJsonMessage</span> <span class='hs-varid'>handler</span> <span class='hs-varid'>req</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-437"></a>  <span class='hs-layout'>(</span><span class='hs-varid'>close</span><span class='hs-layout'>,</span> <span class='hs-varid'>call_result</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>hExec</span> <span class='hs-varid'>handler</span> <span class='hs-varid'>req</span>
<a name="line-438"></a>  <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>close</span><span class='hs-layout'>,</span> <span class='hs-varid'>fmap</span> <span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-varid'>showJSON</span> <span class='hs-varid'>call_result</span><span class='hs-layout'>)</span>
<a name="line-439"></a>
<a name="line-440"></a><a name="handleRawMessage"></a><span class='hs-comment'>-- | Takes a request as a 'String', parses it, passes it to a handler and</span>
<a name="line-441"></a><span class='hs-comment'>-- formats its response.</span>
<a name="line-442"></a><span class='hs-definition'>handleRawMessage</span>
<a name="line-443"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-conid'>JSON</span> <span class='hs-varid'>o</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadLog</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-444"></a>    <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Handler</span> <span class='hs-varid'>i</span> <span class='hs-varid'>m</span> <span class='hs-varid'>o</span>            <span class='hs-comment'>-- ^ handler</span>
<a name="line-445"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>                   <span class='hs-comment'>-- ^ raw unparsed input</span>
<a name="line-446"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>)</span>
<a name="line-447"></a><span class='hs-definition'>handleRawMessage</span> <span class='hs-varid'>handler</span> <span class='hs-varid'>payload</span> <span class='hs-keyglyph'>=</span>
<a name="line-448"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>parseCall</span> <span class='hs-varid'>payload</span> <span class='hs-varop'>&gt;&gt;=</span> <span class='hs-varid'>uncurry</span> <span class='hs-layout'>(</span><span class='hs-varid'>hParse</span> <span class='hs-varid'>handler</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-449"></a>    <span class='hs-conid'>Bad</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-450"></a>         <span class='hs-keyword'>let</span> <span class='hs-varid'>errmsg</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"Failed to parse request: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>err</span>
<a name="line-451"></a>         <span class='hs-varid'>logWarning</span> <span class='hs-varid'>errmsg</span>
<a name="line-452"></a>         <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>buildResponse</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-varid'>showJSON</span> <span class='hs-varid'>errmsg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-453"></a>    <span class='hs-conid'>Ok</span> <span class='hs-varid'>req</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-454"></a>        <span class='hs-varid'>logDebug</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Request: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>hInputLogLong</span> <span class='hs-varid'>handler</span> <span class='hs-varid'>req</span>
<a name="line-455"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>close</span><span class='hs-layout'>,</span> <span class='hs-varid'>call_result_json</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>handleJsonMessage</span> <span class='hs-varid'>handler</span> <span class='hs-varid'>req</span>
<a name="line-456"></a>        <span class='hs-varid'>logMsg</span> <span class='hs-varid'>handler</span> <span class='hs-varid'>req</span> <span class='hs-varid'>call_result_json</span>
<a name="line-457"></a>        <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>status</span><span class='hs-layout'>,</span> <span class='hs-varid'>response</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>prepareMsg</span> <span class='hs-varid'>call_result_json</span>
<a name="line-458"></a>        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>close</span><span class='hs-layout'>,</span> <span class='hs-varid'>buildResponse</span> <span class='hs-varid'>status</span> <span class='hs-varid'>response</span><span class='hs-layout'>)</span>
<a name="line-459"></a>
<a name="line-460"></a><a name="isRisky"></a><span class='hs-definition'>isRisky</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>RecvResult</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-461"></a><span class='hs-definition'>isRisky</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>msg</span> <span class='hs-keyword'>of</span>
<a name="line-462"></a>  <span class='hs-conid'>RecvOk</span> <span class='hs-varid'>payload</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>any</span> <span class='hs-layout'>(</span><span class='hs-varop'>`isInfixOf`</span> <span class='hs-varid'>payload</span><span class='hs-layout'>)</span> <span class='hs-varid'>privateParametersBlacklist</span>
<a name="line-463"></a>  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-464"></a>
<a name="line-465"></a><a name="handleClient"></a><span class='hs-comment'>-- | Reads a request, passes it to a handler and sends a response back to the</span>
<a name="line-466"></a><span class='hs-comment'>-- client.</span>
<a name="line-467"></a><span class='hs-definition'>handleClient</span>
<a name="line-468"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-conid'>JSON</span> <span class='hs-varid'>o</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadBase</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadLog</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-469"></a>    <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Handler</span> <span class='hs-varid'>i</span> <span class='hs-varid'>m</span> <span class='hs-varid'>o</span>
<a name="line-470"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Client</span>
<a name="line-471"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>Bool</span>
<a name="line-472"></a><span class='hs-definition'>handleClient</span> <span class='hs-varid'>handler</span> <span class='hs-varid'>client</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-473"></a>  <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftBase</span> <span class='hs-varop'>$</span> <span class='hs-varid'>recvMsgExt</span> <span class='hs-varid'>client</span>
<a name="line-474"></a>
<a name="line-475"></a>  <span class='hs-varid'>debugMode</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftBase</span> <span class='hs-varid'>isDebugMode</span>
<a name="line-476"></a>  <span class='hs-varid'>when</span> <span class='hs-layout'>(</span><span class='hs-varid'>debugMode</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isRisky</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-477"></a>    <span class='hs-varid'>logAlert</span> <span class='hs-str'>"POSSIBLE LEAKING OF CONFIDENTIAL PARAMETERS. \
<a name="line-478"></a>             \Daemon is running in debug mode. \
<a name="line-479"></a>             \The text of the request has been logged."</span>
<a name="line-480"></a>  <span class='hs-varid'>logDebug</span> <span class='hs-varop'>$</span> <span class='hs-str'>"Received message (truncated): "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>take</span> <span class='hs-num'>500</span> <span class='hs-layout'>(</span><span class='hs-varid'>show</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span>
<a name="line-481"></a>
<a name="line-482"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>msg</span> <span class='hs-keyword'>of</span>
<a name="line-483"></a>    <span class='hs-conid'>RecvConnClosed</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>logDebug</span> <span class='hs-str'>"Connection closed"</span> <span class='hs-varop'>&gt;&gt;</span>
<a name="line-484"></a>                      <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-485"></a>    <span class='hs-conid'>RecvError</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>logWarning</span> <span class='hs-layout'>(</span><span class='hs-str'>"Error during message receiving: "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;</span>
<a name="line-486"></a>                     <span class='hs-varid'>return</span> <span class='hs-conid'>False</span>
<a name="line-487"></a>    <span class='hs-conid'>RecvOk</span> <span class='hs-varid'>payload</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span>
<a name="line-488"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>close</span><span class='hs-layout'>,</span> <span class='hs-varid'>outMsg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>handleRawMessage</span> <span class='hs-varid'>handler</span> <span class='hs-varid'>payload</span>
<a name="line-489"></a>      <span class='hs-varid'>liftBase</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sendMsg</span> <span class='hs-varid'>client</span> <span class='hs-varid'>outMsg</span>
<a name="line-490"></a>      <span class='hs-varid'>return</span> <span class='hs-varid'>close</span>
<a name="line-491"></a>
<a name="line-492"></a>
<a name="line-493"></a><a name="clientLoop"></a><span class='hs-comment'>-- | Main client loop: runs one loop of 'handleClient', and if that</span>
<a name="line-494"></a><span class='hs-comment'>-- doesn't report a finished (closed) connection, restarts itself.</span>
<a name="line-495"></a><span class='hs-definition'>clientLoop</span>
<a name="line-496"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-conid'>JSON</span> <span class='hs-varid'>o</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadBase</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadLog</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-497"></a>    <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Handler</span> <span class='hs-varid'>i</span> <span class='hs-varid'>m</span> <span class='hs-varid'>o</span>
<a name="line-498"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Client</span>
<a name="line-499"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-500"></a><span class='hs-definition'>clientLoop</span> <span class='hs-varid'>handler</span> <span class='hs-varid'>client</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-501"></a>  <span class='hs-varid'>result</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>handleClient</span> <span class='hs-varid'>handler</span> <span class='hs-varid'>client</span>
<a name="line-502"></a>  <span class='hs-comment'>{- It's been observed sometimes that reading immediately after sending
<a name="line-503"></a>     a response leads to worse performance, as there is nothing to read and
<a name="line-504"></a>     the system calls are just wasted. Thus yielding before reading gives
<a name="line-505"></a>     other threads a chance to proceed and provides a natural pause, leading
<a name="line-506"></a>     to a bit more efficient communication.
<a name="line-507"></a>  -}</span>
<a name="line-508"></a>  <span class='hs-keyword'>if</span> <span class='hs-varid'>result</span>
<a name="line-509"></a>    <span class='hs-keyword'>then</span> <span class='hs-varid'>yield</span> <span class='hs-varop'>&gt;&gt;</span> <span class='hs-varid'>clientLoop</span> <span class='hs-varid'>handler</span> <span class='hs-varid'>client</span>
<a name="line-510"></a>    <span class='hs-keyword'>else</span> <span class='hs-varid'>liftBase</span> <span class='hs-varop'>$</span> <span class='hs-varid'>closeClient</span> <span class='hs-varid'>client</span>
<a name="line-511"></a>
<a name="line-512"></a><a name="listener"></a><span class='hs-comment'>-- | Main listener loop: accepts clients, forks an I/O thread to handle</span>
<a name="line-513"></a><span class='hs-comment'>-- that client.</span>
<a name="line-514"></a><span class='hs-definition'>listener</span>
<a name="line-515"></a>    <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-conid'>JSON</span> <span class='hs-varid'>o</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadBaseControl</span> <span class='hs-conid'>IO</span> <span class='hs-varid'>m</span><span class='hs-layout'>,</span> <span class='hs-conid'>MonadLog</span> <span class='hs-varid'>m</span><span class='hs-layout'>)</span>
<a name="line-516"></a>    <span class='hs-keyglyph'>=&gt;</span> <span class='hs-conid'>Handler</span> <span class='hs-varid'>i</span> <span class='hs-varid'>m</span> <span class='hs-varid'>o</span>
<a name="line-517"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Server</span>
<a name="line-518"></a>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>m</span> <span class='hs-conid'>()</span>
<a name="line-519"></a><span class='hs-definition'>listener</span> <span class='hs-varid'>handler</span> <span class='hs-varid'>server</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-520"></a>  <span class='hs-varid'>client</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>liftBase</span> <span class='hs-varop'>$</span> <span class='hs-varid'>acceptClient</span> <span class='hs-varid'>server</span>
<a name="line-521"></a>  <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>fork</span> <span class='hs-varop'>$</span> <span class='hs-varid'>clientLoop</span> <span class='hs-varid'>handler</span> <span class='hs-varid'>client</span>
<a name="line-522"></a>  <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
</pre></body>
</html>
