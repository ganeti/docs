<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Ganeti.JQScheduler.Filtering</title><link href="ocean.css" rel="stylesheet" type="text/css" title="Ocean" /><script src="haddock-util.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
window.onload = function () {pageLoad();setSynopsis("mini_Ganeti-JQScheduler-Filtering.html");};
//]]>
</script></head><body><div id="package-header"><ul class="links" id="page-menu"><li><a href="Ganeti/JQScheduler/Filtering.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul><p class="caption">ganeti</p></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>Safe-Infered</td></tr></table><p class="caption">Ganeti.JQScheduler.Filtering</p></div><div id="description"><p class="caption">Description</p><div class="doc"><p>Filtering of jobs for the Ganeti job queue.
</p></div></div><div id="synopsis"><p id="control.syn" class="caption expander" onclick="toggleSection('syn')">Synopsis</p><ul id="section.syn" class="hide" onclick="toggleSection('syn')"><li class="src short"><a href="#v:accessOpCodeField">accessOpCodeField</a> :: <a href="Ganeti-OpCodes.html#t:OpCode">OpCode</a> -&gt; String -&gt; <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> JSValue</li><li class="src short"><a href="#v:opCodesOf">opCodesOf</a> :: <a href="Ganeti-JQueue-Objects.html#t:QueuedJob">QueuedJob</a> -&gt; [<a href="Ganeti-OpCodes.html#t:OpCode">OpCode</a>]</li><li class="src short"><a href="#v:reasonsOf">reasonsOf</a> :: <a href="Ganeti-JQueue-Objects.html#t:QueuedJob">QueuedJob</a> -&gt; [<a href="Ganeti-Types.html#t:ReasonElem">ReasonElem</a>]</li><li class="src short"><a href="#v:evaluateFilterComparator">evaluateFilterComparator</a> :: Ord field =&gt; <a href="Ganeti-Query-Language.html#t:Filter">Filter</a> field -&gt; (<a href="Ganeti-Query-Filter.html#t:Comparator">Comparator</a> -&gt; field -&gt; <a href="Ganeti-Query-Language.html#t:FilterValue">FilterValue</a> -&gt; Maybe Bool) -&gt; Bool</li><li class="src short"><a href="#v:matchPredicate">matchPredicate</a> :: <a href="Ganeti-JQueue-Objects.html#t:QueuedJob">QueuedJob</a> -&gt; <a href="Ganeti-Types.html#t:JobId">JobId</a> -&gt; <a href="Ganeti-Objects.html#t:FilterPredicate">FilterPredicate</a> -&gt; Bool</li><li class="src short"><a href="#v:matches">matches</a> :: <a href="Ganeti-JQueue-Objects.html#t:QueuedJob">QueuedJob</a> -&gt; <a href="Ganeti-Objects.html#t:FilterRule">FilterRule</a> -&gt; Bool</li><li class="src short"><a href="#v:orderFilters">orderFilters</a> :: Set <a href="Ganeti-Objects.html#t:FilterRule">FilterRule</a> -&gt; [<a href="Ganeti-Objects.html#t:FilterRule">FilterRule</a>]</li><li class="src short"><a href="#v:applyingFilter">applyingFilter</a> :: Set <a href="Ganeti-Objects.html#t:FilterRule">FilterRule</a> -&gt; <a href="Ganeti-JQueue-Objects.html#t:QueuedJob">QueuedJob</a> -&gt; Maybe <a href="Ganeti-Objects.html#t:FilterRule">FilterRule</a></li><li class="src short"><span class="keyword">type</span> <a href="#t:RateLimitSlotMap">RateLimitSlotMap</a> = <a href="Ganeti-SlotMap.html#t:SlotMap">SlotMap</a> ByteString</li><li class="src short"><span class="keyword">data</span>  <a href="#t:FilterChainState">FilterChainState</a>  = <a href="#v:FilterChainState">FilterChainState</a> {<ul class="subs"><li><a href="#v:rateLimitSlotMap">rateLimitSlotMap</a> :: <a href="Ganeti-JQScheduler-Filtering.html#t:RateLimitSlotMap">RateLimitSlotMap</a></li></ul>}</li><li class="src short"><a href="#v:tryFitSlots">tryFitSlots</a> :: <a href="Ganeti-JQScheduler-Filtering.html#t:FilterChainState">FilterChainState</a> -&gt; <a href="Ganeti-SlotMap.html#t:CountMap">CountMap</a> ByteString -&gt; Maybe <a href="Ganeti-JQScheduler-Filtering.html#t:FilterChainState">FilterChainState</a></li><li class="src short"><a href="#v:queueRateLimitSlotMap">queueRateLimitSlotMap</a> :: <a href="Ganeti-JQScheduler-Types.html#t:Queue">Queue</a> -&gt; Set <a href="Ganeti-Objects.html#t:FilterRule">FilterRule</a> -&gt; <a href="Ganeti-JQScheduler-Filtering.html#t:RateLimitSlotMap">RateLimitSlotMap</a></li><li class="src short"><a href="#v:jobFiltering">jobFiltering</a> :: <a href="Ganeti-JQScheduler-Types.html#t:Queue">Queue</a> -&gt; Set <a href="Ganeti-Objects.html#t:FilterRule">FilterRule</a> -&gt; [<a href="Ganeti-JQScheduler-Types.html#t:JobWithStat">JobWithStat</a>] -&gt; [<a href="Ganeti-JQScheduler-Types.html#t:JobWithStat">JobWithStat</a>]</li></ul></div><div id="interface"><h1>Documentation</h1><div class="top"><p class="src"><a name="v:accessOpCodeField" class="def">accessOpCodeField</a> :: <a href="Ganeti-OpCodes.html#t:OpCode">OpCode</a> -&gt; String -&gt; <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> JSValue<a href="Ganeti/JQScheduler/Filtering.html#accessOpCodeField" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:opCodesOf" class="def">opCodesOf</a> :: <a href="Ganeti-JQueue-Objects.html#t:QueuedJob">QueuedJob</a> -&gt; [<a href="Ganeti-OpCodes.html#t:OpCode">OpCode</a>]<a href="Ganeti/JQScheduler/Filtering.html#opCodesOf" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:reasonsOf" class="def">reasonsOf</a> :: <a href="Ganeti-JQueue-Objects.html#t:QueuedJob">QueuedJob</a> -&gt; [<a href="Ganeti-Types.html#t:ReasonElem">ReasonElem</a>]<a href="Ganeti/JQScheduler/Filtering.html#reasonsOf" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:evaluateFilterComparator" class="def">evaluateFilterComparator</a> :: Ord field =&gt; <a href="Ganeti-Query-Language.html#t:Filter">Filter</a> field -&gt; (<a href="Ganeti-Query-Filter.html#t:Comparator">Comparator</a> -&gt; field -&gt; <a href="Ganeti-Query-Language.html#t:FilterValue">FilterValue</a> -&gt; Maybe Bool) -&gt; Bool<a href="Ganeti/JQScheduler/Filtering.html#evaluateFilterComparator" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:matchPredicate" class="def">matchPredicate</a><a href="Ganeti/JQScheduler/Filtering.html#matchPredicate" class="link">Source</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: <a href="Ganeti-JQueue-Objects.html#t:QueuedJob">QueuedJob</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">-&gt; <a href="Ganeti-Types.html#t:JobId">JobId</a></td><td class="doc"><p>the watermark to compare against
   if the predicate references it
</p></td></tr><tr><td class="src">-&gt; <a href="Ganeti-Objects.html#t:FilterPredicate">FilterPredicate</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">-&gt; Bool</td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Whether a <code><a href="Ganeti-Objects.html#t:FilterPredicate">FilterPredicate</a></code> is true for a job.
</p></div></div><div class="top"><p class="src"><a name="v:matches" class="def">matches</a> :: <a href="Ganeti-JQueue-Objects.html#t:QueuedJob">QueuedJob</a> -&gt; <a href="Ganeti-Objects.html#t:FilterRule">FilterRule</a> -&gt; Bool<a href="Ganeti/JQScheduler/Filtering.html#matches" class="link">Source</a></p><div class="doc"><p>Whether all predicates of the filter rule are true for the job.
</p></div></div><div class="top"><p class="src"><a name="v:orderFilters" class="def">orderFilters</a> :: Set <a href="Ganeti-Objects.html#t:FilterRule">FilterRule</a> -&gt; [<a href="Ganeti-Objects.html#t:FilterRule">FilterRule</a>]<a href="Ganeti/JQScheduler/Filtering.html#orderFilters" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:applyingFilter" class="def">applyingFilter</a> :: Set <a href="Ganeti-Objects.html#t:FilterRule">FilterRule</a> -&gt; <a href="Ganeti-JQueue-Objects.html#t:QueuedJob">QueuedJob</a> -&gt; Maybe <a href="Ganeti-Objects.html#t:FilterRule">FilterRule</a><a href="Ganeti/JQScheduler/Filtering.html#applyingFilter" class="link">Source</a></p><div class="doc"><p>Finds the first filter whose predicates all match the job and whose
 action is not <code><a href="Ganeti-Objects.html#v:Continue">Continue</a></code>. This is the <em>applying</em> filter.
</p></div></div><div class="top"><p class="src"><span class="keyword">type</span> <a name="t:RateLimitSlotMap" class="def">RateLimitSlotMap</a> = <a href="Ganeti-SlotMap.html#t:SlotMap">SlotMap</a> ByteString<a href="Ganeti/JQScheduler/Filtering.html#RateLimitSlotMap" class="link">Source</a></p></div><div class="top"><p class="src"><span class="keyword">data</span>  <a name="t:FilterChainState" class="def">FilterChainState</a>  <a href="Ganeti/JQScheduler/Filtering.html#FilterChainState" class="link">Source</a></p><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a name="v:FilterChainState" class="def">FilterChainState</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><dl><dt class="src"><a name="v:rateLimitSlotMap" class="def">rateLimitSlotMap</a> :: <a href="Ganeti-JQScheduler-Filtering.html#t:RateLimitSlotMap">RateLimitSlotMap</a></dt><dd class="doc empty">&nbsp;</dd></dl><div class="clear"></div></div></td></tr></table></div><div class="subs instances"><p id="control.i:FilterChainState" class="caption collapser" onclick="toggleSection('i:FilterChainState')">Instances</p><div id="section.i:FilterChainState" class="show"><table><tr><td class="src">Eq <a href="Ganeti-JQScheduler-Filtering.html#t:FilterChainState">FilterChainState</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">Ord <a href="Ganeti-JQScheduler-Filtering.html#t:FilterChainState">FilterChainState</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">Show <a href="Ganeti-JQScheduler-Filtering.html#t:FilterChainState">FilterChainState</a></td><td class="doc empty">&nbsp;</td></tr></table></div></div></div><div class="top"><p class="src"><a name="v:tryFitSlots" class="def">tryFitSlots</a> :: <a href="Ganeti-JQScheduler-Filtering.html#t:FilterChainState">FilterChainState</a> -&gt; <a href="Ganeti-SlotMap.html#t:CountMap">CountMap</a> ByteString -&gt; Maybe <a href="Ganeti-JQScheduler-Filtering.html#t:FilterChainState">FilterChainState</a><a href="Ganeti/JQScheduler/Filtering.html#tryFitSlots" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:queueRateLimitSlotMap" class="def">queueRateLimitSlotMap</a> :: <a href="Ganeti-JQScheduler-Types.html#t:Queue">Queue</a> -&gt; Set <a href="Ganeti-Objects.html#t:FilterRule">FilterRule</a> -&gt; <a href="Ganeti-JQScheduler-Filtering.html#t:RateLimitSlotMap">RateLimitSlotMap</a><a href="Ganeti/JQScheduler/Filtering.html#queueRateLimitSlotMap" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:jobFiltering" class="def">jobFiltering</a> :: <a href="Ganeti-JQScheduler-Types.html#t:Queue">Queue</a> -&gt; Set <a href="Ganeti-Objects.html#t:FilterRule">FilterRule</a> -&gt; [<a href="Ganeti-JQScheduler-Types.html#t:JobWithStat">JobWithStat</a>] -&gt; [<a href="Ganeti-JQScheduler-Types.html#t:JobWithStat">JobWithStat</a>]<a href="Ganeti/JQScheduler/Filtering.html#jobFiltering" class="link">Source</a></p><div class="doc"><p>Implements job filtering as specified in `doc/design-optables.rst`.
</p><p>Importantly, the filter that *applies* is the first one of which all
 predicates match; this is implemented in <code><a href="Ganeti-JQScheduler-Filtering.html#v:applyingFilter">applyingFilter</a></code>.
</p><p>The initial <code><a href="Ganeti-JQScheduler-Filtering.html#t:FilterChainState">FilterChainState</a></code> is currently not cached across
 <code>selectJobsToRun</code> invocations because the number of running jobs is
 typically small (&lt; 100).
</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.10.0</p></div></body></html>