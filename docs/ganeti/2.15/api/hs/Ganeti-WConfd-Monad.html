<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Ganeti.WConfd.Monad</title><link href="ocean.css" rel="stylesheet" type="text/css" title="Ocean" /><script src="haddock-util.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
window.onload = function () {pageLoad();setSynopsis("mini_Ganeti-WConfd-Monad.html");};
//]]>
</script></head><body><div id="package-header"><ul class="links" id="page-menu"><li><a href="Ganeti/WConfd/Monad.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul><p class="caption">ganeti</p></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr></table><p class="caption">Ganeti.WConfd.Monad</p></div><div id="table-of-contents"><p class="caption">Contents</p><ul><li><a href="#g:1">Pure data types used in the monad
</a></li><li><a href="#g:2">The monad and its instances
</a></li><li><a href="#g:3">Basic functions in the monad
</a></li></ul></div><div id="description"><p class="caption">Description</p><div class="doc"><p>All RPC calls are run within this monad.
</p><p>It encapsulates:
</p><ul><li> IO operations,
* failures,
* working with the daemon state.
</li></ul><p>Code that is specific either to the configuration or the lock management, should
go into their corresponding dedicated modules.
</p></div></div><div id="synopsis"><p id="control.syn" class="caption expander" onclick="toggleSection('syn')">Synopsis</p><ul id="section.syn" class="hide" onclick="toggleSection('syn')"><li class="src short"><span class="keyword">data</span>  <a href="#t:DaemonState">DaemonState</a>  = <a href="#v:DaemonState">DaemonState</a> {<ul class="subs"><li><a href="#v:dsConfigState">dsConfigState</a> :: <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a></li><li><a href="#v:dsLockWaiting">dsLockWaiting</a> :: <a href="Ganeti-Locking-Locks.html#t:GanetiLockWaiting">GanetiLockWaiting</a></li><li><a href="#v:dsTempRes">dsTempRes</a> :: <a href="Ganeti-WConfd-TempRes.html#t:TempResState">TempResState</a></li></ul>}</li><li class="src short"><a href="#v:dsTempResL">dsTempResL</a> :: Lens' <a href="Ganeti-WConfd-Monad.html#t:DaemonState">DaemonState</a> <a href="Ganeti-WConfd-TempRes.html#t:TempResState">TempResState</a></li><li class="src short"><a href="#v:dsLockWaitingL">dsLockWaitingL</a> :: Lens' <a href="Ganeti-WConfd-Monad.html#t:DaemonState">DaemonState</a> <a href="Ganeti-Locking-Locks.html#t:GanetiLockWaiting">GanetiLockWaiting</a></li><li class="src short"><a href="#v:dsConfigStateL">dsConfigStateL</a> :: Lens' <a href="Ganeti-WConfd-Monad.html#t:DaemonState">DaemonState</a> <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a></li><li class="src short"><span class="keyword">data</span>  <a href="#t:DaemonHandle">DaemonHandle</a>  = <a href="#v:DaemonHandle">DaemonHandle</a> {<ul class="subs"><li><a href="#v:dhDaemonState">dhDaemonState</a> :: IORef <a href="Ganeti-WConfd-Monad.html#t:DaemonState">DaemonState</a></li><li><a href="#v:dhConfigPath">dhConfigPath</a> :: FilePath</li><li><a href="#v:dhSaveConfigWorker">dhSaveConfigWorker</a> :: <a href="Ganeti-Utils-AsyncWorker.html#t:AsyncWorker">AsyncWorker</a> Any ()</li><li><a href="#v:dhSaveLocksWorker">dhSaveLocksWorker</a> :: <a href="Ganeti-Utils-AsyncWorker.html#t:AsyncWorker">AsyncWorker</a> () ()</li><li><a href="#v:dhSaveTempResWorker">dhSaveTempResWorker</a> :: <a href="Ganeti-Utils-AsyncWorker.html#t:AsyncWorker">AsyncWorker</a> () ()</li><li><a href="#v:dhLivelock">dhLivelock</a> :: <a href="Ganeti-Utils-Livelock.html#t:Livelock">Livelock</a></li></ul>}</li><li class="src short"><a href="#v:mkDaemonHandle">mkDaemonHandle</a> :: FilePath -&gt; <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a> -&gt; <a href="Ganeti-Locking-Locks.html#t:GanetiLockWaiting">GanetiLockWaiting</a> -&gt; <a href="Ganeti-WConfd-TempRes.html#t:TempResState">TempResState</a> -&gt; (IO <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a> -&gt; [<a href="Ganeti-Utils-AsyncWorker.html#t:AsyncWorker">AsyncWorker</a> () ()] -&gt; <a href="Ganeti-Errors.html#t:ResultG">ResultG</a> (<a href="Ganeti-Utils-AsyncWorker.html#t:AsyncWorker">AsyncWorker</a> Any ())) -&gt; (IO <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a> -&gt; <a href="Ganeti-Errors.html#t:ResultG">ResultG</a> (<a href="Ganeti-Utils-AsyncWorker.html#t:AsyncWorker">AsyncWorker</a> () ())) -&gt; (IO <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a> -&gt; <a href="Ganeti-Errors.html#t:ResultG">ResultG</a> (<a href="Ganeti-Utils-AsyncWorker.html#t:AsyncWorker">AsyncWorker</a> () ())) -&gt; (IO <a href="Ganeti-Locking-Locks.html#t:GanetiLockWaiting">GanetiLockWaiting</a> -&gt; <a href="Ganeti-Errors.html#t:ResultG">ResultG</a> (<a href="Ganeti-Utils-AsyncWorker.html#t:AsyncWorker">AsyncWorker</a> () ())) -&gt; (IO <a href="Ganeti-WConfd-TempRes.html#t:TempResState">TempResState</a> -&gt; <a href="Ganeti-Errors.html#t:ResultG">ResultG</a> (<a href="Ganeti-Utils-AsyncWorker.html#t:AsyncWorker">AsyncWorker</a> () ())) -&gt; <a href="Ganeti-Utils-Livelock.html#t:Livelock">Livelock</a> -&gt; <a href="Ganeti-Errors.html#t:ResultG">ResultG</a> <a href="Ganeti-WConfd-Monad.html#t:DaemonHandle">DaemonHandle</a></li><li class="src short"><span class="keyword">type</span> <a href="#t:WConfdMonadIntType">WConfdMonadIntType</a> = ReaderT <a href="Ganeti-WConfd-Monad.html#t:DaemonHandle">DaemonHandle</a> IO</li><li class="src short"><span class="keyword">newtype</span>  <a href="#t:WConfdMonadInt">WConfdMonadInt</a> a = <a href="#v:WConfdMonadInt">WConfdMonadInt</a> {<ul class="subs"><li><a href="#v:getWConfdMonadInt">getWConfdMonadInt</a> :: <a href="Ganeti-WConfd-Monad.html#t:WConfdMonadIntType">WConfdMonadIntType</a> a</li></ul>}</li><li class="src short"><a href="#v:runWConfdMonadInt">runWConfdMonadInt</a> ::  <a href="Ganeti-WConfd-Monad.html#t:WConfdMonadInt">WConfdMonadInt</a> a -&gt; <a href="Ganeti-WConfd-Monad.html#t:DaemonHandle">DaemonHandle</a> -&gt; IO a</li><li class="src short"><span class="keyword">type</span> <a href="#t:WConfdMonad">WConfdMonad</a> = <a href="Ganeti-BasicTypes.html#t:ResultT">ResultT</a> <a href="Ganeti-Errors.html#t:GanetiException">GanetiException</a> <a href="Ganeti-WConfd-Monad.html#t:WConfdMonadInt">WConfdMonadInt</a></li><li class="src short"><span class="keyword">type</span> <a href="#t:AtomicModifyMonad">AtomicModifyMonad</a> a = <a href="Ganeti-BasicTypes.html#t:ResultT">ResultT</a> <a href="Ganeti-Errors.html#t:GanetiException">GanetiException</a> <a href="Ganeti-Logging-WriterLog.html#t:WriterLog">WriterLog</a> a</li><li class="src short"><a href="#v:daemonHandle">daemonHandle</a> :: <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> <a href="Ganeti-WConfd-Monad.html#t:DaemonHandle">DaemonHandle</a></li><li class="src short"><a href="#v:readConfigState">readConfigState</a> :: <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a></li><li class="src short"><a href="#v:unpackConfigResult">unpackConfigResult</a> ::  ClockTime -&gt; <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a> -&gt; (a, <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a>) -&gt; ((a, Bool, Bool), <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a>)</li><li class="src short"><a href="#v:modifyConfigStateErrWithImmediate">modifyConfigStateErrWithImmediate</a> ::  (<a href="Ganeti-WConfd-TempRes.html#t:TempResState">TempResState</a> -&gt; <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a> -&gt; <a href="Ganeti-WConfd-Monad.html#t:AtomicModifyMonad">AtomicModifyMonad</a> (a, <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a>)) -&gt; <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> () -&gt; <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> a</li><li class="src short"><a href="#v:modifyConfigStateErr">modifyConfigStateErr</a> ::  (<a href="Ganeti-WConfd-TempRes.html#t:TempResState">TempResState</a> -&gt; <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a> -&gt; <a href="Ganeti-WConfd-Monad.html#t:AtomicModifyMonad">AtomicModifyMonad</a> (a, <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a>)) -&gt; <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> a</li><li class="src short"><a href="#v:modifyConfigStateErr_">modifyConfigStateErr_</a> :: (<a href="Ganeti-WConfd-TempRes.html#t:TempResState">TempResState</a> -&gt; <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a> -&gt; <a href="Ganeti-WConfd-Monad.html#t:AtomicModifyMonad">AtomicModifyMonad</a> <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a>) -&gt; <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> ()</li><li class="src short"><a href="#v:modifyConfigState">modifyConfigState</a> ::  (<a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a> -&gt; (a, <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a>)) -&gt; <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> a</li><li class="src short"><a href="#v:modifyConfigStateWithImmediate">modifyConfigStateWithImmediate</a> ::  (<a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a> -&gt; (a, <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a>)) -&gt; <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> () -&gt; <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> a</li><li class="src short"><a href="#v:forceConfigStateDistribution">forceConfigStateDistribution</a> :: <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> ()</li><li class="src short"><a href="#v:modifyConfigDataErr_">modifyConfigDataErr_</a> :: (<a href="Ganeti-WConfd-TempRes.html#t:TempResState">TempResState</a> -&gt; <a href="Ganeti-Objects.html#t:ConfigData">ConfigData</a> -&gt; <a href="Ganeti-WConfd-Monad.html#t:AtomicModifyMonad">AtomicModifyMonad</a> <a href="Ganeti-Objects.html#t:ConfigData">ConfigData</a>) -&gt; <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> ()</li><li class="src short"><a href="#v:modifyTempResStateErr">modifyTempResStateErr</a> ::  (<a href="Ganeti-Objects.html#t:ConfigData">ConfigData</a> -&gt; StateT <a href="Ganeti-WConfd-TempRes.html#t:TempResState">TempResState</a> <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> a) -&gt; <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> a</li><li class="src short"><a href="#v:modifyTempResState">modifyTempResState</a> ::  (<a href="Ganeti-Objects.html#t:ConfigData">ConfigData</a> -&gt; State <a href="Ganeti-WConfd-TempRes.html#t:TempResState">TempResState</a> a) -&gt; <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> a</li><li class="src short"><a href="#v:readTempResState">readTempResState</a> :: <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> (<a href="Ganeti-Objects.html#t:ConfigData">ConfigData</a>, <a href="Ganeti-WConfd-TempRes.html#t:TempResState">TempResState</a>)</li><li class="src short"><a href="#v:modifyLockWaiting">modifyLockWaiting</a> ::  (<a href="Ganeti-Locking-Locks.html#t:GanetiLockWaiting">GanetiLockWaiting</a> -&gt; (<a href="Ganeti-Locking-Locks.html#t:GanetiLockWaiting">GanetiLockWaiting</a>, (a, Set <a href="Ganeti-Locking-Locks.html#t:ClientId">ClientId</a>))) -&gt; <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> a</li><li class="src short"><a href="#v:modifyLockWaiting_">modifyLockWaiting_</a> :: (<a href="Ganeti-Locking-Locks.html#t:GanetiLockWaiting">GanetiLockWaiting</a> -&gt; (<a href="Ganeti-Locking-Locks.html#t:GanetiLockWaiting">GanetiLockWaiting</a>, Set <a href="Ganeti-Locking-Locks.html#t:ClientId">ClientId</a>)) -&gt; <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> ()</li><li class="src short"><a href="#v:readLockWaiting">readLockWaiting</a> :: <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> <a href="Ganeti-Locking-Locks.html#t:GanetiLockWaiting">GanetiLockWaiting</a></li><li class="src short"><a href="#v:readLockAllocation">readLockAllocation</a> :: <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> (<a href="Ganeti-Locking-Allocation.html#t:LockAllocation">LockAllocation</a> <a href="Ganeti-Locking-Locks.html#t:GanetiLocks">GanetiLocks</a> <a href="Ganeti-Locking-Locks.html#t:ClientId">ClientId</a>)</li><li class="src short"><a href="#v:modifyConfigWithLock">modifyConfigWithLock</a> :: (<a href="Ganeti-WConfd-TempRes.html#t:TempResState">TempResState</a> -&gt; <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a> -&gt; <a href="Ganeti-WConfd-Monad.html#t:AtomicModifyMonad">AtomicModifyMonad</a> <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a>) -&gt; State <a href="Ganeti-WConfd-TempRes.html#t:TempResState">TempResState</a> () -&gt; <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> (Maybe ())</li></ul></div><div id="interface"><h1 id="g:1">Pure data types used in the monad
</h1><div class="top"><p class="src"><span class="keyword">data</span>  <a name="t:DaemonState" class="def">DaemonState</a>  <a href="Ganeti/WConfd/Monad.html#DaemonState" class="link">Source</a></p><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a name="v:DaemonState" class="def">DaemonState</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><dl><dt class="src"><a name="v:dsConfigState" class="def">dsConfigState</a> :: <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a></dt><dd class="doc empty">&nbsp;</dd><dt class="src"><a name="v:dsLockWaiting" class="def">dsLockWaiting</a> :: <a href="Ganeti-Locking-Locks.html#t:GanetiLockWaiting">GanetiLockWaiting</a></dt><dd class="doc empty">&nbsp;</dd><dt class="src"><a name="v:dsTempRes" class="def">dsTempRes</a> :: <a href="Ganeti-WConfd-TempRes.html#t:TempResState">TempResState</a></dt><dd class="doc empty">&nbsp;</dd></dl><div class="clear"></div></div></td></tr></table></div></div><div class="top"><p class="src"><a name="v:dsTempResL" class="def">dsTempResL</a> :: Lens' <a href="Ganeti-WConfd-Monad.html#t:DaemonState">DaemonState</a> <a href="Ganeti-WConfd-TempRes.html#t:TempResState">TempResState</a><a href="Ganeti/WConfd/Monad.html#dsTempResL" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:dsLockWaitingL" class="def">dsLockWaitingL</a> :: Lens' <a href="Ganeti-WConfd-Monad.html#t:DaemonState">DaemonState</a> <a href="Ganeti-Locking-Locks.html#t:GanetiLockWaiting">GanetiLockWaiting</a><a href="Ganeti/WConfd/Monad.html#dsLockWaitingL" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:dsConfigStateL" class="def">dsConfigStateL</a> :: Lens' <a href="Ganeti-WConfd-Monad.html#t:DaemonState">DaemonState</a> <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a><a href="Ganeti/WConfd/Monad.html#dsConfigStateL" class="link">Source</a></p></div><div class="top"><p class="src"><span class="keyword">data</span>  <a name="t:DaemonHandle" class="def">DaemonHandle</a>  <a href="Ganeti/WConfd/Monad.html#DaemonHandle" class="link">Source</a></p><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a name="v:DaemonHandle" class="def">DaemonHandle</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><dl><dt class="src"><a name="v:dhDaemonState" class="def">dhDaemonState</a> :: IORef <a href="Ganeti-WConfd-Monad.html#t:DaemonState">DaemonState</a></dt><dd class="doc empty">&nbsp;</dd><dt class="src"><a name="v:dhConfigPath" class="def">dhConfigPath</a> :: FilePath</dt><dd class="doc"><p>The configuration file path
 all static information that doesn't change during the life-time of the
 daemon should go here;
 all IDs of threads that do asynchronous work should probably also go here
</p></dd><dt class="src"><a name="v:dhSaveConfigWorker" class="def">dhSaveConfigWorker</a> :: <a href="Ganeti-Utils-AsyncWorker.html#t:AsyncWorker">AsyncWorker</a> Any ()</dt><dd class="doc empty">&nbsp;</dd><dt class="src"><a name="v:dhSaveLocksWorker" class="def">dhSaveLocksWorker</a> :: <a href="Ganeti-Utils-AsyncWorker.html#t:AsyncWorker">AsyncWorker</a> () ()</dt><dd class="doc empty">&nbsp;</dd><dt class="src"><a name="v:dhSaveTempResWorker" class="def">dhSaveTempResWorker</a> :: <a href="Ganeti-Utils-AsyncWorker.html#t:AsyncWorker">AsyncWorker</a> () ()</dt><dd class="doc empty">&nbsp;</dd><dt class="src"><a name="v:dhLivelock" class="def">dhLivelock</a> :: <a href="Ganeti-Utils-Livelock.html#t:Livelock">Livelock</a></dt><dd class="doc empty">&nbsp;</dd></dl><div class="clear"></div></div></td></tr></table></div></div><div class="top"><p class="src"><a name="v:mkDaemonHandle" class="def">mkDaemonHandle</a><a href="Ganeti/WConfd/Monad.html#mkDaemonHandle" class="link">Source</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: FilePath</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">-&gt; <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">-&gt; <a href="Ganeti-Locking-Locks.html#t:GanetiLockWaiting">GanetiLockWaiting</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">-&gt; <a href="Ganeti-WConfd-TempRes.html#t:TempResState">TempResState</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">-&gt; (IO <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a> -&gt; [<a href="Ganeti-Utils-AsyncWorker.html#t:AsyncWorker">AsyncWorker</a> () ()] -&gt; <a href="Ganeti-Errors.html#t:ResultG">ResultG</a> (<a href="Ganeti-Utils-AsyncWorker.html#t:AsyncWorker">AsyncWorker</a> Any ()))</td><td class="doc"><p>A function that creates a worker that asynchronously
 saves the configuration to the master file.
</p></td></tr><tr><td class="src">-&gt; (IO <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a> -&gt; <a href="Ganeti-Errors.html#t:ResultG">ResultG</a> (<a href="Ganeti-Utils-AsyncWorker.html#t:AsyncWorker">AsyncWorker</a> () ()))</td><td class="doc"><p>A function that creates a worker that asynchronously
 distributes the configuration to master candidates
</p></td></tr><tr><td class="src">-&gt; (IO <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a> -&gt; <a href="Ganeti-Errors.html#t:ResultG">ResultG</a> (<a href="Ganeti-Utils-AsyncWorker.html#t:AsyncWorker">AsyncWorker</a> () ()))</td><td class="doc"><p>A function that creates a worker that asynchronously
 distributes SSConf to nodes
</p></td></tr><tr><td class="src">-&gt; (IO <a href="Ganeti-Locking-Locks.html#t:GanetiLockWaiting">GanetiLockWaiting</a> -&gt; <a href="Ganeti-Errors.html#t:ResultG">ResultG</a> (<a href="Ganeti-Utils-AsyncWorker.html#t:AsyncWorker">AsyncWorker</a> () ()))</td><td class="doc"><p>A function that creates a worker that asynchronously
 saves the lock allocation state.
</p></td></tr><tr><td class="src">-&gt; (IO <a href="Ganeti-WConfd-TempRes.html#t:TempResState">TempResState</a> -&gt; <a href="Ganeti-Errors.html#t:ResultG">ResultG</a> (<a href="Ganeti-Utils-AsyncWorker.html#t:AsyncWorker">AsyncWorker</a> () ()))</td><td class="doc"><p>A function that creates a worker that asynchronously
 saves the temporary reservations state.
</p></td></tr><tr><td class="src">-&gt; <a href="Ganeti-Utils-Livelock.html#t:Livelock">Livelock</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">-&gt; <a href="Ganeti-Errors.html#t:ResultG">ResultG</a> <a href="Ganeti-WConfd-Monad.html#t:DaemonHandle">DaemonHandle</a></td><td class="doc empty">&nbsp;</td></tr></table></div></div><h1 id="g:2">The monad and its instances
</h1><div class="top"><p class="src"><span class="keyword">type</span> <a name="t:WConfdMonadIntType" class="def">WConfdMonadIntType</a> = ReaderT <a href="Ganeti-WConfd-Monad.html#t:DaemonHandle">DaemonHandle</a> IO<a href="Ganeti/WConfd/Monad.html#WConfdMonadIntType" class="link">Source</a></p></div><div class="top"><p class="src"><span class="keyword">newtype</span>  <a name="t:WConfdMonadInt" class="def">WConfdMonadInt</a> a <a href="Ganeti/WConfd/Monad.html#WConfdMonadInt" class="link">Source</a></p><div class="doc"><p>The internal part of the monad without error handling.
</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a name="v:WConfdMonadInt" class="def">WConfdMonadInt</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><dl><dt class="src"><a name="v:getWConfdMonadInt" class="def">getWConfdMonadInt</a> :: <a href="Ganeti-WConfd-Monad.html#t:WConfdMonadIntType">WConfdMonadIntType</a> a</dt><dd class="doc empty">&nbsp;</dd></dl><div class="clear"></div></div></td></tr></table></div><div class="subs instances"><p id="control.i:WConfdMonadInt" class="caption collapser" onclick="toggleSection('i:WConfdMonadInt')">Instances</p><div id="section.i:WConfdMonadInt" class="show"><table><tr><td class="src">Monad <a href="Ganeti-WConfd-Monad.html#t:WConfdMonadInt">WConfdMonadInt</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">Functor <a href="Ganeti-WConfd-Monad.html#t:WConfdMonadInt">WConfdMonadInt</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">Applicative <a href="Ganeti-WConfd-Monad.html#t:WConfdMonadInt">WConfdMonadInt</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">MonadIO <a href="Ganeti-WConfd-Monad.html#t:WConfdMonadInt">WConfdMonadInt</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src"><a href="Ganeti-Logging.html#t:MonadLog">MonadLog</a> <a href="Ganeti-WConfd-Monad.html#t:WConfdMonadInt">WConfdMonadInt</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">MonadBase IO <a href="Ganeti-WConfd-Monad.html#t:WConfdMonadInt">WConfdMonadInt</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">MonadBaseControl IO <a href="Ganeti-WConfd-Monad.html#t:WConfdMonadInt">WConfdMonadInt</a></td><td class="doc empty">&nbsp;</td></tr></table></div></div></div><div class="top"><p class="src"><a name="v:runWConfdMonadInt" class="def">runWConfdMonadInt</a> ::  <a href="Ganeti-WConfd-Monad.html#t:WConfdMonadInt">WConfdMonadInt</a> a -&gt; <a href="Ganeti-WConfd-Monad.html#t:DaemonHandle">DaemonHandle</a> -&gt; IO a<a href="Ganeti/WConfd/Monad.html#runWConfdMonadInt" class="link">Source</a></p><div class="doc"><p>Runs the internal part of the WConfdMonad monad on a given daemon
 handle.
</p></div></div><div class="top"><p class="src"><span class="keyword">type</span> <a name="t:WConfdMonad" class="def">WConfdMonad</a> = <a href="Ganeti-BasicTypes.html#t:ResultT">ResultT</a> <a href="Ganeti-Errors.html#t:GanetiException">GanetiException</a> <a href="Ganeti-WConfd-Monad.html#t:WConfdMonadInt">WConfdMonadInt</a><a href="Ganeti/WConfd/Monad.html#WConfdMonad" class="link">Source</a></p><div class="doc"><p>The complete monad with error handling.
</p></div></div><div class="top"><p class="src"><span class="keyword">type</span> <a name="t:AtomicModifyMonad" class="def">AtomicModifyMonad</a> a = <a href="Ganeti-BasicTypes.html#t:ResultT">ResultT</a> <a href="Ganeti-Errors.html#t:GanetiException">GanetiException</a> <a href="Ganeti-Logging-WriterLog.html#t:WriterLog">WriterLog</a> a<a href="Ganeti/WConfd/Monad.html#AtomicModifyMonad" class="link">Source</a></p></div><h1 id="g:3">Basic functions in the monad
</h1><div class="top"><p class="src"><a name="v:daemonHandle" class="def">daemonHandle</a> :: <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> <a href="Ganeti-WConfd-Monad.html#t:DaemonHandle">DaemonHandle</a><a href="Ganeti/WConfd/Monad.html#daemonHandle" class="link">Source</a></p><div class="doc"><p>Returns the daemon handle.
</p></div></div><div class="top"><p class="src"><a name="v:readConfigState" class="def">readConfigState</a> :: <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a><a href="Ganeti/WConfd/Monad.html#readConfigState" class="link">Source</a></p><div class="doc"><p>Returns the current configuration, given a handle
</p></div></div><div class="top"><p class="src"><a name="v:unpackConfigResult" class="def">unpackConfigResult</a> ::  ClockTime -&gt; <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a> -&gt; (a, <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a>) -&gt; ((a, Bool, Bool), <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a>)<a href="Ganeti/WConfd/Monad.html#unpackConfigResult" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:modifyConfigStateErrWithImmediate" class="def">modifyConfigStateErrWithImmediate</a> ::  (<a href="Ganeti-WConfd-TempRes.html#t:TempResState">TempResState</a> -&gt; <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a> -&gt; <a href="Ganeti-WConfd-Monad.html#t:AtomicModifyMonad">AtomicModifyMonad</a> (a, <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a>)) -&gt; <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> () -&gt; <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> a<a href="Ganeti/WConfd/Monad.html#modifyConfigStateErrWithImmediate" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:modifyConfigStateErr" class="def">modifyConfigStateErr</a> ::  (<a href="Ganeti-WConfd-TempRes.html#t:TempResState">TempResState</a> -&gt; <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a> -&gt; <a href="Ganeti-WConfd-Monad.html#t:AtomicModifyMonad">AtomicModifyMonad</a> (a, <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a>)) -&gt; <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> a<a href="Ganeti/WConfd/Monad.html#modifyConfigStateErr" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:modifyConfigStateErr_" class="def">modifyConfigStateErr_</a> :: (<a href="Ganeti-WConfd-TempRes.html#t:TempResState">TempResState</a> -&gt; <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a> -&gt; <a href="Ganeti-WConfd-Monad.html#t:AtomicModifyMonad">AtomicModifyMonad</a> <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a>) -&gt; <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> ()<a href="Ganeti/WConfd/Monad.html#modifyConfigStateErr_" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:modifyConfigState" class="def">modifyConfigState</a> ::  (<a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a> -&gt; (a, <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a>)) -&gt; <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> a<a href="Ganeti/WConfd/Monad.html#modifyConfigState" class="link">Source</a></p><div class="doc"><p>Atomically modifies the configuration state in the WConfdMonad.
</p></div></div><div class="top"><p class="src"><a name="v:modifyConfigStateWithImmediate" class="def">modifyConfigStateWithImmediate</a> ::  (<a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a> -&gt; (a, <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a>)) -&gt; <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> () -&gt; <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> a<a href="Ganeti/WConfd/Monad.html#modifyConfigStateWithImmediate" class="link">Source</a></p><div class="doc"><p>Atomically modifies the configuration state in WConfdMonad; immediately
 afterwards (while the config write-out is not necessarily finished) do
 another acation.
</p></div></div><div class="top"><p class="src"><a name="v:forceConfigStateDistribution" class="def">forceConfigStateDistribution</a> :: <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> ()<a href="Ganeti/WConfd/Monad.html#forceConfigStateDistribution" class="link">Source</a></p><div class="doc"><p>Force the distribution of configuration without actually modifying it.
</p><p>We need a separate call for this operation, because <code><a href="Ganeti-WConfd-Monad.html#v:modifyConfigState">modifyConfigState</a></code> only
 triggers the distribution when the configuration changes.
</p></div></div><div class="top"><p class="src"><a name="v:modifyConfigDataErr_" class="def">modifyConfigDataErr_</a> :: (<a href="Ganeti-WConfd-TempRes.html#t:TempResState">TempResState</a> -&gt; <a href="Ganeti-Objects.html#t:ConfigData">ConfigData</a> -&gt; <a href="Ganeti-WConfd-Monad.html#t:AtomicModifyMonad">AtomicModifyMonad</a> <a href="Ganeti-Objects.html#t:ConfigData">ConfigData</a>) -&gt; <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> ()<a href="Ganeti/WConfd/Monad.html#modifyConfigDataErr_" class="link">Source</a></p><div class="doc"><p>Atomically modifies the configuration data in the WConfdMonad
 with a computation that can possibly fail.
</p></div></div><div class="top"><p class="src"><a name="v:modifyTempResStateErr" class="def">modifyTempResStateErr</a> ::  (<a href="Ganeti-Objects.html#t:ConfigData">ConfigData</a> -&gt; StateT <a href="Ganeti-WConfd-TempRes.html#t:TempResState">TempResState</a> <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> a) -&gt; <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> a<a href="Ganeti/WConfd/Monad.html#modifyTempResStateErr" class="link">Source</a></p><div class="doc"><p>Atomically modifies the state of temporary reservations in
 WConfdMonad in the presence of possible errors.
</p></div></div><div class="top"><p class="src"><a name="v:modifyTempResState" class="def">modifyTempResState</a> ::  (<a href="Ganeti-Objects.html#t:ConfigData">ConfigData</a> -&gt; State <a href="Ganeti-WConfd-TempRes.html#t:TempResState">TempResState</a> a) -&gt; <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> a<a href="Ganeti/WConfd/Monad.html#modifyTempResState" class="link">Source</a></p><div class="doc"><p>Atomically modifies the state of temporary reservations in
 WConfdMonad.
</p></div></div><div class="top"><p class="src"><a name="v:readTempResState" class="def">readTempResState</a> :: <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> (<a href="Ganeti-Objects.html#t:ConfigData">ConfigData</a>, <a href="Ganeti-WConfd-TempRes.html#t:TempResState">TempResState</a>)<a href="Ganeti/WConfd/Monad.html#readTempResState" class="link">Source</a></p><div class="doc"><p>Reads the state of of the configuration and temporary reservations
 in WConfdMonad.
</p></div></div><div class="top"><p class="src"><a name="v:modifyLockWaiting" class="def">modifyLockWaiting</a> ::  (<a href="Ganeti-Locking-Locks.html#t:GanetiLockWaiting">GanetiLockWaiting</a> -&gt; (<a href="Ganeti-Locking-Locks.html#t:GanetiLockWaiting">GanetiLockWaiting</a>, (a, Set <a href="Ganeti-Locking-Locks.html#t:ClientId">ClientId</a>))) -&gt; <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> a<a href="Ganeti/WConfd/Monad.html#modifyLockWaiting" class="link">Source</a></p><div class="doc"><p>Atomically modifies the lock waiting state in WConfdMonad.
</p></div></div><div class="top"><p class="src"><a name="v:modifyLockWaiting_" class="def">modifyLockWaiting_</a> :: (<a href="Ganeti-Locking-Locks.html#t:GanetiLockWaiting">GanetiLockWaiting</a> -&gt; (<a href="Ganeti-Locking-Locks.html#t:GanetiLockWaiting">GanetiLockWaiting</a>, Set <a href="Ganeti-Locking-Locks.html#t:ClientId">ClientId</a>)) -&gt; <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> ()<a href="Ganeti/WConfd/Monad.html#modifyLockWaiting_" class="link">Source</a></p><div class="doc"><p>Atomically modifies the lock allocation state in WConfdMonad, not
 producing any result
</p></div></div><div class="top"><p class="src"><a name="v:readLockWaiting" class="def">readLockWaiting</a> :: <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> <a href="Ganeti-Locking-Locks.html#t:GanetiLockWaiting">GanetiLockWaiting</a><a href="Ganeti/WConfd/Monad.html#readLockWaiting" class="link">Source</a></p><div class="doc"><p>Read the lock waiting state in WConfdMonad.
</p></div></div><div class="top"><p class="src"><a name="v:readLockAllocation" class="def">readLockAllocation</a> :: <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> (<a href="Ganeti-Locking-Allocation.html#t:LockAllocation">LockAllocation</a> <a href="Ganeti-Locking-Locks.html#t:GanetiLocks">GanetiLocks</a> <a href="Ganeti-Locking-Locks.html#t:ClientId">ClientId</a>)<a href="Ganeti/WConfd/Monad.html#readLockAllocation" class="link">Source</a></p><div class="doc"><p>Read the underlying lock allocation.
</p></div></div><div class="top"><p class="src"><a name="v:modifyConfigWithLock" class="def">modifyConfigWithLock</a> :: (<a href="Ganeti-WConfd-TempRes.html#t:TempResState">TempResState</a> -&gt; <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a> -&gt; <a href="Ganeti-WConfd-Monad.html#t:AtomicModifyMonad">AtomicModifyMonad</a> <a href="Ganeti-WConfd-ConfigState.html#t:ConfigState">ConfigState</a>) -&gt; State <a href="Ganeti-WConfd-TempRes.html#t:TempResState">TempResState</a> () -&gt; <a href="Ganeti-WConfd-Monad.html#t:WConfdMonad">WConfdMonad</a> (Maybe ())<a href="Ganeti/WConfd/Monad.html#modifyConfigWithLock" class="link">Source</a></p><div class="doc"><p>Modify the configuration while temporarily acquiring
 the configuration lock. If the configuration lock is held by
 someone else, nothing is changed and Nothing is returned.
</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.10.0</p></div></body></html>