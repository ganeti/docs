<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Ganeti.Query.Filter</title><link href="ocean.css" rel="stylesheet" type="text/css" title="Ocean" /><script src="haddock-util.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
window.onload = function () {pageLoad();setSynopsis("mini_Ganeti-Query-Filter.html");};
//]]>
</script></head><body><div id="package-header"><ul class="links" id="page-menu"><li><a href="Ganeti/Query/Filter.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul><p class="caption">ganeti</p></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>Safe-Infered</td></tr></table><p class="caption">Ganeti.Query.Filter</p></div><div id="description"><p class="caption">Description</p><div class="doc"><p>Implementation of the Ganeti Query2 filterning.
</p><p>The filtering of results should be done in two phases.
</p><p>In the first phase, before contacting any remote nodes for runtime
data, the filtering should be executed with <code>Nothing</code> for the runtime
context. This will make all non-runtime filters filter correctly,
whereas all runtime filters will respond successfully. As described in
the Python version too, this makes for example <em>Or</em> filters very
inefficient if they contain runtime fields.
</p><p>Once this first filtering phase has been done, we hopefully eliminated
some remote nodes out of the list of candidates, we run the remote
data gathering, and we evaluate the filter again, this time with a
<code>Just</code> runtime context. This will make all filters work correctly.
</p><p>Note that the second run will re-evaluate the config/simple fields,
without caching; this is not perfect, but we consider config accesses
very cheap (and the configuration snapshot we have won't change
between the two runs, hence we will not get inconsistent results).
</p></div></div><div id="synopsis"><p id="control.syn" class="caption expander" onclick="toggleSection('syn')">Synopsis</p><ul id="section.syn" class="hide" onclick="toggleSection('syn')"><li class="src short"><a href="#v:compileFilter">compileFilter</a> ::  <a href="Ganeti-Query-Types.html#t:FieldMap">FieldMap</a> a b -&gt; <a href="Ganeti-Query-Language.html#t:Filter">Filter</a> <a href="Ganeti-Query-Language.html#t:FilterField">FilterField</a> -&gt; <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> (<a href="Ganeti-Query-Language.html#t:Filter">Filter</a> (<a href="Ganeti-Query-Types.html#t:FieldGetter">FieldGetter</a> a b, <a href="Ganeti-Query-Types.html#t:QffMode">QffMode</a>))</li><li class="src short"><a href="#v:qffField">qffField</a> :: <a href="Ganeti-Query-Types.html#t:QffMode">QffMode</a> -&gt; JSValue -&gt; <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> JSValue</li><li class="src short"><a href="#v:wrapGetter">wrapGetter</a> ::  <a href="Ganeti-Objects.html#t:ConfigData">ConfigData</a> -&gt; Maybe b -&gt; a -&gt; (<a href="Ganeti-Query-Types.html#t:FieldGetter">FieldGetter</a> a b, <a href="Ganeti-Query-Types.html#t:QffMode">QffMode</a>) -&gt; (JSValue -&gt; <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> Bool) -&gt; MaybeT <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> Bool</li><li class="src short"><a href="#v:trueFilter">trueFilter</a> :: JSValue -&gt; <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> Bool</li><li class="src short"><span class="keyword">type</span> <a href="#t:Comparator">Comparator</a> = (Eq a, Ord a) =&gt; a -&gt; a -&gt; Bool</li><li class="src short"><a href="#v:eqFilter">eqFilter</a> :: <a href="Ganeti-Query-Types.html#t:QffMode">QffMode</a> -&gt; <a href="Ganeti-Query-Language.html#t:FilterValue">FilterValue</a> -&gt; JSValue -&gt; <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> Bool</li><li class="src short"><a href="#v:binOpFilter">binOpFilter</a> :: <a href="Ganeti-Query-Filter.html#t:Comparator">Comparator</a> -&gt; <a href="Ganeti-Query-Language.html#t:FilterValue">FilterValue</a> -&gt; JSValue -&gt; <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> Bool</li><li class="src short"><a href="#v:regexpFilter">regexpFilter</a> :: <a href="Ganeti-Query-Language.html#t:FilterRegex">FilterRegex</a> -&gt; JSValue -&gt; <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> Bool</li><li class="src short"><a href="#v:containsFilter">containsFilter</a> :: <a href="Ganeti-Query-Language.html#t:FilterValue">FilterValue</a> -&gt; JSValue -&gt; <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> Bool</li><li class="src short"><span class="keyword">data</span>  <a href="#t:Comparison">Comparison</a> <ul class="subs"><li>= <a href="#v:Eq">Eq</a>  </li><li>| <a href="#v:Lt">Lt</a>  </li><li>| <a href="#v:Le">Le</a>  </li><li>| <a href="#v:Gt">Gt</a>  </li><li>| <a href="#v:Ge">Ge</a>  </li></ul></li><li class="src short"><a href="#v:toCompFun">toCompFun</a> :: <a href="Ganeti-Query-Filter.html#t:Comparison">Comparison</a> -&gt; <a href="Ganeti-Query-Filter.html#t:Comparator">Comparator</a></li><li class="src short"><span class="keyword">data</span>  <a href="#t:FilterOp">FilterOp</a> field val <span class="keyword">where</span><ul class="subs"><li><a href="#v:Truth">Truth</a> ::  <a href="Ganeti-Query-Filter.html#t:FilterOp">FilterOp</a> field ()  </li><li><a href="#v:Comp">Comp</a> ::  <a href="Ganeti-Query-Filter.html#t:Comparison">Comparison</a> -&gt; <a href="Ganeti-Query-Filter.html#t:FilterOp">FilterOp</a> field <a href="Ganeti-Query-Language.html#t:FilterValue">FilterValue</a>  </li><li><a href="#v:Regex">Regex</a> ::  <a href="Ganeti-Query-Filter.html#t:FilterOp">FilterOp</a> field <a href="Ganeti-Query-Language.html#t:FilterRegex">FilterRegex</a>  </li><li><a href="#v:Contains">Contains</a> ::  <a href="Ganeti-Query-Filter.html#t:FilterOp">FilterOp</a> field <a href="Ganeti-Query-Language.html#t:FilterValue">FilterValue</a>  </li></ul></li><li class="src short"><a href="#v:evaluateFilterM">evaluateFilterM</a> :: (Monad m, Applicative m) =&gt; (<span class="keyword">forall</span> val.  <a href="Ganeti-Query-Filter.html#t:FilterOp">FilterOp</a> field val -&gt; field -&gt; val -&gt; m Bool) -&gt; <a href="Ganeti-Query-Language.html#t:Filter">Filter</a> field -&gt; m Bool</li><li class="src short"><a href="#v:evaluateQueryFilter">evaluateQueryFilter</a> ::  <a href="Ganeti-Objects.html#t:ConfigData">ConfigData</a> -&gt; Maybe b -&gt; a -&gt; <a href="Ganeti-Query-Language.html#t:Filter">Filter</a> (<a href="Ganeti-Query-Types.html#t:FieldGetter">FieldGetter</a> a b, <a href="Ganeti-Query-Types.html#t:QffMode">QffMode</a>) -&gt; <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> Bool</li><li class="src short"><a href="#v:evaluateFilterJSON">evaluateFilterJSON</a> :: <a href="Ganeti-Query-Language.html#t:Filter">Filter</a> JSValue -&gt; <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> Bool</li><li class="src short"><a href="#v:tryGetter">tryGetter</a> ::  <a href="Ganeti-Objects.html#t:ConfigData">ConfigData</a> -&gt; Maybe b -&gt; a -&gt; <a href="Ganeti-Query-Types.html#t:FieldGetter">FieldGetter</a> a b -&gt; Maybe <a href="Ganeti-Query-Language.html#t:ResultEntry">ResultEntry</a></li><li class="src short"><a href="#v:requestedNames">requestedNames</a> :: <a href="Ganeti-Query-Language.html#t:FilterField">FilterField</a> -&gt; <a href="Ganeti-Query-Language.html#t:Filter">Filter</a> <a href="Ganeti-Query-Language.html#t:FilterField">FilterField</a> -&gt; Maybe [<a href="Ganeti-Query-Language.html#t:FilterValue">FilterValue</a>]</li><li class="src short"><a href="#v:makeSimpleFilter">makeSimpleFilter</a> :: String -&gt; [Either String Integer] -&gt; <a href="Ganeti-Query-Language.html#t:Filter">Filter</a> <a href="Ganeti-Query-Language.html#t:FilterField">FilterField</a></li></ul></div><div id="interface"><h1>Documentation</h1><div class="top"><p class="src"><a name="v:compileFilter" class="def">compileFilter</a> ::  <a href="Ganeti-Query-Types.html#t:FieldMap">FieldMap</a> a b -&gt; <a href="Ganeti-Query-Language.html#t:Filter">Filter</a> <a href="Ganeti-Query-Language.html#t:FilterField">FilterField</a> -&gt; <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> (<a href="Ganeti-Query-Language.html#t:Filter">Filter</a> (<a href="Ganeti-Query-Types.html#t:FieldGetter">FieldGetter</a> a b, <a href="Ganeti-Query-Types.html#t:QffMode">QffMode</a>))<a href="Ganeti/Query/Filter.html#compileFilter" class="link">Source</a></p><div class="doc"><p>Compiles a filter based on field names to one based on getters.
</p></div></div><div class="top"><p class="src"><a name="v:qffField" class="def">qffField</a> :: <a href="Ganeti-Query-Types.html#t:QffMode">QffMode</a> -&gt; JSValue -&gt; <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> JSValue<a href="Ganeti/Query/Filter.html#qffField" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:wrapGetter" class="def">wrapGetter</a> ::  <a href="Ganeti-Objects.html#t:ConfigData">ConfigData</a> -&gt; Maybe b -&gt; a -&gt; (<a href="Ganeti-Query-Types.html#t:FieldGetter">FieldGetter</a> a b, <a href="Ganeti-Query-Types.html#t:QffMode">QffMode</a>) -&gt; (JSValue -&gt; <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> Bool) -&gt; MaybeT <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> Bool<a href="Ganeti/Query/Filter.html#wrapGetter" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:trueFilter" class="def">trueFilter</a> :: JSValue -&gt; <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> Bool<a href="Ganeti/Query/Filter.html#trueFilter" class="link">Source</a></p></div><div class="top"><p class="src"><span class="keyword">type</span> <a name="t:Comparator" class="def">Comparator</a> = (Eq a, Ord a) =&gt; a -&gt; a -&gt; Bool<a href="Ganeti/Query/Filter.html#Comparator" class="link">Source</a></p><div class="doc"><p>A type synonim for a rank-2 comparator function. This is used so
 that we can pass the usual <code>&lt;=</code>, <code>&gt;</code>, <code>==</code> functions to <code><a href="Ganeti-Query-Filter.html#v:binOpFilter">binOpFilter</a></code>
 and for them to be used in multiple contexts.
</p></div></div><div class="top"><p class="src"><a name="v:eqFilter" class="def">eqFilter</a> :: <a href="Ganeti-Query-Types.html#t:QffMode">QffMode</a> -&gt; <a href="Ganeti-Query-Language.html#t:FilterValue">FilterValue</a> -&gt; JSValue -&gt; <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> Bool<a href="Ganeti/Query/Filter.html#eqFilter" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:binOpFilter" class="def">binOpFilter</a> :: <a href="Ganeti-Query-Filter.html#t:Comparator">Comparator</a> -&gt; <a href="Ganeti-Query-Language.html#t:FilterValue">FilterValue</a> -&gt; JSValue -&gt; <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> Bool<a href="Ganeti/Query/Filter.html#binOpFilter" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:regexpFilter" class="def">regexpFilter</a> :: <a href="Ganeti-Query-Language.html#t:FilterRegex">FilterRegex</a> -&gt; JSValue -&gt; <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> Bool<a href="Ganeti/Query/Filter.html#regexpFilter" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:containsFilter" class="def">containsFilter</a> :: <a href="Ganeti-Query-Language.html#t:FilterValue">FilterValue</a> -&gt; JSValue -&gt; <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> Bool<a href="Ganeti/Query/Filter.html#containsFilter" class="link">Source</a></p></div><div class="top"><p class="src"><span class="keyword">data</span>  <a name="t:Comparison" class="def">Comparison</a>  <a href="Ganeti/Query/Filter.html#Comparison" class="link">Source</a></p><div class="doc"><p>Ways we can compare things in the filter language.
</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a name="v:Eq" class="def">Eq</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src"><a name="v:Lt" class="def">Lt</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src"><a name="v:Le" class="def">Le</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src"><a name="v:Gt" class="def">Gt</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src"><a name="v:Ge" class="def">Ge</a></td><td class="doc empty">&nbsp;</td></tr></table></div><div class="subs instances"><p id="control.i:Comparison" class="caption collapser" onclick="toggleSection('i:Comparison')">Instances</p><div id="section.i:Comparison" class="show"><table><tr><td class="src">Eq <a href="Ganeti-Query-Filter.html#t:Comparison">Comparison</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">Ord <a href="Ganeti-Query-Filter.html#t:Comparison">Comparison</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">Show <a href="Ganeti-Query-Filter.html#t:Comparison">Comparison</a></td><td class="doc empty">&nbsp;</td></tr></table></div></div></div><div class="top"><p class="src"><a name="v:toCompFun" class="def">toCompFun</a> :: <a href="Ganeti-Query-Filter.html#t:Comparison">Comparison</a> -&gt; <a href="Ganeti-Query-Filter.html#t:Comparator">Comparator</a><a href="Ganeti/Query/Filter.html#toCompFun" class="link">Source</a></p><div class="doc"><p>Turns a comparison into the corresponding Haskell function.
</p></div></div><div class="top"><p class="src"><span class="keyword">data</span>  <a name="t:FilterOp" class="def">FilterOp</a> field val <span class="keyword">where</span><a href="Ganeti/Query/Filter.html#FilterOp" class="link">Source</a></p><div class="doc"><p>Operations in the leaves of the Ganeti filter language.
</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a name="v:Truth" class="def">Truth</a> ::  <a href="Ganeti-Query-Filter.html#t:FilterOp">FilterOp</a> field ()</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src"><a name="v:Comp" class="def">Comp</a> ::  <a href="Ganeti-Query-Filter.html#t:Comparison">Comparison</a> -&gt; <a href="Ganeti-Query-Filter.html#t:FilterOp">FilterOp</a> field <a href="Ganeti-Query-Language.html#t:FilterValue">FilterValue</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src"><a name="v:Regex" class="def">Regex</a> ::  <a href="Ganeti-Query-Filter.html#t:FilterOp">FilterOp</a> field <a href="Ganeti-Query-Language.html#t:FilterRegex">FilterRegex</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src"><a name="v:Contains" class="def">Contains</a> ::  <a href="Ganeti-Query-Filter.html#t:FilterOp">FilterOp</a> field <a href="Ganeti-Query-Language.html#t:FilterValue">FilterValue</a></td><td class="doc empty">&nbsp;</td></tr></table></div><div class="subs instances"><p id="control.i:FilterOp" class="caption collapser" onclick="toggleSection('i:FilterOp')">Instances</p><div id="section.i:FilterOp" class="show"><table><tr><td class="src">Eq (<a href="Ganeti-Query-Filter.html#t:FilterOp">FilterOp</a> field val)</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">Show (<a href="Ganeti-Query-Filter.html#t:FilterOp">FilterOp</a> field val)</td><td class="doc empty">&nbsp;</td></tr></table></div></div></div><div class="top"><p class="src"><a name="v:evaluateFilterM" class="def">evaluateFilterM</a> :: (Monad m, Applicative m) =&gt; (<span class="keyword">forall</span> val.  <a href="Ganeti-Query-Filter.html#t:FilterOp">FilterOp</a> field val -&gt; field -&gt; val -&gt; m Bool) -&gt; <a href="Ganeti-Query-Language.html#t:Filter">Filter</a> field -&gt; m Bool<a href="Ganeti/Query/Filter.html#evaluateFilterM" class="link">Source</a></p><div class="doc"><p>Checks if a filter matches.
</p><p>The leaves of the filter are evaluated against an object using the passed
 <code>opFun</code>; that is why the object need not be passed in.
</p><p>The <code>field</code> type describes the <a href="accessors.html">accessors</a> that are used to query
 values from the object; those values are to be matched against the
 <code>val</code> type in the filter leaves.
</p><p>Useful monads <code>m</code> for this are <code><a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a></code> and <code>Maybe</code>.
</p></div></div><div class="top"><p class="src"><a name="v:evaluateQueryFilter" class="def">evaluateQueryFilter</a> ::  <a href="Ganeti-Objects.html#t:ConfigData">ConfigData</a> -&gt; Maybe b -&gt; a -&gt; <a href="Ganeti-Query-Language.html#t:Filter">Filter</a> (<a href="Ganeti-Query-Types.html#t:FieldGetter">FieldGetter</a> a b, <a href="Ganeti-Query-Types.html#t:QffMode">QffMode</a>) -&gt; <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> Bool<a href="Ganeti/Query/Filter.html#evaluateQueryFilter" class="link">Source</a></p><div class="doc"><p>Verifies if a given item passes a filter. The runtime context
 might be missing, in which case most of the filters will consider
 this as passing the filter.
</p></div></div><div class="top"><p class="src"><a name="v:evaluateFilterJSON" class="def">evaluateFilterJSON</a> :: <a href="Ganeti-Query-Language.html#t:Filter">Filter</a> JSValue -&gt; <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> Bool<a href="Ganeti/Query/Filter.html#evaluateFilterJSON" class="link">Source</a></p><div class="doc"><p>Evaluates a <code><a href="Ganeti-Query-Language.html#t:Filter">Filter</a></code> on a JSON object.
</p></div></div><div class="top"><p class="src"><a name="v:tryGetter" class="def">tryGetter</a> ::  <a href="Ganeti-Objects.html#t:ConfigData">ConfigData</a> -&gt; Maybe b -&gt; a -&gt; <a href="Ganeti-Query-Types.html#t:FieldGetter">FieldGetter</a> a b -&gt; Maybe <a href="Ganeti-Query-Language.html#t:ResultEntry">ResultEntry</a><a href="Ganeti/Query/Filter.html#tryGetter" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:requestedNames" class="def">requestedNames</a> :: <a href="Ganeti-Query-Language.html#t:FilterField">FilterField</a> -&gt; <a href="Ganeti-Query-Language.html#t:Filter">Filter</a> <a href="Ganeti-Query-Language.html#t:FilterField">FilterField</a> -&gt; Maybe [<a href="Ganeti-Query-Language.html#t:FilterValue">FilterValue</a>]<a href="Ganeti/Query/Filter.html#requestedNames" class="link">Source</a></p><div class="doc"><p>Computes the requested names, if only names were requested (and
 with equality). Otherwise returns <code>Nothing</code>.
</p></div></div><div class="top"><p class="src"><a name="v:makeSimpleFilter" class="def">makeSimpleFilter</a> :: String -&gt; [Either String Integer] -&gt; <a href="Ganeti-Query-Language.html#t:Filter">Filter</a> <a href="Ganeti-Query-Language.html#t:FilterField">FilterField</a><a href="Ganeti/Query/Filter.html#makeSimpleFilter" class="link">Source</a></p><div class="doc"><p>Builds a simple filter from a list of names.
</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.10.0</p></div></body></html>