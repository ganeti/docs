<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.6: http://docutils.sourceforge.net/" />
<title>Ganeti customisation using hooks</title>
<style type="text/css">

/*
:Author: David Goodger (goodger@python.org)
:Id: $Id: html4css1.css 5951 2009-05-18 18:03:10Z milde $
:Copyright: This stylesheet has been placed in the public domain.

Default cascading style sheet for the HTML output of Docutils.

See http://docutils.sf.net/docs/howto/html-stylesheets.html for how to
customize this style sheet.
*/

/* used to remove borders from tables and images */
.borderless, table.borderless td, table.borderless th {
  border: 0 }

table.borderless td, table.borderless th {
  /* Override padding for "table.docutils td" with "! important".
     The right padding separates the table cells. */
  padding: 0 0.5em 0 0 ! important }

.first {
  /* Override more specific margin styles with "! important". */
  margin-top: 0 ! important }

.last, .with-subtitle {
  margin-bottom: 0 ! important }

.hidden {
  display: none }

a.toc-backref {
  text-decoration: none ;
  color: black }

blockquote.epigraph {
  margin: 2em 5em ; }

dl.docutils dd {
  margin-bottom: 0.5em }

/* Uncomment (and remove this text!) to get bold-faced definition list terms
dl.docutils dt {
  font-weight: bold }
*/

div.abstract {
  margin: 2em 5em }

div.abstract p.topic-title {
  font-weight: bold ;
  text-align: center }

div.admonition, div.attention, div.caution, div.danger, div.error,
div.hint, div.important, div.note, div.tip, div.warning {
  margin: 2em ;
  border: medium outset ;
  padding: 1em }

div.admonition p.admonition-title, div.hint p.admonition-title,
div.important p.admonition-title, div.note p.admonition-title,
div.tip p.admonition-title {
  font-weight: bold ;
  font-family: sans-serif }

div.attention p.admonition-title, div.caution p.admonition-title,
div.danger p.admonition-title, div.error p.admonition-title,
div.warning p.admonition-title {
  color: red ;
  font-weight: bold ;
  font-family: sans-serif }

/* Uncomment (and remove this text!) to get reduced vertical space in
   compound paragraphs.
div.compound .compound-first, div.compound .compound-middle {
  margin-bottom: 0.5em }

div.compound .compound-last, div.compound .compound-middle {
  margin-top: 0.5em }
*/

div.dedication {
  margin: 2em 5em ;
  text-align: center ;
  font-style: italic }

div.dedication p.topic-title {
  font-weight: bold ;
  font-style: normal }

div.figure {
  margin-left: 2em ;
  margin-right: 2em }

div.footer, div.header {
  clear: both;
  font-size: smaller }

div.line-block {
  display: block ;
  margin-top: 1em ;
  margin-bottom: 1em }

div.line-block div.line-block {
  margin-top: 0 ;
  margin-bottom: 0 ;
  margin-left: 1.5em }

div.sidebar {
  margin: 0 0 0.5em 1em ;
  border: medium outset ;
  padding: 1em ;
  background-color: #ffffee ;
  width: 40% ;
  float: right ;
  clear: right }

div.sidebar p.rubric {
  font-family: sans-serif ;
  font-size: medium }

div.system-messages {
  margin: 5em }

div.system-messages h1 {
  color: red }

div.system-message {
  border: medium outset ;
  padding: 1em }

div.system-message p.system-message-title {
  color: red ;
  font-weight: bold }

div.topic {
  margin: 2em }

h1.section-subtitle, h2.section-subtitle, h3.section-subtitle,
h4.section-subtitle, h5.section-subtitle, h6.section-subtitle {
  margin-top: 0.4em }

h1.title {
  text-align: center }

h2.subtitle {
  text-align: center }

hr.docutils {
  width: 75% }

img.align-left, .figure.align-left{
  clear: left ;
  float: left ;
  margin-right: 1em }

img.align-right, .figure.align-right {
  clear: right ;
  float: right ;
  margin-left: 1em }

.align-left {
  text-align: left }

.align-center {
  clear: both ;
  text-align: center }

.align-right {
  text-align: right }

/* reset inner alignment in figures */
div.align-right {
  text-align: left }

/* div.align-center * { */
/*   text-align: left } */

ol.simple, ul.simple {
  margin-bottom: 1em }

ol.arabic {
  list-style: decimal }

ol.loweralpha {
  list-style: lower-alpha }

ol.upperalpha {
  list-style: upper-alpha }

ol.lowerroman {
  list-style: lower-roman }

ol.upperroman {
  list-style: upper-roman }

p.attribution {
  text-align: right ;
  margin-left: 50% }

p.caption {
  font-style: italic }

p.credits {
  font-style: italic ;
  font-size: smaller }

p.label {
  white-space: nowrap }

p.rubric {
  font-weight: bold ;
  font-size: larger ;
  color: maroon ;
  text-align: center }

p.sidebar-title {
  font-family: sans-serif ;
  font-weight: bold ;
  font-size: larger }

p.sidebar-subtitle {
  font-family: sans-serif ;
  font-weight: bold }

p.topic-title {
  font-weight: bold }

pre.address {
  margin-bottom: 0 ;
  margin-top: 0 ;
  font: inherit }

pre.literal-block, pre.doctest-block {
  margin-left: 2em ;
  margin-right: 2em }

span.classifier {
  font-family: sans-serif ;
  font-style: oblique }

span.classifier-delimiter {
  font-family: sans-serif ;
  font-weight: bold }

span.interpreted {
  font-family: sans-serif }

span.option {
  white-space: nowrap }

span.pre {
  white-space: pre }

span.problematic {
  color: red }

span.section-subtitle {
  /* font-size relative to parent (h1..h6 element) */
  font-size: 80% }

table.citation {
  border-left: solid 1px gray;
  margin-left: 1px }

table.docinfo {
  margin: 2em 4em }

table.docutils {
  margin-top: 0.5em ;
  margin-bottom: 0.5em }

table.footnote {
  border-left: solid 1px black;
  margin-left: 1px }

table.docutils td, table.docutils th,
table.docinfo td, table.docinfo th {
  padding-left: 0.5em ;
  padding-right: 0.5em ;
  vertical-align: top }

table.docutils th.field-name, table.docinfo th.docinfo-name {
  font-weight: bold ;
  text-align: left ;
  white-space: nowrap ;
  padding-left: 0 }

h1 tt.docutils, h2 tt.docutils, h3 tt.docutils,
h4 tt.docutils, h5 tt.docutils, h6 tt.docutils {
  font-size: 100% }

ul.auto-toc {
  list-style-type: none }

</style>
</head>
<body>
<div class="document" id="ganeti-customisation-using-hooks">
<h1 class="title">Ganeti customisation using hooks</h1>

<p>Documents ganeti version 2.0</p>
<div class="contents topic" id="contents">
<p class="topic-title first">Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#introduction" id="id1">Introduction</a></li>
<li><a class="reference internal" href="#organisation" id="id2">Organisation</a><ul>
<li><a class="reference internal" href="#pre-scripts" id="id3"><em>pre</em> scripts</a></li>
<li><a class="reference internal" href="#post-scripts" id="id4"><em>post</em> scripts</a></li>
<li><a class="reference internal" href="#naming" id="id5">Naming</a></li>
<li><a class="reference internal" href="#order-of-execution" id="id6">Order of execution</a></li>
<li><a class="reference internal" href="#execution-environment" id="id7">Execution environment</a></li>
</ul>
</li>
<li><a class="reference internal" href="#operation-list" id="id8">Operation list</a><ul>
<li><a class="reference internal" href="#node-operations" id="id9">Node operations</a><ul>
<li><a class="reference internal" href="#op-add-node" id="id10">OP_ADD_NODE</a></li>
<li><a class="reference internal" href="#op-remove-node" id="id11">OP_REMOVE_NODE</a></li>
<li><a class="reference internal" href="#op-node-set-params" id="id12">OP_NODE_SET_PARAMS</a></li>
</ul>
</li>
<li><a class="reference internal" href="#instance-operations" id="id13">Instance operations</a><ul>
<li><a class="reference internal" href="#op-instance-add" id="id14">OP_INSTANCE_ADD</a></li>
<li><a class="reference internal" href="#op-instance-reinstall" id="id15">OP_INSTANCE_REINSTALL</a></li>
<li><a class="reference internal" href="#op-backup-export" id="id16">OP_BACKUP_EXPORT</a></li>
<li><a class="reference internal" href="#op-instance-start" id="id17">OP_INSTANCE_START</a></li>
<li><a class="reference internal" href="#op-instance-shutdown" id="id18">OP_INSTANCE_SHUTDOWN</a></li>
<li><a class="reference internal" href="#op-instance-reboot" id="id19">OP_INSTANCE_REBOOT</a></li>
<li><a class="reference internal" href="#op-instance-modify" id="id20">OP_INSTANCE_MODIFY</a></li>
<li><a class="reference internal" href="#op-instance-failover" id="id21">OP_INSTANCE_FAILOVER</a></li>
<li><a class="reference internal" href="#op-instance-migrate" id="id22">OP_INSTANCE_MIGRATE</a></li>
<li><a class="reference internal" href="#op-instance-remove" id="id23">OP_INSTANCE_REMOVE</a></li>
<li><a class="reference internal" href="#op-instance-replace-disks" id="id24">OP_INSTANCE_REPLACE_DISKS</a></li>
<li><a class="reference internal" href="#op-instance-grow-disk" id="id25">OP_INSTANCE_GROW_DISK</a></li>
<li><a class="reference internal" href="#op-instance-rename" id="id26">OP_INSTANCE_RENAME</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cluster-operations" id="id27">Cluster operations</a><ul>
<li><a class="reference internal" href="#op-cluster-verify" id="id28">OP_CLUSTER_VERIFY</a></li>
<li><a class="reference internal" href="#op-cluster-rename" id="id29">OP_CLUSTER_RENAME</a></li>
<li><a class="reference internal" href="#op-cluster-set-params" id="id30">OP_CLUSTER_SET_PARAMS</a></li>
</ul>
</li>
<li><a class="reference internal" href="#obsolete-operations" id="id31">Obsolete operations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#environment-variables" id="id32">Environment variables</a><ul>
<li><a class="reference internal" href="#common-variables" id="id33">Common variables</a></li>
<li><a class="reference internal" href="#specialised-variables" id="id34">Specialised variables</a></li>
</ul>
</li>
<li><a class="reference internal" href="#examples" id="id35">Examples</a></li>
</ul>
</div>
<div class="section" id="introduction">
<h1><a class="toc-backref" href="#id1">Introduction</a></h1>
<p>In order to allow customisation of operations, ganeti runs scripts
under <tt class="docutils literal">/etc/ganeti/hooks</tt> based on certain rules.</p>
<p>This is similar to the <tt class="docutils literal">/etc/network/</tt> structure present in Debian
for network interface handling.</p>
</div>
<div class="section" id="organisation">
<h1><a class="toc-backref" href="#id2">Organisation</a></h1>
<p>For every operation, two sets of scripts are run:</p>
<ul class="simple">
<li>pre phase (for authorization/checking)</li>
<li>post phase (for logging)</li>
</ul>
<p>Also, for each operation, the scripts are run on one or more nodes,
depending on the operation type.</p>
<p>Note that, even though we call them scripts, we are actually talking
about any executable.</p>
<div class="section" id="pre-scripts">
<h2><a class="toc-backref" href="#id3"><em>pre</em> scripts</a></h2>
<p>The <em>pre</em> scripts have a definite target: to check that the operation
is allowed given the site-specific constraints. You could have, for
example, a rule that says every new instance is required to exists in
a database; to implement this, you could write a script that checks
the new instance parameters against your database.</p>
<p>The objective of these scripts should be their return code (zero or
non-zero for success and failure). However, if they modify the
environment in any way, they should be idempotent, as failed
executions could be restarted and thus the script(s) run again with
exactly the same parameters.</p>
<p>Note that if a node is unreachable at the time a hooks is run, this
will not be interpreted as a deny for the execution. In other words,
only an actual error returned from a script will cause abort, and not
an unreachable node.</p>
<p>Therefore, if you want to guarantee that a hook script is run and
denies an action, it's best to put it on the master node.</p>
</div>
<div class="section" id="post-scripts">
<h2><a class="toc-backref" href="#id4"><em>post</em> scripts</a></h2>
<p>These scripts should do whatever you need as a reaction to the
completion of an operation. Their return code is not checked (but
logged), and they should not depend on the fact that the <em>pre</em> scripts
have been run.</p>
</div>
<div class="section" id="naming">
<h2><a class="toc-backref" href="#id5">Naming</a></h2>
<p>The allowed names for the scripts consist of (similar to <em>run-parts</em> )
upper and lower case, digits, underscores and hyphens. In other words,
the regexp <tt class="docutils literal"><span class="pre">^[a-zA-Z0-9_-]+$</span></tt>. Also, non-executable scripts will be
ignored.</p>
</div>
<div class="section" id="order-of-execution">
<h2><a class="toc-backref" href="#id6">Order of execution</a></h2>
<p>On a single node, the scripts in a directory are run in lexicographic
order (more exactly, the python string comparison order). It is
advisable to implement the usual <em>NN-name</em> convention where <em>NN</em> is a
two digit number.</p>
<p>For an operation whose hooks are run on multiple nodes, there is no
specific ordering of nodes with regard to hooks execution; you should
assume that the scripts are run in parallel on the target nodes
(keeping on each node the above specified ordering).  If you need any
kind of inter-node synchronisation, you have to implement it yourself
in the scripts.</p>
</div>
<div class="section" id="execution-environment">
<h2><a class="toc-backref" href="#id7">Execution environment</a></h2>
<p>The scripts will be run as follows:</p>
<ul class="simple">
<li>no command line arguments</li>
<li>no controlling <em>tty</em></li>
<li>stdin is actually <em>/dev/null</em></li>
<li>stdout and stderr are directed to files</li>
<li>PATH is reset to <tt class="docutils literal"><span class="pre">/sbin:/bin:/usr/sbin:/usr/bin</span></tt></li>
<li>the environment is cleared, and only ganeti-specific variables will
be left</li>
</ul>
<p>All information about the cluster is passed using environment
variables. Different operations will have sligthly different
environments, but most of the variables are common.</p>
</div>
</div>
<div class="section" id="operation-list">
<h1><a class="toc-backref" href="#id8">Operation list</a></h1>
<div class="section" id="node-operations">
<h2><a class="toc-backref" href="#id9">Node operations</a></h2>
<div class="section" id="op-add-node">
<h3><a class="toc-backref" href="#id10">OP_ADD_NODE</a></h3>
<p>Adds a node to the cluster.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">directory:</th><td class="field-body">node-add</td>
</tr>
<tr class="field"><th class="field-name">env. vars:</th><td class="field-body">NODE_NAME, NODE_PIP, NODE_SIP</td>
</tr>
<tr class="field"><th class="field-name">pre-execution:</th><td class="field-body">all existing nodes</td>
</tr>
<tr class="field"><th class="field-name">post-execution:</th><td class="field-body">all nodes plus the new node</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="op-remove-node">
<h3><a class="toc-backref" href="#id11">OP_REMOVE_NODE</a></h3>
<p>Removes a node from the cluster.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">directory:</th><td class="field-body">node-remove</td>
</tr>
<tr class="field"><th class="field-name">env. vars:</th><td class="field-body">NODE_NAME</td>
</tr>
<tr class="field"><th class="field-name">pre-execution:</th><td class="field-body">all existing nodes except the removed node</td>
</tr>
<tr class="field"><th class="field-name">post-execution:</th><td class="field-body">all existing nodes except the removed node</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="op-node-set-params">
<h3><a class="toc-backref" href="#id12">OP_NODE_SET_PARAMS</a></h3>
<p>Changes a node's parameters.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">directory:</th><td class="field-body">node-modify</td>
</tr>
<tr class="field"><th class="field-name">env. vars:</th><td class="field-body">MASTER_CANDIDATE, OFFLINE, DRAINED</td>
</tr>
<tr class="field"><th class="field-name">pre-execution:</th><td class="field-body">master node, the target node</td>
</tr>
<tr class="field"><th class="field-name">post-execution:</th><td class="field-body">master node, the target node</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="instance-operations">
<h2><a class="toc-backref" href="#id13">Instance operations</a></h2>
<p>All instance operations take at least the following variables:
INSTANCE_NAME, INSTANCE_PRIMARY, INSTANCE_SECONDARIES,
INSTANCE_OS_TYPE, INSTANCE_DISK_TEMPLATE, INSTANCE_MEMORY,
INSTANCE_DISK_SIZES, INSTANCE_VCPUS, INSTANCE_NIC_COUNT,
INSTANCE_NICn_IP, INSTANCE_NICn_BRIDGE, INSTANCE_NICn_MAC,
INSTANCE_DISK_COUNT, INSTANCE_DISKn_SIZE, INSTANCE_DISKn_MODE.</p>
<p>The INSTANCE_NICn_* and INSTANCE_DISKn_* variables represent the
properties of the <em>n</em> -th NIC and disk, and are zero-indexed.</p>
<div class="section" id="op-instance-add">
<h3><a class="toc-backref" href="#id14">OP_INSTANCE_ADD</a></h3>
<p>Creates a new instance.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">directory:</th><td class="field-body">instance-add</td>
</tr>
<tr class="field"><th class="field-name">env. vars:</th><td class="field-body">ADD_MODE, SRC_NODE, SRC_PATH, SRC_IMAGES</td>
</tr>
<tr class="field"><th class="field-name">pre-execution:</th><td class="field-body">master node, primary and secondary nodes</td>
</tr>
<tr class="field"><th class="field-name">post-execution:</th><td class="field-body">master node, primary and secondary nodes</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="op-instance-reinstall">
<h3><a class="toc-backref" href="#id15">OP_INSTANCE_REINSTALL</a></h3>
<p>Reinstalls an instance.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">directory:</th><td class="field-body">instance-reinstall</td>
</tr>
<tr class="field"><th class="field-name">env. vars:</th><td class="field-body">only the standard instance vars</td>
</tr>
<tr class="field"><th class="field-name">pre-execution:</th><td class="field-body">master node, primary and secondary nodes</td>
</tr>
<tr class="field"><th class="field-name">post-execution:</th><td class="field-body">master node, primary and secondary nodes</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="op-backup-export">
<h3><a class="toc-backref" href="#id16">OP_BACKUP_EXPORT</a></h3>
<p>Exports the instance.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">directory:</th><td class="field-body">instance-export</td>
</tr>
<tr class="field"><th class="field-name">env. vars:</th><td class="field-body">EXPORT_NODE, EXPORT_DO_SHUTDOWN</td>
</tr>
<tr class="field"><th class="field-name">pre-execution:</th><td class="field-body">master node, primary and secondary nodes</td>
</tr>
<tr class="field"><th class="field-name">post-execution:</th><td class="field-body">master node, primary and secondary nodes</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="op-instance-start">
<h3><a class="toc-backref" href="#id17">OP_INSTANCE_START</a></h3>
<p>Starts an instance.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">directory:</th><td class="field-body">instance-start</td>
</tr>
<tr class="field"><th class="field-name">env. vars:</th><td class="field-body">INSTANCE_NAME, INSTANCE_PRIMARY, INSTANCE_SECONDARIES, FORCE</td>
</tr>
<tr class="field"><th class="field-name">pre-execution:</th><td class="field-body">master node, primary and secondary nodes</td>
</tr>
<tr class="field"><th class="field-name">post-execution:</th><td class="field-body">master node, primary and secondary nodes</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="op-instance-shutdown">
<h3><a class="toc-backref" href="#id18">OP_INSTANCE_SHUTDOWN</a></h3>
<p>Stops an instance.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">directory:</th><td class="field-body">instance-shutdown</td>
</tr>
<tr class="field"><th class="field-name">env. vars:</th><td class="field-body">INSTANCE_NAME, INSTANCE_PRIMARY, INSTANCE_SECONDARIES</td>
</tr>
<tr class="field"><th class="field-name">pre-execution:</th><td class="field-body">master node, primary and secondary nodes</td>
</tr>
<tr class="field"><th class="field-name">post-execution:</th><td class="field-body">master node, primary and secondary nodes</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="op-instance-reboot">
<h3><a class="toc-backref" href="#id19">OP_INSTANCE_REBOOT</a></h3>
<p>Reboots an instance.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">directory:</th><td class="field-body">instance-reboot</td>
</tr>
<tr class="field"><th class="field-name">env. vars:</th><td class="field-body">IGNORE_SECONDARIES, REBOOT_TYPE</td>
</tr>
<tr class="field"><th class="field-name">pre-execution:</th><td class="field-body">master node, primary and secondary nodes</td>
</tr>
<tr class="field"><th class="field-name">post-execution:</th><td class="field-body">master node, primary and secondary nodes</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="op-instance-modify">
<h3><a class="toc-backref" href="#id20">OP_INSTANCE_MODIFY</a></h3>
<p>Modifies the instance parameters.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">directory:</th><td class="field-body">instance-modify</td>
</tr>
<tr class="field"><th class="field-name">env. vars:</th><td class="field-body">INSTANCE_NAME, MEM_SIZE, VCPUS, INSTANCE_IP</td>
</tr>
<tr class="field"><th class="field-name">pre-execution:</th><td class="field-body">master node, primary and secondary nodes</td>
</tr>
<tr class="field"><th class="field-name">post-execution:</th><td class="field-body">master node, primary and secondary nodes</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="op-instance-failover">
<h3><a class="toc-backref" href="#id21">OP_INSTANCE_FAILOVER</a></h3>
<p>Failovers an instance.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">directory:</th><td class="field-body">instance-failover</td>
</tr>
<tr class="field"><th class="field-name">env. vars:</th><td class="field-body">IGNORE_CONSISTENCY</td>
</tr>
<tr class="field"><th class="field-name">pre-execution:</th><td class="field-body">master node, secondary node</td>
</tr>
<tr class="field"><th class="field-name">post-execution:</th><td class="field-body">master node, secondary node</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="op-instance-migrate">
<h3><a class="toc-backref" href="#id22">OP_INSTANCE_MIGRATE</a></h3>
<p>Migrates an instance.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">directory:</th><td class="field-body">instance-failover</td>
</tr>
<tr class="field"><th class="field-name">env. vars:</th><td class="field-body">INSTANCE_MIGRATE_LIVE, INSTANCE_MIGRATE_CLEANUP</td>
</tr>
<tr class="field"><th class="field-name">pre-execution:</th><td class="field-body">master node, secondary node</td>
</tr>
<tr class="field"><th class="field-name">post-execution:</th><td class="field-body">master node, secondary node</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="op-instance-remove">
<h3><a class="toc-backref" href="#id23">OP_INSTANCE_REMOVE</a></h3>
<p>Remove an instance.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">directory:</th><td class="field-body">instance-remove</td>
</tr>
<tr class="field"><th class="field-name">env. vars:</th><td class="field-body">INSTANCE_NAME, INSTANCE_PRIMARY, INSTANCE_SECONDARIES</td>
</tr>
<tr class="field"><th class="field-name">pre-execution:</th><td class="field-body">master node</td>
</tr>
<tr class="field"><th class="field-name">post-execution:</th><td class="field-body">master node</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="op-instance-replace-disks">
<h3><a class="toc-backref" href="#id24">OP_INSTANCE_REPLACE_DISKS</a></h3>
<p>Replace an instance's disks.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">directory:</th><td class="field-body">mirror-replace</td>
</tr>
<tr class="field"><th class="field-name">env. vars:</th><td class="field-body">MODE, NEW_SECONDARY, OLD_SECONDARY</td>
</tr>
<tr class="field"><th class="field-name">pre-execution:</th><td class="field-body">master node, primary and secondary nodes</td>
</tr>
<tr class="field"><th class="field-name">post-execution:</th><td class="field-body">master node, primary and secondary nodes</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="op-instance-grow-disk">
<h3><a class="toc-backref" href="#id25">OP_INSTANCE_GROW_DISK</a></h3>
<p>Grows the disk of an instance.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">directory:</th><td class="field-body">disk-grow</td>
</tr>
<tr class="field"><th class="field-name">env. vars:</th><td class="field-body">DISK, AMOUNT</td>
</tr>
<tr class="field"><th class="field-name">pre-execution:</th><td class="field-body">master node, primary node</td>
</tr>
<tr class="field"><th class="field-name">post-execution:</th><td class="field-body">master node, primary node</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="op-instance-rename">
<h3><a class="toc-backref" href="#id26">OP_INSTANCE_RENAME</a></h3>
<p>Renames an instance.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">directory:</th><td class="field-body">instance-rename</td>
</tr>
<tr class="field"><th class="field-name">env. vars:</th><td class="field-body">INSTANCE_NEW_NAME</td>
</tr>
<tr class="field"><th class="field-name">pre-execution:</th><td class="field-body">master node, primary and secondary nodes</td>
</tr>
<tr class="field"><th class="field-name">post-execution:</th><td class="field-body">master node, primary and secondary nodes</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="cluster-operations">
<h2><a class="toc-backref" href="#id27">Cluster operations</a></h2>
<div class="section" id="op-cluster-verify">
<h3><a class="toc-backref" href="#id28">OP_CLUSTER_VERIFY</a></h3>
<p>Verifies the cluster status. This is a special LU with regard to
hooks, as the result of the opcode will be combined with the result of
post-execution hooks, in order to allow administrators to enhance the
cluster verification procedure.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">directory:</th><td class="field-body">cluster-verify</td>
</tr>
<tr class="field"><th class="field-name">env. vars:</th><td class="field-body">CLUSTER, MASTER, CLUSTER_TAGS, NODE_TAGS_&lt;name&gt;</td>
</tr>
<tr class="field"><th class="field-name">pre-execution:</th><td class="field-body">none</td>
</tr>
<tr class="field"><th class="field-name">post-execution:</th><td class="field-body">all nodes</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="op-cluster-rename">
<h3><a class="toc-backref" href="#id29">OP_CLUSTER_RENAME</a></h3>
<p>Renames the cluster.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">directory:</th><td class="field-body">cluster-rename</td>
</tr>
<tr class="field"><th class="field-name">env. vars:</th><td class="field-body">NEW_NAME</td>
</tr>
<tr class="field"><th class="field-name">pre-execution:</th><td class="field-body">master-node</td>
</tr>
<tr class="field"><th class="field-name">post-execution:</th><td class="field-body">master-node</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="op-cluster-set-params">
<h3><a class="toc-backref" href="#id30">OP_CLUSTER_SET_PARAMS</a></h3>
<p>Modifies the cluster parameters.</p>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field"><th class="field-name">directory:</th><td class="field-body">cluster-modify</td>
</tr>
<tr class="field"><th class="field-name">env. vars:</th><td class="field-body">NEW_VG_NAME</td>
</tr>
<tr class="field"><th class="field-name">pre-execution:</th><td class="field-body">master node</td>
</tr>
<tr class="field"><th class="field-name">post-execution:</th><td class="field-body">master node</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="section" id="obsolete-operations">
<h2><a class="toc-backref" href="#id31">Obsolete operations</a></h2>
<p>The following operations are no longer present or don't execute hooks
anymore in Ganeti 2.0:</p>
<ul class="simple">
<li>OP_INIT_CLUSTER</li>
<li>OP_MASTER_FAILOVER</li>
<li>OP_INSTANCE_ADD_MDDRBD</li>
<li>OP_INSTANCE_REMOVE_MDDRBD</li>
</ul>
</div>
</div>
<div class="section" id="environment-variables">
<h1><a class="toc-backref" href="#id32">Environment variables</a></h1>
<p>Note that all variables listed here are actually prefixed with
<em>GANETI_</em> in order to provide a clear namespace.</p>
<div class="section" id="common-variables">
<h2><a class="toc-backref" href="#id33">Common variables</a></h2>
<p>This is the list of environment variables supported by all operations:</p>
<dl class="docutils">
<dt>HOOKS_VERSION</dt>
<dd>Documents the hooks interface version. In case this doesnt match
what the script expects, it should not run. The documents conforms
to the version 2.</dd>
<dt>HOOKS_PHASE</dt>
<dd>One of <em>PRE</em> or <em>POST</em> denoting which phase are we in.</dd>
<dt>CLUSTER</dt>
<dd>The cluster name.</dd>
<dt>MASTER</dt>
<dd>The master node.</dd>
<dt>OP_CODE</dt>
<dd>One of the <em>OP_</em> values from the list of operations.</dd>
<dt>OBJECT_TYPE</dt>
<dd>One of <tt class="docutils literal">INSTANCE</tt>, <tt class="docutils literal">NODE</tt>, <tt class="docutils literal">CLUSTER</tt>.</dd>
<dt>DATA_DIR</dt>
<dd>The path to the Ganeti configuration directory (to read, for
example, the <em>ssconf</em> files).</dd>
</dl>
</div>
<div class="section" id="specialised-variables">
<h2><a class="toc-backref" href="#id34">Specialised variables</a></h2>
<p>This is the list of variables which are specific to one or more
operations.</p>
<dl class="docutils">
<dt>INSTANCE_NAME</dt>
<dd>The name of the instance which is the target of the operation.</dd>
<dt>INSTANCE_DISK_TEMPLATE</dt>
<dd>The disk type for the instance.</dd>
<dt>INSTANCE_DISK_COUNT</dt>
<dd>The number of disks for the instance.</dd>
<dt>INSTANCE_DISKn_SIZE</dt>
<dd>The size of disk <em>n</em> for the instance.</dd>
<dt>INSTANCE_DISKn_MODE</dt>
<dd>Either <em>rw</em> for a read-write disk or <em>ro</em> for a read-only one.</dd>
<dt>INSTANCE_NIC_COUNT</dt>
<dd>The number of NICs for the instance.</dd>
<dt>INSTANCE_NICn_BRIDGE</dt>
<dd>The bridge to which the <em>n</em> -th NIC of the instance is attached.</dd>
<dt>INSTANCE_NICn_IP</dt>
<dd>The IP (if any) of the <em>n</em> -th NIC of the instance.</dd>
<dt>INSTANCE_NICn_MAC</dt>
<dd>The MAC address of the <em>n</em> -th NIC of the instance.</dd>
<dt>INSTANCE_OS_TYPE</dt>
<dd>The name of the instance OS.</dd>
<dt>INSTANCE_PRIMARY</dt>
<dd>The name of the node which is the primary for the instance.</dd>
<dt>INSTANCE_SECONDARIES</dt>
<dd>Space-separated list of secondary nodes for the instance.</dd>
<dt>INSTANCE_MEMORY</dt>
<dd>The memory size (in MiBs) of the instance.</dd>
<dt>INSTANCE_VCPUS</dt>
<dd>The number of virtual CPUs for the instance.</dd>
<dt>INSTANCE_STATUS</dt>
<dd>The run status of the instance.</dd>
<dt>NODE_NAME</dt>
<dd>The target node of this operation (not the node on which the hook
runs).</dd>
<dt>NODE_PIP</dt>
<dd>The primary IP of the target node (the one over which inter-node
communication is done).</dd>
<dt>NODE_SIP</dt>
<dd>The secondary IP of the target node (the one over which drbd
replication is done). This can be equal to the primary ip, in case
the cluster is not dual-homed.</dd>
<dt>FORCE</dt>
<dd>This is provided by some operations when the user gave this flag.</dd>
<dt>IGNORE_CONSISTENCY</dt>
<dd>The user has specified this flag. It is used when failing over
instances in case the primary node is down.</dd>
<dt>ADD_MODE</dt>
<dd>The mode of the instance create: either <em>create</em> for create from
scratch or <em>import</em> for restoring from an exported image.</dd>
<dt>SRC_NODE, SRC_PATH, SRC_IMAGE</dt>
<dd>In case the instance has been added by import, these variables are
defined and point to the source node, source path (the directory
containing the image and the config file) and the source disk image
file.</dd>
<dt>NEW_SECONDARY</dt>
<dd>The name of the node on which the new mirror component is being
added. This can be the name of the current secondary, if the new
mirror is on the same secondary.</dd>
<dt>OLD_SECONDARY</dt>
<dd>The name of the old secondary in the replace-disks command Note that
this can be equal to the new secondary if the secondary node hasn't
actually changed.</dd>
<dt>EXPORT_NODE</dt>
<dd>The node on which the exported image of the instance was done.</dd>
<dt>EXPORT_DO_SHUTDOWN</dt>
<dd>This variable tells if the instance has been shutdown or not while
doing the export. In the &quot;was shutdown&quot; case, it's likely that the
filesystem is consistent, whereas in the &quot;did not shutdown&quot; case,
the filesystem would need a check (journal replay or full fsck) in
order to guarantee consistency.</dd>
<dt>CLUSTER_TAGS</dt>
<dd>The list of cluster tags, space separated.</dd>
<dt>NODE_TAGS_&lt;name&gt;</dt>
<dd>The list of tags for node <em>&lt;name&gt;</em>, space separated.</dd>
</dl>
</div>
</div>
<div class="section" id="examples">
<h1><a class="toc-backref" href="#id35">Examples</a></h1>
<p>The startup of an instance will pass this environment to the hook
script:</p>
<pre class="literal-block">
GANETI_CLUSTER=cluster1.example.com
GANETI_DATA_DIR=/var/lib/ganeti
GANETI_FORCE=False
GANETI_HOOKS_PATH=instance-start
GANETI_HOOKS_PHASE=post
GANETI_HOOKS_VERSION=2
GANETI_INSTANCE_DISK0_MODE=rw
GANETI_INSTANCE_DISK0_SIZE=128
GANETI_INSTANCE_DISK_COUNT=1
GANETI_INSTANCE_DISK_TEMPLATE=drbd
GANETI_INSTANCE_MEMORY=128
GANETI_INSTANCE_NAME=instance2.example.com
GANETI_INSTANCE_NIC0_BRIDGE=xen-br0
GANETI_INSTANCE_NIC0_IP=
GANETI_INSTANCE_NIC0_MAC=aa:00:00:a5:91:58
GANETI_INSTANCE_NIC_COUNT=1
GANETI_INSTANCE_OS_TYPE=debootstrap
GANETI_INSTANCE_PRIMARY=node3.example.com
GANETI_INSTANCE_SECONDARIES=node5.example.com
GANETI_INSTANCE_STATUS=down
GANETI_INSTANCE_VCPUS=1
GANETI_MASTER=node1.example.com
GANETI_OBJECT_TYPE=INSTANCE
GANETI_OP_CODE=OP_INSTANCE_STARTUP
GANETI_OP_TARGET=instance2.example.com
</pre>
</div>
</div>
</body>
</html>
