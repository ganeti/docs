<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/Ganeti/Query/Node.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-comment'>{-| Implementation of the Ganeti Query2 node queries.
<a name="line-2"></a>
<a name="line-3"></a> -}</span>
<a name="line-4"></a>
<a name="line-5"></a><span class='hs-comment'>{-
<a name="line-6"></a>
<a name="line-7"></a>Copyright (C) 2012, 2013 Google Inc.
<a name="line-8"></a>All rights reserved.
<a name="line-9"></a>
<a name="line-10"></a>Redistribution and use in source and binary forms, with or without
<a name="line-11"></a>modification, are permitted provided that the following conditions are
<a name="line-12"></a>met:
<a name="line-13"></a>
<a name="line-14"></a>1. Redistributions of source code must retain the above copyright notice,
<a name="line-15"></a>this list of conditions and the following disclaimer.
<a name="line-16"></a>
<a name="line-17"></a>2. Redistributions in binary form must reproduce the above copyright
<a name="line-18"></a>notice, this list of conditions and the following disclaimer in the
<a name="line-19"></a>documentation and/or other materials provided with the distribution.
<a name="line-20"></a>
<a name="line-21"></a>THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS
<a name="line-22"></a>IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
<a name="line-23"></a>TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
<a name="line-24"></a>PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR
<a name="line-25"></a>CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
<a name="line-26"></a>EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,
<a name="line-27"></a>PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
<a name="line-28"></a>PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
<a name="line-29"></a>LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
<a name="line-30"></a>NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
<a name="line-31"></a>SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
<a name="line-32"></a>
<a name="line-33"></a>-}</span>
<a name="line-34"></a>
<a name="line-35"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>Ganeti</span><span class='hs-varop'>.</span><span class='hs-conid'>Query</span><span class='hs-varop'>.</span><span class='hs-conid'>Node</span>
<a name="line-36"></a>  <span class='hs-layout'>(</span> <span class='hs-conid'>Runtime</span>
<a name="line-37"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>fieldsMap</span>
<a name="line-38"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>collectLiveData</span>
<a name="line-39"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-40"></a>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Applicative</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Map</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>Map</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-keyword'>qualified</span> <span class='hs-conid'>Text</span><span class='hs-varop'>.</span><span class='hs-conid'>JSON</span> <span class='hs-keyword'>as</span> <span class='hs-conid'>J</span>
<a name="line-46"></a>
<a name="line-47"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Ganeti</span><span class='hs-varop'>.</span><span class='hs-conid'>Config</span>
<a name="line-48"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Ganeti</span><span class='hs-varop'>.</span><span class='hs-conid'>Common</span>
<a name="line-49"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Ganeti</span><span class='hs-varop'>.</span><span class='hs-conid'>Objects</span>
<a name="line-50"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Ganeti</span><span class='hs-varop'>.</span><span class='hs-conid'>JSON</span>
<a name="line-51"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Ganeti</span><span class='hs-varop'>.</span><span class='hs-conid'>Rpc</span>
<a name="line-52"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Ganeti</span><span class='hs-varop'>.</span><span class='hs-conid'>Types</span>
<a name="line-53"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Ganeti</span><span class='hs-varop'>.</span><span class='hs-conid'>Query</span><span class='hs-varop'>.</span><span class='hs-conid'>Language</span>
<a name="line-54"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Ganeti</span><span class='hs-varop'>.</span><span class='hs-conid'>Query</span><span class='hs-varop'>.</span><span class='hs-conid'>Common</span>
<a name="line-55"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Ganeti</span><span class='hs-varop'>.</span><span class='hs-conid'>Query</span><span class='hs-varop'>.</span><span class='hs-conid'>Types</span>
<a name="line-56"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Ganeti</span><span class='hs-varop'>.</span><span class='hs-conid'>Storage</span><span class='hs-varop'>.</span><span class='hs-conid'>Utils</span>
<a name="line-57"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Ganeti</span><span class='hs-varop'>.</span><span class='hs-conid'>Utils</span> <span class='hs-layout'>(</span><span class='hs-varid'>niceSort</span><span class='hs-layout'>)</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="Runtime"></a><span class='hs-comment'>-- | Runtime is the resulting type for NodeInfo call.</span>
<a name="line-60"></a><a name="Runtime"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Runtime</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Either</span> <span class='hs-conid'>RpcError</span> <span class='hs-conid'>RpcResultNodeInfo</span>
<a name="line-61"></a>
<a name="line-62"></a><a name="nodeLiveFieldsDefs"></a><span class='hs-comment'>-- | List of node live fields.</span>
<a name="line-63"></a><span class='hs-definition'>nodeLiveFieldsDefs</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>FieldName</span><span class='hs-layout'>,</span> <span class='hs-conid'>FieldTitle</span><span class='hs-layout'>,</span> <span class='hs-conid'>FieldType</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>FieldDoc</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-64"></a><span class='hs-definition'>nodeLiveFieldsDefs</span> <span class='hs-keyglyph'>=</span>
<a name="line-65"></a>  <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-str'>"bootid"</span><span class='hs-layout'>,</span> <span class='hs-str'>"BootID"</span><span class='hs-layout'>,</span> <span class='hs-conid'>QFTText</span><span class='hs-layout'>,</span> <span class='hs-str'>"bootid"</span><span class='hs-layout'>,</span>
<a name="line-66"></a>     <span class='hs-str'>"Random UUID renewed for each system reboot, can be used\
<a name="line-67"></a>     \ for detecting reboots by tracking changes"</span><span class='hs-layout'>)</span>
<a name="line-68"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"cnodes"</span><span class='hs-layout'>,</span> <span class='hs-str'>"CNodes"</span><span class='hs-layout'>,</span> <span class='hs-conid'>QFTNumber</span><span class='hs-layout'>,</span> <span class='hs-str'>"cpu_nodes"</span><span class='hs-layout'>,</span>
<a name="line-69"></a>     <span class='hs-str'>"Number of NUMA domains on node (if exported by hypervisor)"</span><span class='hs-layout'>)</span>
<a name="line-70"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"cnos"</span><span class='hs-layout'>,</span> <span class='hs-str'>"CNOs"</span><span class='hs-layout'>,</span> <span class='hs-conid'>QFTNumber</span><span class='hs-layout'>,</span> <span class='hs-str'>"cpu_dom0"</span><span class='hs-layout'>,</span>
<a name="line-71"></a>     <span class='hs-str'>"Number of logical processors used by the node OS (dom0 for Xen)"</span><span class='hs-layout'>)</span>
<a name="line-72"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"csockets"</span><span class='hs-layout'>,</span> <span class='hs-str'>"CSockets"</span><span class='hs-layout'>,</span> <span class='hs-conid'>QFTNumber</span><span class='hs-layout'>,</span> <span class='hs-str'>"cpu_sockets"</span><span class='hs-layout'>,</span>
<a name="line-73"></a>     <span class='hs-str'>"Number of physical CPU sockets (if exported by hypervisor)"</span><span class='hs-layout'>)</span>
<a name="line-74"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"ctotal"</span><span class='hs-layout'>,</span> <span class='hs-str'>"CTotal"</span><span class='hs-layout'>,</span> <span class='hs-conid'>QFTNumber</span><span class='hs-layout'>,</span> <span class='hs-str'>"cpu_total"</span><span class='hs-layout'>,</span>
<a name="line-75"></a>     <span class='hs-str'>"Number of logical processors"</span><span class='hs-layout'>)</span>
<a name="line-76"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"dfree"</span><span class='hs-layout'>,</span> <span class='hs-str'>"DFree"</span><span class='hs-layout'>,</span> <span class='hs-conid'>QFTUnit</span><span class='hs-layout'>,</span> <span class='hs-str'>"storage_free"</span><span class='hs-layout'>,</span>
<a name="line-77"></a>     <span class='hs-str'>"Available storage space on storage unit"</span><span class='hs-layout'>)</span>
<a name="line-78"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"dtotal"</span><span class='hs-layout'>,</span> <span class='hs-str'>"DTotal"</span><span class='hs-layout'>,</span> <span class='hs-conid'>QFTUnit</span><span class='hs-layout'>,</span> <span class='hs-str'>"storage_size"</span><span class='hs-layout'>,</span>
<a name="line-79"></a>     <span class='hs-str'>"Total storage space on storage unit for instance disk allocation"</span><span class='hs-layout'>)</span>
<a name="line-80"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"spfree"</span><span class='hs-layout'>,</span> <span class='hs-str'>"SpFree"</span><span class='hs-layout'>,</span> <span class='hs-conid'>QFTNumber</span><span class='hs-layout'>,</span> <span class='hs-str'>"spindles_free"</span><span class='hs-layout'>,</span>
<a name="line-81"></a>     <span class='hs-str'>"Available spindles in volume group (exclusive storage only)"</span><span class='hs-layout'>)</span>
<a name="line-82"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"sptotal"</span><span class='hs-layout'>,</span> <span class='hs-str'>"SpTotal"</span><span class='hs-layout'>,</span> <span class='hs-conid'>QFTNumber</span><span class='hs-layout'>,</span> <span class='hs-str'>"spindles_total"</span><span class='hs-layout'>,</span>
<a name="line-83"></a>     <span class='hs-str'>"Total spindles in volume group (exclusive storage only)"</span><span class='hs-layout'>)</span>
<a name="line-84"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"mfree"</span><span class='hs-layout'>,</span> <span class='hs-str'>"MFree"</span><span class='hs-layout'>,</span> <span class='hs-conid'>QFTUnit</span><span class='hs-layout'>,</span> <span class='hs-str'>"memory_free"</span><span class='hs-layout'>,</span>
<a name="line-85"></a>     <span class='hs-str'>"Memory available for instance allocations"</span><span class='hs-layout'>)</span>
<a name="line-86"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"mnode"</span><span class='hs-layout'>,</span> <span class='hs-str'>"MNode"</span><span class='hs-layout'>,</span> <span class='hs-conid'>QFTUnit</span><span class='hs-layout'>,</span> <span class='hs-str'>"memory_dom0"</span><span class='hs-layout'>,</span>
<a name="line-87"></a>     <span class='hs-str'>"Amount of memory used by node (dom0 for Xen)"</span><span class='hs-layout'>)</span>
<a name="line-88"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"mtotal"</span><span class='hs-layout'>,</span> <span class='hs-str'>"MTotal"</span><span class='hs-layout'>,</span> <span class='hs-conid'>QFTUnit</span><span class='hs-layout'>,</span> <span class='hs-str'>"memory_total"</span><span class='hs-layout'>,</span>
<a name="line-89"></a>     <span class='hs-str'>"Total amount of memory of physical machine"</span><span class='hs-layout'>)</span>
<a name="line-90"></a>  <span class='hs-keyglyph'>]</span>
<a name="line-91"></a>
<a name="line-92"></a><a name="getAttrFromStorageInfo"></a><span class='hs-comment'>-- | Helper function to extract an attribute from a maybe StorageType</span>
<a name="line-93"></a><span class='hs-definition'>getAttrFromStorageInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-conid'>JSON</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>StorageInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-94"></a>                       <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>StorageInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-conid'>JSValue</span>
<a name="line-95"></a><span class='hs-definition'>getAttrFromStorageInfo</span> <span class='hs-varid'>attr_fn</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>info</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-96"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>attr_fn</span> <span class='hs-varid'>info</span> <span class='hs-keyword'>of</span>
<a name="line-97"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>val</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-varid'>showJSON</span> <span class='hs-varid'>val</span>
<a name="line-98"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-conid'>JSNull</span>
<a name="line-99"></a><span class='hs-definition'>getAttrFromStorageInfo</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-conid'>JSNull</span>
<a name="line-100"></a>
<a name="line-101"></a><a name="isStorageInfoOfType"></a><span class='hs-comment'>-- | Check whether the given storage info fits to the given storage type</span>
<a name="line-102"></a><span class='hs-definition'>isStorageInfoOfType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>StorageType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StorageInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-103"></a><span class='hs-definition'>isStorageInfoOfType</span> <span class='hs-varid'>stype</span> <span class='hs-varid'>sinfo</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>storageInfoType</span> <span class='hs-varid'>sinfo</span> <span class='hs-varop'>==</span>
<a name="line-104"></a>    <span class='hs-varid'>storageTypeToRaw</span> <span class='hs-varid'>stype</span>
<a name="line-105"></a>
<a name="line-106"></a><a name="getStorageInfoForDefault"></a><span class='hs-comment'>-- | Get storage info for the default storage unit</span>
<a name="line-107"></a><span class='hs-definition'>getStorageInfoForDefault</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StorageInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>StorageInfo</span>
<a name="line-108"></a><span class='hs-definition'>getStorageInfoForDefault</span> <span class='hs-varid'>sinfos</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>listToMaybe</span> <span class='hs-varop'>$</span> <span class='hs-varid'>filter</span>
<a name="line-109"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isStorageInfoOfType</span> <span class='hs-conid'>StorageLvmPv</span><span class='hs-layout'>)</span> <span class='hs-varid'>sinfos</span>
<a name="line-110"></a>
<a name="line-111"></a><a name="getStorageInfoForType"></a><span class='hs-comment'>-- | Gets the storage info for a storage type</span>
<a name="line-112"></a><span class='hs-comment'>-- FIXME: This needs to be extended when storage pools are implemented,</span>
<a name="line-113"></a><span class='hs-comment'>-- because storage types are not necessarily unique then</span>
<a name="line-114"></a><span class='hs-definition'>getStorageInfoForType</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>StorageInfo</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>StorageType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>StorageInfo</span>
<a name="line-115"></a><span class='hs-definition'>getStorageInfoForType</span> <span class='hs-varid'>sinfos</span> <span class='hs-varid'>stype</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>listToMaybe</span> <span class='hs-varop'>$</span> <span class='hs-varid'>filter</span>
<a name="line-116"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>isStorageInfoOfType</span> <span class='hs-varid'>stype</span><span class='hs-layout'>)</span> <span class='hs-varid'>sinfos</span>
<a name="line-117"></a>
<a name="line-118"></a><a name="nodeLiveFieldExtract"></a><span class='hs-comment'>-- | Map each name to a function that extracts that value from</span>
<a name="line-119"></a><span class='hs-comment'>-- the RPC result.</span>
<a name="line-120"></a><span class='hs-definition'>nodeLiveFieldExtract</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FieldName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>RpcResultNodeInfo</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-conid'>JSValue</span>
<a name="line-121"></a><span class='hs-definition'>nodeLiveFieldExtract</span> <span class='hs-str'>"bootid"</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>=</span>
<a name="line-122"></a>  <span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-varid'>showJSON</span> <span class='hs-varop'>$</span> <span class='hs-varid'>rpcResNodeInfoBootId</span> <span class='hs-varid'>res</span>
<a name="line-123"></a><span class='hs-definition'>nodeLiveFieldExtract</span> <span class='hs-str'>"cnodes"</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>=</span>
<a name="line-124"></a>  <span class='hs-varid'>jsonHead</span> <span class='hs-layout'>(</span><span class='hs-varid'>rpcResNodeInfoHvInfo</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-varid'>hvInfoCpuNodes</span>
<a name="line-125"></a><span class='hs-definition'>nodeLiveFieldExtract</span> <span class='hs-str'>"cnos"</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>=</span>
<a name="line-126"></a>  <span class='hs-varid'>jsonHead</span> <span class='hs-layout'>(</span><span class='hs-varid'>rpcResNodeInfoHvInfo</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-varid'>hvInfoCpuDom0</span>
<a name="line-127"></a><span class='hs-definition'>nodeLiveFieldExtract</span> <span class='hs-str'>"csockets"</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>=</span>
<a name="line-128"></a>  <span class='hs-varid'>jsonHead</span> <span class='hs-layout'>(</span><span class='hs-varid'>rpcResNodeInfoHvInfo</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-varid'>hvInfoCpuSockets</span>
<a name="line-129"></a><span class='hs-definition'>nodeLiveFieldExtract</span> <span class='hs-str'>"ctotal"</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>=</span>
<a name="line-130"></a>  <span class='hs-varid'>jsonHead</span> <span class='hs-layout'>(</span><span class='hs-varid'>rpcResNodeInfoHvInfo</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-varid'>hvInfoCpuTotal</span>
<a name="line-131"></a><span class='hs-definition'>nodeLiveFieldExtract</span> <span class='hs-str'>"dfree"</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>=</span>
<a name="line-132"></a>  <span class='hs-varid'>getAttrFromStorageInfo</span> <span class='hs-varid'>storageInfoStorageFree</span> <span class='hs-layout'>(</span><span class='hs-varid'>getStorageInfoForDefault</span>
<a name="line-133"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>rpcResNodeInfoStorageInfo</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-134"></a><span class='hs-definition'>nodeLiveFieldExtract</span> <span class='hs-str'>"dtotal"</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>=</span>
<a name="line-135"></a>  <span class='hs-varid'>getAttrFromStorageInfo</span> <span class='hs-varid'>storageInfoStorageSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>getStorageInfoForDefault</span>
<a name="line-136"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>rpcResNodeInfoStorageInfo</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-137"></a><span class='hs-definition'>nodeLiveFieldExtract</span> <span class='hs-str'>"spfree"</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>=</span>
<a name="line-138"></a>  <span class='hs-varid'>getAttrFromStorageInfo</span> <span class='hs-varid'>storageInfoStorageFree</span> <span class='hs-layout'>(</span><span class='hs-varid'>getStorageInfoForType</span>
<a name="line-139"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>rpcResNodeInfoStorageInfo</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-conid'>StorageLvmPv</span><span class='hs-layout'>)</span>
<a name="line-140"></a><span class='hs-definition'>nodeLiveFieldExtract</span> <span class='hs-str'>"sptotal"</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>=</span>
<a name="line-141"></a>  <span class='hs-varid'>getAttrFromStorageInfo</span> <span class='hs-varid'>storageInfoStorageSize</span> <span class='hs-layout'>(</span><span class='hs-varid'>getStorageInfoForType</span>
<a name="line-142"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>rpcResNodeInfoStorageInfo</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-conid'>StorageLvmPv</span><span class='hs-layout'>)</span>
<a name="line-143"></a><span class='hs-definition'>nodeLiveFieldExtract</span> <span class='hs-str'>"mfree"</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>=</span>
<a name="line-144"></a>  <span class='hs-varid'>jsonHead</span> <span class='hs-layout'>(</span><span class='hs-varid'>rpcResNodeInfoHvInfo</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-varid'>hvInfoMemoryFree</span>
<a name="line-145"></a><span class='hs-definition'>nodeLiveFieldExtract</span> <span class='hs-str'>"mnode"</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>=</span>
<a name="line-146"></a>  <span class='hs-varid'>jsonHead</span> <span class='hs-layout'>(</span><span class='hs-varid'>rpcResNodeInfoHvInfo</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-varid'>hvInfoMemoryDom0</span>
<a name="line-147"></a><span class='hs-definition'>nodeLiveFieldExtract</span> <span class='hs-str'>"mtotal"</span> <span class='hs-varid'>res</span> <span class='hs-keyglyph'>=</span>
<a name="line-148"></a>  <span class='hs-varid'>jsonHead</span> <span class='hs-layout'>(</span><span class='hs-varid'>rpcResNodeInfoHvInfo</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-varid'>hvInfoMemoryTotal</span>
<a name="line-149"></a><span class='hs-definition'>nodeLiveFieldExtract</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-conid'>JSNull</span>
<a name="line-150"></a>
<a name="line-151"></a><a name="nodeLiveRpcCall"></a><span class='hs-comment'>-- | Helper for extracting field from RPC result.</span>
<a name="line-152"></a><span class='hs-definition'>nodeLiveRpcCall</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FieldName</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Runtime</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Node</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ResultEntry</span>
<a name="line-153"></a><span class='hs-definition'>nodeLiveRpcCall</span> <span class='hs-varid'>fname</span> <span class='hs-layout'>(</span><span class='hs-conid'>Right</span> <span class='hs-varid'>res</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span>
<a name="line-154"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>nodeLiveFieldExtract</span> <span class='hs-varid'>fname</span> <span class='hs-varid'>res</span> <span class='hs-keyword'>of</span>
<a name="line-155"></a>    <span class='hs-conid'>J</span><span class='hs-varop'>.</span><span class='hs-conid'>JSNull</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>rsNoData</span>
<a name="line-156"></a>    <span class='hs-varid'>x</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>rsNormal</span> <span class='hs-varid'>x</span>
<a name="line-157"></a><span class='hs-definition'>nodeLiveRpcCall</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>Left</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span>
<a name="line-158"></a>    <span class='hs-conid'>ResultEntry</span> <span class='hs-layout'>(</span><span class='hs-varid'>rpcErrorToStatus</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span> <span class='hs-conid'>Nothing</span>
<a name="line-159"></a>
<a name="line-160"></a><a name="nodeLiveFieldBuilder"></a><span class='hs-comment'>-- | Builder for node live fields.</span>
<a name="line-161"></a><span class='hs-definition'>nodeLiveFieldBuilder</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>FieldName</span><span class='hs-layout'>,</span> <span class='hs-conid'>FieldTitle</span><span class='hs-layout'>,</span> <span class='hs-conid'>FieldType</span><span class='hs-layout'>,</span> <span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>FieldDoc</span><span class='hs-layout'>)</span>
<a name="line-162"></a>                     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>FieldData</span> <span class='hs-conid'>Node</span> <span class='hs-conid'>Runtime</span>
<a name="line-163"></a><span class='hs-definition'>nodeLiveFieldBuilder</span> <span class='hs-layout'>(</span><span class='hs-varid'>fname</span><span class='hs-layout'>,</span> <span class='hs-varid'>ftitle</span><span class='hs-layout'>,</span> <span class='hs-varid'>ftype</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>fdoc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span>
<a name="line-164"></a>  <span class='hs-layout'>(</span> <span class='hs-conid'>FieldDefinition</span> <span class='hs-varid'>fname</span> <span class='hs-varid'>ftitle</span> <span class='hs-varid'>ftype</span> <span class='hs-varid'>fdoc</span>
<a name="line-165"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>FieldRuntime</span> <span class='hs-varop'>$</span> <span class='hs-varid'>nodeLiveRpcCall</span> <span class='hs-varid'>fname</span>
<a name="line-166"></a>  <span class='hs-layout'>,</span> <span class='hs-conid'>QffNormal</span><span class='hs-layout'>)</span>
<a name="line-167"></a>
<a name="line-168"></a><a name="nodeRoleDoc"></a><span class='hs-comment'>-- | The docstring for the node role. Note that we use 'reverse' in</span>
<a name="line-169"></a><span class='hs-comment'>-- order to keep the same order as Python.</span>
<a name="line-170"></a><span class='hs-definition'>nodeRoleDoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>String</span>
<a name="line-171"></a><span class='hs-definition'>nodeRoleDoc</span> <span class='hs-keyglyph'>=</span>
<a name="line-172"></a>  <span class='hs-str'>"Node role; "</span> <span class='hs-varop'>++</span>
<a name="line-173"></a>  <span class='hs-varid'>intercalate</span> <span class='hs-str'>", "</span>
<a name="line-174"></a>   <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>role</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-175"></a>          <span class='hs-str'>"\""</span> <span class='hs-varop'>++</span> <span class='hs-varid'>nodeRoleToRaw</span> <span class='hs-varid'>role</span> <span class='hs-varop'>++</span> <span class='hs-str'>"\" for "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>roleDescription</span> <span class='hs-varid'>role</span><span class='hs-layout'>)</span>
<a name="line-176"></a>   <span class='hs-layout'>(</span><span class='hs-varid'>reverse</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>minBound</span><span class='hs-keyglyph'>..</span><span class='hs-varid'>maxBound</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-177"></a>
<a name="line-178"></a><a name="getNodePower"></a><span class='hs-comment'>-- | Get node powered status.</span>
<a name="line-179"></a><span class='hs-definition'>getNodePower</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ConfigData</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Node</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ResultEntry</span>
<a name="line-180"></a><span class='hs-definition'>getNodePower</span> <span class='hs-varid'>cfg</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>=</span>
<a name="line-181"></a>  <span class='hs-keyword'>case</span> <span class='hs-varid'>getNodeNdParams</span> <span class='hs-varid'>cfg</span> <span class='hs-varid'>node</span> <span class='hs-keyword'>of</span>
<a name="line-182"></a>    <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>rsNoData</span>
<a name="line-183"></a>    <span class='hs-conid'>Just</span> <span class='hs-varid'>ndp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>ndpOobProgram</span> <span class='hs-varid'>ndp</span><span class='hs-layout'>)</span>
<a name="line-184"></a>                  <span class='hs-keyword'>then</span> <span class='hs-varid'>rsUnavail</span>
<a name="line-185"></a>                  <span class='hs-keyword'>else</span> <span class='hs-varid'>rsNormal</span> <span class='hs-layout'>(</span><span class='hs-varid'>nodePowered</span> <span class='hs-varid'>node</span><span class='hs-layout'>)</span>
<a name="line-186"></a>
<a name="line-187"></a><a name="nodeFields"></a><span class='hs-comment'>-- | List of all node fields.</span>
<a name="line-188"></a><span class='hs-definition'>nodeFields</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FieldList</span> <span class='hs-conid'>Node</span> <span class='hs-conid'>Runtime</span>
<a name="line-189"></a><span class='hs-definition'>nodeFields</span> <span class='hs-keyglyph'>=</span>
<a name="line-190"></a>  <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-conid'>FieldDefinition</span> <span class='hs-str'>"drained"</span> <span class='hs-str'>"Drained"</span> <span class='hs-conid'>QFTBool</span> <span class='hs-str'>"Whether node is drained"</span><span class='hs-layout'>,</span>
<a name="line-191"></a>     <span class='hs-conid'>FieldSimple</span> <span class='hs-layout'>(</span><span class='hs-varid'>rsNormal</span> <span class='hs-varop'>.</span> <span class='hs-varid'>nodeDrained</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>QffNormal</span><span class='hs-layout'>)</span>
<a name="line-192"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>FieldDefinition</span> <span class='hs-str'>"master_candidate"</span> <span class='hs-str'>"MasterC"</span> <span class='hs-conid'>QFTBool</span>
<a name="line-193"></a>       <span class='hs-str'>"Whether node is a master candidate"</span><span class='hs-layout'>,</span>
<a name="line-194"></a>     <span class='hs-conid'>FieldSimple</span> <span class='hs-layout'>(</span><span class='hs-varid'>rsNormal</span> <span class='hs-varop'>.</span> <span class='hs-varid'>nodeMasterCandidate</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>QffNormal</span><span class='hs-layout'>)</span>
<a name="line-195"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>FieldDefinition</span> <span class='hs-str'>"master_capable"</span> <span class='hs-str'>"MasterCapable"</span> <span class='hs-conid'>QFTBool</span>
<a name="line-196"></a>       <span class='hs-str'>"Whether node can become a master candidate"</span><span class='hs-layout'>,</span>
<a name="line-197"></a>     <span class='hs-conid'>FieldSimple</span> <span class='hs-layout'>(</span><span class='hs-varid'>rsNormal</span> <span class='hs-varop'>.</span> <span class='hs-varid'>nodeMasterCapable</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>QffNormal</span><span class='hs-layout'>)</span>
<a name="line-198"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>FieldDefinition</span> <span class='hs-str'>"name"</span> <span class='hs-str'>"Node"</span> <span class='hs-conid'>QFTText</span> <span class='hs-str'>"Node name"</span><span class='hs-layout'>,</span>
<a name="line-199"></a>     <span class='hs-conid'>FieldSimple</span> <span class='hs-layout'>(</span><span class='hs-varid'>rsNormal</span> <span class='hs-varop'>.</span> <span class='hs-varid'>nodeName</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>QffHostname</span><span class='hs-layout'>)</span>
<a name="line-200"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>FieldDefinition</span> <span class='hs-str'>"offline"</span> <span class='hs-str'>"Offline"</span> <span class='hs-conid'>QFTBool</span>
<a name="line-201"></a>       <span class='hs-str'>"Whether node is marked offline"</span><span class='hs-layout'>,</span>
<a name="line-202"></a>     <span class='hs-conid'>FieldSimple</span> <span class='hs-layout'>(</span><span class='hs-varid'>rsNormal</span> <span class='hs-varop'>.</span> <span class='hs-varid'>nodeOffline</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>QffNormal</span><span class='hs-layout'>)</span>
<a name="line-203"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>FieldDefinition</span> <span class='hs-str'>"vm_capable"</span> <span class='hs-str'>"VMCapable"</span> <span class='hs-conid'>QFTBool</span>
<a name="line-204"></a>       <span class='hs-str'>"Whether node can host instances"</span><span class='hs-layout'>,</span>
<a name="line-205"></a>     <span class='hs-conid'>FieldSimple</span> <span class='hs-layout'>(</span><span class='hs-varid'>rsNormal</span> <span class='hs-varop'>.</span> <span class='hs-varid'>nodeVmCapable</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>QffNormal</span><span class='hs-layout'>)</span>
<a name="line-206"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>FieldDefinition</span> <span class='hs-str'>"pip"</span> <span class='hs-str'>"PrimaryIP"</span> <span class='hs-conid'>QFTText</span> <span class='hs-str'>"Primary IP address"</span><span class='hs-layout'>,</span>
<a name="line-207"></a>     <span class='hs-conid'>FieldSimple</span> <span class='hs-layout'>(</span><span class='hs-varid'>rsNormal</span> <span class='hs-varop'>.</span> <span class='hs-varid'>nodePrimaryIp</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>QffNormal</span><span class='hs-layout'>)</span>
<a name="line-208"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>FieldDefinition</span> <span class='hs-str'>"sip"</span> <span class='hs-str'>"SecondaryIP"</span> <span class='hs-conid'>QFTText</span> <span class='hs-str'>"Secondary IP address"</span><span class='hs-layout'>,</span>
<a name="line-209"></a>     <span class='hs-conid'>FieldSimple</span> <span class='hs-layout'>(</span><span class='hs-varid'>rsNormal</span> <span class='hs-varop'>.</span> <span class='hs-varid'>nodeSecondaryIp</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>QffNormal</span><span class='hs-layout'>)</span>
<a name="line-210"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>FieldDefinition</span> <span class='hs-str'>"master"</span> <span class='hs-str'>"IsMaster"</span> <span class='hs-conid'>QFTBool</span> <span class='hs-str'>"Whether node is master"</span><span class='hs-layout'>,</span>
<a name="line-211"></a>     <span class='hs-conid'>FieldConfig</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>cfg</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-212"></a>                    <span class='hs-varid'>rsNormal</span> <span class='hs-layout'>(</span><span class='hs-varid'>nodeUuid</span> <span class='hs-varid'>node</span> <span class='hs-varop'>==</span>
<a name="line-213"></a>                              <span class='hs-varid'>clusterMasterNode</span> <span class='hs-layout'>(</span><span class='hs-varid'>configCluster</span> <span class='hs-varid'>cfg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-214"></a>     <span class='hs-conid'>QffNormal</span><span class='hs-layout'>)</span>
<a name="line-215"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>FieldDefinition</span> <span class='hs-str'>"group"</span> <span class='hs-str'>"Group"</span> <span class='hs-conid'>QFTText</span> <span class='hs-str'>"Node group"</span><span class='hs-layout'>,</span>
<a name="line-216"></a>     <span class='hs-conid'>FieldConfig</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>cfg</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-217"></a>                    <span class='hs-varid'>rsMaybeNoData</span> <span class='hs-layout'>(</span><span class='hs-varid'>groupName</span> <span class='hs-varop'>&lt;$&gt;</span> <span class='hs-varid'>getGroupOfNode</span> <span class='hs-varid'>cfg</span> <span class='hs-varid'>node</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-218"></a>     <span class='hs-conid'>QffNormal</span><span class='hs-layout'>)</span>
<a name="line-219"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>FieldDefinition</span> <span class='hs-str'>"group.uuid"</span> <span class='hs-str'>"GroupUUID"</span> <span class='hs-conid'>QFTText</span> <span class='hs-str'>"UUID of node group"</span><span class='hs-layout'>,</span>
<a name="line-220"></a>     <span class='hs-conid'>FieldSimple</span> <span class='hs-layout'>(</span><span class='hs-varid'>rsNormal</span> <span class='hs-varop'>.</span> <span class='hs-varid'>nodeGroup</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>QffNormal</span><span class='hs-layout'>)</span>
<a name="line-221"></a>  <span class='hs-layout'>,</span>  <span class='hs-layout'>(</span><span class='hs-conid'>FieldDefinition</span> <span class='hs-str'>"ndparams"</span> <span class='hs-str'>"NodeParameters"</span> <span class='hs-conid'>QFTOther</span>
<a name="line-222"></a>        <span class='hs-str'>"Merged node parameters"</span><span class='hs-layout'>,</span>
<a name="line-223"></a>      <span class='hs-conid'>FieldConfig</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>rsMaybeNoData</span> <span class='hs-varop'>.</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getNodeNdParams</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>QffNormal</span><span class='hs-layout'>)</span>
<a name="line-224"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>FieldDefinition</span> <span class='hs-str'>"custom_ndparams"</span> <span class='hs-str'>"CustomNodeParameters"</span> <span class='hs-conid'>QFTOther</span>
<a name="line-225"></a>                       <span class='hs-str'>"Custom node parameters"</span><span class='hs-layout'>,</span>
<a name="line-226"></a>     <span class='hs-conid'>FieldSimple</span> <span class='hs-layout'>(</span><span class='hs-varid'>rsNormal</span> <span class='hs-varop'>.</span> <span class='hs-varid'>nodeNdparams</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>QffNormal</span><span class='hs-layout'>)</span>
<a name="line-227"></a>  <span class='hs-comment'>-- FIXME: the below could be generalised a bit, like in Python</span>
<a name="line-228"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>FieldDefinition</span> <span class='hs-str'>"pinst_cnt"</span> <span class='hs-str'>"Pinst"</span> <span class='hs-conid'>QFTNumber</span>
<a name="line-229"></a>       <span class='hs-str'>"Number of instances with this node as primary"</span><span class='hs-layout'>,</span>
<a name="line-230"></a>     <span class='hs-conid'>FieldConfig</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>cfg</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-231"></a>                    <span class='hs-varid'>rsNormal</span> <span class='hs-varop'>.</span> <span class='hs-varid'>length</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getNodeInstances</span> <span class='hs-varid'>cfg</span> <span class='hs-varop'>.</span> <span class='hs-varid'>nodeUuid</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-232"></a>     <span class='hs-conid'>QffNormal</span><span class='hs-layout'>)</span>
<a name="line-233"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>FieldDefinition</span> <span class='hs-str'>"sinst_cnt"</span> <span class='hs-str'>"Sinst"</span> <span class='hs-conid'>QFTNumber</span>
<a name="line-234"></a>       <span class='hs-str'>"Number of instances with this node as secondary"</span><span class='hs-layout'>,</span>
<a name="line-235"></a>     <span class='hs-conid'>FieldConfig</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>cfg</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-236"></a>                    <span class='hs-varid'>rsNormal</span> <span class='hs-varop'>.</span> <span class='hs-varid'>length</span> <span class='hs-varop'>.</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getNodeInstances</span> <span class='hs-varid'>cfg</span> <span class='hs-varop'>.</span> <span class='hs-varid'>nodeUuid</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-237"></a>     <span class='hs-conid'>QffNormal</span><span class='hs-layout'>)</span>
<a name="line-238"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>FieldDefinition</span> <span class='hs-str'>"pinst_list"</span> <span class='hs-str'>"PriInstances"</span> <span class='hs-conid'>QFTOther</span>
<a name="line-239"></a>       <span class='hs-str'>"List of instances with this node as primary"</span><span class='hs-layout'>,</span>
<a name="line-240"></a>     <span class='hs-conid'>FieldConfig</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>cfg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>rsNormal</span> <span class='hs-varop'>.</span> <span class='hs-varid'>niceSort</span> <span class='hs-varop'>.</span> <span class='hs-varid'>map</span> <span class='hs-varid'>instName</span> <span class='hs-varop'>.</span> <span class='hs-varid'>fst</span> <span class='hs-varop'>.</span>
<a name="line-241"></a>                          <span class='hs-varid'>getNodeInstances</span> <span class='hs-varid'>cfg</span> <span class='hs-varop'>.</span> <span class='hs-varid'>nodeUuid</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>QffNormal</span><span class='hs-layout'>)</span>
<a name="line-242"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>FieldDefinition</span> <span class='hs-str'>"sinst_list"</span> <span class='hs-str'>"SecInstances"</span> <span class='hs-conid'>QFTOther</span>
<a name="line-243"></a>       <span class='hs-str'>"List of instances with this node as secondary"</span><span class='hs-layout'>,</span>
<a name="line-244"></a>     <span class='hs-conid'>FieldConfig</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>cfg</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>rsNormal</span> <span class='hs-varop'>.</span> <span class='hs-varid'>niceSort</span> <span class='hs-varop'>.</span> <span class='hs-varid'>map</span> <span class='hs-varid'>instName</span> <span class='hs-varop'>.</span> <span class='hs-varid'>snd</span> <span class='hs-varop'>.</span>
<a name="line-245"></a>                          <span class='hs-varid'>getNodeInstances</span> <span class='hs-varid'>cfg</span> <span class='hs-varop'>.</span> <span class='hs-varid'>nodeUuid</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>QffNormal</span><span class='hs-layout'>)</span>
<a name="line-246"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>FieldDefinition</span> <span class='hs-str'>"role"</span> <span class='hs-str'>"Role"</span> <span class='hs-conid'>QFTText</span> <span class='hs-varid'>nodeRoleDoc</span><span class='hs-layout'>,</span>
<a name="line-247"></a>     <span class='hs-conid'>FieldConfig</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>rsNormal</span> <span class='hs-varop'>.</span><span class='hs-layout'>)</span> <span class='hs-varop'>.</span> <span class='hs-varid'>getNodeRole</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>QffNormal</span><span class='hs-layout'>)</span>
<a name="line-248"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>FieldDefinition</span> <span class='hs-str'>"powered"</span> <span class='hs-str'>"Powered"</span> <span class='hs-conid'>QFTBool</span>
<a name="line-249"></a>       <span class='hs-str'>"Whether node is thought to be powered on"</span><span class='hs-layout'>,</span>
<a name="line-250"></a>     <span class='hs-conid'>FieldConfig</span> <span class='hs-varid'>getNodePower</span><span class='hs-layout'>,</span> <span class='hs-conid'>QffNormal</span><span class='hs-layout'>)</span>
<a name="line-251"></a>  <span class='hs-comment'>-- FIXME: the two fields below are incomplete in Python, part of the</span>
<a name="line-252"></a>  <span class='hs-comment'>-- non-implemented node resource model; they are declared just for</span>
<a name="line-253"></a>  <span class='hs-comment'>-- parity, but are not functional</span>
<a name="line-254"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>FieldDefinition</span> <span class='hs-str'>"hv_state"</span> <span class='hs-str'>"HypervisorState"</span> <span class='hs-conid'>QFTOther</span> <span class='hs-str'>"Hypervisor state"</span><span class='hs-layout'>,</span>
<a name="line-255"></a>     <span class='hs-conid'>FieldSimple</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>rsUnavail</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>QffNormal</span><span class='hs-layout'>)</span>
<a name="line-256"></a>  <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-conid'>FieldDefinition</span> <span class='hs-str'>"disk_state"</span> <span class='hs-str'>"DiskState"</span> <span class='hs-conid'>QFTOther</span> <span class='hs-str'>"Disk state"</span><span class='hs-layout'>,</span>
<a name="line-257"></a>     <span class='hs-conid'>FieldSimple</span> <span class='hs-layout'>(</span><span class='hs-varid'>const</span> <span class='hs-varid'>rsUnavail</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span> <span class='hs-conid'>QffNormal</span><span class='hs-layout'>)</span>
<a name="line-258"></a>  <span class='hs-keyglyph'>]</span> <span class='hs-varop'>++</span>
<a name="line-259"></a>  <span class='hs-varid'>map</span> <span class='hs-varid'>nodeLiveFieldBuilder</span> <span class='hs-varid'>nodeLiveFieldsDefs</span> <span class='hs-varop'>++</span>
<a name="line-260"></a>  <span class='hs-varid'>map</span> <span class='hs-varid'>buildNdParamField</span> <span class='hs-varid'>allNDParamFields</span> <span class='hs-varop'>++</span>
<a name="line-261"></a>  <span class='hs-varid'>timeStampFields</span> <span class='hs-varop'>++</span>
<a name="line-262"></a>  <span class='hs-varid'>uuidFields</span> <span class='hs-str'>"Node"</span> <span class='hs-varop'>++</span>
<a name="line-263"></a>  <span class='hs-varid'>serialFields</span> <span class='hs-str'>"Node"</span> <span class='hs-varop'>++</span>
<a name="line-264"></a>  <span class='hs-varid'>tagsFields</span>
<a name="line-265"></a>
<a name="line-266"></a><a name="fieldsMap"></a><span class='hs-comment'>-- | The node fields map.</span>
<a name="line-267"></a><span class='hs-definition'>fieldsMap</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>FieldMap</span> <span class='hs-conid'>Node</span> <span class='hs-conid'>Runtime</span>
<a name="line-268"></a><span class='hs-definition'>fieldsMap</span> <span class='hs-keyglyph'>=</span>
<a name="line-269"></a>  <span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>v</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>f</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>fdefName</span> <span class='hs-varid'>f</span><span class='hs-layout'>,</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>nodeFields</span>
<a name="line-270"></a>
<a name="line-271"></a><a name="rpcResultNodeBroken"></a><span class='hs-comment'>-- | Create an RPC result for a broken node</span>
<a name="line-272"></a><span class='hs-definition'>rpcResultNodeBroken</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Node</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Node</span><span class='hs-layout'>,</span> <span class='hs-conid'>Runtime</span><span class='hs-layout'>)</span>
<a name="line-273"></a><span class='hs-definition'>rpcResultNodeBroken</span> <span class='hs-varid'>node</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>node</span><span class='hs-layout'>,</span> <span class='hs-conid'>Left</span> <span class='hs-layout'>(</span><span class='hs-conid'>RpcResultError</span> <span class='hs-str'>"Broken configuration"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-274"></a>
<a name="line-275"></a><a name="collectLiveData"></a><span class='hs-comment'>-- | Collect live data from RPC query if enabled.</span>
<a name="line-276"></a><span class='hs-comment'>--</span>
<a name="line-277"></a><span class='hs-comment'>-- FIXME: Check which fields we actually need and possibly send empty</span>
<a name="line-278"></a><span class='hs-comment'>-- hvs\/vgs if no info from hypervisor\/volume group respectively is</span>
<a name="line-279"></a><span class='hs-comment'>-- required</span>
<a name="line-280"></a><span class='hs-definition'>collectLiveData</span><span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ConfigData</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Node</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>IO</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Node</span><span class='hs-layout'>,</span> <span class='hs-conid'>Runtime</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-281"></a><span class='hs-definition'>collectLiveData</span> <span class='hs-conid'>False</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>nodes</span> <span class='hs-keyglyph'>=</span>
<a name="line-282"></a>  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>zip</span> <span class='hs-varid'>nodes</span> <span class='hs-layout'>(</span><span class='hs-varid'>repeat</span> <span class='hs-varop'>$</span> <span class='hs-conid'>Left</span> <span class='hs-layout'>(</span><span class='hs-conid'>RpcResultError</span> <span class='hs-str'>"Live data disabled"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-283"></a><span class='hs-definition'>collectLiveData</span> <span class='hs-conid'>True</span> <span class='hs-varid'>cfg</span> <span class='hs-varid'>nodes</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>
<a name="line-284"></a>  <span class='hs-keyword'>let</span> <span class='hs-varid'>hvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>getDefaultHypervisorSpec</span> <span class='hs-varid'>cfg</span><span class='hs-keyglyph'>]</span>
<a name="line-285"></a>      <span class='hs-varid'>good_nodes</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nodesWithValidConfig</span> <span class='hs-varid'>cfg</span> <span class='hs-varid'>nodes</span>
<a name="line-286"></a>      <span class='hs-comment'>-- FIXME: use storage units from calling code</span>
<a name="line-287"></a>      <span class='hs-varid'>storage_units</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getStorageUnitsOfNodes</span> <span class='hs-varid'>cfg</span> <span class='hs-varid'>good_nodes</span>
<a name="line-288"></a>  <span class='hs-varid'>rpcres</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>executeRpcCall</span> <span class='hs-varid'>good_nodes</span> <span class='hs-layout'>(</span><span class='hs-conid'>RpcCallNodeInfo</span> <span class='hs-varid'>storage_units</span> <span class='hs-varid'>hvs</span><span class='hs-layout'>)</span>
<a name="line-289"></a>  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>fillUpList</span> <span class='hs-layout'>(</span><span class='hs-varid'>fillPairFromMaybe</span> <span class='hs-varid'>rpcResultNodeBroken</span> <span class='hs-varid'>pickPairUnique</span><span class='hs-layout'>)</span>
<a name="line-290"></a>      <span class='hs-varid'>nodes</span> <span class='hs-varid'>rpcres</span>
<a name="line-291"></a>
<a name="line-292"></a><a name="getDefaultHypervisorSpec"></a><span class='hs-comment'>-- | Looks up the default hypervisor and it's hvparams</span>
<a name="line-293"></a><span class='hs-definition'>getDefaultHypervisorSpec</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ConfigData</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Hypervisor</span><span class='hs-layout'>,</span> <span class='hs-conid'>HvParams</span><span class='hs-layout'>)</span>
<a name="line-294"></a><span class='hs-definition'>getDefaultHypervisorSpec</span> <span class='hs-varid'>cfg</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>hv</span><span class='hs-layout'>,</span> <span class='hs-varid'>getHvParamsFromCluster</span> <span class='hs-varid'>cfg</span> <span class='hs-varid'>hv</span><span class='hs-layout'>)</span>
<a name="line-295"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>hv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getDefaultHypervisor</span> <span class='hs-varid'>cfg</span>
<a name="line-296"></a>
<a name="line-297"></a><a name="getHvParamsFromCluster"></a><span class='hs-comment'>-- | Looks up the cluster's hvparams of the given hypervisor</span>
<a name="line-298"></a><span class='hs-definition'>getHvParamsFromCluster</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ConfigData</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Hypervisor</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>HvParams</span>
<a name="line-299"></a><span class='hs-definition'>getHvParamsFromCluster</span> <span class='hs-varid'>cfg</span> <span class='hs-varid'>hv</span> <span class='hs-keyglyph'>=</span>
<a name="line-300"></a>  <span class='hs-varid'>fromMaybe</span> <span class='hs-layout'>(</span><span class='hs-conid'>GenericContainer</span> <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>fromList</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-301"></a>    <span class='hs-layout'>(</span><span class='hs-conid'>Map</span><span class='hs-varop'>.</span><span class='hs-varid'>lookup</span> <span class='hs-layout'>(</span><span class='hs-varid'>hypervisorToRaw</span> <span class='hs-varid'>hv</span><span class='hs-layout'>)</span>
<a name="line-302"></a>       <span class='hs-layout'>(</span><span class='hs-varid'>fromContainer</span> <span class='hs-layout'>(</span><span class='hs-varid'>clusterHvparams</span> <span class='hs-layout'>(</span><span class='hs-varid'>configCluster</span> <span class='hs-varid'>cfg</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
</pre></body>
</html>
