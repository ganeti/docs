<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Ganeti.UDSServer</title><link href="ocean.css" rel="stylesheet" type="text/css" title="Ocean" /><script src="haddock-util.js" type="text/javascript"></script><script type="text/javascript">//<![CDATA[
window.onload = function () {pageLoad();setSynopsis("mini_Ganeti-UDSServer.html");};
//]]>
</script></head><body><div id="package-header"><ul class="links" id="page-menu"><li><a href="Ganeti/UDSServer.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul><p class="caption">ganeti</p></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr></table><p class="caption">Ganeti.UDSServer</p></div><div id="table-of-contents"><p class="caption">Contents</p><ul><li><a href="#g:1">Utility functions
</a></li><li><a href="#g:2">Generic protocol functionality
</a></li><li><a href="#g:3">Unix sockets
</a></li><li><a href="#g:4">Client and server
</a></li><li><a href="#g:5">Processing client requests
</a></li></ul></div><div id="description"><p class="caption">Description</p><div class="doc"><p>Implementation of the Ganeti Unix Domain Socket JSON server interface.
</p></div></div><div id="synopsis"><p id="control.syn" class="caption expander" onclick="toggleSection('syn')">Synopsis</p><ul id="section.syn" class="hide" onclick="toggleSection('syn')"><li class="src short"><a href="#v:withTimeout">withTimeout</a> ::  Int -&gt; String -&gt; IO a -&gt; IO a</li><li class="src short"><span class="keyword">data</span>  <a href="#t:RecvResult">RecvResult</a> <ul class="subs"><li>= <a href="#v:RecvConnClosed">RecvConnClosed</a>  </li><li>| <a href="#v:RecvError">RecvError</a> String  </li><li>| <a href="#v:RecvOk">RecvOk</a> String  </li></ul></li><li class="src short"><a href="#v:eOM">eOM</a> :: Word8</li><li class="src short"><a href="#v:bEOM">bEOM</a> :: ByteString</li><li class="src short"><span class="keyword">data</span>  <a href="#t:MsgKeys">MsgKeys</a> <ul class="subs"><li>= <a href="#v:Method">Method</a>  </li><li>| <a href="#v:Args">Args</a>  </li><li>| <a href="#v:Success">Success</a>  </li><li>| <a href="#v:Result">Result</a>  </li></ul></li><li class="src short"><a href="#v:strOfKey">strOfKey</a> :: <a href="Ganeti-UDSServer.html#t:MsgKeys">MsgKeys</a> -&gt; String</li><li class="src short"><span class="keyword">data</span>  <a href="#t:ServerConfig">ServerConfig</a>  = <a href="#v:ServerConfig">ServerConfig</a> {<ul class="subs"><li><a href="#v:connPermissions">connPermissions</a> :: <a href="Ganeti-Utils.html#t:FilePermissions">FilePermissions</a></li><li><a href="#v:connConfig">connConfig</a> :: <a href="Ganeti-UDSServer.html#t:ConnectConfig">ConnectConfig</a></li></ul>}</li><li class="src short"><span class="keyword">data</span>  <a href="#t:ConnectConfig">ConnectConfig</a>  = <a href="#v:ConnectConfig">ConnectConfig</a> {<ul class="subs"><li><a href="#v:recvTmo">recvTmo</a> :: Int</li><li><a href="#v:sendTmo">sendTmo</a> :: Int</li></ul>}</li><li class="src short"><span class="keyword">data</span>  <a href="#t:Client">Client</a>  = <a href="#v:Client">Client</a> {<ul class="subs"><li><a href="#v:rsocket">rsocket</a> :: Handle</li><li><a href="#v:wsocket">wsocket</a> :: Handle</li><li><a href="#v:rbuf">rbuf</a> :: IORef ByteString</li><li><a href="#v:clientConfig">clientConfig</a> :: <a href="Ganeti-UDSServer.html#t:ConnectConfig">ConnectConfig</a></li></ul>}</li><li class="src short"><span class="keyword">data</span>  <a href="#t:Server">Server</a>  = <a href="#v:Server">Server</a> {<ul class="subs"><li><a href="#v:sSocket">sSocket</a> :: Socket</li><li><a href="#v:sPath">sPath</a> :: FilePath</li><li><a href="#v:serverConfig">serverConfig</a> :: <a href="Ganeti-UDSServer.html#t:ConnectConfig">ConnectConfig</a></li></ul>}</li><li class="src short"><a href="#v:openClientSocket">openClientSocket</a> :: Int -&gt; FilePath -&gt; IO Handle</li><li class="src short"><a href="#v:closeClientSocket">closeClientSocket</a> :: Handle -&gt; IO ()</li><li class="src short"><a href="#v:openServerSocket">openServerSocket</a> :: FilePath -&gt; IO Socket</li><li class="src short"><a href="#v:closeServerSocket">closeServerSocket</a> :: Socket -&gt; FilePath -&gt; IO ()</li><li class="src short"><a href="#v:acceptSocket">acceptSocket</a> :: Socket -&gt; IO Handle</li><li class="src short"><a href="#v:connectClient">connectClient</a> :: <a href="Ganeti-UDSServer.html#t:ConnectConfig">ConnectConfig</a> -&gt; Int -&gt; FilePath -&gt; IO <a href="Ganeti-UDSServer.html#t:Client">Client</a></li><li class="src short"><a href="#v:connectServer">connectServer</a> :: <a href="Ganeti-UDSServer.html#t:ServerConfig">ServerConfig</a> -&gt; Bool -&gt; FilePath -&gt; IO <a href="Ganeti-UDSServer.html#t:Server">Server</a></li><li class="src short"><a href="#v:pipeClient">pipeClient</a> :: <a href="Ganeti-UDSServer.html#t:ConnectConfig">ConnectConfig</a> -&gt; IO (<a href="Ganeti-UDSServer.html#t:Client">Client</a>, <a href="Ganeti-UDSServer.html#t:Client">Client</a>)</li><li class="src short"><a href="#v:closeServer">closeServer</a> :: MonadBase IO m =&gt; <a href="Ganeti-UDSServer.html#t:Server">Server</a> -&gt; m ()</li><li class="src short"><a href="#v:acceptClient">acceptClient</a> :: <a href="Ganeti-UDSServer.html#t:Server">Server</a> -&gt; IO <a href="Ganeti-UDSServer.html#t:Client">Client</a></li><li class="src short"><a href="#v:closeClient">closeClient</a> :: <a href="Ganeti-UDSServer.html#t:Client">Client</a> -&gt; IO ()</li><li class="src short"><a href="#v:clientToFd">clientToFd</a> :: <a href="Ganeti-UDSServer.html#t:Client">Client</a> -&gt; IO (Fd, Fd)</li><li class="src short"><a href="#v:sendMsg">sendMsg</a> :: <a href="Ganeti-UDSServer.html#t:Client">Client</a> -&gt; String -&gt; IO ()</li><li class="src short"><a href="#v:recvUpdate">recvUpdate</a> :: <a href="Ganeti-UDSServer.html#t:ConnectConfig">ConnectConfig</a> -&gt; Handle -&gt; ByteString -&gt; IO (ByteString, ByteString)</li><li class="src short"><a href="#v:recvMsg">recvMsg</a> :: <a href="Ganeti-UDSServer.html#t:Client">Client</a> -&gt; IO String</li><li class="src short"><a href="#v:recvMsgExt">recvMsgExt</a> :: <a href="Ganeti-UDSServer.html#t:Client">Client</a> -&gt; IO <a href="Ganeti-UDSServer.html#t:RecvResult">RecvResult</a></li><li class="src short"><a href="#v:buildCall">buildCall</a> :: (JSON mth, JSON args) =&gt; mth -&gt; args -&gt; String</li><li class="src short"><a href="#v:parseCall">parseCall</a> :: (JSON mth, JSON args) =&gt; String -&gt; <a href="Ganeti-BasicTypes.html#t:Result">Result</a> (mth, args)</li><li class="src short"><a href="#v:buildResponse">buildResponse</a> :: Bool -&gt; JSValue -&gt; String</li><li class="src short"><a href="#v:decodeError">decodeError</a> :: JSValue -&gt; <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> JSValue</li><li class="src short"><a href="#v:parseResponse">parseResponse</a> :: String -&gt; <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> JSValue</li><li class="src short"><a href="#v:logMsg">logMsg</a> :: (Show e, JSON e, <a href="Ganeti-Logging.html#t:MonadLog">MonadLog</a> m) =&gt; <a href="Ganeti-UDSServer.html#t:Handler">Handler</a> i m o -&gt; i -&gt; <a href="Ganeti-BasicTypes.html#t:GenericResult">GenericResult</a> e JSValue -&gt; m ()</li><li class="src short"><a href="#v:prepareMsg">prepareMsg</a> :: JSON e =&gt; <a href="Ganeti-BasicTypes.html#t:GenericResult">GenericResult</a> e JSValue -&gt; (Bool, JSValue)</li><li class="src short"><span class="keyword">type</span> <a href="#t:HandlerResult">HandlerResult</a> m o = m (Bool, <a href="Ganeti-BasicTypes.html#t:GenericResult">GenericResult</a> <a href="Ganeti-Errors.html#t:GanetiException">GanetiException</a> o)</li><li class="src short"><span class="keyword">data</span>  <a href="#t:Handler">Handler</a> i m o = <a href="#v:Handler">Handler</a> {<ul class="subs"><li><a href="#v:hParse">hParse</a> :: JSValue -&gt; JSValue -&gt; <a href="Ganeti-BasicTypes.html#t:Result">Result</a> i</li><li><a href="#v:hInputLogShort">hInputLogShort</a> :: i -&gt; String</li><li><a href="#v:hInputLogLong">hInputLogLong</a> :: i -&gt; String</li><li><a href="#v:hExec">hExec</a> :: i -&gt; <a href="Ganeti-UDSServer.html#t:HandlerResult">HandlerResult</a> m o</li></ul>}</li><li class="src short"><a href="#v:handleJsonMessage">handleJsonMessage</a> :: (JSON o, Monad m) =&gt; <a href="Ganeti-UDSServer.html#t:Handler">Handler</a> i m o -&gt; i -&gt; <a href="Ganeti-UDSServer.html#t:HandlerResult">HandlerResult</a> m JSValue</li><li class="src short"><a href="#v:handleRawMessage">handleRawMessage</a> :: (JSON o, <a href="Ganeti-Logging.html#t:MonadLog">MonadLog</a> m) =&gt; <a href="Ganeti-UDSServer.html#t:Handler">Handler</a> i m o -&gt; String -&gt; m (Bool, String)</li><li class="src short"><a href="#v:isRisky">isRisky</a> :: <a href="Ganeti-UDSServer.html#t:RecvResult">RecvResult</a> -&gt; Bool</li><li class="src short"><a href="#v:handleClient">handleClient</a> :: (JSON o, MonadBase IO m, <a href="Ganeti-Logging.html#t:MonadLog">MonadLog</a> m) =&gt; <a href="Ganeti-UDSServer.html#t:Handler">Handler</a> i m o -&gt; <a href="Ganeti-UDSServer.html#t:Client">Client</a> -&gt; m Bool</li><li class="src short"><a href="#v:clientLoop">clientLoop</a> :: (JSON o, MonadBase IO m, <a href="Ganeti-Logging.html#t:MonadLog">MonadLog</a> m) =&gt; <a href="Ganeti-UDSServer.html#t:Handler">Handler</a> i m o -&gt; <a href="Ganeti-UDSServer.html#t:Client">Client</a> -&gt; m ()</li><li class="src short"><a href="#v:listener">listener</a> :: (JSON o, MonadBaseControl IO m, <a href="Ganeti-Logging.html#t:MonadLog">MonadLog</a> m) =&gt; <a href="Ganeti-UDSServer.html#t:Handler">Handler</a> i m o -&gt; <a href="Ganeti-UDSServer.html#t:Server">Server</a> -&gt; m ()</li></ul></div><div id="interface"><h1 id="g:1">Utility functions
</h1><div class="top"><p class="src"><a name="v:withTimeout" class="def">withTimeout</a> ::  Int -&gt; String -&gt; IO a -&gt; IO a<a href="Ganeti/UDSServer.html#withTimeout" class="link">Source</a></p></div><h1 id="g:2">Generic protocol functionality
</h1><div class="top"><p class="src"><span class="keyword">data</span>  <a name="t:RecvResult" class="def">RecvResult</a>  <a href="Ganeti/UDSServer.html#RecvResult" class="link">Source</a></p><div class="doc"><p>Result of receiving a message from the socket.
</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a name="v:RecvConnClosed" class="def">RecvConnClosed</a></td><td class="doc"><p>Connection closed
</p></td></tr><tr><td class="src"><a name="v:RecvError" class="def">RecvError</a> String</td><td class="doc"><p>Any other error
</p></td></tr><tr><td class="src"><a name="v:RecvOk" class="def">RecvOk</a> String</td><td class="doc"><p>Successfull receive
</p></td></tr></table></div><div class="subs instances"><p id="control.i:RecvResult" class="caption collapser" onclick="toggleSection('i:RecvResult')">Instances</p><div id="section.i:RecvResult" class="show"><table><tr><td class="src">Eq <a href="Ganeti-UDSServer.html#t:RecvResult">RecvResult</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">Show <a href="Ganeti-UDSServer.html#t:RecvResult">RecvResult</a></td><td class="doc empty">&nbsp;</td></tr></table></div></div></div><div class="top"><p class="src"><a name="v:eOM" class="def">eOM</a> :: Word8<a href="Ganeti/UDSServer.html#eOM" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:bEOM" class="def">bEOM</a> :: ByteString<a href="Ganeti/UDSServer.html#bEOM" class="link">Source</a></p></div><div class="top"><p class="src"><span class="keyword">data</span>  <a name="t:MsgKeys" class="def">MsgKeys</a>  <a href="Ganeti/UDSServer.html#MsgKeys" class="link">Source</a></p><div class="doc"><p>Valid keys in the requests and responses.
</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a name="v:Method" class="def">Method</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src"><a name="v:Args" class="def">Args</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src"><a name="v:Success" class="def">Success</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src"><a name="v:Result" class="def">Result</a></td><td class="doc empty">&nbsp;</td></tr></table></div></div><div class="top"><p class="src"><a name="v:strOfKey" class="def">strOfKey</a> :: <a href="Ganeti-UDSServer.html#t:MsgKeys">MsgKeys</a> -&gt; String<a href="Ganeti/UDSServer.html#strOfKey" class="link">Source</a></p><div class="doc"><p>The serialisation of MsgKeys into strings in messages.
</p></div></div><div class="top"><p class="src"><span class="keyword">data</span>  <a name="t:ServerConfig" class="def">ServerConfig</a>  <a href="Ganeti/UDSServer.html#ServerConfig" class="link">Source</a></p><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a name="v:ServerConfig" class="def">ServerConfig</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><dl><dt class="src"><a name="v:connPermissions" class="def">connPermissions</a> :: <a href="Ganeti-Utils.html#t:FilePermissions">FilePermissions</a></dt><dd class="doc empty">&nbsp;</dd><dt class="src"><a name="v:connConfig" class="def">connConfig</a> :: <a href="Ganeti-UDSServer.html#t:ConnectConfig">ConnectConfig</a></dt><dd class="doc empty">&nbsp;</dd></dl><div class="clear"></div></div></td></tr></table></div></div><div class="top"><p class="src"><span class="keyword">data</span>  <a name="t:ConnectConfig" class="def">ConnectConfig</a>  <a href="Ganeti/UDSServer.html#ConnectConfig" class="link">Source</a></p><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a name="v:ConnectConfig" class="def">ConnectConfig</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><dl><dt class="src"><a name="v:recvTmo" class="def">recvTmo</a> :: Int</dt><dd class="doc empty">&nbsp;</dd><dt class="src"><a name="v:sendTmo" class="def">sendTmo</a> :: Int</dt><dd class="doc empty">&nbsp;</dd></dl><div class="clear"></div></div></td></tr></table></div></div><div class="top"><p class="src"><span class="keyword">data</span>  <a name="t:Client" class="def">Client</a>  <a href="Ganeti/UDSServer.html#Client" class="link">Source</a></p><div class="doc"><p>A client encapsulation. Note that it has separate read and write handle.
 For sockets it is the same handle. It is required for bi-directional
 inter-process pipes though.
</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a name="v:Client" class="def">Client</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><dl><dt class="src"><a name="v:rsocket" class="def">rsocket</a> :: Handle</dt><dd class="doc empty">&nbsp;</dd><dt class="src"><a name="v:wsocket" class="def">wsocket</a> :: Handle</dt><dd class="doc empty">&nbsp;</dd><dt class="src"><a name="v:rbuf" class="def">rbuf</a> :: IORef ByteString</dt><dd class="doc empty">&nbsp;</dd><dt class="src"><a name="v:clientConfig" class="def">clientConfig</a> :: <a href="Ganeti-UDSServer.html#t:ConnectConfig">ConnectConfig</a></dt><dd class="doc empty">&nbsp;</dd></dl><div class="clear"></div></div></td></tr></table></div></div><div class="top"><p class="src"><span class="keyword">data</span>  <a name="t:Server" class="def">Server</a>  <a href="Ganeti/UDSServer.html#Server" class="link">Source</a></p><div class="doc"><p>A server encapsulation.
</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a name="v:Server" class="def">Server</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><dl><dt class="src"><a name="v:sSocket" class="def">sSocket</a> :: Socket</dt><dd class="doc empty">&nbsp;</dd><dt class="src"><a name="v:sPath" class="def">sPath</a> :: FilePath</dt><dd class="doc empty">&nbsp;</dd><dt class="src"><a name="v:serverConfig" class="def">serverConfig</a> :: <a href="Ganeti-UDSServer.html#t:ConnectConfig">ConnectConfig</a></dt><dd class="doc empty">&nbsp;</dd></dl><div class="clear"></div></div></td></tr></table></div></div><h1 id="g:3">Unix sockets
</h1><div class="top"><p class="src"><a name="v:openClientSocket" class="def">openClientSocket</a><a href="Ganeti/UDSServer.html#openClientSocket" class="link">Source</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: Int</td><td class="doc"><p>connection timeout
</p></td></tr><tr><td class="src">-&gt; FilePath</td><td class="doc"><p>socket path
</p></td></tr><tr><td class="src">-&gt; IO Handle</td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Creates a Unix socket and connects it to the specified <code>path</code>,
 where <code>timeout</code> specifies the connection timeout.
</p></div></div><div class="top"><p class="src"><a name="v:closeClientSocket" class="def">closeClientSocket</a> :: Handle -&gt; IO ()<a href="Ganeti/UDSServer.html#closeClientSocket" class="link">Source</a></p><div class="doc"><p>Closes the handle.
 Performing the operation on a handle that has already been closed has no
 effect; doing so is not an error.
 All other operations on a closed handle will fail.
</p></div></div><div class="top"><p class="src"><a name="v:openServerSocket" class="def">openServerSocket</a> :: FilePath -&gt; IO Socket<a href="Ganeti/UDSServer.html#openServerSocket" class="link">Source</a></p><div class="doc"><p>Creates a Unix socket and binds it to the specified <code>path</code>.
</p></div></div><div class="top"><p class="src"><a name="v:closeServerSocket" class="def">closeServerSocket</a> :: Socket -&gt; FilePath -&gt; IO ()<a href="Ganeti/UDSServer.html#closeServerSocket" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:acceptSocket" class="def">acceptSocket</a> :: Socket -&gt; IO Handle<a href="Ganeti/UDSServer.html#acceptSocket" class="link">Source</a></p></div><h1 id="g:4">Client and server
</h1><div class="top"><p class="src"><a name="v:connectClient" class="def">connectClient</a><a href="Ganeti/UDSServer.html#connectClient" class="link">Source</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: <a href="Ganeti-UDSServer.html#t:ConnectConfig">ConnectConfig</a></td><td class="doc"><p>configuration for the client
</p></td></tr><tr><td class="src">-&gt; Int</td><td class="doc"><p>connection timeout
</p></td></tr><tr><td class="src">-&gt; FilePath</td><td class="doc"><p>socket path
</p></td></tr><tr><td class="src">-&gt; IO <a href="Ganeti-UDSServer.html#t:Client">Client</a></td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Connects to the master daemon and returns a Client.
</p></div></div><div class="top"><p class="src"><a name="v:connectServer" class="def">connectServer</a> :: <a href="Ganeti-UDSServer.html#t:ServerConfig">ServerConfig</a> -&gt; Bool -&gt; FilePath -&gt; IO <a href="Ganeti-UDSServer.html#t:Server">Server</a><a href="Ganeti/UDSServer.html#connectServer" class="link">Source</a></p><div class="doc"><p>Creates and returns a server endpoint.
</p></div></div><div class="top"><p class="src"><a name="v:pipeClient" class="def">pipeClient</a> :: <a href="Ganeti-UDSServer.html#t:ConnectConfig">ConnectConfig</a> -&gt; IO (<a href="Ganeti-UDSServer.html#t:Client">Client</a>, <a href="Ganeti-UDSServer.html#t:Client">Client</a>)<a href="Ganeti/UDSServer.html#pipeClient" class="link">Source</a></p><div class="doc"><p>Creates a new bi-directional client pipe. The two returned clients
 talk to each other through the pipe.
</p></div></div><div class="top"><p class="src"><a name="v:closeServer" class="def">closeServer</a> :: MonadBase IO m =&gt; <a href="Ganeti-UDSServer.html#t:Server">Server</a> -&gt; m ()<a href="Ganeti/UDSServer.html#closeServer" class="link">Source</a></p><div class="doc"><p>Closes a server endpoint.
</p></div></div><div class="top"><p class="src"><a name="v:acceptClient" class="def">acceptClient</a> :: <a href="Ganeti-UDSServer.html#t:Server">Server</a> -&gt; IO <a href="Ganeti-UDSServer.html#t:Client">Client</a><a href="Ganeti/UDSServer.html#acceptClient" class="link">Source</a></p><div class="doc"><p>Accepts a client
</p></div></div><div class="top"><p class="src"><a name="v:closeClient" class="def">closeClient</a> :: <a href="Ganeti-UDSServer.html#t:Client">Client</a> -&gt; IO ()<a href="Ganeti/UDSServer.html#closeClient" class="link">Source</a></p><div class="doc"><p>Closes the client socket.
 Performing the operation on a client that has already been closed has no
 effect; doing so is not an error.
 All other operations on a closed client will fail with an exception.
</p></div></div><div class="top"><p class="src"><a name="v:clientToFd" class="def">clientToFd</a> :: <a href="Ganeti-UDSServer.html#t:Client">Client</a> -&gt; IO (Fd, Fd)<a href="Ganeti/UDSServer.html#clientToFd" class="link">Source</a></p><div class="doc"><p>Extracts the read (the first) and the write (the second) file descriptor
 of a client. This closes the underlying <code>Handle</code>s, therefore the original
 client is closed and unusable after the call.
</p><p>The purpose of this function is to keep the communication channel open,
 while replacing a <code><a href="Ganeti-UDSServer.html#t:Client">Client</a></code> with some other means.
</p></div></div><div class="top"><p class="src"><a name="v:sendMsg" class="def">sendMsg</a> :: <a href="Ganeti-UDSServer.html#t:Client">Client</a> -&gt; String -&gt; IO ()<a href="Ganeti/UDSServer.html#sendMsg" class="link">Source</a></p><div class="doc"><p>Sends a message over a transport.
</p></div></div><div class="top"><p class="src"><a name="v:recvUpdate" class="def">recvUpdate</a> :: <a href="Ganeti-UDSServer.html#t:ConnectConfig">ConnectConfig</a> -&gt; Handle -&gt; ByteString -&gt; IO (ByteString, ByteString)<a href="Ganeti/UDSServer.html#recvUpdate" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:recvMsg" class="def">recvMsg</a> :: <a href="Ganeti-UDSServer.html#t:Client">Client</a> -&gt; IO String<a href="Ganeti/UDSServer.html#recvMsg" class="link">Source</a></p><div class="doc"><p>Waits for a message over a transport.
</p></div></div><div class="top"><p class="src"><a name="v:recvMsgExt" class="def">recvMsgExt</a> :: <a href="Ganeti-UDSServer.html#t:Client">Client</a> -&gt; IO <a href="Ganeti-UDSServer.html#t:RecvResult">RecvResult</a><a href="Ganeti/UDSServer.html#recvMsgExt" class="link">Source</a></p><div class="doc"><p>Extended wrapper over recvMsg.
</p></div></div><div class="top"><p class="src"><a name="v:buildCall" class="def">buildCall</a><a href="Ganeti/UDSServer.html#buildCall" class="link">Source</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: (JSON mth, JSON args)</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">=&gt; mth</td><td class="doc"><p>The method
</p></td></tr><tr><td class="src">-&gt; args</td><td class="doc"><p>The arguments
</p></td></tr><tr><td class="src">-&gt; String</td><td class="doc"><p>The serialized form
</p></td></tr></table></div><div class="doc"><p>Serialize a request to String.
</p></div></div><div class="top"><p class="src"><a name="v:parseCall" class="def">parseCall</a> :: (JSON mth, JSON args) =&gt; String -&gt; <a href="Ganeti-BasicTypes.html#t:Result">Result</a> (mth, args)<a href="Ganeti/UDSServer.html#parseCall" class="link">Source</a></p><div class="doc"><p>Parse the required keys out of a call.
</p></div></div><div class="top"><p class="src"><a name="v:buildResponse" class="def">buildResponse</a><a href="Ganeti/UDSServer.html#buildResponse" class="link">Source</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: Bool</td><td class="doc"><p>Success
</p></td></tr><tr><td class="src">-&gt; JSValue</td><td class="doc"><p>The arguments
</p></td></tr><tr><td class="src">-&gt; String</td><td class="doc"><p>The serialized form
</p></td></tr></table></div><div class="doc"><p>Serialize the response to String.
</p></div></div><div class="top"><p class="src"><a name="v:decodeError" class="def">decodeError</a> :: JSValue -&gt; <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> JSValue<a href="Ganeti/UDSServer.html#decodeError" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:parseResponse" class="def">parseResponse</a> :: String -&gt; <a href="Ganeti-Errors.html#t:ErrorResult">ErrorResult</a> JSValue<a href="Ganeti/UDSServer.html#parseResponse" class="link">Source</a></p><div class="doc"><p>Check that luxi responses contain the required keys and that the
 call was successful.
</p></div></div><div class="top"><p class="src"><a name="v:logMsg" class="def">logMsg</a> :: (Show e, JSON e, <a href="Ganeti-Logging.html#t:MonadLog">MonadLog</a> m) =&gt; <a href="Ganeti-UDSServer.html#t:Handler">Handler</a> i m o -&gt; i -&gt; <a href="Ganeti-BasicTypes.html#t:GenericResult">GenericResult</a> e JSValue -&gt; m ()<a href="Ganeti/UDSServer.html#logMsg" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:prepareMsg" class="def">prepareMsg</a> :: JSON e =&gt; <a href="Ganeti-BasicTypes.html#t:GenericResult">GenericResult</a> e JSValue -&gt; (Bool, JSValue)<a href="Ganeti/UDSServer.html#prepareMsg" class="link">Source</a></p></div><h1 id="g:5">Processing client requests
</h1><div class="top"><p class="src"><span class="keyword">type</span> <a name="t:HandlerResult" class="def">HandlerResult</a> m o = m (Bool, <a href="Ganeti-BasicTypes.html#t:GenericResult">GenericResult</a> <a href="Ganeti-Errors.html#t:GanetiException">GanetiException</a> o)<a href="Ganeti/UDSServer.html#HandlerResult" class="link">Source</a></p></div><div class="top"><p class="src"><span class="keyword">data</span>  <a name="t:Handler" class="def">Handler</a> i m o <a href="Ganeti/UDSServer.html#Handler" class="link">Source</a></p><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a name="v:Handler" class="def">Handler</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><dl><dt class="src"><a name="v:hParse" class="def">hParse</a> :: JSValue -&gt; JSValue -&gt; <a href="Ganeti-BasicTypes.html#t:Result">Result</a> i</dt><dd class="doc"><p>parses method and its arguments into the input type
</p></dd><dt class="src"><a name="v:hInputLogShort" class="def">hInputLogShort</a> :: i -&gt; String</dt><dd class="doc"><p>short description of an input, for the INFO logging level
</p></dd><dt class="src"><a name="v:hInputLogLong" class="def">hInputLogLong</a> :: i -&gt; String</dt><dd class="doc"><p>long description of an input, for the DEBUG logging level
</p></dd><dt class="src"><a name="v:hExec" class="def">hExec</a> :: i -&gt; <a href="Ganeti-UDSServer.html#t:HandlerResult">HandlerResult</a> m o</dt><dd class="doc"><p>executes the handler on an input
</p></dd></dl><div class="clear"></div></div></td></tr></table></div></div><div class="top"><p class="src"><a name="v:handleJsonMessage" class="def">handleJsonMessage</a> :: (JSON o, Monad m) =&gt; <a href="Ganeti-UDSServer.html#t:Handler">Handler</a> i m o -&gt; i -&gt; <a href="Ganeti-UDSServer.html#t:HandlerResult">HandlerResult</a> m JSValue<a href="Ganeti/UDSServer.html#handleJsonMessage" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:handleRawMessage" class="def">handleRawMessage</a> :: (JSON o, <a href="Ganeti-Logging.html#t:MonadLog">MonadLog</a> m) =&gt; <a href="Ganeti-UDSServer.html#t:Handler">Handler</a> i m o -&gt; String -&gt; m (Bool, String)<a href="Ganeti/UDSServer.html#handleRawMessage" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:isRisky" class="def">isRisky</a> :: <a href="Ganeti-UDSServer.html#t:RecvResult">RecvResult</a> -&gt; Bool<a href="Ganeti/UDSServer.html#isRisky" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:handleClient" class="def">handleClient</a> :: (JSON o, MonadBase IO m, <a href="Ganeti-Logging.html#t:MonadLog">MonadLog</a> m) =&gt; <a href="Ganeti-UDSServer.html#t:Handler">Handler</a> i m o -&gt; <a href="Ganeti-UDSServer.html#t:Client">Client</a> -&gt; m Bool<a href="Ganeti/UDSServer.html#handleClient" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:clientLoop" class="def">clientLoop</a> :: (JSON o, MonadBase IO m, <a href="Ganeti-Logging.html#t:MonadLog">MonadLog</a> m) =&gt; <a href="Ganeti-UDSServer.html#t:Handler">Handler</a> i m o -&gt; <a href="Ganeti-UDSServer.html#t:Client">Client</a> -&gt; m ()<a href="Ganeti/UDSServer.html#clientLoop" class="link">Source</a></p></div><div class="top"><p class="src"><a name="v:listener" class="def">listener</a> :: (JSON o, MonadBaseControl IO m, <a href="Ganeti-Logging.html#t:MonadLog">MonadLog</a> m) =&gt; <a href="Ganeti-UDSServer.html#t:Handler">Handler</a> i m o -&gt; <a href="Ganeti-UDSServer.html#t:Server">Server</a> -&gt; m ()<a href="Ganeti/UDSServer.html#listener" class="link">Source</a></p><div class="doc"><p>Main listener loop: accepts clients, forks an I/O thread to handle
 that client.
</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.10.0</p></div></body></html>