
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ganeti monitoring agent &#8212; Ganeti 3.0.2 documentation</title>
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Instance move improvements" href="design-move-instance-improvements.html" />
    <link rel="prev" title="Submitting jobs from logical units" href="design-lu-generated-jobs.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="design-move-instance-improvements.html" title="Instance move improvements"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="design-lu-generated-jobs.html" title="Submitting jobs from logical units"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Ganeti 3.0.2 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Ganeti monitoring agent</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="ganeti-monitoring-agent">
<h1><a class="toc-backref" href="#id3">Ganeti monitoring agent</a><a class="headerlink" href="#ganeti-monitoring-agent" title="Permalink to this headline">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Created</dt>
<dd class="field-odd"><p>2012-Oct-18</p>
</dd>
<dt class="field-even">Status</dt>
<dd class="field-even"><p>Implemented</p>
</dd>
<dt class="field-odd">Ganeti-Version</dt>
<dd class="field-odd"><p>2.7.0, 2.8.0, 2.9.0</p>
</dd>
</dl>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#ganeti-monitoring-agent" id="id3">Ganeti monitoring agent</a></p>
<ul>
<li><p><a class="reference internal" href="#current-state-and-shortcomings" id="id4">Current state and shortcomings</a></p></li>
<li><p><a class="reference internal" href="#proposed-changes" id="id5">Proposed changes</a></p>
<ul>
<li><p><a class="reference internal" href="#location-of-agent-report" id="id6">Location of agent report</a></p></li>
<li><p><a class="reference internal" href="#information-reported" id="id7">Information reported</a></p></li>
<li><p><a class="reference internal" href="#format-of-the-report" id="id8">Format of the report</a></p>
<ul>
<li><p><a class="reference internal" href="#performance-reporting-collectors" id="id9">Performance reporting collectors</a></p></li>
<li><p><a class="reference internal" href="#status-reporting-collectors" id="id10">Status reporting collectors</a></p></li>
<li><p><a class="reference internal" href="#instance-status" id="id11">Instance status</a></p></li>
<li><p><a class="reference internal" href="#storage-collectors" id="id12">Storage collectors</a></p></li>
<li><p><a class="reference internal" href="#ganeti-daemons-status" id="id13">Ganeti daemons status</a></p></li>
<li><p><a class="reference internal" href="#hypervisor-resources-report" id="id14">Hypervisor resources report</a></p></li>
<li><p><a class="reference internal" href="#node-os-resources-report" id="id15">Node OS resources report</a></p></li>
<li><p><a class="reference internal" href="#node-os-cpu-load-average-report" id="id16">Node OS CPU load average report</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#format-of-the-query" id="id17">Format of the query</a></p>
<ul>
<li><p><a class="reference internal" href="#id1" id="id18"><code class="docutils literal notranslate"><span class="pre">/</span></code></a></p></li>
<li><p><a class="reference internal" href="#id2" id="id19"><code class="docutils literal notranslate"><span class="pre">/1</span></code></a></p></li>
<li><p><a class="reference internal" href="#list-collectors" id="id20"><code class="docutils literal notranslate"><span class="pre">/1/list/collectors</span></code></a></p></li>
<li><p><a class="reference internal" href="#report-all" id="id21"><code class="docutils literal notranslate"><span class="pre">/1/report/all</span></code></a></p></li>
<li><p><a class="reference internal" href="#report-category-collector-name" id="id22"><code class="docutils literal notranslate"><span class="pre">/1/report/[category]/[collector_name]</span></code></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#instance-disk-status-propagation" id="id23">Instance disk status propagation</a></p></li>
<li><p><a class="reference internal" href="#plugin-system" id="id24">Plugin system</a></p></li>
<li><p><a class="reference internal" href="#data-collectors" id="id25">Data collectors</a></p></li>
<li><p><a class="reference internal" href="#mode-of-operation" id="id26">Mode of operation</a></p></li>
<li><p><a class="reference internal" href="#implementation-place" id="id27">Implementation place</a></p></li>
<li><p><a class="reference internal" href="#implementation-order" id="id28">Implementation order</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#future-work" id="id29">Future work</a></p></li>
</ul>
</li>
</ul>
</div>
<p>This is a design document detailing the implementation of a Ganeti
monitoring agent report system, that can be queried by a monitoring
system to calculate health information for a Ganeti cluster.</p>
<div class="section" id="current-state-and-shortcomings">
<h2><a class="toc-backref" href="#id4">Current state and shortcomings</a><a class="headerlink" href="#current-state-and-shortcomings" title="Permalink to this headline">¶</a></h2>
<p>There is currently no monitoring support in Ganeti. While we don’t want
to build something like Nagios or Pacemaker as part of Ganeti, it would
be useful if such tools could easily extract information from a Ganeti
machine in order to take actions (example actions include logging an
outage for future reporting or alerting a person or system about it).</p>
</div>
<div class="section" id="proposed-changes">
<h2><a class="toc-backref" href="#id5">Proposed changes</a><a class="headerlink" href="#proposed-changes" title="Permalink to this headline">¶</a></h2>
<p>Each Ganeti node should export a status page that can be queried by a
monitoring system. Such status page will be exported on a network port
and will be encoded in JSON (simple text) over HTTP.</p>
<p>The choice of JSON is obvious as we already depend on it in Ganeti and
thus we don’t need to add extra libraries to use it, as opposed to what
would happen for XML or some other markup format.</p>
<div class="section" id="location-of-agent-report">
<h3><a class="toc-backref" href="#id6">Location of agent report</a><a class="headerlink" href="#location-of-agent-report" title="Permalink to this headline">¶</a></h3>
<p>The report will be available from all nodes, and be concerned for all
node-local resources. This allows more real-time information to be
available, at the cost of querying all nodes.</p>
</div>
<div class="section" id="information-reported">
<h3><a class="toc-backref" href="#id7">Information reported</a><a class="headerlink" href="#information-reported" title="Permalink to this headline">¶</a></h3>
<p>The monitoring agent system will report on the following basic information:</p>
<ul class="simple">
<li><p>Instance status</p></li>
<li><p>Instance disk status</p></li>
<li><p>Status of storage for instances</p></li>
<li><p>Ganeti daemons status, CPU usage, memory footprint</p></li>
<li><p>Hypervisor resources report (memory, CPU, network interfaces)</p></li>
<li><p>Node OS resources report (memory, CPU, network interfaces)</p></li>
<li><p>Node OS CPU load average report</p></li>
<li><p>Information from a plugin system</p></li>
</ul>
</div>
<div class="section" id="format-of-the-report">
<span id="monitoring-agent-format-of-the-report"></span><h3><a class="toc-backref" href="#id8">Format of the report</a><a class="headerlink" href="#format-of-the-report" title="Permalink to this headline">¶</a></h3>
<p>The report of the will be in JSON format, and it will present an array
of report objects.
Each report object will be produced by a specific data collector.
Each report object includes some mandatory fields, to be provided by all
the data collectors:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">name</span></code></dt><dd><p>The name of the data collector that produced this part of the report.
It is supposed to be unique inside a report.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">version</span></code></dt><dd><p>The version of the data collector that produces this part of the
report. Built-in data collectors (as opposed to those implemented as
plugins) should have “B” as the version number.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">format_version</span></code></dt><dd><p>The format of what is represented in the “data” field for each data
collector might change over time. Every time this happens, the
format_version should be changed, so that who reads the report knows
what format to expect, and how to correctly interpret it.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">timestamp</span></code></dt><dd><p>The time when the reported data were gathered. It has to be expressed
in nanoseconds since the unix epoch (0:00:00 January 01, 1970). If not
enough precision is available (or needed) it can be padded with
zeroes. If a report object needs multiple timestamps, it can add more
and/or override this one inside its own “data” section.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">category</span></code></dt><dd><p>A collector can belong to a given category of collectors (e.g.: storage
collectors, daemon collector). This means that it will have to provide a
minimum set of prescribed fields, as documented for each category.
This field will contain the name of the category the collector belongs to,
if any, or just the <code class="docutils literal notranslate"><span class="pre">null</span></code> value.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">kind</span></code></dt><dd><p>Two kinds of collectors are possible:
<a class="reference internal" href="#performance-reporting-collectors">Performance reporting collectors</a> and <a class="reference internal" href="#status-reporting-collectors">Status reporting collectors</a>.
The respective paragraphs will describe them and the value of this field.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">data</span></code></dt><dd><p>This field contains all the data generated by the specific data collector,
in its own independently defined format. The monitoring agent could check
this syntactically (according to the JSON specifications) but not
semantically.</p>
</dd>
</dl>
<p>Here follows a minimal example of a report:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
<span class="p">{</span>
    <span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="s2">&quot;TheCollectorIdentifier&quot;</span><span class="p">,</span>
    <span class="s2">&quot;version&quot;</span> <span class="p">:</span> <span class="s2">&quot;1.2&quot;</span><span class="p">,</span>
    <span class="s2">&quot;format_version&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;timestamp&quot;</span> <span class="p">:</span> <span class="mi">1351607182000000000</span><span class="p">,</span>
    <span class="s2">&quot;category&quot;</span> <span class="p">:</span> <span class="n">null</span><span class="p">,</span>
    <span class="s2">&quot;kind&quot;</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">&quot;data&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;plugin_specific_data&quot;</span> <span class="p">:</span> <span class="s2">&quot;go_here&quot;</span> <span class="p">}</span>
<span class="p">},</span>
<span class="p">{</span>
    <span class="s2">&quot;name&quot;</span> <span class="p">:</span> <span class="s2">&quot;AnotherDataCollector&quot;</span><span class="p">,</span>
    <span class="s2">&quot;version&quot;</span> <span class="p">:</span> <span class="s2">&quot;B&quot;</span><span class="p">,</span>
    <span class="s2">&quot;format_version&quot;</span> <span class="p">:</span> <span class="mi">7</span><span class="p">,</span>
    <span class="s2">&quot;timestamp&quot;</span> <span class="p">:</span> <span class="mi">1351609526123854000</span><span class="p">,</span>
    <span class="s2">&quot;category&quot;</span> <span class="p">:</span> <span class="s2">&quot;storage&quot;</span><span class="p">,</span>
    <span class="s2">&quot;kind&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">&quot;data&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;status&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;code&quot;</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="s2">&quot;message&quot;</span> <span class="p">:</span> <span class="s2">&quot;Error on disk 2&quot;</span>
                          <span class="p">},</span>
               <span class="s2">&quot;plugin_specific&quot;</span> <span class="p">:</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span>
               <span class="s2">&quot;some_late_data&quot;</span> <span class="p">:</span> <span class="p">{</span> <span class="s2">&quot;timestamp&quot;</span> <span class="p">:</span> <span class="mi">1351609526123942720</span><span class="p">,</span>
                                    <span class="o">...</span>
                                  <span class="p">}</span>
             <span class="p">}</span>
<span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
<div class="section" id="performance-reporting-collectors">
<h4><a class="toc-backref" href="#id9">Performance reporting collectors</a><a class="headerlink" href="#performance-reporting-collectors" title="Permalink to this headline">¶</a></h4>
<p>These collectors only provide data about some component of the system, without
giving any interpretation over their meaning.</p>
<p>The value of the <code class="docutils literal notranslate"><span class="pre">kind</span></code> field of the report will be <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p>
</div>
<div class="section" id="status-reporting-collectors">
<h4><a class="toc-backref" href="#id10">Status reporting collectors</a><a class="headerlink" href="#status-reporting-collectors" title="Permalink to this headline">¶</a></h4>
<p>These collectors will provide information about the status of some
component of ganeti, or managed by ganeti.</p>
<p>The value of their <code class="docutils literal notranslate"><span class="pre">kind</span></code> field will be <code class="docutils literal notranslate"><span class="pre">1</span></code>.</p>
<p>The rationale behind this kind of collectors is that there are some situations
where exporting data about the underlying subsystems would expose potential
issues. But if Ganeti itself is able (and going) to fix the problem, conflicts
might arise between Ganeti and something/somebody else trying to fix the same
problem.
Also, some external monitoring systems might not be aware of the internals of a
particular subsystem (e.g.: DRBD) and might only exploit the high level
response of its data collector, alerting an administrator if anything is wrong.
Still, completely hiding the underlying data is not a good idea, as they might
still be of use in some cases. So status reporting plugins will provide two
output modes: one just exporting a high level information about the status,
and one also exporting all the data they gathered.
The default output mode will be the status-only one. Through a command line
parameter (for stand-alone data collectors) or through the HTTP request to the
monitoring agent
(when collectors are executed as part of it) the verbose output mode providing
all the data can be selected.</p>
<p>When exporting just the status each status reporting collector will provide,
in its <code class="docutils literal notranslate"><span class="pre">data</span></code> section, at least the following field:</p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">status</span></code></dt><dd><p>summarizes the status of the component being monitored and consists of two
subfields:</p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">code</span></code></dt><dd><p>It assumes a numeric value, encoded in such a way to allow using a bitset
to easily distinguish which states are currently present in the whole
cluster. If the bitwise OR of all the <code class="docutils literal notranslate"><span class="pre">status</span></code> fields is 0, the cluster
is completely healthy.
The status codes are as follows:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">0</span></code></dt><dd><p>The collector can determine that everything is working as
intended.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">1</span></code></dt><dd><p>Something is temporarily wrong but it is being automatically fixed by
Ganeti.
There is no need of external intervention.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">2</span></code></dt><dd><p>The collector has failed to understand whether the status is good or
bad. Further analysis is required. Interpret this status as a
potentially dangerous situation.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">4</span></code></dt><dd><p>The collector can determine that something is wrong and Ganeti has no
way to fix it autonomously. External intervention is required.</p>
</dd>
</dl>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">message</span></code></dt><dd><p>A message to better explain the reason of the status.
The exact format of the message string is data collector dependent.</p>
<p>The field is mandatory, but the content can be an empty string if the
<code class="docutils literal notranslate"><span class="pre">code</span></code> is <code class="docutils literal notranslate"><span class="pre">0</span></code> (working as intended) or <code class="docutils literal notranslate"><span class="pre">1</span></code> (being fixed
automatically).</p>
<p>If the status code is <code class="docutils literal notranslate"><span class="pre">2</span></code>, the message should specify what has gone
wrong.
If the status code is <code class="docutils literal notranslate"><span class="pre">4</span></code>, the message should explain why it was not
possible to determine a proper status.</p>
</dd>
</dl>
</dd>
</dl>
<p>The <code class="docutils literal notranslate"><span class="pre">data</span></code> section will also contain all the fields describing the gathered
data, according to a collector-specific format.</p>
</div>
<div class="section" id="instance-status">
<h4><a class="toc-backref" href="#id11">Instance status</a><a class="headerlink" href="#instance-status" title="Permalink to this headline">¶</a></h4>
<p>At the moment each node knows which instances are running on it, which
instances it is primary for, but not the cause why an instance might not
be running. On the other hand we don’t want to distribute full instance
“admin” status information to all nodes, because of the performance
impact this would have.</p>
<p>As such we propose that:</p>
<ul class="simple">
<li><p>Any operation that can affect instance status will have an optional
“reason” attached to it (at opcode level). This can be used for
example to distinguish an admin request, from a scheduled maintenance
or an automated tool’s work. If this reason is not passed, Ganeti will
just use the information it has about the source of the request.
This reason information will be structured according to the
<a class="reference internal" href="design-reason-trail.html"><span class="doc">Ganeti reason trail</span></a> design document.</p></li>
<li><p>RPCs that affect the instance status will be changed so that the
“reason” and the version of the config object they ran on is passed to
them. They will then export the new expected instance status, together
with the associated reason and object version to the status report
system, which then will export those themselves.</p></li>
</ul>
<p>Monitoring and auditing systems can then use the reason to understand
the cause of an instance status, and they can use the timestamp to
understand the freshness of their data even in the absence of an atomic
cross-node reporting: for example if they see an instance “up” on a node
after seeing it running on a previous one, they can compare these values
to understand which data is freshest, and repoll the “older” node. Of
course if they keep seeing this status this represents an error (either
an instance continuously “flapping” between nodes, or an instance is
constantly up on more than one), which should be reported and acted
upon.</p>
<p>The instance status will be on each node, for the instances it is
primary for, and its <code class="docutils literal notranslate"><span class="pre">data</span></code> section of the report will contain a list
of instances, named <code class="docutils literal notranslate"><span class="pre">instances</span></code>, with at least the following fields for
each instance:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">name</span></code></dt><dd><p>The name of the instance.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">uuid</span></code></dt><dd><p>The UUID of the instance (stable on name change).</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">admin_state</span></code></dt><dd><p>The status of the instance (up/down/offline) as requested by the admin.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">actual_state</span></code></dt><dd><p>The actual status of the instance. It can be <code class="docutils literal notranslate"><span class="pre">up</span></code>, <code class="docutils literal notranslate"><span class="pre">down</span></code>, or
<code class="docutils literal notranslate"><span class="pre">hung</span></code> if the instance is up but it appears to be completely stuck.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">uptime</span></code></dt><dd><p>The uptime of the instance (if it is up, “null” otherwise).</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">mtime</span></code></dt><dd><p>The timestamp of the last known change to the instance state.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">state_reason</span></code></dt><dd><p>The last known reason for state change of the instance, described according
to the JSON representation of a reason trail, as detailed in the <a class="reference internal" href="design-reason-trail.html"><span class="doc">reason
trail design document</span></a>.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">status</span></code></dt><dd><p>It represents the status of the instance, and its format is the same as that
of the <code class="docutils literal notranslate"><span class="pre">status</span></code> field of <a class="reference internal" href="#status-reporting-collectors">Status reporting collectors</a>.</p>
</dd>
</dl>
<p>Each hypervisor should provide its own instance status data collector, possibly
with the addition of more, specific, fields.
The <code class="docutils literal notranslate"><span class="pre">category</span></code> field of all of them will be <code class="docutils literal notranslate"><span class="pre">instance</span></code>.
The <code class="docutils literal notranslate"><span class="pre">kind</span></code> field will be <code class="docutils literal notranslate"><span class="pre">1</span></code>.</p>
<p>Note that as soon as a node knows it’s not the primary anymore for an
instance it will stop reporting status for it: this means the instance
will either disappear, if it has been deleted, or appear on another
node, if it’s been moved.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">code</span></code> of the <code class="docutils literal notranslate"><span class="pre">status</span></code> field of the report of the Instance status data
collector will be:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">0</span></code></dt><dd><p>if <code class="docutils literal notranslate"><span class="pre">status</span></code> is <code class="docutils literal notranslate"><span class="pre">0</span></code> for all the instances it is reporting about.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">1</span></code></dt><dd><p>otherwise.</p>
</dd>
</dl>
</div>
<div class="section" id="storage-collectors">
<h4><a class="toc-backref" href="#id12">Storage collectors</a><a class="headerlink" href="#storage-collectors" title="Permalink to this headline">¶</a></h4>
<p>The storage collectors will be a series of data collectors
that will gather data about storage for the current node. The collection
will be performed at different granularity and abstraction levels, from
the physical disks, to partitions, logical volumes and to the specific
storage types used by Ganeti itself (drbd, rbd, plain, file).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">name</span></code> of each of these collector will reflect what storage type each of
them refers to.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">category</span></code> field of these collector will be <code class="docutils literal notranslate"><span class="pre">storage</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">kind</span></code> field will depend on the specific collector.</p>
<p>Each <code class="docutils literal notranslate"><span class="pre">storage</span></code> collector’s <code class="docutils literal notranslate"><span class="pre">data</span></code> section will provide collector-specific
fields.</p>
<p>The various storage collectors will provide keys to join the data they provide,
in order to allow the user to get a better understanding of the system. E.g.:
through device names, or instance names.</p>
<div class="section" id="diskstats-collector">
<h5>Diskstats collector<a class="headerlink" href="#diskstats-collector" title="Permalink to this headline">¶</a></h5>
<p>This storage data collector will gather information about the status of the
disks installed in the system, as listed in the /proc/diskstats file. This means
that not only physical hard drives, but also ramdisks and loopback devices will
be listed.</p>
<p>Its <code class="docutils literal notranslate"><span class="pre">kind</span></code> in the report will be <code class="docutils literal notranslate"><span class="pre">0</span></code> (<a class="reference internal" href="#performance-reporting-collectors">Performance reporting collectors</a>).</p>
<p>Its <code class="docutils literal notranslate"><span class="pre">category</span></code> field in the report will contain the value <code class="docutils literal notranslate"><span class="pre">storage</span></code>.</p>
<p>When executed in verbose mode, the <code class="docutils literal notranslate"><span class="pre">data</span></code> section of the report of this
collector will be a list of items, each representing one disk, each providing
the following fields:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">major</span></code></dt><dd><p>The major number of the device.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">minor</span></code></dt><dd><p>The minor number of the device.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">name</span></code></dt><dd><p>The name of the device.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">readsNum</span></code></dt><dd><p>This is the total number of reads completed successfully.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">mergedReads</span></code></dt><dd><p>Reads which are adjacent to each other may be merged for efficiency. Thus
two 4K reads may become one 8K read before it is ultimately handed to the
disk, and so it will be counted (and queued) as only one I/O. This field
specifies how often this was done.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">secRead</span></code></dt><dd><p>This is the total number of sectors read successfully.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">timeRead</span></code></dt><dd><p>This is the total number of milliseconds spent by all reads.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">writes</span></code></dt><dd><p>This is the total number of writes completed successfully.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">mergedWrites</span></code></dt><dd><p>Writes which are adjacent to each other may be merged for efficiency. Thus
two 4K writes may become one 8K read before it is ultimately handed to the
disk, and so it will be counted (and queued) as only one I/O. This field
specifies how often this was done.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">secWritten</span></code></dt><dd><p>This is the total number of sectors written successfully.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">timeWrite</span></code></dt><dd><p>This is the total number of milliseconds spent by all writes.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ios</span></code></dt><dd><p>The number of I/Os currently in progress.
The only field that should go to zero, it is incremented as requests are
given to appropriate struct request_queue and decremented as they finish.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">timeIO</span></code></dt><dd><p>The number of milliseconds spent doing I/Os. This field increases so long
as field <code class="docutils literal notranslate"><span class="pre">IOs</span></code> is nonzero.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">wIOmillis</span></code></dt><dd><p>The weighted number of milliseconds spent doing I/Os.
This field is incremented at each I/O start, I/O completion, I/O merge,
or read of these stats by the number of I/Os in progress (field <code class="docutils literal notranslate"><span class="pre">IOs</span></code>)
times the number of milliseconds spent doing I/O since the last update of
this field. This can provide an easy measure of both I/O completion time
and the backlog that may be accumulating.</p>
</dd>
</dl>
</div>
<div class="section" id="logical-volume-collector">
<h5>Logical Volume collector<a class="headerlink" href="#logical-volume-collector" title="Permalink to this headline">¶</a></h5>
<p>This data collector will gather information about the attributes of logical
volumes present in the system.</p>
<p>Its <code class="docutils literal notranslate"><span class="pre">kind</span></code> in the report will be <code class="docutils literal notranslate"><span class="pre">0</span></code> (<a class="reference internal" href="#performance-reporting-collectors">Performance reporting collectors</a>).</p>
<p>Its <code class="docutils literal notranslate"><span class="pre">category</span></code> field in the report will contain the value <code class="docutils literal notranslate"><span class="pre">storage</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">data</span></code> section of the report of this collector will be a list of items,
each representing one logical volume and providing the following fields:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">uuid</span></code></dt><dd><p>The UUID of the logical volume.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">name</span></code></dt><dd><p>The name of the logical volume.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">attr</span></code></dt><dd><p>The attributes of the logical volume.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">major</span></code></dt><dd><p>Persistent major number or -1 if not persistent.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">minor</span></code></dt><dd><p>Persistent minor number or -1 if not persistent.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">kernel_major</span></code></dt><dd><p>Currently assigned major number or -1 if LV is not active.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">kernel_minor</span></code></dt><dd><p>Currently assigned minor number or -1 if LV is not active.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size</span></code></dt><dd><p>Size of LV in bytes.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">seg_count</span></code></dt><dd><p>Number of segments in LV.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">tags</span></code></dt><dd><p>Tags, if any.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">modules</span></code></dt><dd><p>Kernel device-mapper modules required for this LV, if any.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">vg_uuid</span></code></dt><dd><p>Unique identifier of the volume group.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">vg_name</span></code></dt><dd><p>Name of the volume group.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">segtype</span></code></dt><dd><p>Type of LV segment.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">seg_start</span></code></dt><dd><p>Offset within the LV to the start of the segment in bytes.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">seg_start_pe</span></code></dt><dd><p>Offset within the LV to the start of the segment in physical extents.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">seg_size</span></code></dt><dd><p>Size of the segment in bytes.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">seg_tags</span></code></dt><dd><p>Tags for the segment, if any.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">seg_pe_ranges</span></code></dt><dd><p>Ranges of Physical Extents of underlying devices in lvs command line format.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">devices</span></code></dt><dd><p>Underlying devices used with starting extent numbers.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">instance</span></code></dt><dd><p>The name of the instance this LV is used by, or <code class="docutils literal notranslate"><span class="pre">null</span></code> if it was not
possible to determine it.</p>
</dd>
</dl>
</div>
<div class="section" id="drbd-status">
<h5>DRBD status<a class="headerlink" href="#drbd-status" title="Permalink to this headline">¶</a></h5>
<p>This data collector will run only on nodes where DRBD is actually
present and it will gather information about DRBD devices.</p>
<p>Its <code class="docutils literal notranslate"><span class="pre">kind</span></code> in the report will be <code class="docutils literal notranslate"><span class="pre">1</span></code> (<a class="reference internal" href="#status-reporting-collectors">Status reporting collectors</a>).</p>
<p>Its <code class="docutils literal notranslate"><span class="pre">category</span></code> field in the report will contain the value <code class="docutils literal notranslate"><span class="pre">storage</span></code>.</p>
<p>When executed in verbose mode, the <code class="docutils literal notranslate"><span class="pre">data</span></code> section of the report of this
collector will provide the following fields:</p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">versionInfo</span></code></dt><dd><p>Information about the DRBD version number, given by a combination of
any (but at least one) of the following fields:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">version</span></code></dt><dd><p>The DRBD driver version.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">api</span></code></dt><dd><p>The API version number.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">proto</span></code></dt><dd><p>The protocol version.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">srcversion</span></code></dt><dd><p>The version of the source files.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">gitHash</span></code></dt><dd><p>Git hash of the source files.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">buildBy</span></code></dt><dd><p>Who built the binary, and, optionally, when.</p>
</dd>
</dl>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">device</span></code></dt><dd><p>A list of structures, each describing a DRBD device (a minor) and containing
the following fields:</p>
<dl>
<dt><code class="docutils literal notranslate"><span class="pre">minor</span></code></dt><dd><p>The device minor number.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">connectionState</span></code></dt><dd><p>The state of the connection. If it is “Unconfigured”, all the following
fields are not present.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">localRole</span></code></dt><dd><p>The role of the local resource.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">remoteRole</span></code></dt><dd><p>The role of the remote resource.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">localState</span></code></dt><dd><p>The status of the local disk.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">remoteState</span></code></dt><dd><p>The status of the remote disk.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">replicationProtocol</span></code></dt><dd><p>The replication protocol being used.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">ioFlags</span></code></dt><dd><p>The input/output flags.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">perfIndicators</span></code></dt><dd><p>The performance indicators. This field will contain the following
sub-fields:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">networkSend</span></code></dt><dd><p>KiB of data sent on the network.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">networkReceive</span></code></dt><dd><p>KiB of data received from the network.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">diskWrite</span></code></dt><dd><p>KiB of data written on local disk.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">diskRead</span></code></dt><dd><p>KiB of date read from the local disk.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">activityLog</span></code></dt><dd><p>Number of updates of the activity log.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">bitMap</span></code></dt><dd><p>Number of updates to the bitmap area of the metadata.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">localCount</span></code></dt><dd><p>Number of open requests to the local I/O subsystem.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">pending</span></code></dt><dd><p>Number of requests sent to the partner but not yet answered.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">unacknowledged</span></code></dt><dd><p>Number of requests received by the partner but still to be answered.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">applicationPending</span></code></dt><dd><p>Num of block input/output requests forwarded to DRBD but that have not yet
been answered.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">epochs</span></code></dt><dd><p>(Optional) Number of epoch objects. Not provided by all DRBD versions.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">writeOrder</span></code></dt><dd><p>(Optional) Currently used write ordering method. Not provided by all DRBD
versions.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">outOfSync</span></code></dt><dd><p>(Optional) KiB of storage currently out of sync. Not provided by all DRBD
versions.</p>
</dd>
</dl>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">syncStatus</span></code></dt><dd><p>(Optional) The status of the synchronization of the disk. This is present
only if the disk is being synchronized, and includes the following fields:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">percentage</span></code></dt><dd><p>The percentage of synchronized data.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">progress</span></code></dt><dd><p>How far the synchronization is. Written as “x/y”, where x and y are
integer numbers expressed in the measurement unit stated in
<code class="docutils literal notranslate"><span class="pre">progressUnit</span></code></p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">progressUnit</span></code></dt><dd><p>The measurement unit for the progress indicator.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">timeToFinish</span></code></dt><dd><p>The expected time before finishing the synchronization.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">speed</span></code></dt><dd><p>The speed of the synchronization.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">want</span></code></dt><dd><p>The desired speed of the synchronization.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">speedUnit</span></code></dt><dd><p>The measurement unit of the <code class="docutils literal notranslate"><span class="pre">speed</span></code> and <code class="docutils literal notranslate"><span class="pre">want</span></code> values. Expressed
as “size/time”.</p>
</dd>
</dl>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">instance</span></code></dt><dd><p>The name of the Ganeti instance this disk is associated to.</p>
</dd>
</dl>
</dd>
</dl>
</div>
</div>
<div class="section" id="ganeti-daemons-status">
<h4><a class="toc-backref" href="#id13">Ganeti daemons status</a><a class="headerlink" href="#ganeti-daemons-status" title="Permalink to this headline">¶</a></h4>
<p>Ganeti will report what information it has about its own daemons.
This should allow identifying possible problems with the Ganeti system itself:
for example memory leaks, crashes and high resource utilization should be
evident by analyzing this information.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">kind</span></code> field will be <code class="docutils literal notranslate"><span class="pre">1</span></code> (<a class="reference internal" href="#status-reporting-collectors">Status reporting collectors</a>).</p>
<p>Each daemon will have its own data collector, and each of them will have
a <code class="docutils literal notranslate"><span class="pre">category</span></code> field valued <code class="docutils literal notranslate"><span class="pre">daemon</span></code>.</p>
<p>When executed in verbose mode, their data section will include at least:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">memory</span></code></dt><dd><p>The amount of used memory.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">size_unit</span></code></dt><dd><p>The measurement unit used for the memory.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">uptime</span></code></dt><dd><p>The uptime of the daemon.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">CPU</span> <span class="pre">usage</span></code></dt><dd><p>How much cpu the daemon is using (percentage).</p>
</dd>
</dl>
<p>Any other daemon-specific information can be included as well in the <code class="docutils literal notranslate"><span class="pre">data</span></code>
section.</p>
</div>
<div class="section" id="hypervisor-resources-report">
<h4><a class="toc-backref" href="#id14">Hypervisor resources report</a><a class="headerlink" href="#hypervisor-resources-report" title="Permalink to this headline">¶</a></h4>
<p>Each hypervisor has a view of system resources that sometimes is
different than the one the OS sees (for example in Xen the Node OS,
running as Dom0, has access to only part of those resources). In this
section we’ll report all information we can in a “non hypervisor
specific” way. Each hypervisor can then add extra specific information
that is not generic enough be abstracted.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">kind</span></code> field will be <code class="docutils literal notranslate"><span class="pre">0</span></code> (<a class="reference internal" href="#performance-reporting-collectors">Performance reporting collectors</a>).</p>
<p>Each of the hypervisor data collectors will be of <code class="docutils literal notranslate"><span class="pre">category</span></code>: <code class="docutils literal notranslate"><span class="pre">hypervisor</span></code>.</p>
</div>
<div class="section" id="node-os-resources-report">
<h4><a class="toc-backref" href="#id15">Node OS resources report</a><a class="headerlink" href="#node-os-resources-report" title="Permalink to this headline">¶</a></h4>
<p>Since Ganeti assumes it’s running on Linux, it’s useful to export some
basic information as seen by the host system.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">category</span></code> field of the report will be <code class="docutils literal notranslate"><span class="pre">null</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">kind</span></code> field will be <code class="docutils literal notranslate"><span class="pre">0</span></code> (<a class="reference internal" href="#performance-reporting-collectors">Performance reporting collectors</a>).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">data</span></code> section will include:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">cpu_number</span></code></dt><dd><p>The number of available cpus.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">cpus</span></code></dt><dd><p>A list with one element per cpu, showing its average load.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">memory</span></code></dt><dd><p>The current view of memory (free, used, cached, etc.)</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">filesystem</span></code></dt><dd><p>A list with one element per filesystem, showing a summary of the
total/available space.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">NICs</span></code></dt><dd><p>A list with one element per network interface, showing the amount of
sent/received data, error rate, IP address of the interface, etc.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">versions</span></code></dt><dd><p>A map using the name of a component Ganeti interacts (Linux, drbd,
hypervisor, etc) as the key and its version number as the value.</p>
</dd>
</dl>
<p>Note that we won’t go into any hardware specific details (e.g. querying a
node RAID is outside the scope of this, and can be implemented as a
plugin) but we can easily just report the information above, since it’s
standard enough across all systems.</p>
</div>
<div class="section" id="node-os-cpu-load-average-report">
<h4><a class="toc-backref" href="#id16">Node OS CPU load average report</a><a class="headerlink" href="#node-os-cpu-load-average-report" title="Permalink to this headline">¶</a></h4>
<p>This data collector will export CPU load statistics as seen by the host
system. Apart from using the data from an external monitoring system we
can also use the data to improve instance allocation and/or the Ganeti
cluster balance. To compute the CPU load average we will use a number of
values collected inside a time window. The collection process will be
done by an independent thread (see <a class="reference internal" href="#mode-of-operation">Mode of Operation</a>).</p>
<p>This report is a subset of the previous report (<a class="reference internal" href="#node-os-resources-report">Node OS resources
report</a>) and they might eventually get merged, once reporting for the
other fields (memory, filesystem, NICs) gets implemented too.</p>
<p>Specifically:</p>
<p>The <code class="docutils literal notranslate"><span class="pre">category</span></code> field of the report will be <code class="docutils literal notranslate"><span class="pre">null</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">kind</span></code> field will be <code class="docutils literal notranslate"><span class="pre">0</span></code> (<a class="reference internal" href="#performance-reporting-collectors">Performance reporting collectors</a>).</p>
<p>The <code class="docutils literal notranslate"><span class="pre">data</span></code> section will include:</p>
<dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">cpu_number</span></code></dt><dd><p>The number of available cpus.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">cpus</span></code></dt><dd><p>A list with one element per cpu, showing its average load.</p>
</dd>
<dt><code class="docutils literal notranslate"><span class="pre">cpu_total</span></code></dt><dd><p>The total CPU load average as a sum of the all separate cpus.</p>
</dd>
</dl>
<p>The CPU load report function will get N values, collected by the
CPU load collection function and calculate the above averages. Please
see the section <a class="reference internal" href="#mode-of-operation">Mode of Operation</a>  for more information one how the
two functions of the data collector interact.</p>
</div>
</div>
<div class="section" id="format-of-the-query">
<h3><a class="toc-backref" href="#id17">Format of the query</a><a class="headerlink" href="#format-of-the-query" title="Permalink to this headline">¶</a></h3>
<p>The queries to the monitoring agent will be HTTP GET requests on port 1815.
The answer will be encoded in JSON format and will depend on the specific
accessed resource.</p>
<p>If a request is sent to a non-existing resource, a 404 error will be returned by
the HTTP server.</p>
<p>The following paragraphs will present the existing resources supported by the
current protocol version, that is version 1.</p>
<div class="section" id="id1">
<h4><a class="toc-backref" href="#id18"><code class="docutils literal notranslate"><span class="pre">/</span></code></a><a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>The root resource. It will return the list of the supported protocol version
numbers.</p>
<p>Currently, this will include only version 1.</p>
</div>
<div class="section" id="id2">
<h4><a class="toc-backref" href="#id19"><code class="docutils literal notranslate"><span class="pre">/1</span></code></a><a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>Not an actual resource per-se, it is the root of all the resources of protocol
version 1.</p>
<p>If requested through GET, the null JSON value will be returned.</p>
</div>
<div class="section" id="list-collectors">
<h4><a class="toc-backref" href="#id20"><code class="docutils literal notranslate"><span class="pre">/1/list/collectors</span></code></a><a class="headerlink" href="#list-collectors" title="Permalink to this headline">¶</a></h4>
<p>Returns a list of tuples (kind, category, name) showing all the collectors
available in the system.</p>
</div>
<div class="section" id="report-all">
<h4><a class="toc-backref" href="#id21"><code class="docutils literal notranslate"><span class="pre">/1/report/all</span></code></a><a class="headerlink" href="#report-all" title="Permalink to this headline">¶</a></h4>
<p>A list of the reports of all the data collectors, as a JSON list.</p>
<p>Status reporting collectors will provide their output in non-verbose format.
The verbose format can be requested by adding the parameter <code class="docutils literal notranslate"><span class="pre">verbose=1</span></code> to the
request.</p>
</div>
<div class="section" id="report-category-collector-name">
<h4><a class="toc-backref" href="#id22"><code class="docutils literal notranslate"><span class="pre">/1/report/[category]/[collector_name]</span></code></a><a class="headerlink" href="#report-category-collector-name" title="Permalink to this headline">¶</a></h4>
<p>Returns the report of the collector <code class="docutils literal notranslate"><span class="pre">[collector_name]</span></code> that belongs to the
specified <code class="docutils literal notranslate"><span class="pre">[category]</span></code>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">category</span></code> has to be written in lowercase.</p>
<p>If a collector does not belong to any category, <code class="docutils literal notranslate"><span class="pre">default</span></code> will have to be
used as the value for <code class="docutils literal notranslate"><span class="pre">[category]</span></code>.</p>
<p>Status reporting collectors will provide their output in non-verbose format.
The verbose format can be requested by adding the parameter <code class="docutils literal notranslate"><span class="pre">verbose=1</span></code> to the
request.</p>
</div>
</div>
<div class="section" id="instance-disk-status-propagation">
<h3><a class="toc-backref" href="#id23">Instance disk status propagation</a><a class="headerlink" href="#instance-disk-status-propagation" title="Permalink to this headline">¶</a></h3>
<p>As for the instance status Ganeti has now only partial information about
its instance disks: in particular each node is unaware of the disk to
instance mapping, that exists only on the master.</p>
<p>For this design doc we plan to fix this by changing all RPCs that create
a backend storage or that put an already existing one in use and passing
the relevant instance to the node. The node can then export these to the
status reporting tool.</p>
<p>While we haven’t implemented these RPC changes yet, we’ll use Confd to
fetch this information in the data collectors.</p>
</div>
<div class="section" id="plugin-system">
<h3><a class="toc-backref" href="#id24">Plugin system</a><a class="headerlink" href="#plugin-system" title="Permalink to this headline">¶</a></h3>
<p>The monitoring system will be equipped with a plugin system that can
export specific local information through it.</p>
<p>The plugin system is expected to be used by local installations to
export any installation specific information that they want to be
monitored, about either hardware or software on their systems.</p>
<p>The plugin system will be in the form of either scripts or binaries whose output
will be inserted in the report.</p>
<p>Eventually support for other kinds of plugins might be added as well, such as
plain text files which will be inserted into the report, or local unix or
network sockets from which the information has to be read.  This should allow
most flexibility for implementing an efficient system, while being able to keep
it as simple as possible.</p>
</div>
<div class="section" id="data-collectors">
<h3><a class="toc-backref" href="#id25">Data collectors</a><a class="headerlink" href="#data-collectors" title="Permalink to this headline">¶</a></h3>
<p>In order to ease testing as well as to make it simple to reuse this
subsystem it will be possible to run just the “data collectors” on each
node without passing through the agent daemon.</p>
<p>If a data collector is run independently, it should print on stdout its
report, according to the format corresponding to a single data collector
report object, as described in the previous paragraphs.</p>
</div>
<div class="section" id="mode-of-operation">
<h3><a class="toc-backref" href="#id26">Mode of operation</a><a class="headerlink" href="#mode-of-operation" title="Permalink to this headline">¶</a></h3>
<p>In order to be able to report information fast the monitoring agent
daemon will keep an in-memory or on-disk cache of the status, which will
be returned when queries are made. The status system will then
periodically check resources to make sure the status is up to date.</p>
<p>Different parts of the report will be queried at different speeds. These
will depend on:
- how often they vary (or we expect them to vary)
- how fast they are to query
- how important their freshness is</p>
<p>Of course the last parameter is installation specific, and while we’ll
try to have defaults, it will be configurable. The first two instead we
can use adaptively to query a certain resource faster or slower
depending on those two parameters.</p>
<p>When run as stand-alone binaries, the data collector will not using any
caching system, and just fetch and return the data immediately.</p>
<p>Since some performance collectors have to operate on a number of values
collected in previous times, we need a mechanism independent of the data
collector which will trigger the collection of those values and also
store them, so that they are available for calculation by the data
collectors.</p>
<p>To collect data periodically, a thread will be created by the monitoring
agent which will run the collection function of every data collector
that provides one. The values returned by the collection function of
the data collector will be saved in an appropriate map, associating each
value to the corresponding collector, using the collector’s name as the
key of the map. This map will be stored in mond’s memory.</p>
<p>The collectors are divided in two categories:</p>
<ul class="simple">
<li><p>stateless collectors, collectors who have immediate access to the
reported information</p></li>
<li><p>stateful collectors, collectors whose report is based on data collected
in a previous time window</p></li>
</ul>
<p>For example: the collection function of the CPU load collector will
collect a CPU load value and save it in the map mentioned above. The
collection function will be called by the collector thread every t
milliseconds. When the report function of the collector is called, it
will process the last N values of the map and calculate the
corresponding average.</p>
</div>
<div class="section" id="implementation-place">
<h3><a class="toc-backref" href="#id27">Implementation place</a><a class="headerlink" href="#implementation-place" title="Permalink to this headline">¶</a></h3>
<p>The status daemon will be implemented as a standalone Haskell daemon. In
the future it should be easy to merge multiple daemons into one with
multiple entry points, should we find out it saves resources and doesn’t
impact functionality.</p>
<p>The libekg library should be looked at for easily providing metrics in
json format.</p>
</div>
<div class="section" id="implementation-order">
<h3><a class="toc-backref" href="#id28">Implementation order</a><a class="headerlink" href="#implementation-order" title="Permalink to this headline">¶</a></h3>
<p>We will implement the agent system in this order:</p>
<ul class="simple">
<li><p>initial example data collectors (eg. for drbd and instance status).</p></li>
<li><p>initial daemon for exporting data, integrating the existing collectors</p></li>
<li><p>plugin system</p></li>
<li><p>RPC updates for instance status reasons and disk to instance mapping</p></li>
<li><p>cache layer for the daemon</p></li>
<li><p>more data collectors</p></li>
</ul>
</div>
</div>
<div class="section" id="future-work">
<h2><a class="toc-backref" href="#id29">Future work</a><a class="headerlink" href="#future-work" title="Permalink to this headline">¶</a></h2>
<p>As a future step it can be useful to “centralize” all this reporting
data on a single place. This for example can be just the master node, or
all the master candidates. We will evaluate doing this after the first
node-local version has been developed and tested.</p>
<p>Another possible change is replacing the “read-only” RPCs with queries
to the agent system, thus having only one way of collecting information
from the nodes from a monitoring system and for Ganeti itself.</p>
<p>One extra feature we may need is a way to query for only sub-parts of
the report (eg. instances status only). This can be done by passing
arguments to the HTTP GET, which will be defined when we get to this
functionality.</p>
<p>Finally the <a class="reference internal" href="design-autorepair.html"><span class="doc">autorepair system design</span></a>. system
(see its design) can be expanded to use the monitoring agent system as a
source of information to decide which repairs it can perform.</p>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Ganeti monitoring agent</a><ul>
<li><a class="reference internal" href="#current-state-and-shortcomings">Current state and shortcomings</a></li>
<li><a class="reference internal" href="#proposed-changes">Proposed changes</a><ul>
<li><a class="reference internal" href="#location-of-agent-report">Location of agent report</a></li>
<li><a class="reference internal" href="#information-reported">Information reported</a></li>
<li><a class="reference internal" href="#format-of-the-report">Format of the report</a><ul>
<li><a class="reference internal" href="#performance-reporting-collectors">Performance reporting collectors</a></li>
<li><a class="reference internal" href="#status-reporting-collectors">Status reporting collectors</a></li>
<li><a class="reference internal" href="#instance-status">Instance status</a></li>
<li><a class="reference internal" href="#storage-collectors">Storage collectors</a><ul>
<li><a class="reference internal" href="#diskstats-collector">Diskstats collector</a></li>
<li><a class="reference internal" href="#logical-volume-collector">Logical Volume collector</a></li>
<li><a class="reference internal" href="#drbd-status">DRBD status</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ganeti-daemons-status">Ganeti daemons status</a></li>
<li><a class="reference internal" href="#hypervisor-resources-report">Hypervisor resources report</a></li>
<li><a class="reference internal" href="#node-os-resources-report">Node OS resources report</a></li>
<li><a class="reference internal" href="#node-os-cpu-load-average-report">Node OS CPU load average report</a></li>
</ul>
</li>
<li><a class="reference internal" href="#format-of-the-query">Format of the query</a><ul>
<li><a class="reference internal" href="#id1"><code class="docutils literal notranslate"><span class="pre">/</span></code></a></li>
<li><a class="reference internal" href="#id2"><code class="docutils literal notranslate"><span class="pre">/1</span></code></a></li>
<li><a class="reference internal" href="#list-collectors"><code class="docutils literal notranslate"><span class="pre">/1/list/collectors</span></code></a></li>
<li><a class="reference internal" href="#report-all"><code class="docutils literal notranslate"><span class="pre">/1/report/all</span></code></a></li>
<li><a class="reference internal" href="#report-category-collector-name"><code class="docutils literal notranslate"><span class="pre">/1/report/[category]/[collector_name]</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#instance-disk-status-propagation">Instance disk status propagation</a></li>
<li><a class="reference internal" href="#plugin-system">Plugin system</a></li>
<li><a class="reference internal" href="#data-collectors">Data collectors</a></li>
<li><a class="reference internal" href="#mode-of-operation">Mode of operation</a></li>
<li><a class="reference internal" href="#implementation-place">Implementation place</a></li>
<li><a class="reference internal" href="#implementation-order">Implementation order</a></li>
</ul>
</li>
<li><a class="reference internal" href="#future-work">Future work</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="design-lu-generated-jobs.html"
                        title="previous chapter">Submitting jobs from logical units</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="design-move-instance-improvements.html"
                        title="next chapter">Instance move improvements</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/design-monitoring-agent.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="design-move-instance-improvements.html" title="Instance move improvements"
             >next</a></li>
        <li class="right" >
          <a href="design-lu-generated-jobs.html" title="Submitting jobs from logical units"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Ganeti 3.0.2 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Ganeti monitoring agent</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015 Google Inc..
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.4.3.
    </div>
  </body>
</html>