
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ganeti customisation using hooks &#8212; Ganeti 3.0.2 documentation</title>
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Ganeti automatic instance allocation" href="iallocator.html" />
    <link rel="prev" title="Glossary" href="glossary.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="iallocator.html" title="Ganeti automatic instance allocation"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="glossary.html" title="Glossary"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Ganeti 3.0.2 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Ganeti customisation using hooks</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="ganeti-customisation-using-hooks">
<h1><a class="toc-backref" href="#id1">Ganeti customisation using hooks</a><a class="headerlink" href="#ganeti-customisation-using-hooks" title="Permalink to this headline">¶</a></h1>
<p>Documents Ganeti version 3.0</p>
<div class="contents topic" id="contents">
<p class="topic-title">Contents</p>
<ul class="simple">
<li><p><a class="reference internal" href="#ganeti-customisation-using-hooks" id="id1">Ganeti customisation using hooks</a></p>
<ul>
<li><p><a class="reference internal" href="#introduction" id="id2">Introduction</a></p></li>
<li><p><a class="reference internal" href="#organisation" id="id3">Organisation</a></p>
<ul>
<li><p><a class="reference internal" href="#pre-scripts" id="id4"><em>pre</em> scripts</a></p></li>
<li><p><a class="reference internal" href="#post-scripts" id="id5"><em>post</em> scripts</a></p></li>
<li><p><a class="reference internal" href="#naming" id="id6">Naming</a></p></li>
<li><p><a class="reference internal" href="#order-of-execution" id="id7">Order of execution</a></p></li>
<li><p><a class="reference internal" href="#execution-environment" id="id8">Execution environment</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#operation-list" id="id9">Operation list</a></p>
<ul>
<li><p><a class="reference internal" href="#node-operations" id="id10">Node operations</a></p>
<ul>
<li><p><a class="reference internal" href="#op-node-add" id="id11">OP_NODE_ADD</a></p></li>
<li><p><a class="reference internal" href="#op-node-remove" id="id12">OP_NODE_REMOVE</a></p></li>
<li><p><a class="reference internal" href="#op-node-set-params" id="id13">OP_NODE_SET_PARAMS</a></p></li>
<li><p><a class="reference internal" href="#op-node-migrate" id="id14">OP_NODE_MIGRATE</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#node-group-operations" id="id15">Node group operations</a></p>
<ul>
<li><p><a class="reference internal" href="#op-group-add" id="id16">OP_GROUP_ADD</a></p></li>
<li><p><a class="reference internal" href="#op-group-set-params" id="id17">OP_GROUP_SET_PARAMS</a></p></li>
<li><p><a class="reference internal" href="#op-group-remove" id="id18">OP_GROUP_REMOVE</a></p></li>
<li><p><a class="reference internal" href="#op-group-rename" id="id19">OP_GROUP_RENAME</a></p></li>
<li><p><a class="reference internal" href="#op-group-evacuate" id="id20">OP_GROUP_EVACUATE</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#network-operations" id="id21">Network operations</a></p>
<ul>
<li><p><a class="reference internal" href="#op-network-add" id="id22">OP_NETWORK_ADD</a></p></li>
<li><p><a class="reference internal" href="#op-network-remove" id="id23">OP_NETWORK_REMOVE</a></p></li>
<li><p><a class="reference internal" href="#op-network-connect" id="id24">OP_NETWORK_CONNECT</a></p></li>
<li><p><a class="reference internal" href="#op-network-disconnect" id="id25">OP_NETWORK_DISCONNECT</a></p></li>
<li><p><a class="reference internal" href="#op-network-set-params" id="id26">OP_NETWORK_SET_PARAMS</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#instance-operations" id="id27">Instance operations</a></p>
<ul>
<li><p><a class="reference internal" href="#op-instance-create" id="id28">OP_INSTANCE_CREATE</a></p></li>
<li><p><a class="reference internal" href="#op-instance-reinstall" id="id29">OP_INSTANCE_REINSTALL</a></p></li>
<li><p><a class="reference internal" href="#op-backup-export" id="id30">OP_BACKUP_EXPORT</a></p></li>
<li><p><a class="reference internal" href="#op-instance-startup" id="id31">OP_INSTANCE_STARTUP</a></p></li>
<li><p><a class="reference internal" href="#op-instance-shutdown" id="id32">OP_INSTANCE_SHUTDOWN</a></p></li>
<li><p><a class="reference internal" href="#op-instance-reboot" id="id33">OP_INSTANCE_REBOOT</a></p></li>
<li><p><a class="reference internal" href="#op-instance-set-params" id="id34">OP_INSTANCE_SET_PARAMS</a></p></li>
<li><p><a class="reference internal" href="#op-instance-failover" id="id35">OP_INSTANCE_FAILOVER</a></p></li>
<li><p><a class="reference internal" href="#op-instance-migrate" id="id36">OP_INSTANCE_MIGRATE</a></p></li>
<li><p><a class="reference internal" href="#op-instance-remove" id="id37">OP_INSTANCE_REMOVE</a></p></li>
<li><p><a class="reference internal" href="#op-instance-grow-disk" id="id38">OP_INSTANCE_GROW_DISK</a></p></li>
<li><p><a class="reference internal" href="#op-instance-rename" id="id39">OP_INSTANCE_RENAME</a></p></li>
<li><p><a class="reference internal" href="#op-instance-move" id="id40">OP_INSTANCE_MOVE</a></p></li>
<li><p><a class="reference internal" href="#op-instance-recreate-disks" id="id41">OP_INSTANCE_RECREATE_DISKS</a></p></li>
<li><p><a class="reference internal" href="#op-instance-replace-disks" id="id42">OP_INSTANCE_REPLACE_DISKS</a></p></li>
<li><p><a class="reference internal" href="#op-instance-change-group" id="id43">OP_INSTANCE_CHANGE_GROUP</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#cluster-operations" id="id44">Cluster operations</a></p>
<ul>
<li><p><a class="reference internal" href="#op-cluster-post-init" id="id45">OP_CLUSTER_POST_INIT</a></p></li>
<li><p><a class="reference internal" href="#op-cluster-destroy" id="id46">OP_CLUSTER_DESTROY</a></p></li>
<li><p><a class="reference internal" href="#op-cluster-verify-group" id="id47">OP_CLUSTER_VERIFY_GROUP</a></p></li>
<li><p><a class="reference internal" href="#op-cluster-rename" id="id48">OP_CLUSTER_RENAME</a></p></li>
<li><p><a class="reference internal" href="#op-cluster-set-params" id="id49">OP_CLUSTER_SET_PARAMS</a></p></li>
<li><p><a class="reference internal" href="#virtual-operation-op-cluster-ip-turnup" id="id50">Virtual operation <code class="docutils literal notranslate"><span class="pre">OP_CLUSTER_IP_TURNUP</span></code></a></p></li>
<li><p><a class="reference internal" href="#virtual-operation-op-cluster-ip-turndown" id="id51">Virtual operation <code class="docutils literal notranslate"><span class="pre">OP_CLUSTER_IP_TURNDOWN</span></code></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#obsolete-operations" id="id52">Obsolete operations</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#environment-variables" id="id53">Environment variables</a></p>
<ul>
<li><p><a class="reference internal" href="#common-variables" id="id54">Common variables</a></p></li>
<li><p><a class="reference internal" href="#specialised-variables" id="id55">Specialised variables</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#examples" id="id56">Examples</a></p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="introduction">
<h2><a class="toc-backref" href="#id2">Introduction</a><a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>In order to allow customisation of operations, Ganeti runs scripts in
sub-directories of <code class="docutils literal notranslate"><span class="pre">&#64;SYSCONFDIR&#64;/ganeti/hooks</span></code> (that is usually
<code class="docutils literal notranslate"><span class="pre">/etc/ganeti/hooks</span></code>). These sub-directories
are named <code class="docutils literal notranslate"><span class="pre">$hook-$phase.d</span></code>, where <code class="docutils literal notranslate"><span class="pre">$phase</span></code> is either <code class="docutils literal notranslate"><span class="pre">pre</span></code> or
<code class="docutils literal notranslate"><span class="pre">post</span></code> and <code class="docutils literal notranslate"><span class="pre">$hook</span></code> matches the directory name given for a hook (e.g.
<code class="docutils literal notranslate"><span class="pre">cluster-verify-post.d</span></code> or <code class="docutils literal notranslate"><span class="pre">node-add-pre.d</span></code>).</p>
<p>This is similar to the <code class="docutils literal notranslate"><span class="pre">/etc/network/</span></code> structure present in Debian
for network interface handling.</p>
<p>Note that Ganeti does not create its <code class="docutils literal notranslate"><span class="pre">hooks</span></code> directory by default.
If you want to use hooks scripts, create it on all nodes. This applies
also to all sub directories such as <code class="docutils literal notranslate"><span class="pre">node-add-pre.d</span></code>.</p>
</div>
<div class="section" id="organisation">
<h2><a class="toc-backref" href="#id3">Organisation</a><a class="headerlink" href="#organisation" title="Permalink to this headline">¶</a></h2>
<p>For every operation, two sets of scripts are run:</p>
<ul class="simple">
<li><p>pre phase (for authorization/checking)</p></li>
<li><p>post phase (for logging)</p></li>
</ul>
<p>Also, for each operation, the scripts are run on one or more nodes,
depending on the operation type.</p>
<p>Note that, even though we call them scripts, we are actually talking
about any executable.</p>
<p>The filenames of the scripts need to match the regular expression
<code class="docutils literal notranslate"><span class="pre">^[a-zA-Z0-9_-]+$</span></code>. This means in particular, that scripts having
a filename extension (such as <code class="docutils literal notranslate"><span class="pre">myhook.sh</span></code>) are silently ignored
by Ganeti.</p>
<div class="section" id="pre-scripts">
<h3><a class="toc-backref" href="#id4"><em>pre</em> scripts</a><a class="headerlink" href="#pre-scripts" title="Permalink to this headline">¶</a></h3>
<p>The <em>pre</em> scripts have a definite target: to check that the operation
is allowed given the site-specific constraints. You could have, for
example, a rule that says every new instance is required to exists in
a database; to implement this, you could write a script that checks
the new instance parameters against your database.</p>
<p>The objective of these scripts should be their return code (zero or
non-zero for success and failure). However, if they modify the
environment in any way, they should be idempotent, as failed
executions could be restarted and thus the script(s) run again with
exactly the same parameters.</p>
<p>Note that if a node is unreachable at the time a hooks is run, this
will not be interpreted as a deny for the execution. In other words,
only an actual error returned from a script will cause abort, and not
an unreachable node.</p>
<p>Therefore, if you want to guarantee that a hook script is run and
denies an action, it’s best to put it on the master node.</p>
</div>
<div class="section" id="post-scripts">
<h3><a class="toc-backref" href="#id5"><em>post</em> scripts</a><a class="headerlink" href="#post-scripts" title="Permalink to this headline">¶</a></h3>
<p>These scripts should do whatever you need as a reaction to the
completion of an operation. Their return code is not checked (but
logged), and they should not depend on the fact that the <em>pre</em> scripts
have been run.</p>
</div>
<div class="section" id="naming">
<h3><a class="toc-backref" href="#id6">Naming</a><a class="headerlink" href="#naming" title="Permalink to this headline">¶</a></h3>
<p>The allowed names for the scripts consist of (similar to <em>run-parts</em>)
upper and lower case, digits, underscores and hyphens. In other words,
the regexp <code class="docutils literal notranslate"><span class="pre">^[a-zA-Z0-9_-]+$</span></code>. Also, non-executable scripts will be
ignored.</p>
</div>
<div class="section" id="order-of-execution">
<h3><a class="toc-backref" href="#id7">Order of execution</a><a class="headerlink" href="#order-of-execution" title="Permalink to this headline">¶</a></h3>
<p>On a single node, the scripts in a directory are run in lexicographic
order (more exactly, the python string comparison order). It is
advisable to implement the usual <em>NN-name</em> convention where <em>NN</em> is a
two digit number.</p>
<p>For an operation whose hooks are run on multiple nodes, there is no
specific ordering of nodes with regard to hooks execution; you should
assume that the scripts are run in parallel on the target nodes
(keeping on each node the above specified ordering).  If you need any
kind of inter-node synchronisation, you have to implement it yourself
in the scripts.</p>
</div>
<div class="section" id="execution-environment">
<h3><a class="toc-backref" href="#id8">Execution environment</a><a class="headerlink" href="#execution-environment" title="Permalink to this headline">¶</a></h3>
<p>The scripts will be run as follows:</p>
<ul class="simple">
<li><p>no command line arguments</p></li>
<li><p>no controlling <em>tty</em></p></li>
<li><p>stdin is actually <em>/dev/null</em></p></li>
<li><p>stdout and stderr are directed to files</p></li>
<li><p>PATH is reset to <code class="docutils literal notranslate"><span class="pre">/sbin:/bin:/usr/sbin:/usr/bin</span></code></p></li>
<li><p>the environment is cleared, and only ganeti-specific variables will
be left</p></li>
</ul>
<p>All information about the cluster is passed using environment
variables. Different operations will have sligthly different
environments, but most of the variables are common.</p>
</div>
</div>
<div class="section" id="operation-list">
<h2><a class="toc-backref" href="#id9">Operation list</a><a class="headerlink" href="#operation-list" title="Permalink to this headline">¶</a></h2>
<div class="section" id="node-operations">
<h3><a class="toc-backref" href="#id10">Node operations</a><a class="headerlink" href="#node-operations" title="Permalink to this headline">¶</a></h3>
<div class="section" id="op-node-add">
<h4><a class="toc-backref" href="#id11">OP_NODE_ADD</a><a class="headerlink" href="#op-node-add" title="Permalink to this headline">¶</a></h4>
<p>Adds a node to the cluster.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>node-add</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>NODE_NAME, NODE_PIP, NODE_SIP, MASTER_CAPABLE, VM_CAPABLE</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>all existing nodes</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>all nodes plus the new node</p>
</dd>
</dl>
</div>
<div class="section" id="op-node-remove">
<h4><a class="toc-backref" href="#id12">OP_NODE_REMOVE</a><a class="headerlink" href="#op-node-remove" title="Permalink to this headline">¶</a></h4>
<p>Removes a node from the cluster. On the removed node the hooks are
called during the execution of the operation and not after its
completion.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>node-remove</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>NODE_NAME</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>all existing nodes except the removed node</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>all existing nodes</p>
</dd>
</dl>
</div>
<div class="section" id="op-node-set-params">
<h4><a class="toc-backref" href="#id13">OP_NODE_SET_PARAMS</a><a class="headerlink" href="#op-node-set-params" title="Permalink to this headline">¶</a></h4>
<p>Changes a node’s parameters.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>node-modify</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>MASTER_CANDIDATE, OFFLINE, DRAINED, MASTER_CAPABLE, VM_CAPABLE</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node, the target node</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node, the target node</p>
</dd>
</dl>
</div>
<div class="section" id="op-node-migrate">
<h4><a class="toc-backref" href="#id14">OP_NODE_MIGRATE</a><a class="headerlink" href="#op-node-migrate" title="Permalink to this headline">¶</a></h4>
<p>Relocate secondary instances from a node.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>node-migrate</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>NODE_NAME</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node</p>
</dd>
</dl>
</div>
</div>
<div class="section" id="node-group-operations">
<h3><a class="toc-backref" href="#id15">Node group operations</a><a class="headerlink" href="#node-group-operations" title="Permalink to this headline">¶</a></h3>
<div class="section" id="op-group-add">
<h4><a class="toc-backref" href="#id16">OP_GROUP_ADD</a><a class="headerlink" href="#op-group-add" title="Permalink to this headline">¶</a></h4>
<p>Adds a node group to the cluster.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>group-add</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>GROUP_NAME</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node</p>
</dd>
</dl>
</div>
<div class="section" id="op-group-set-params">
<h4><a class="toc-backref" href="#id17">OP_GROUP_SET_PARAMS</a><a class="headerlink" href="#op-group-set-params" title="Permalink to this headline">¶</a></h4>
<p>Changes a node group’s parameters.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>group-modify</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>GROUP_NAME, NEW_ALLOC_POLICY</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node</p>
</dd>
</dl>
</div>
<div class="section" id="op-group-remove">
<h4><a class="toc-backref" href="#id18">OP_GROUP_REMOVE</a><a class="headerlink" href="#op-group-remove" title="Permalink to this headline">¶</a></h4>
<p>Removes a node group from the cluster. Since the node group must be
empty for removal to succeed, the concept of “nodes in the group” does
not exist, and the hook is only executed in the master node.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>group-remove</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>GROUP_NAME</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node</p>
</dd>
</dl>
</div>
<div class="section" id="op-group-rename">
<h4><a class="toc-backref" href="#id19">OP_GROUP_RENAME</a><a class="headerlink" href="#op-group-rename" title="Permalink to this headline">¶</a></h4>
<p>Renames a node group.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>group-rename</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>OLD_NAME, NEW_NAME</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node and all nodes in the group</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node and all nodes in the group</p>
</dd>
</dl>
</div>
<div class="section" id="op-group-evacuate">
<h4><a class="toc-backref" href="#id20">OP_GROUP_EVACUATE</a><a class="headerlink" href="#op-group-evacuate" title="Permalink to this headline">¶</a></h4>
<p>Evacuates a node group.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>group-evacuate</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>GROUP_NAME, TARGET_GROUPS</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node and all nodes in the group</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node and all nodes in the group</p>
</dd>
</dl>
</div>
</div>
<div class="section" id="network-operations">
<h3><a class="toc-backref" href="#id21">Network operations</a><a class="headerlink" href="#network-operations" title="Permalink to this headline">¶</a></h3>
<div class="section" id="op-network-add">
<h4><a class="toc-backref" href="#id22">OP_NETWORK_ADD</a><a class="headerlink" href="#op-network-add" title="Permalink to this headline">¶</a></h4>
<p>Adds a network to the cluster.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>network-add</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>NETWORK_NAME, NETWORK_SUBNET, NETWORK_GATEWAY, NETWORK_SUBNET6,
NETWORK_GATEWAY6, NETWORK_MAC_PREFIX, NETWORK_TAGS</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node</p>
</dd>
</dl>
</div>
<div class="section" id="op-network-remove">
<h4><a class="toc-backref" href="#id23">OP_NETWORK_REMOVE</a><a class="headerlink" href="#op-network-remove" title="Permalink to this headline">¶</a></h4>
<p>Removes a network from the cluster.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>network-remove</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>NETWORK_NAME</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node</p>
</dd>
</dl>
</div>
<div class="section" id="op-network-connect">
<h4><a class="toc-backref" href="#id24">OP_NETWORK_CONNECT</a><a class="headerlink" href="#op-network-connect" title="Permalink to this headline">¶</a></h4>
<p>Connects a network to a nodegroup.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>network-connect</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>GROUP_NAME, NETWORK_NAME,
GROUP_NETWORK_MODE, GROUP_NETWORK_LINK, GROUP_NETWORK_VLAN,
NETWORK_SUBNET, NETWORK_GATEWAY, NETWORK_SUBNET6,
NETWORK_GATEWAY6, NETWORK_MAC_PREFIX, NETWORK_TAGS</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>nodegroup nodes</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>nodegroup nodes</p>
</dd>
</dl>
</div>
<div class="section" id="op-network-disconnect">
<h4><a class="toc-backref" href="#id25">OP_NETWORK_DISCONNECT</a><a class="headerlink" href="#op-network-disconnect" title="Permalink to this headline">¶</a></h4>
<p>Disconnects a network from a nodegroup.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>network-disconnect</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>GROUP_NAME, NETWORK_NAME,
GROUP_NETWORK_MODE, GROUP_NETWORK_LINK, GROUP_NETWORK_VLAN,
NETWORK_SUBNET, NETWORK_GATEWAY, NETWORK_SUBNET6,
NETWORK_GATEWAY6, NETWORK_MAC_PREFIX, NETWORK_TAGS</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>nodegroup nodes</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>nodegroup nodes</p>
</dd>
</dl>
</div>
<div class="section" id="op-network-set-params">
<h4><a class="toc-backref" href="#id26">OP_NETWORK_SET_PARAMS</a><a class="headerlink" href="#op-network-set-params" title="Permalink to this headline">¶</a></h4>
<p>Modifies a network.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>network-modify</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>NETWORK_NAME, NETWORK_SUBNET, NETWORK_GATEWAY, NETWORK_SUBNET6,
NETWORK_GATEWAY6, NETWORK_MAC_PREFIX, NETWORK_TAGS</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node</p>
</dd>
</dl>
</div>
</div>
<div class="section" id="instance-operations">
<h3><a class="toc-backref" href="#id27">Instance operations</a><a class="headerlink" href="#instance-operations" title="Permalink to this headline">¶</a></h3>
<p>All instance operations take at least the following variables:
INSTANCE_NAME, INSTANCE_PRIMARY, INSTANCE_SECONDARY,
INSTANCE_OS_TYPE, INSTANCE_DISK_TEMPLATE, INSTANCE_MEMORY,
INSTANCE_DISK_SIZES, INSTANCE_VCPUS, INSTANCE_NIC_COUNT,
INSTANCE_NICn_IP, INSTANCE_NICn_BRIDGE, INSTANCE_NICn_MAC,
INSTANCE_NICn_NETWORK,
INSTANCE_NICn_NETWORK_UUID, INSTANCE_NICn_NETWORK_SUBNET,
INSTANCE_NICn_NETWORK_GATEWAY, INSTANCE_NICn_NETWORK_SUBNET6,
INSTANCE_NICn_NETWORK_GATEWAY6, INSTANCE_NICn_NETWORK_MAC_PREFIX,
INSTANCE_DISK_COUNT, INSTANCE_DISKn_SIZE, INSTANCE_DISKn_MODE,
INSTANCE_DISKn_NAME, INSTANCE_DISKn_UUID, INSTANCE_DISKn_DEV_TYPE.</p>
<p>The INSTANCE_NICn_* and INSTANCE_DISKn_* variables represent the
properties of the <em>n</em> -th NIC and disk, and are zero-indexed.
Depending on the disk template, Ganeti exports some info related to
the logical id of the disk, that is basically its driver and id.</p>
<p>The INSTANCE_NICn_NETWORK_* variables are only passed if a NIC’s network
parameter is set (that is if the NIC is associated to a network defined
via <code class="docutils literal notranslate"><span class="pre">gnt-network</span></code>)</p>
<div class="section" id="op-instance-create">
<h4><a class="toc-backref" href="#id28">OP_INSTANCE_CREATE</a><a class="headerlink" href="#op-instance-create" title="Permalink to this headline">¶</a></h4>
<p>Creates a new instance.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>instance-add</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>ADD_MODE, SRC_NODE, SRC_PATH, SRC_IMAGES</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node, primary and secondary nodes</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node, primary and secondary nodes</p>
</dd>
</dl>
</div>
<div class="section" id="op-instance-reinstall">
<h4><a class="toc-backref" href="#id29">OP_INSTANCE_REINSTALL</a><a class="headerlink" href="#op-instance-reinstall" title="Permalink to this headline">¶</a></h4>
<p>Reinstalls an instance.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>instance-reinstall</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>only the standard instance vars</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node, primary and secondary nodes</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node, primary and secondary nodes</p>
</dd>
</dl>
</div>
<div class="section" id="op-backup-export">
<h4><a class="toc-backref" href="#id30">OP_BACKUP_EXPORT</a><a class="headerlink" href="#op-backup-export" title="Permalink to this headline">¶</a></h4>
<p>Exports the instance.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>instance-export</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>EXPORT_MODE, EXPORT_NODE, EXPORT_DO_SHUTDOWN, REMOVE_INSTANCE</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node, primary and secondary nodes</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node, primary and secondary nodes</p>
</dd>
</dl>
</div>
<div class="section" id="op-instance-startup">
<h4><a class="toc-backref" href="#id31">OP_INSTANCE_STARTUP</a><a class="headerlink" href="#op-instance-startup" title="Permalink to this headline">¶</a></h4>
<p>Starts an instance.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>instance-start</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>FORCE</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node, primary and secondary nodes</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node, primary and secondary nodes</p>
</dd>
</dl>
</div>
<div class="section" id="op-instance-shutdown">
<h4><a class="toc-backref" href="#id32">OP_INSTANCE_SHUTDOWN</a><a class="headerlink" href="#op-instance-shutdown" title="Permalink to this headline">¶</a></h4>
<p>Stops an instance.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>instance-stop</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>TIMEOUT</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node, primary and secondary nodes</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node, primary and secondary nodes</p>
</dd>
</dl>
</div>
<div class="section" id="op-instance-reboot">
<h4><a class="toc-backref" href="#id33">OP_INSTANCE_REBOOT</a><a class="headerlink" href="#op-instance-reboot" title="Permalink to this headline">¶</a></h4>
<p>Reboots an instance.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>instance-reboot</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>IGNORE_SECONDARIES, REBOOT_TYPE, SHUTDOWN_TIMEOUT</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node, primary and secondary nodes</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node, primary and secondary nodes</p>
</dd>
</dl>
</div>
<div class="section" id="op-instance-set-params">
<h4><a class="toc-backref" href="#id34">OP_INSTANCE_SET_PARAMS</a><a class="headerlink" href="#op-instance-set-params" title="Permalink to this headline">¶</a></h4>
<p>Modifies the instance parameters.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>instance-modify</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>NEW_DISK_TEMPLATE, RUNTIME_MEMORY</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node, primary and secondary nodes</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node, primary and secondary nodes</p>
</dd>
</dl>
</div>
<div class="section" id="op-instance-failover">
<h4><a class="toc-backref" href="#id35">OP_INSTANCE_FAILOVER</a><a class="headerlink" href="#op-instance-failover" title="Permalink to this headline">¶</a></h4>
<p>Failovers an instance. In the post phase INSTANCE_PRIMARY and
INSTANCE_SECONDARY refer to the nodes that were repectively primary
and secondary before failover.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>instance-failover</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>IGNORE_CONSISTENCY, SHUTDOWN_TIMEOUT, OLD_PRIMARY, OLD_SECONDARY, NEW_PRIMARY, NEW_SECONDARY</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node, secondary (target) node</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node, primary (source) and secondary (target) nodes</p>
</dd>
</dl>
</div>
<div class="section" id="op-instance-migrate">
<h4><a class="toc-backref" href="#id36">OP_INSTANCE_MIGRATE</a><a class="headerlink" href="#op-instance-migrate" title="Permalink to this headline">¶</a></h4>
<p>Migrates an instance. In the post phase INSTANCE_PRIMARY and
INSTANCE_SECONDARY refer to the nodes that were repectively primary
and secondary before migration.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>instance-migrate</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>MIGRATE_LIVE, MIGRATE_CLEANUP, OLD_PRIMARY, OLD_SECONDARY, NEW_PRIMARY, NEW_SECONDARY</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node, primary (source) and secondary (target) nodes</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node, primary (source) and secondary (target) nodes</p>
</dd>
</dl>
</div>
<div class="section" id="op-instance-remove">
<h4><a class="toc-backref" href="#id37">OP_INSTANCE_REMOVE</a><a class="headerlink" href="#op-instance-remove" title="Permalink to this headline">¶</a></h4>
<p>Remove an instance.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>instance-remove</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>SHUTDOWN_TIMEOUT</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node, primary and secondary nodes</p>
</dd>
</dl>
</div>
<div class="section" id="op-instance-grow-disk">
<h4><a class="toc-backref" href="#id38">OP_INSTANCE_GROW_DISK</a><a class="headerlink" href="#op-instance-grow-disk" title="Permalink to this headline">¶</a></h4>
<p>Grows the disk of an instance.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>disk-grow</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>DISK, AMOUNT</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node, primary and secondary nodes</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node, primary and secondary nodes</p>
</dd>
</dl>
</div>
<div class="section" id="op-instance-rename">
<h4><a class="toc-backref" href="#id39">OP_INSTANCE_RENAME</a><a class="headerlink" href="#op-instance-rename" title="Permalink to this headline">¶</a></h4>
<p>Renames an instance.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>instance-rename</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>INSTANCE_NEW_NAME</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node, primary and secondary nodes</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node, primary and secondary nodes</p>
</dd>
</dl>
</div>
<div class="section" id="op-instance-move">
<h4><a class="toc-backref" href="#id40">OP_INSTANCE_MOVE</a><a class="headerlink" href="#op-instance-move" title="Permalink to this headline">¶</a></h4>
<p>Move an instance by data-copying.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>instance-move</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>TARGET_NODE, SHUTDOWN_TIMEOUT</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node, primary and target nodes</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node, primary and target nodes</p>
</dd>
</dl>
</div>
<div class="section" id="op-instance-recreate-disks">
<h4><a class="toc-backref" href="#id41">OP_INSTANCE_RECREATE_DISKS</a><a class="headerlink" href="#op-instance-recreate-disks" title="Permalink to this headline">¶</a></h4>
<p>Recreate an instance’s missing disks.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>instance-recreate-disks</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>only the standard instance vars</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node, primary and secondary nodes</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node, primary and secondary nodes</p>
</dd>
</dl>
</div>
<div class="section" id="op-instance-replace-disks">
<h4><a class="toc-backref" href="#id42">OP_INSTANCE_REPLACE_DISKS</a><a class="headerlink" href="#op-instance-replace-disks" title="Permalink to this headline">¶</a></h4>
<p>Replace the disks of an instance.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>mirrors-replace</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>MODE, NEW_SECONDARY, OLD_SECONDARY</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node, primary and new secondary nodes</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node, primary and new secondary nodes</p>
</dd>
</dl>
</div>
<div class="section" id="op-instance-change-group">
<h4><a class="toc-backref" href="#id43">OP_INSTANCE_CHANGE_GROUP</a><a class="headerlink" href="#op-instance-change-group" title="Permalink to this headline">¶</a></h4>
<p>Moves an instance to another group.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>instance-change-group</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>TARGET_GROUPS</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node</p>
</dd>
</dl>
</div>
</div>
<div class="section" id="cluster-operations">
<h3><a class="toc-backref" href="#id44">Cluster operations</a><a class="headerlink" href="#cluster-operations" title="Permalink to this headline">¶</a></h3>
<div class="section" id="op-cluster-post-init">
<h4><a class="toc-backref" href="#id45">OP_CLUSTER_POST_INIT</a><a class="headerlink" href="#op-cluster-post-init" title="Permalink to this headline">¶</a></h4>
<p>This hook is called via a special “empty” LU right after cluster
initialization.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>cluster-init</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>none</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>none</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node</p>
</dd>
</dl>
</div>
<div class="section" id="op-cluster-destroy">
<h4><a class="toc-backref" href="#id46">OP_CLUSTER_DESTROY</a><a class="headerlink" href="#op-cluster-destroy" title="Permalink to this headline">¶</a></h4>
<p>The post phase of this hook is called during the execution of destroy
operation and not after its completion.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>cluster-destroy</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>none</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>none</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node</p>
</dd>
</dl>
</div>
<div class="section" id="op-cluster-verify-group">
<h4><a class="toc-backref" href="#id47">OP_CLUSTER_VERIFY_GROUP</a><a class="headerlink" href="#op-cluster-verify-group" title="Permalink to this headline">¶</a></h4>
<p>Verifies all nodes in a group. This is a special LU with regard to
hooks, as the result of the opcode will be combined with the result of
post-execution hooks, in order to allow administrators to enhance the
cluster verification procedure.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>cluster-verify</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>CLUSTER, MASTER, CLUSTER_TAGS, NODE_TAGS_&lt;name&gt;</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>none</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>all nodes in a group</p>
</dd>
</dl>
</div>
<div class="section" id="op-cluster-rename">
<h4><a class="toc-backref" href="#id48">OP_CLUSTER_RENAME</a><a class="headerlink" href="#op-cluster-rename" title="Permalink to this headline">¶</a></h4>
<p>Renames the cluster.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>cluster-rename</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>NEW_NAME</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master-node</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master-node</p>
</dd>
</dl>
</div>
<div class="section" id="op-cluster-set-params">
<h4><a class="toc-backref" href="#id49">OP_CLUSTER_SET_PARAMS</a><a class="headerlink" href="#op-cluster-set-params" title="Permalink to this headline">¶</a></h4>
<p>Modifies the cluster parameters.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>cluster-modify</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>NEW_VG_NAME</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node</p>
</dd>
</dl>
</div>
<div class="section" id="virtual-operation-op-cluster-ip-turnup">
<h4><a class="toc-backref" href="#id50">Virtual operation <code class="docutils literal notranslate"><span class="pre">OP_CLUSTER_IP_TURNUP</span></code></a><a class="headerlink" href="#virtual-operation-op-cluster-ip-turnup" title="Permalink to this headline">¶</a></h4>
<p>This doesn’t correspond to an actual op-code, but it is called when the
master IP is activated.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>master-ip-turnup</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>MASTER_NETDEV, MASTER_IP, MASTER_NETMASK, CLUSTER_IP_VERSION</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node</p>
</dd>
</dl>
</div>
<div class="section" id="virtual-operation-op-cluster-ip-turndown">
<h4><a class="toc-backref" href="#id51">Virtual operation <code class="docutils literal notranslate"><span class="pre">OP_CLUSTER_IP_TURNDOWN</span></code></a><a class="headerlink" href="#virtual-operation-op-cluster-ip-turndown" title="Permalink to this headline">¶</a></h4>
<p>This doesn’t correspond to an actual op-code, but it is called when the
master IP is deactivated.</p>
<dl class="field-list simple">
<dt class="field-odd">directory</dt>
<dd class="field-odd"><p>master-ip-turndown</p>
</dd>
<dt class="field-even">env. vars</dt>
<dd class="field-even"><p>MASTER_NETDEV, MASTER_IP, MASTER_NETMASK, CLUSTER_IP_VERSION</p>
</dd>
<dt class="field-odd">pre-execution</dt>
<dd class="field-odd"><p>master node</p>
</dd>
<dt class="field-even">post-execution</dt>
<dd class="field-even"><p>master node</p>
</dd>
</dl>
</div>
</div>
<div class="section" id="obsolete-operations">
<h3><a class="toc-backref" href="#id52">Obsolete operations</a><a class="headerlink" href="#obsolete-operations" title="Permalink to this headline">¶</a></h3>
<p>The following operations are no longer present or don’t execute hooks
anymore in Ganeti 2.0:</p>
<ul class="simple">
<li><p>OP_INIT_CLUSTER</p></li>
<li><p>OP_MASTER_FAILOVER</p></li>
<li><p>OP_INSTANCE_ADD_MDDRBD</p></li>
<li><p>OP_INSTANCE_REMOVE_MDDRBD</p></li>
</ul>
</div>
</div>
<div class="section" id="environment-variables">
<h2><a class="toc-backref" href="#id53">Environment variables</a><a class="headerlink" href="#environment-variables" title="Permalink to this headline">¶</a></h2>
<p>Note that all variables listed here are actually prefixed with <em>GANETI_</em>
in order to provide a clear namespace. In addition, post-execution
scripts receive another set of variables, prefixed with <em>GANETI_POST_</em>,
representing the status after the opcode executed.</p>
<div class="section" id="common-variables">
<h3><a class="toc-backref" href="#id54">Common variables</a><a class="headerlink" href="#common-variables" title="Permalink to this headline">¶</a></h3>
<p>This is the list of environment variables supported by all operations:</p>
<dl class="simple">
<dt>HOOKS_VERSION</dt><dd><p>Documents the hooks interface version. In case this doesnt match
what the script expects, it should not run. The documents conforms
to the version 2.</p>
</dd>
<dt>HOOKS_PHASE</dt><dd><p>One of <em>PRE</em> or <em>POST</em> denoting which phase are we in.</p>
</dd>
<dt>CLUSTER</dt><dd><p>The cluster name.</p>
</dd>
<dt>MASTER</dt><dd><p>The master node.</p>
</dd>
<dt>OP_CODE</dt><dd><p>One of the <em>OP_</em> values from the list of operations.</p>
</dd>
<dt>OBJECT_TYPE</dt><dd><p>One of <code class="docutils literal notranslate"><span class="pre">INSTANCE</span></code>, <code class="docutils literal notranslate"><span class="pre">NODE</span></code>, <code class="docutils literal notranslate"><span class="pre">CLUSTER</span></code>.</p>
</dd>
<dt>DATA_DIR</dt><dd><p>The path to the Ganeti configuration directory (to read, for
example, the <em>ssconf</em> files).</p>
</dd>
</dl>
</div>
<div class="section" id="specialised-variables">
<h3><a class="toc-backref" href="#id55">Specialised variables</a><a class="headerlink" href="#specialised-variables" title="Permalink to this headline">¶</a></h3>
<p>This is the list of variables which are specific to one or more
operations.</p>
<dl class="simple">
<dt>CLUSTER_IP_VERSION</dt><dd><p>IP version of the master IP (4 or 6)</p>
</dd>
<dt>INSTANCE_NAME</dt><dd><p>The name of the instance which is the target of the operation.</p>
</dd>
<dt>INSTANCE_BE_x,y,z,…</dt><dd><p>Instance BE params. There is one variable per BE param. For instance, GANETI_INSTANCE_BE_auto_balance</p>
</dd>
<dt>INSTANCE_DISK_TEMPLATE</dt><dd><p>The disk type for the instance.</p>
</dd>
<dt>NEW_DISK_TEMPLATE</dt><dd><p>The new disk type for the instance.</p>
</dd>
<dt>INSTANCE_DISK_COUNT</dt><dd><p>The number of disks for the instance.</p>
</dd>
<dt>INSTANCE_DISKn_SIZE</dt><dd><p>The size of disk <em>n</em> for the instance.</p>
</dd>
<dt>INSTANCE_DISKn_MODE</dt><dd><p>Either <em>rw</em> for a read-write disk or <em>ro</em> for a read-only one.</p>
</dd>
<dt>INSTANCE_HV_x,y,z,…</dt><dd><p>Instance hypervisor options. There is one variable per option. For instance, GANETI_INSTANCE_HV_use_bootloader</p>
</dd>
<dt>INSTANCE_HYPERVISOR</dt><dd><p>The instance hypervisor.</p>
</dd>
<dt>INSTANCE_NIC_COUNT</dt><dd><p>The number of NICs for the instance.</p>
</dd>
<dt>INSTANCE_NICn_BRIDGE</dt><dd><p>The bridge to which the <em>n</em> -th NIC of the instance is attached.</p>
</dd>
<dt>INSTANCE_NICn_IP</dt><dd><p>The IP (if any) of the <em>n</em> -th NIC of the instance.</p>
</dd>
<dt>INSTANCE_NICn_MAC</dt><dd><p>The MAC address of the <em>n</em> -th NIC of the instance.</p>
</dd>
<dt>INSTANCE_NICn_MODE</dt><dd><p>The mode of the <em>n</em> -th NIC of the instance.</p>
</dd>
<dt>INSTANCE_OS_TYPE</dt><dd><p>The name of the instance OS.</p>
</dd>
<dt>INSTANCE_PRIMARY</dt><dd><p>The name of the node which is the primary for the instance. Note that
for migrations/failovers, you shouldn’t rely on this variable since
the nodes change during the exectution, but on the
OLD_PRIMARY/NEW_PRIMARY values.</p>
</dd>
<dt>INSTANCE_SECONDARY</dt><dd><p>Space-separated list of secondary nodes for the instance. Note that
for migrations/failovers, you shouldn’t rely on this variable since
the nodes change during the exectution, but on the
OLD_SECONDARY/NEW_SECONDARY values.</p>
</dd>
<dt>INSTANCE_MEMORY</dt><dd><p>The memory size (in MiBs) of the instance.</p>
</dd>
<dt>INSTANCE_VCPUS</dt><dd><p>The number of virtual CPUs for the instance.</p>
</dd>
<dt>INSTANCE_STATUS</dt><dd><p>The run status of the instance.</p>
</dd>
<dt>MASTER_CAPABLE</dt><dd><p>Whether a node is capable of being promoted to master.</p>
</dd>
<dt>VM_CAPABLE</dt><dd><p>Whether the node can host instances.</p>
</dd>
<dt>MASTER_NETDEV</dt><dd><p>Network device of the master IP</p>
</dd>
<dt>MASTER_IP</dt><dd><p>The master IP</p>
</dd>
<dt>MASTER_NETMASK</dt><dd><p>Netmask of the master IP</p>
</dd>
<dt>INSTANCE_TAGS</dt><dd><p>A space-delimited list of the instance’s tags.</p>
</dd>
<dt>NODE_NAME</dt><dd><p>The target node of this operation (not the node on which the hook
runs).</p>
</dd>
<dt>NODE_PIP</dt><dd><p>The primary IP of the target node (the one over which inter-node
communication is done).</p>
</dd>
<dt>NODE_SIP</dt><dd><p>The secondary IP of the target node (the one over which drbd
replication is done). This can be equal to the primary ip, in case
the cluster is not dual-homed.</p>
</dd>
<dt>FORCE</dt><dd><p>This is provided by some operations when the user gave this flag.</p>
</dd>
<dt>IGNORE_CONSISTENCY</dt><dd><p>The user has specified this flag. It is used when failing over
instances in case the primary node is down.</p>
</dd>
<dt>ADD_MODE</dt><dd><p>The mode of the instance create: either <em>create</em> for create from
scratch or <em>import</em> for restoring from an exported image.</p>
</dd>
<dt>SRC_NODE, SRC_PATH, SRC_IMAGE</dt><dd><p>In case the instance has been added by import, these variables are
defined and point to the source node, source path (the directory
containing the image and the config file) and the source disk image
file.</p>
</dd>
<dt>NEW_SECONDARY</dt><dd><p>The name of the node on which the new mirror component is being
added (for replace disk). This can be the name of the current
secondary, if the new mirror is on the same secondary. For
migrations/failovers, this is the old primary node.</p>
</dd>
<dt>OLD_SECONDARY</dt><dd><p>The name of the old secondary in the replace-disks command. Note that
this can be equal to the new secondary if the secondary node hasn’t
actually changed. For migrations/failovers, this is the new primary
node.</p>
</dd>
<dt>OLD_PRIMARY, NEW_PRIMARY</dt><dd><p>For migrations/failovers, the old and respectively new primary
nodes. These two mirror the NEW_SECONDARY/OLD_SECONDARY variables</p>
</dd>
<dt>EXPORT_MODE</dt><dd><p>The instance export mode. Either “remote” or “local”.</p>
</dd>
<dt>EXPORT_NODE</dt><dd><p>The node on which the exported image of the instance was done.</p>
</dd>
<dt>EXPORT_DO_SHUTDOWN</dt><dd><p>This variable tells if the instance has been shutdown or not while
doing the export. In the “was shutdown” case, it’s likely that the
filesystem is consistent, whereas in the “did not shutdown” case,
the filesystem would need a check (journal replay or full fsck) in
order to guarantee consistency.</p>
</dd>
<dt>REMOVE_INSTANCE</dt><dd><p>Whether the instance was removed from the node.</p>
</dd>
<dt>SHUTDOWN_TIMEOUT</dt><dd><p>Amount of time to wait for the instance to shutdown.</p>
</dd>
<dt>TIMEOUT</dt><dd><p>Amount of time to wait before aborting the op.</p>
</dd>
<dt>OLD_NAME, NEW_NAME</dt><dd><p>Old/new name of the node group.</p>
</dd>
<dt>GROUP_NAME</dt><dd><p>The name of the node group.</p>
</dd>
<dt>NEW_ALLOC_POLICY</dt><dd><p>The new allocation policy for the node group.</p>
</dd>
<dt>CLUSTER_TAGS</dt><dd><p>The list of cluster tags, space separated.</p>
</dd>
<dt>NODE_TAGS_&lt;name&gt;</dt><dd><p>The list of tags for node <em>&lt;name&gt;</em>, space separated.</p>
</dd>
</dl>
</div>
</div>
<div class="section" id="examples">
<h2><a class="toc-backref" href="#id56">Examples</a><a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h2>
<p>The startup of an instance will pass this environment to the hook
script:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">GANETI_CLUSTER</span><span class="o">=</span><span class="n">cluster1</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">GANETI_DATA_DIR</span><span class="o">=/</span><span class="n">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ganeti</span>
<span class="n">GANETI_FORCE</span><span class="o">=</span><span class="kc">False</span>
<span class="n">GANETI_HOOKS_PATH</span><span class="o">=</span><span class="n">instance</span><span class="o">-</span><span class="n">start</span>
<span class="n">GANETI_HOOKS_PHASE</span><span class="o">=</span><span class="n">post</span>
<span class="n">GANETI_HOOKS_VERSION</span><span class="o">=</span><span class="mi">2</span>
<span class="n">GANETI_INSTANCE_DISK0_MODE</span><span class="o">=</span><span class="n">rw</span>
<span class="n">GANETI_INSTANCE_DISK0_SIZE</span><span class="o">=</span><span class="mi">128</span>
<span class="n">GANETI_INSTANCE_DISK_COUNT</span><span class="o">=</span><span class="mi">1</span>
<span class="n">GANETI_INSTANCE_DISK_TEMPLATE</span><span class="o">=</span><span class="n">drbd</span>
<span class="n">GANETI_INSTANCE_MEMORY</span><span class="o">=</span><span class="mi">128</span>
<span class="n">GANETI_INSTANCE_NAME</span><span class="o">=</span><span class="n">instance2</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">GANETI_INSTANCE_NIC0_BRIDGE</span><span class="o">=</span><span class="n">xen</span><span class="o">-</span><span class="n">br0</span>
<span class="n">GANETI_INSTANCE_NIC0_IP</span><span class="o">=</span>
<span class="n">GANETI_INSTANCE_NIC0_MAC</span><span class="o">=</span><span class="n">aa</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="mi">00</span><span class="p">:</span><span class="n">a5</span><span class="p">:</span><span class="mi">91</span><span class="p">:</span><span class="mi">58</span>
<span class="n">GANETI_INSTANCE_NIC_COUNT</span><span class="o">=</span><span class="mi">1</span>
<span class="n">GANETI_INSTANCE_OS_TYPE</span><span class="o">=</span><span class="n">debootstrap</span>
<span class="n">GANETI_INSTANCE_PRIMARY</span><span class="o">=</span><span class="n">node3</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">GANETI_INSTANCE_SECONDARY</span><span class="o">=</span><span class="n">node5</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">GANETI_INSTANCE_STATUS</span><span class="o">=</span><span class="n">down</span>
<span class="n">GANETI_INSTANCE_VCPUS</span><span class="o">=</span><span class="mi">1</span>
<span class="n">GANETI_MASTER</span><span class="o">=</span><span class="n">node1</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">GANETI_OBJECT_TYPE</span><span class="o">=</span><span class="n">INSTANCE</span>
<span class="n">GANETI_OP_CODE</span><span class="o">=</span><span class="n">OP_INSTANCE_STARTUP</span>
<span class="n">GANETI_OP_TARGET</span><span class="o">=</span><span class="n">instance2</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Ganeti customisation using hooks</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#organisation">Organisation</a><ul>
<li><a class="reference internal" href="#pre-scripts"><em>pre</em> scripts</a></li>
<li><a class="reference internal" href="#post-scripts"><em>post</em> scripts</a></li>
<li><a class="reference internal" href="#naming">Naming</a></li>
<li><a class="reference internal" href="#order-of-execution">Order of execution</a></li>
<li><a class="reference internal" href="#execution-environment">Execution environment</a></li>
</ul>
</li>
<li><a class="reference internal" href="#operation-list">Operation list</a><ul>
<li><a class="reference internal" href="#node-operations">Node operations</a><ul>
<li><a class="reference internal" href="#op-node-add">OP_NODE_ADD</a></li>
<li><a class="reference internal" href="#op-node-remove">OP_NODE_REMOVE</a></li>
<li><a class="reference internal" href="#op-node-set-params">OP_NODE_SET_PARAMS</a></li>
<li><a class="reference internal" href="#op-node-migrate">OP_NODE_MIGRATE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#node-group-operations">Node group operations</a><ul>
<li><a class="reference internal" href="#op-group-add">OP_GROUP_ADD</a></li>
<li><a class="reference internal" href="#op-group-set-params">OP_GROUP_SET_PARAMS</a></li>
<li><a class="reference internal" href="#op-group-remove">OP_GROUP_REMOVE</a></li>
<li><a class="reference internal" href="#op-group-rename">OP_GROUP_RENAME</a></li>
<li><a class="reference internal" href="#op-group-evacuate">OP_GROUP_EVACUATE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#network-operations">Network operations</a><ul>
<li><a class="reference internal" href="#op-network-add">OP_NETWORK_ADD</a></li>
<li><a class="reference internal" href="#op-network-remove">OP_NETWORK_REMOVE</a></li>
<li><a class="reference internal" href="#op-network-connect">OP_NETWORK_CONNECT</a></li>
<li><a class="reference internal" href="#op-network-disconnect">OP_NETWORK_DISCONNECT</a></li>
<li><a class="reference internal" href="#op-network-set-params">OP_NETWORK_SET_PARAMS</a></li>
</ul>
</li>
<li><a class="reference internal" href="#instance-operations">Instance operations</a><ul>
<li><a class="reference internal" href="#op-instance-create">OP_INSTANCE_CREATE</a></li>
<li><a class="reference internal" href="#op-instance-reinstall">OP_INSTANCE_REINSTALL</a></li>
<li><a class="reference internal" href="#op-backup-export">OP_BACKUP_EXPORT</a></li>
<li><a class="reference internal" href="#op-instance-startup">OP_INSTANCE_STARTUP</a></li>
<li><a class="reference internal" href="#op-instance-shutdown">OP_INSTANCE_SHUTDOWN</a></li>
<li><a class="reference internal" href="#op-instance-reboot">OP_INSTANCE_REBOOT</a></li>
<li><a class="reference internal" href="#op-instance-set-params">OP_INSTANCE_SET_PARAMS</a></li>
<li><a class="reference internal" href="#op-instance-failover">OP_INSTANCE_FAILOVER</a></li>
<li><a class="reference internal" href="#op-instance-migrate">OP_INSTANCE_MIGRATE</a></li>
<li><a class="reference internal" href="#op-instance-remove">OP_INSTANCE_REMOVE</a></li>
<li><a class="reference internal" href="#op-instance-grow-disk">OP_INSTANCE_GROW_DISK</a></li>
<li><a class="reference internal" href="#op-instance-rename">OP_INSTANCE_RENAME</a></li>
<li><a class="reference internal" href="#op-instance-move">OP_INSTANCE_MOVE</a></li>
<li><a class="reference internal" href="#op-instance-recreate-disks">OP_INSTANCE_RECREATE_DISKS</a></li>
<li><a class="reference internal" href="#op-instance-replace-disks">OP_INSTANCE_REPLACE_DISKS</a></li>
<li><a class="reference internal" href="#op-instance-change-group">OP_INSTANCE_CHANGE_GROUP</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cluster-operations">Cluster operations</a><ul>
<li><a class="reference internal" href="#op-cluster-post-init">OP_CLUSTER_POST_INIT</a></li>
<li><a class="reference internal" href="#op-cluster-destroy">OP_CLUSTER_DESTROY</a></li>
<li><a class="reference internal" href="#op-cluster-verify-group">OP_CLUSTER_VERIFY_GROUP</a></li>
<li><a class="reference internal" href="#op-cluster-rename">OP_CLUSTER_RENAME</a></li>
<li><a class="reference internal" href="#op-cluster-set-params">OP_CLUSTER_SET_PARAMS</a></li>
<li><a class="reference internal" href="#virtual-operation-op-cluster-ip-turnup">Virtual operation <code class="docutils literal notranslate"><span class="pre">OP_CLUSTER_IP_TURNUP</span></code></a></li>
<li><a class="reference internal" href="#virtual-operation-op-cluster-ip-turndown">Virtual operation <code class="docutils literal notranslate"><span class="pre">OP_CLUSTER_IP_TURNDOWN</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#obsolete-operations">Obsolete operations</a></li>
</ul>
</li>
<li><a class="reference internal" href="#environment-variables">Environment variables</a><ul>
<li><a class="reference internal" href="#common-variables">Common variables</a></li>
<li><a class="reference internal" href="#specialised-variables">Specialised variables</a></li>
</ul>
</li>
<li><a class="reference internal" href="#examples">Examples</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="glossary.html"
                        title="previous chapter">Glossary</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="iallocator.html"
                        title="next chapter">Ganeti automatic instance allocation</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/hooks.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="iallocator.html" title="Ganeti automatic instance allocation"
             >next</a></li>
        <li class="right" >
          <a href="glossary.html" title="Glossary"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Ganeti 3.0.2 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Ganeti customisation using hooks</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015 Google Inc..
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.4.3.
    </div>
  </body>
</html>