
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ganeti Node OOB Management Framework &#8212; Ganeti 3.0.2 documentation</title>
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css" />
    
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Support for Open vSwitch" href="design-openvswitch.html" />
    <link rel="prev" title="Improvements of Node Security" href="design-node-security.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="design-openvswitch.html" title="Support for Open vSwitch"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="design-node-security.html" title="Improvements of Node Security"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Ganeti 3.0.2 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Ganeti Node OOB Management Framework</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="ganeti-node-oob-management-framework">
<h1>Ganeti Node OOB Management Framework<a class="headerlink" href="#ganeti-node-oob-management-framework" title="Permalink to this headline">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Created</dt>
<dd class="field-odd"><p>2010-Nov-04</p>
</dd>
<dt class="field-even">Status</dt>
<dd class="field-even"><p>Implemented</p>
</dd>
<dt class="field-odd">Ganeti-Version</dt>
<dd class="field-odd"><p>2.4.0</p>
</dd>
</dl>
<div class="section" id="objective">
<h2>Objective<a class="headerlink" href="#objective" title="Permalink to this headline">¶</a></h2>
<p>Extend Ganeti with Out of Band (<a class="reference internal" href="glossary.html#term-OOB"><span class="xref std std-term">OOB</span></a>) Cluster Node Management
Capabilities.</p>
</div>
<div class="section" id="background">
<h2>Background<a class="headerlink" href="#background" title="Permalink to this headline">¶</a></h2>
<p>Ganeti currently has no support for Out of Band management of the nodes
in a cluster. It relies on the OS running on the nodes and has therefore
limited possibilities when the OS is not responding. The command
<code class="docutils literal notranslate"><span class="pre">gnt-node</span> <span class="pre">powercycle</span></code> can be issued to attempt a reboot of a node that
crashed but there are no means to power a node off and power it back
on. Supporting this is very handy in the following situations:</p>
<blockquote>
<div><ul class="simple">
<li><p><strong>Emergency Power Off</strong>: During emergencies, time is critical and
manual tasks just add latency which can be avoided through
automation. If a server room overheats, halting the OS on the nodes
is not enough. The nodes need to be powered off cleanly to prevent
damage to equipment.</p></li>
<li><p><strong>Repairs</strong>: In most cases, repairing a node means that the node has
to be powered off.</p></li>
<li><p><strong>Crashes</strong>: Software bugs may crash a node. Having an OS
independent way to power-cycle a node helps to recover the node
without human intervention.</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h2>
<p>Ganeti will be extended with OOB capabilities through adding a new
<strong>Cluster Parameter</strong> (<code class="docutils literal notranslate"><span class="pre">--oob-program</span></code>), a new <strong>Node Property</strong>
(<code class="docutils literal notranslate"><span class="pre">--oob-program</span></code>), a new <strong>Node State (powered)</strong> and support in
<code class="docutils literal notranslate"><span class="pre">gnt-node</span></code> for invoking an <strong>External Helper Command</strong> which executes
the actual OOB command (<code class="docutils literal notranslate"><span class="pre">gnt-node</span> <span class="pre">&lt;command&gt;</span> <span class="pre">nodename</span> <span class="pre">...</span></code>). The
supported commands are: <code class="docutils literal notranslate"><span class="pre">power</span> <span class="pre">on</span></code>, <code class="docutils literal notranslate"><span class="pre">power</span> <span class="pre">off</span></code>, <code class="docutils literal notranslate"><span class="pre">power</span> <span class="pre">cycle</span></code>,
<code class="docutils literal notranslate"><span class="pre">power</span> <span class="pre">status</span></code> and <code class="docutils literal notranslate"><span class="pre">health</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The new <strong>Node State (powered)</strong> is a <strong>State of Record</strong>
(<a class="reference internal" href="glossary.html#term-SoR"><span class="xref std std-term">SoR</span></a>), not a <strong>State of World</strong> (<a class="reference internal" href="glossary.html#term-SoW"><span class="xref std std-term">SoW</span></a>).  The maximum
execution time of the <strong>External Helper Command</strong> will be limited to
60s to prevent the cluster from getting locked for an undefined amount
of time.</p>
</div>
</div>
<div class="section" id="detailed-design">
<h2>Detailed Design<a class="headerlink" href="#detailed-design" title="Permalink to this headline">¶</a></h2>
<div class="section" id="new-gnt-cluster-parameter">
<h3>New <code class="docutils literal notranslate"><span class="pre">gnt-cluster</span></code> Parameter<a class="headerlink" href="#new-gnt-cluster-parameter" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">Program: <code class="docutils literal notranslate"><span class="pre">gnt-cluster</span></code></div>
<div class="line">Command: <code class="docutils literal notranslate"><span class="pre">modify|init</span></code></div>
<div class="line">Parameters: <code class="docutils literal notranslate"><span class="pre">--oob-program</span></code></div>
<div class="line">Options: <code class="docutils literal notranslate"><span class="pre">--oob-program</span></code>: executable OOB program (absolute path)</div>
</div>
</div>
<div class="section" id="new-gnt-cluster-epo-command">
<h3>New <code class="docutils literal notranslate"><span class="pre">gnt-cluster</span> <span class="pre">epo</span></code> Command<a class="headerlink" href="#new-gnt-cluster-epo-command" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">Program: <code class="docutils literal notranslate"><span class="pre">gnt-cluster</span></code></div>
<div class="line">Command: <code class="docutils literal notranslate"><span class="pre">epo</span></code></div>
<div class="line">Parameter: <code class="docutils literal notranslate"><span class="pre">--on</span></code> <code class="docutils literal notranslate"><span class="pre">--force</span></code> <code class="docutils literal notranslate"><span class="pre">--groups</span></code> <code class="docutils literal notranslate"><span class="pre">--all</span></code></div>
<div class="line">Options: <code class="docutils literal notranslate"><span class="pre">--on</span></code>: By default epo turns off, with <code class="docutils literal notranslate"><span class="pre">--on</span></code> it tries to get the</div>
<div class="line-block">
<div class="line-block">
<div class="line">cluster back online</div>
</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">--force</span></code>: To force the operation without asking for confirmation</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">--groups</span></code>: To operate on groups instead of nodes</div>
<div class="line"><code class="docutils literal notranslate"><span class="pre">--all</span></code>: To operate on the whole cluster</div>
</div>
</div>
<p>This is a convenience command to allow easy emergency power off of a
whole cluster or part of it. It takes care of all steps needed to get
the cluster into a sane state to turn off the nodes.</p>
<p>With <code class="docutils literal notranslate"><span class="pre">--on</span></code> it does the reverse and tries to bring the rest of the
cluster back to life.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The master node is not able to shut itself cleanly down. Therefore,
this command will not do all the work on single node clusters. On
multi node clusters the command tries to find another master or if
that is not possible prepares everything to the point where the user
has to shutdown the master node itself alone this applies also to the
single node cluster configuration.</p>
</div>
</div>
<div class="section" id="new-gnt-node-property">
<h3>New <code class="docutils literal notranslate"><span class="pre">gnt-node</span></code> Property<a class="headerlink" href="#new-gnt-node-property" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">Program: <code class="docutils literal notranslate"><span class="pre">gnt-node</span></code></div>
<div class="line">Command: <code class="docutils literal notranslate"><span class="pre">modify|add</span></code></div>
<div class="line">Parameters: <code class="docutils literal notranslate"><span class="pre">--oob-program</span></code></div>
<div class="line">Options: <code class="docutils literal notranslate"><span class="pre">--oob-program</span></code>: executable OOB program (absolute path)</div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If <code class="docutils literal notranslate"><span class="pre">--oob-program</span></code> is set to <code class="docutils literal notranslate"><span class="pre">!</span></code> then the node has no OOB
capabilities.  Otherwise, we will inherit the node group respectively
the cluster wide value. I.e. the nodes have to opt out from OOB
capabilities.</p>
</div>
</div>
<div class="section" id="addition-to-gnt-cluster-verify">
<h3>Addition to <code class="docutils literal notranslate"><span class="pre">gnt-cluster</span> <span class="pre">verify</span></code><a class="headerlink" href="#addition-to-gnt-cluster-verify" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">Program: <code class="docutils literal notranslate"><span class="pre">gnt-cluster</span></code></div>
<div class="line">Command: <code class="docutils literal notranslate"><span class="pre">verify</span></code></div>
<div class="line">Parameter: None</div>
<div class="line">Option: None</div>
<div class="line">Additional Checks:</div>
</div>
<blockquote>
<div><ol class="arabic simple">
<li><p>existence and execution flag of OOB program on all Master
Candidates if the cluster parameter <code class="docutils literal notranslate"><span class="pre">--oob-program</span></code> is set or at
least one node has the property <code class="docutils literal notranslate"><span class="pre">--oob-program</span></code> set. The OOB
helper is just invoked on the master</p></li>
<li><p>check if node state powered matches actual power state of the
machine for those nodes where <code class="docutils literal notranslate"><span class="pre">--oob-program</span></code> is set</p></li>
</ol>
</div></blockquote>
</div>
<div class="section" id="new-node-state">
<h3>New Node State<a class="headerlink" href="#new-node-state" title="Permalink to this headline">¶</a></h3>
<p>Ganeti supports the following two boolean states related to the nodes:</p>
<dl class="simple">
<dt><strong>drained</strong></dt><dd><p>The cluster still communicates with drained nodes but excludes them
from allocation operations</p>
</dd>
<dt><strong>offline</strong></dt><dd><p>if offline, the cluster does not communicate with offline nodes;
useful for nodes that are not reachable in order to avoid delays</p>
</dd>
</dl>
<p>And will extend this list with the following boolean state:</p>
<dl class="simple">
<dt><strong>powered</strong></dt><dd><p>if not powered, the cluster does not communicate with not powered
nodes if the node property <code class="docutils literal notranslate"><span class="pre">--oob-program</span></code> is not set, the state
powered is not displayed</p>
</dd>
</dl>
<p>Additionally modify the meaning of the offline state as follows:</p>
<dl class="simple">
<dt><strong>offline</strong></dt><dd><p>if offline, the cluster does not communicate with offline nodes
(<strong>with the exception of OOB commands for nodes where</strong>
<code class="docutils literal notranslate"><span class="pre">--oob-program</span></code> <strong>is set</strong>); useful for nodes that are not reachable
in order to avoid delays</p>
</dd>
</dl>
<p>The corresponding command extensions are:</p>
<div class="line-block">
<div class="line">Program: <code class="docutils literal notranslate"><span class="pre">gnt-node</span></code></div>
<div class="line">Command: <code class="docutils literal notranslate"><span class="pre">info</span></code></div>
<div class="line">Parameter:  [ <code class="docutils literal notranslate"><span class="pre">nodename</span></code> … ]</div>
<div class="line">Option: None</div>
</div>
<p>Additional Output (<a class="reference internal" href="glossary.html#term-SoR"><span class="xref std std-term">SoR</span></a>, ommited if node property
<code class="docutils literal notranslate"><span class="pre">--oob-program</span></code> is not set):
powered: <code class="docutils literal notranslate"><span class="pre">[True|False]</span></code></p>
<div class="line-block">
<div class="line">Program: <code class="docutils literal notranslate"><span class="pre">gnt-node</span></code></div>
<div class="line">Command: <code class="docutils literal notranslate"><span class="pre">modify</span></code></div>
<div class="line">Parameter: nodename</div>
<div class="line">Option: [ <code class="docutils literal notranslate"><span class="pre">--powered=yes|no</span></code> ]</div>
<div class="line">Reasoning: sometimes you will need to sync the <a class="reference internal" href="glossary.html#term-SoR"><span class="xref std std-term">SoR</span></a> with the <a class="reference internal" href="glossary.html#term-SoW"><span class="xref std std-term">SoW</span></a> manually</div>
<div class="line">Caveat: <code class="docutils literal notranslate"><span class="pre">--powered</span></code> can only be modified if <code class="docutils literal notranslate"><span class="pre">--oob-program</span></code> is set for</div>
<div class="line-block">
<div class="line">the node in question</div>
</div>
</div>
</div>
<div class="section" id="new-gnt-node-commands-power-on-off-cycle-status">
<h3>New <code class="docutils literal notranslate"><span class="pre">gnt-node</span></code> commands: <code class="docutils literal notranslate"><span class="pre">power</span> <span class="pre">[on|off|cycle|status]</span></code><a class="headerlink" href="#new-gnt-node-commands-power-on-off-cycle-status" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">Program: <code class="docutils literal notranslate"><span class="pre">gnt-node</span></code></div>
<div class="line">Command: <code class="docutils literal notranslate"><span class="pre">power</span> <span class="pre">[on|off|cycle|status]</span></code></div>
<div class="line">Parameters: [ <code class="docutils literal notranslate"><span class="pre">nodename</span></code> … ]</div>
<div class="line">Options: None</div>
<div class="line">Caveats:</div>
</div>
<blockquote>
<div><ul class="simple">
<li><p>If no nodenames are passed to <code class="docutils literal notranslate"><span class="pre">power</span> <span class="pre">[on|off|cycle]</span></code>, the user
will be prompted with <code class="docutils literal notranslate"><span class="pre">&quot;Do</span> <span class="pre">you</span> <span class="pre">really</span> <span class="pre">want</span> <span class="pre">to</span> <span class="pre">power</span> <span class="pre">[on|off|cycle]</span>
<span class="pre">the</span> <span class="pre">following</span> <span class="pre">nodes:</span> <span class="pre">&lt;display</span> <span class="pre">list</span> <span class="pre">of</span> <span class="pre">OOB</span> <span class="pre">capable</span> <span class="pre">nodes</span> <span class="pre">in</span> <span class="pre">the</span>
<span class="pre">cluster)?</span> <span class="pre">(y/n)&quot;</span></code></p></li>
<li><p>For <code class="docutils literal notranslate"><span class="pre">power-status</span></code>, nodename is optional, if omitted, we list the
power-status of all OOB capable nodes in the cluster (<a class="reference internal" href="glossary.html#term-SoW"><span class="xref std std-term">SoW</span></a>)</p></li>
<li><p>User should be warned and needs to confirm with yes if s/he tries to
<code class="docutils literal notranslate"><span class="pre">power</span> <span class="pre">[off|cycle]</span></code> a node with running instances.</p></li>
</ul>
</div></blockquote>
<div class="section" id="error-handling">
<h4>Error Handling<a class="headerlink" href="#error-handling" title="Permalink to this headline">¶</a></h4>
<table class="docutils align-default">
<colgroup>
<col style="width: 39%" />
<col style="width: 61%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Exception</p></th>
<th class="head"><p>Error Message</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>OOB program return code != 0</p></td>
<td><p>OOB program execution failed ($ERROR_MSG)</p></td>
</tr>
<tr class="row-odd"><td><p>OOB program execution time
exceeds 60s</p></td>
<td><p>OOB program execution timeout exceeded, OOB
program execution aborted</p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="node-state-changes">
<h4>Node State Changes<a class="headerlink" href="#node-state-changes" title="Permalink to this headline">¶</a></h4>
<table class="docutils align-default">
<colgroup>
<col style="width: 22%" />
<col style="width: 21%" />
<col style="width: 22%" />
<col style="width: 36%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>State before
execution</p></th>
<th class="head"><p>Command</p></th>
<th class="head"><p>State after
execution</p></th>
<th class="head"><p>Comment</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>powered: False</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">power</span> <span class="pre">off</span></code></p></td>
<td><p>powered: False</p></td>
<td><p>FYI: IPMI will complain
if you try to power off
a machine that is already
powered off</p></td>
</tr>
<tr class="row-odd"><td><p>powered: False</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">power</span> <span class="pre">cycle</span></code></p></td>
<td><p>powered: False</p></td>
<td><p>FYI: IPMI will complain
if you try to cycle a
machine that is already
powered off</p></td>
</tr>
<tr class="row-even"><td><p>powered: False</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">power</span> <span class="pre">on</span></code></p></td>
<td><p>powered: True</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>powered: True</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">power</span> <span class="pre">off</span></code></p></td>
<td><p>powered: False</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>powered: True</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">power</span> <span class="pre">cycle</span></code></p></td>
<td><p>powered: True</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>powered: True</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">power</span> <span class="pre">on</span></code></p></td>
<td><p>powered: True</p></td>
<td><p>FYI: IPMI will complain
if you try to power on
a machine that is already
powered on</p></td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>If the command fails, the Node State remains unchanged.</p></li>
<li><p>We will not prevent the user from trying to power off a node that is
already powered off since the powered state represents the
<a class="reference internal" href="glossary.html#term-SoR"><span class="xref std std-term">SoR</span></a> only and not the <a class="reference internal" href="glossary.html#term-SoW"><span class="xref std std-term">SoW</span></a>. This can however create
problems when the cluster administrator wants to bring the
<a class="reference internal" href="glossary.html#term-SoR"><span class="xref std std-term">SoR</span></a> in sync with the :term:SoW` without actually having to
mess with the node(s). For this case, we allow direct modification
of the powered state through the gnt-node modify
<code class="docutils literal notranslate"><span class="pre">--powered=[yes|no]</span></code> command as long as the node has OOB
capabilities (i.e. <code class="docutils literal notranslate"><span class="pre">--oob-program</span></code> is set).</p></li>
<li><p>All node power state changes will be logged</p></li>
</ul>
</div>
</div>
</div>
<div class="section" id="node-power-status-listing-sow">
<h3>Node Power Status Listing (<a class="reference internal" href="glossary.html#term-SoW"><span class="xref std std-term">SoW</span></a>)<a class="headerlink" href="#node-power-status-listing-sow" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">Program: <code class="docutils literal notranslate"><span class="pre">gnt-node</span></code></div>
<div class="line">Command: <code class="docutils literal notranslate"><span class="pre">power-status</span></code></div>
<div class="line">Parameters: [ <code class="docutils literal notranslate"><span class="pre">nodename</span></code> … ]</div>
</div>
<p>Example output (represents <a class="reference internal" href="glossary.html#term-SoW"><span class="xref std std-term">SoW</span></a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gnt</span><span class="o">-</span><span class="n">node</span> <span class="n">oob</span> <span class="n">power</span><span class="o">-</span><span class="n">status</span>
<span class="n">Node</span>                      <span class="n">Power</span> <span class="n">Status</span>
<span class="n">node1</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>         <span class="n">on</span>
<span class="n">node2</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>         <span class="n">off</span>
<span class="n">node3</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>         <span class="n">on</span>
<span class="n">node4</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>         <span class="n">unknown</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>We use <code class="docutils literal notranslate"><span class="pre">unknown</span></code> in case the Helper Program could not determine
the power state.</p></li>
<li><p>If no nodenames are provided, we will list the power state of all
nodes which are not opted out from OOB management.</p></li>
<li><p>Only nodes which are not opted out from OOB management will be
listed.  Invoking the command on a node that does not meet this
condition will result in an error message “Node X does not support
OOB commands”.</p></li>
</ul>
</div>
</div>
<div class="section" id="node-power-status-listing-sor">
<h3>Node Power Status Listing (<a class="reference internal" href="glossary.html#term-SoR"><span class="xref std std-term">SoR</span></a>)<a class="headerlink" href="#node-power-status-listing-sor" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">Program: <code class="docutils literal notranslate"><span class="pre">gnt-node</span></code></div>
<div class="line">Command: <code class="docutils literal notranslate"><span class="pre">info</span></code></div>
<div class="line">Parameter:  [ <code class="docutils literal notranslate"><span class="pre">nodename</span></code> … ]</div>
<div class="line">Option: None</div>
</div>
<p>Example output (represents <a class="reference internal" href="glossary.html#term-SoR"><span class="xref std std-term">SoR</span></a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gnt</span><span class="o">-</span><span class="n">node</span> <span class="n">info</span> <span class="n">node1</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
<span class="n">Node</span> <span class="n">name</span><span class="p">:</span> <span class="n">node1</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
  <span class="n">primary</span> <span class="n">ip</span><span class="p">:</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.1</span>
  <span class="n">secondary</span> <span class="n">ip</span><span class="p">:</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">2.1</span>
  <span class="n">master</span> <span class="n">candidate</span><span class="p">:</span> <span class="kc">True</span>
  <span class="n">drained</span><span class="p">:</span> <span class="kc">False</span>
  <span class="n">offline</span><span class="p">:</span> <span class="kc">False</span>
  <span class="n">powered</span><span class="p">:</span> <span class="kc">True</span>
  <span class="n">primary</span> <span class="k">for</span> <span class="n">instances</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">inst1</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
    <span class="o">-</span> <span class="n">inst2</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
    <span class="o">-</span> <span class="n">inst3</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
  <span class="n">secondary</span> <span class="k">for</span> <span class="n">instances</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">inst4</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
    <span class="o">-</span> <span class="n">inst5</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
    <span class="o">-</span> <span class="n">inst6</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
    <span class="o">-</span> <span class="n">inst7</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Only nodes which are not opted out from OOB management will report the
powered state.</p>
</div>
</div>
<div class="section" id="new-gnt-node-oob-subcommand-health">
<h3>New <code class="docutils literal notranslate"><span class="pre">gnt-node</span></code> oob subcommand: <code class="docutils literal notranslate"><span class="pre">health</span></code><a class="headerlink" href="#new-gnt-node-oob-subcommand-health" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">Program: <code class="docutils literal notranslate"><span class="pre">gnt-node</span></code></div>
<div class="line">Command: <code class="docutils literal notranslate"><span class="pre">health</span></code></div>
<div class="line">Parameters: [ <code class="docutils literal notranslate"><span class="pre">nodename</span></code> … ]</div>
<div class="line">Options: None</div>
<div class="line">Example: <code class="docutils literal notranslate"><span class="pre">/usr/bin/oob</span> <span class="pre">health</span> <span class="pre">node5.example.com</span></code></div>
</div>
<p>Caveats:</p>
<blockquote>
<div><ul class="simple">
<li><p>If no nodename(s) are provided, we will report the health of all
nodes in the cluster which have <code class="docutils literal notranslate"><span class="pre">--oob-program</span></code> set.</p></li>
<li><p>Only nodes which are not opted out from OOB management will report
their health. Invoking the command on a node that does not meet this
condition will result in an error message “Node does not support OOB
commands”.</p></li>
</ul>
</div></blockquote>
<p>For error handling see <a class="reference internal" href="#error-handling">Error Handling</a></p>
</div>
<div class="section" id="oob-program-helper-program-parameters-return-codes-and-data-format">
<h3>OOB Program (Helper Program) Parameters, Return Codes and Data Format<a class="headerlink" href="#oob-program-helper-program-parameters-return-codes-and-data-format" title="Permalink to this headline">¶</a></h3>
<div class="line-block">
<div class="line">Program: executable OOB program (absolute path)</div>
<div class="line">Parameters: command nodename</div>
<div class="line">Command: [power-{on|off|cycle|status}|health]</div>
<div class="line">Options: None</div>
<div class="line">Example: <code class="docutils literal notranslate"><span class="pre">/usr/bin/oob</span> <span class="pre">power-on</span> <span class="pre">node1.example.com</span></code></div>
<div class="line">Caveat: maximum runtime is limited to 60s</div>
</div>
<div class="section" id="return-codes">
<h4>Return Codes<a class="headerlink" href="#return-codes" title="Permalink to this headline">¶</a></h4>
<table class="docutils align-default">
<colgroup>
<col style="width: 34%" />
<col style="width: 66%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Return code</p></th>
<th class="head"><p>Meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>0</p></td>
<td><p>Command succeeded</p></td>
</tr>
<tr class="row-odd"><td><p>1</p></td>
<td><p>Command failed</p></td>
</tr>
<tr class="row-even"><td><p>others</p></td>
<td><p>Unsupported/undefined</p></td>
</tr>
</tbody>
</table>
<p>Error messages are passed from the helper program to Ganeti through
<em class="manpage">stderr(3)</em> (return code == 1).  On <em class="manpage">stdout(3)</em>, the
helper program will send data back to Ganeti (return code == 0). The
format of the data is JSON.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 36%" />
<col style="width: 64%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Command</p></th>
<th class="head"><p>Expected output</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">power-on</span></code></p></td>
<td><p>None</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">power-off</span></code></p></td>
<td><p>None</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">power-cycle</span></code></p></td>
<td><p>None</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">power-status</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{</span> <span class="pre">&quot;powered&quot;:</span> <span class="pre">true|false</span> <span class="pre">}</span></code></p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">health</span></code></p></td>
<td><div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[[</span><span class="n">item</span><span class="p">,</span> <span class="n">status</span><span class="p">],</span>
 <span class="p">[</span><span class="n">item</span><span class="p">,</span> <span class="n">status</span><span class="p">],</span>
 <span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="data-format">
<h4>Data Format<a class="headerlink" href="#data-format" title="Permalink to this headline">¶</a></h4>
<p>For the health output, the fields are:</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 11%" />
<col style="width: 89%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>Field</p></th>
<th class="head"><p>Meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>item</p></td>
<td><p>String identifier of the item we are querying the health of,
examples:</p>
<blockquote>
<div><ul class="simple">
<li><p>Ambient Temp</p></li>
<li><p>PS Redundancy</p></li>
<li><p>FAN 1 RPM</p></li>
</ul>
</div></blockquote>
</td>
</tr>
<tr class="row-odd"><td><p>status</p></td>
<td><p>String; Can take one of the following four values:</p>
<blockquote>
<div><ul class="simple">
<li><p>OK</p></li>
<li><p>WARNING</p></li>
<li><p>CRITICAL</p></li>
<li><p>UNKNOWN</p></li>
</ul>
</div></blockquote>
</td>
</tr>
</tbody>
</table>
<div class="admonition note">
<p class="admonition-title">Note</p>
<ul class="simple">
<li><p>The item output list is defined by the Helper Program. It is up to
the author of the Helper Program to decide which items should be
monitored and what each corresponding return status is.</p></li>
<li><p>Ganeti will currently not take any actions based on the item
status. It will however create log entries for items with status
WARNING or CRITICAL for each run of the <code class="docutils literal notranslate"><span class="pre">gnt-node</span> <span class="pre">oob</span> <span class="pre">health</span>
<span class="pre">nodename</span></code> command. Automatic actions (regular monitoring of the
item status) is considered a new service and will be treated in a
separate design document.</p></li>
</ul>
</div>
</div>
</div>
</div>
<div class="section" id="logging">
<h2>Logging<a class="headerlink" href="#logging" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">gnt-node</span> <span class="pre">power-[on|off]</span></code> (power state changes) commands will
create log entries following current Ganeti logging practices. In
addition, health items with status WARNING or CRITICAL will be logged
for each run of <code class="docutils literal notranslate"><span class="pre">gnt-node</span> <span class="pre">health</span></code>.</p>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Ganeti Node OOB Management Framework</a><ul>
<li><a class="reference internal" href="#objective">Objective</a></li>
<li><a class="reference internal" href="#background">Background</a></li>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#detailed-design">Detailed Design</a><ul>
<li><a class="reference internal" href="#new-gnt-cluster-parameter">New <code class="docutils literal notranslate"><span class="pre">gnt-cluster</span></code> Parameter</a></li>
<li><a class="reference internal" href="#new-gnt-cluster-epo-command">New <code class="docutils literal notranslate"><span class="pre">gnt-cluster</span> <span class="pre">epo</span></code> Command</a></li>
<li><a class="reference internal" href="#new-gnt-node-property">New <code class="docutils literal notranslate"><span class="pre">gnt-node</span></code> Property</a></li>
<li><a class="reference internal" href="#addition-to-gnt-cluster-verify">Addition to <code class="docutils literal notranslate"><span class="pre">gnt-cluster</span> <span class="pre">verify</span></code></a></li>
<li><a class="reference internal" href="#new-node-state">New Node State</a></li>
<li><a class="reference internal" href="#new-gnt-node-commands-power-on-off-cycle-status">New <code class="docutils literal notranslate"><span class="pre">gnt-node</span></code> commands: <code class="docutils literal notranslate"><span class="pre">power</span> <span class="pre">[on|off|cycle|status]</span></code></a><ul>
<li><a class="reference internal" href="#error-handling">Error Handling</a></li>
<li><a class="reference internal" href="#node-state-changes">Node State Changes</a></li>
</ul>
</li>
<li><a class="reference internal" href="#node-power-status-listing-sow">Node Power Status Listing (<span class="xref std std-term">SoW</span>)</a></li>
<li><a class="reference internal" href="#node-power-status-listing-sor">Node Power Status Listing (<span class="xref std std-term">SoR</span>)</a></li>
<li><a class="reference internal" href="#new-gnt-node-oob-subcommand-health">New <code class="docutils literal notranslate"><span class="pre">gnt-node</span></code> oob subcommand: <code class="docutils literal notranslate"><span class="pre">health</span></code></a></li>
<li><a class="reference internal" href="#oob-program-helper-program-parameters-return-codes-and-data-format">OOB Program (Helper Program) Parameters, Return Codes and Data Format</a><ul>
<li><a class="reference internal" href="#return-codes">Return Codes</a></li>
<li><a class="reference internal" href="#data-format">Data Format</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#logging">Logging</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="design-node-security.html"
                        title="previous chapter">Improvements of Node Security</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="design-openvswitch.html"
                        title="next chapter">Support for Open vSwitch</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/design-oob.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="design-openvswitch.html" title="Support for Open vSwitch"
             >next</a></li>
        <li class="right" >
          <a href="design-node-security.html" title="Improvements of Node Security"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">Ganeti 3.0.2 documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Ganeti Node OOB Management Framework</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015 Google Inc..
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.4.3.
    </div>
  </body>
</html>