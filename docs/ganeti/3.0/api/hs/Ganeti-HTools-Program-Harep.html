<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Ganeti.HTools.Program.Harep</title><link href="linuwial.css" rel="stylesheet" type="text/css" title="Linuwial" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { processClass: "mathjax", ignoreClass: ".*" } });</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><span class="caption">ganeti</span><ul class="links" id="page-menu"><li><a href="Ganeti/HTools/Program/Harep.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr></table><p class="caption">Ganeti.HTools.Program.Harep</p></div><div id="description"><p class="caption">Description</p><div class="doc"><p>Auto-repair tool for Ganeti.</p></div></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><a href="#v:options">options</a> :: IO [<a href="Ganeti-HTools-CLI.html#t:OptType" title="Ganeti.HTools.CLI">OptType</a>]</li><li class="src short"><a href="#v:arguments">arguments</a> :: [<a href="Ganeti-Common.html#t:ArgCompletion" title="Ganeti.Common">ArgCompletion</a>]</li><li class="src short"><a href="#v:annotateOpCode">annotateOpCode</a> :: Maybe String -&gt; <a href="Ganeti-JQueue-Objects.html#t:Timestamp" title="Ganeti.JQueue.Objects">Timestamp</a> -&gt; <a href="Ganeti-OpCodes.html#t:OpCode" title="Ganeti.OpCodes">OpCode</a> -&gt; <a href="Ganeti-OpCodes.html#t:MetaOpCode" title="Ganeti.OpCodes">MetaOpCode</a></li><li class="src short"><span class="keyword">data</span> <a href="#t:InstanceData">InstanceData</a> = <a href="#v:InstanceData">InstanceData</a> {<ul class="subs"><li><a href="#v:arInstance">arInstance</a> :: <a href="Ganeti-HTools-Instance.html#t:Instance" title="Ganeti.HTools.Instance">Instance</a></li><li><a href="#v:arState">arState</a> :: <a href="Ganeti-HTools-Types.html#t:AutoRepairStatus" title="Ganeti.HTools.Types">AutoRepairStatus</a></li><li><a href="#v:tagsToRemove">tagsToRemove</a> :: [String]</li></ul>}</li><li class="src short"><a href="#v:parseInitTag">parseInitTag</a> :: String -&gt; Maybe <a href="Ganeti-HTools-Types.html#t:AutoRepairData" title="Ganeti.HTools.Types">AutoRepairData</a></li><li class="src short"><a href="#v:getArData">getArData</a> :: <a href="Ganeti-HTools-Types.html#t:AutoRepairStatus" title="Ganeti.HTools.Types">AutoRepairStatus</a> -&gt; Maybe <a href="Ganeti-HTools-Types.html#t:AutoRepairData" title="Ganeti.HTools.Types">AutoRepairData</a></li><li class="src short"><a href="#v:arStateName">arStateName</a> :: <a href="Ganeti-HTools-Types.html#t:AutoRepairStatus" title="Ganeti.HTools.Types">AutoRepairStatus</a> -&gt; String</li><li class="src short"><a href="#v:delCurTag">delCurTag</a> :: <a href="Ganeti-HTools-Program-Harep.html#t:InstanceData" title="Ganeti.HTools.Program.Harep">InstanceData</a> -&gt; [String]</li><li class="src short"><a href="#v:setInitialState">setInitialState</a> :: <a href="Ganeti-HTools-Instance.html#t:Instance" title="Ganeti.HTools.Instance">Instance</a> -&gt; <a href="Ganeti-BasicTypes.html#t:Result" title="Ganeti.BasicTypes">Result</a> <a href="Ganeti-HTools-Program-Harep.html#t:InstanceData" title="Ganeti.HTools.Program.Harep">InstanceData</a></li><li class="src short"><a href="#v:arStatusCmp">arStatusCmp</a> :: <a href="Ganeti-HTools-Program-Harep.html#t:InstanceData" title="Ganeti.HTools.Program.Harep">InstanceData</a> -&gt; [<a href="Ganeti-HTools-Types.html#t:AutoRepairData" title="Ganeti.HTools.Types">AutoRepairData</a>] -&gt; <a href="Ganeti-BasicTypes.html#t:Result" title="Ganeti.BasicTypes">Result</a> <a href="Ganeti-HTools-Program-Harep.html#t:InstanceData" title="Ganeti.HTools.Program.Harep">InstanceData</a></li><li class="src short"><a href="#v:processPending">processPending</a> :: <a href="Ganeti-HTools-CLI.html#t:Options" title="Ganeti.HTools.CLI">Options</a> -&gt; <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a> -&gt; <a href="Ganeti-HTools-Program-Harep.html#t:InstanceData" title="Ganeti.HTools.Program.Harep">InstanceData</a> -&gt; IO <a href="Ganeti-HTools-Program-Harep.html#t:InstanceData" title="Ganeti.HTools.Program.Harep">InstanceData</a></li><li class="src short"><a href="#v:updateTag">updateTag</a> :: <a href="Ganeti-HTools-Types.html#t:AutoRepairData" title="Ganeti.HTools.Types">AutoRepairData</a> -&gt; <a href="Ganeti-HTools-Types.html#t:AutoRepairData" title="Ganeti.HTools.Types">AutoRepairData</a></li><li class="src short"><a href="#v:commitChange">commitChange</a> :: <a href="Ganeti-HTools-CLI.html#t:Options" title="Ganeti.HTools.CLI">Options</a> -&gt; <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a> -&gt; <a href="Ganeti-HTools-Program-Harep.html#t:InstanceData" title="Ganeti.HTools.Program.Harep">InstanceData</a> -&gt; IO <a href="Ganeti-HTools-Program-Harep.html#t:InstanceData" title="Ganeti.HTools.Program.Harep">InstanceData</a></li><li class="src short"><a href="#v:detectBroken">detectBroken</a> :: <a href="Ganeti-HTools-Node.html#t:List" title="Ganeti.HTools.Node">List</a> -&gt; <a href="Ganeti-HTools-Instance.html#t:Instance" title="Ganeti.HTools.Instance">Instance</a> -&gt; Maybe (<a href="Ganeti-HTools-Types.html#t:AutoRepairType" title="Ganeti.HTools.Types">AutoRepairType</a>, [<a href="Ganeti-OpCodes.html#t:OpCode" title="Ganeti.OpCodes">OpCode</a>])</li><li class="src short"><a href="#v:submitJobs-39-">submitJobs'</a> :: <a href="Ganeti-HTools-CLI.html#t:Options" title="Ganeti.HTools.CLI">Options</a> -&gt; [[<a href="Ganeti-OpCodes.html#t:MetaOpCode" title="Ganeti.OpCodes">MetaOpCode</a>]] -&gt; <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a> -&gt; IO (<a href="Ganeti-BasicTypes.html#t:Result" title="Ganeti.BasicTypes">Result</a> [<a href="Ganeti-Types.html#t:JobId" title="Ganeti.Types">JobId</a>])</li><li class="src short"><a href="#v:doRepair">doRepair</a> :: <a href="Ganeti-HTools-CLI.html#t:Options" title="Ganeti.HTools.CLI">Options</a> -&gt; <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a> -&gt; Double -&gt; <a href="Ganeti-HTools-Program-Harep.html#t:InstanceData" title="Ganeti.HTools.Program.Harep">InstanceData</a> -&gt; (<a href="Ganeti-HTools-Types.html#t:AutoRepairType" title="Ganeti.HTools.Types">AutoRepairType</a>, [<a href="Ganeti-OpCodes.html#t:OpCode" title="Ganeti.OpCodes">OpCode</a>]) -&gt; IO <a href="Ganeti-HTools-Program-Harep.html#t:InstanceData" title="Ganeti.HTools.Program.Harep">InstanceData</a></li><li class="src short"><a href="#v:main">main</a> :: <a href="Ganeti-HTools-CLI.html#t:Options" title="Ganeti.HTools.CLI">Options</a> -&gt; [String] -&gt; IO ()</li></ul></details></div><div id="interface"><h1>Documentation</h1><div class="top"><p class="src"><a id="v:options" class="def">options</a> :: IO [<a href="Ganeti-HTools-CLI.html#t:OptType" title="Ganeti.HTools.CLI">OptType</a>] <a href="Ganeti/HTools/Program/Harep.html#options" class="link">Source</a> <a href="#v:options" class="selflink">#</a></p><div class="doc"><p>Options list and functions.</p></div></div><div class="top"><p class="src"><a id="v:arguments" class="def">arguments</a> :: [<a href="Ganeti-Common.html#t:ArgCompletion" title="Ganeti.Common">ArgCompletion</a>] <a href="Ganeti/HTools/Program/Harep.html#arguments" class="link">Source</a> <a href="#v:arguments" class="selflink">#</a></p></div><div class="top"><p class="src"><a id="v:annotateOpCode" class="def">annotateOpCode</a> :: Maybe String -&gt; <a href="Ganeti-JQueue-Objects.html#t:Timestamp" title="Ganeti.JQueue.Objects">Timestamp</a> -&gt; <a href="Ganeti-OpCodes.html#t:OpCode" title="Ganeti.OpCodes">OpCode</a> -&gt; <a href="Ganeti-OpCodes.html#t:MetaOpCode" title="Ganeti.OpCodes">MetaOpCode</a> <a href="Ganeti/HTools/Program/Harep.html#annotateOpCode" class="link">Source</a> <a href="#v:annotateOpCode" class="selflink">#</a></p><div class="doc"><p>Wraps an <code><a href="Ganeti-OpCodes.html#t:OpCode" title="Ganeti.OpCodes">OpCode</a></code> in a <code><a href="Ganeti-OpCodes.html#t:MetaOpCode" title="Ganeti.OpCodes">MetaOpCode</a></code> while also adding a comment
 about what generated the opcode.</p></div></div><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:InstanceData" class="def">InstanceData</a> <a href="Ganeti/HTools/Program/Harep.html#InstanceData" class="link">Source</a> <a href="#t:InstanceData" class="selflink">#</a></p><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:InstanceData" class="def">InstanceData</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><ul><li><dfn class="src"><a id="v:arInstance" class="def">arInstance</a> :: <a href="Ganeti-HTools-Instance.html#t:Instance" title="Ganeti.HTools.Instance">Instance</a></dfn><div class="doc empty">&nbsp;</div></li><li><dfn class="src"><a id="v:arState" class="def">arState</a> :: <a href="Ganeti-HTools-Types.html#t:AutoRepairStatus" title="Ganeti.HTools.Types">AutoRepairStatus</a></dfn><div class="doc empty">&nbsp;</div></li><li><dfn class="src"><a id="v:tagsToRemove" class="def">tagsToRemove</a> :: [String]</dfn><div class="doc empty">&nbsp;</div></li></ul></div></td></tr></table></div></div><div class="top"><p class="src"><a id="v:parseInitTag" class="def">parseInitTag</a> :: String -&gt; Maybe <a href="Ganeti-HTools-Types.html#t:AutoRepairData" title="Ganeti.HTools.Types">AutoRepairData</a> <a href="Ganeti/HTools/Program/Harep.html#parseInitTag" class="link">Source</a> <a href="#v:parseInitTag" class="selflink">#</a></p><div class="doc"><p>Parse a tag into an <code><a href="Ganeti-HTools-Types.html#t:AutoRepairData" title="Ganeti.HTools.Types">AutoRepairData</a></code> record.</p><p><code>Nothing</code> is returned if the tag is not an auto-repair tag, or if it's
 malformed.</p></div></div><div class="top"><p class="src"><a id="v:getArData" class="def">getArData</a> :: <a href="Ganeti-HTools-Types.html#t:AutoRepairStatus" title="Ganeti.HTools.Types">AutoRepairStatus</a> -&gt; Maybe <a href="Ganeti-HTools-Types.html#t:AutoRepairData" title="Ganeti.HTools.Types">AutoRepairData</a> <a href="Ganeti/HTools/Program/Harep.html#getArData" class="link">Source</a> <a href="#v:getArData" class="selflink">#</a></p><div class="doc"><p>Return the <code><a href="Ganeti-HTools-Types.html#t:AutoRepairData" title="Ganeti.HTools.Types">AutoRepairData</a></code> element of an <code><a href="Ganeti-HTools-Types.html#t:AutoRepairStatus" title="Ganeti.HTools.Types">AutoRepairStatus</a></code> type.</p></div></div><div class="top"><p class="src"><a id="v:arStateName" class="def">arStateName</a> :: <a href="Ganeti-HTools-Types.html#t:AutoRepairStatus" title="Ganeti.HTools.Types">AutoRepairStatus</a> -&gt; String <a href="Ganeti/HTools/Program/Harep.html#arStateName" class="link">Source</a> <a href="#v:arStateName" class="selflink">#</a></p><div class="doc"><p>Return a short name for each auto-repair status.</p><p>This is a more concise representation of the status, because the default
 <a href="Show.html">Show</a> formatting includes all the accompanying auto-repair data.</p></div></div><div class="top"><p class="src"><a id="v:delCurTag" class="def">delCurTag</a> :: <a href="Ganeti-HTools-Program-Harep.html#t:InstanceData" title="Ganeti.HTools.Program.Harep">InstanceData</a> -&gt; [String] <a href="Ganeti/HTools/Program/Harep.html#delCurTag" class="link">Source</a> <a href="#v:delCurTag" class="selflink">#</a></p><div class="doc"><p>Return a new list of tags to remove that includes <code>arTag</code> if present.</p></div></div><div class="top"><p class="src"><a id="v:setInitialState" class="def">setInitialState</a> :: <a href="Ganeti-HTools-Instance.html#t:Instance" title="Ganeti.HTools.Instance">Instance</a> -&gt; <a href="Ganeti-BasicTypes.html#t:Result" title="Ganeti.BasicTypes">Result</a> <a href="Ganeti-HTools-Program-Harep.html#t:InstanceData" title="Ganeti.HTools.Program.Harep">InstanceData</a> <a href="Ganeti/HTools/Program/Harep.html#setInitialState" class="link">Source</a> <a href="#v:setInitialState" class="selflink">#</a></p><div class="doc"><p>Set the initial auto-repair state of an instance from its auto-repair tags.</p><p>The rules when there are multiple tags is:</p><ul><li>the earliest failure result always wins</li><li>two or more pending repairs results in a fatal error</li><li>a pending result from id X and a success result from id Y result in error
     if Y is newer than X</li><li>if there are no pending repairs, the newest success result wins,
     otherwise the pending result is used.</li></ul></div></div><div class="top"><p class="src"><a id="v:arStatusCmp" class="def">arStatusCmp</a> :: <a href="Ganeti-HTools-Program-Harep.html#t:InstanceData" title="Ganeti.HTools.Program.Harep">InstanceData</a> -&gt; [<a href="Ganeti-HTools-Types.html#t:AutoRepairData" title="Ganeti.HTools.Types">AutoRepairData</a>] -&gt; <a href="Ganeti-BasicTypes.html#t:Result" title="Ganeti.BasicTypes">Result</a> <a href="Ganeti-HTools-Program-Harep.html#t:InstanceData" title="Ganeti.HTools.Program.Harep">InstanceData</a> <a href="Ganeti/HTools/Program/Harep.html#arStatusCmp" class="link">Source</a> <a href="#v:arStatusCmp" class="selflink">#</a></p><div class="doc"><p>Update the initial status of an instance with new repair task tags.</p><p>This function gets called once per repair group in an instance's tag, and it
 determines whether to set the status of the instance according to this new
 group, or to keep the existing state. See the documentation for
 <code><a href="Ganeti-HTools-Program-Harep.html#v:setInitialState" title="Ganeti.HTools.Program.Harep">setInitialState</a></code> for the rules to be followed when determining this.</p></div></div><div class="top"><p class="src"><a id="v:processPending" class="def">processPending</a> :: <a href="Ganeti-HTools-CLI.html#t:Options" title="Ganeti.HTools.CLI">Options</a> -&gt; <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a> -&gt; <a href="Ganeti-HTools-Program-Harep.html#t:InstanceData" title="Ganeti.HTools.Program.Harep">InstanceData</a> -&gt; IO <a href="Ganeti-HTools-Program-Harep.html#t:InstanceData" title="Ganeti.HTools.Program.Harep">InstanceData</a> <a href="Ganeti/HTools/Program/Harep.html#processPending" class="link">Source</a> <a href="#v:processPending" class="selflink">#</a></p><div class="doc"><p>Query jobs of a pending repair, returning the new instance data.</p></div></div><div class="top"><p class="src"><a id="v:updateTag" class="def">updateTag</a> :: <a href="Ganeti-HTools-Types.html#t:AutoRepairData" title="Ganeti.HTools.Types">AutoRepairData</a> -&gt; <a href="Ganeti-HTools-Types.html#t:AutoRepairData" title="Ganeti.HTools.Types">AutoRepairData</a> <a href="Ganeti/HTools/Program/Harep.html#updateTag" class="link">Source</a> <a href="#v:updateTag" class="selflink">#</a></p><div class="doc"><p>Update the tag of an <code><a href="Ganeti-HTools-Types.html#t:AutoRepairData" title="Ganeti.HTools.Types">AutoRepairData</a></code> record to match all the other fields.</p></div></div><div class="top"><p class="src"><a id="v:commitChange" class="def">commitChange</a> :: <a href="Ganeti-HTools-CLI.html#t:Options" title="Ganeti.HTools.CLI">Options</a> -&gt; <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a> -&gt; <a href="Ganeti-HTools-Program-Harep.html#t:InstanceData" title="Ganeti.HTools.Program.Harep">InstanceData</a> -&gt; IO <a href="Ganeti-HTools-Program-Harep.html#t:InstanceData" title="Ganeti.HTools.Program.Harep">InstanceData</a> <a href="Ganeti/HTools/Program/Harep.html#commitChange" class="link">Source</a> <a href="#v:commitChange" class="selflink">#</a></p><div class="doc"><p>Apply and remove tags from an instance as indicated by <code><a href="Ganeti-HTools-Program-Harep.html#t:InstanceData" title="Ganeti.HTools.Program.Harep">InstanceData</a></code>.</p><p>If the <em>arState</em> of the <em>InstanceData</em> record has an associated
 <code><a href="Ganeti-HTools-Types.html#t:AutoRepairData" title="Ganeti.HTools.Types">AutoRepairData</a></code>, add its tag to the instance object. Additionally, if
 <em>tagsToRemove</em> is not empty, remove those tags from the instance object. The
 returned <em>InstanceData</em> object always has an empty <em>tagsToRemove</em>.</p></div></div><div class="top"><p class="src"><a id="v:detectBroken" class="def">detectBroken</a> :: <a href="Ganeti-HTools-Node.html#t:List" title="Ganeti.HTools.Node">List</a> -&gt; <a href="Ganeti-HTools-Instance.html#t:Instance" title="Ganeti.HTools.Instance">Instance</a> -&gt; Maybe (<a href="Ganeti-HTools-Types.html#t:AutoRepairType" title="Ganeti.HTools.Types">AutoRepairType</a>, [<a href="Ganeti-OpCodes.html#t:OpCode" title="Ganeti.OpCodes">OpCode</a>]) <a href="Ganeti/HTools/Program/Harep.html#detectBroken" class="link">Source</a> <a href="#v:detectBroken" class="selflink">#</a></p><div class="doc"><p>Detect brokenness with an instance and suggest repair type and jobs to run.</p></div></div><div class="top"><p class="src"><a id="v:submitJobs-39-" class="def">submitJobs'</a> :: <a href="Ganeti-HTools-CLI.html#t:Options" title="Ganeti.HTools.CLI">Options</a> -&gt; [[<a href="Ganeti-OpCodes.html#t:MetaOpCode" title="Ganeti.OpCodes">MetaOpCode</a>]] -&gt; <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a> -&gt; IO (<a href="Ganeti-BasicTypes.html#t:Result" title="Ganeti.BasicTypes">Result</a> [<a href="Ganeti-Types.html#t:JobId" title="Ganeti.Types">JobId</a>]) <a href="Ganeti/HTools/Program/Harep.html#submitJobs%27" class="link">Source</a> <a href="#v:submitJobs-39-" class="selflink">#</a></p><div class="doc"><p>Submit jobs, unless a dry-run is requested; in this case, just report
 the job that would be submitted.</p></div></div><div class="top"><p class="src"><a id="v:doRepair" class="def">doRepair</a> <a href="Ganeti/HTools/Program/Harep.html#doRepair" class="link">Source</a> <a href="#v:doRepair" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: <a href="Ganeti-HTools-CLI.html#t:Options" title="Ganeti.HTools.CLI">Options</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">-&gt; <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a></td><td class="doc"><p>The Luxi client</p></td></tr><tr><td class="src">-&gt; Double</td><td class="doc"><p>Delay to insert before the first repair opcode</p></td></tr><tr><td class="src">-&gt; <a href="Ganeti-HTools-Program-Harep.html#t:InstanceData" title="Ganeti.HTools.Program.Harep">InstanceData</a></td><td class="doc"><p>The instance data</p></td></tr><tr><td class="src">-&gt; (<a href="Ganeti-HTools-Types.html#t:AutoRepairType" title="Ganeti.HTools.Types">AutoRepairType</a>, [<a href="Ganeti-OpCodes.html#t:OpCode" title="Ganeti.OpCodes">OpCode</a>])</td><td class="doc"><p>The repair job to perform</p></td></tr><tr><td class="src">-&gt; IO <a href="Ganeti-HTools-Program-Harep.html#t:InstanceData" title="Ganeti.HTools.Program.Harep">InstanceData</a></td><td class="doc"><p>The updated instance data</p></td></tr></table></div><div class="doc"><p>Perform the suggested repair on an instance if its policy allows it.</p></div></div><div class="top"><p class="src"><a id="v:main" class="def">main</a> :: <a href="Ganeti-HTools-CLI.html#t:Options" title="Ganeti.HTools.CLI">Options</a> -&gt; [String] -&gt; IO () <a href="Ganeti/HTools/Program/Harep.html#main" class="link">Source</a> <a href="#v:main" class="selflink">#</a></p><div class="doc"><p>Main function.</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.23.0</p></div></body></html>