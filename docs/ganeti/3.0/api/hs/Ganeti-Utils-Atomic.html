<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Ganeti.Utils.Atomic</title><link href="linuwial.css" rel="stylesheet" type="text/css" title="Linuwial" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { processClass: "mathjax", ignoreClass: ".*" } });</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><span class="caption">ganeti</span><ul class="links" id="page-menu"><li><a href="Ganeti/Utils/Atomic.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr></table><p class="caption">Ganeti.Utils.Atomic</p></div><div id="description"><p class="caption">Description</p><div class="doc"><p>Utility functions for atomic file access. </p></div></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><a href="#v:atomicWriteFile">atomicWriteFile</a> :: FilePath -&gt; String -&gt; IO ()</li><li class="src short"><a href="#v:fsyncFileChecked">fsyncFileChecked</a> :: FilePath -&gt; IO ()</li><li class="src short"><a href="#v:atomicUpdateFile">atomicUpdateFile</a> :: MonadBaseControl IO m =&gt; FilePath -&gt; (FilePath -&gt; Handle -&gt; m a) -&gt; m a</li><li class="src short"><a href="#v:withLockedFile">withLockedFile</a> :: (MonadError e m, Error e, MonadBaseControl IO m) =&gt; FilePath -&gt; (Fd -&gt; m a) -&gt; m a</li><li class="src short"><a href="#v:atomicUpdateLockedFile">atomicUpdateLockedFile</a> :: FilePath -&gt; <a href="Ganeti-Utils.html#t:FStat" title="Ganeti.Utils">FStat</a> -&gt; (FilePath -&gt; Handle -&gt; IO a) -&gt; <a href="Ganeti-Errors.html#t:ResultG" title="Ganeti.Errors">ResultG</a> (<a href="Ganeti-Utils.html#t:FStat" title="Ganeti.Utils">FStat</a>, a)</li><li class="src short"><a href="#v:atomicUpdateLockedFile_">atomicUpdateLockedFile_</a> :: FilePath -&gt; <a href="Ganeti-Utils.html#t:FStat" title="Ganeti.Utils">FStat</a> -&gt; (FilePath -&gt; Handle -&gt; IO a) -&gt; <a href="Ganeti-Errors.html#t:ResultG" title="Ganeti.Errors">ResultG</a> <a href="Ganeti-Utils.html#t:FStat" title="Ganeti.Utils">FStat</a></li></ul></details></div><div id="interface"><h1>Documentation</h1><div class="top"><p class="src"><a id="v:atomicWriteFile" class="def">atomicWriteFile</a> :: FilePath -&gt; String -&gt; IO () <a href="Ganeti/Utils/Atomic.html#atomicWriteFile" class="link">Source</a> <a href="#v:atomicWriteFile" class="selflink">#</a></p><div class="doc"><p>Atomically write a file, by first writing the contents into a temporary
 file and then renaming it to the old position.</p></div></div><div class="top"><p class="src"><a id="v:fsyncFileChecked" class="def">fsyncFileChecked</a> :: FilePath -&gt; IO () <a href="Ganeti/Utils/Atomic.html#fsyncFileChecked" class="link">Source</a> <a href="#v:fsyncFileChecked" class="selflink">#</a></p><div class="doc"><p>Calls fsync(2) on a given file.
 If the operation fails, issue an alert log message and continue.
 Doesn't throw an exception.</p></div></div><div class="top"><p class="src"><a id="v:atomicUpdateFile" class="def">atomicUpdateFile</a> :: MonadBaseControl IO m =&gt; FilePath -&gt; (FilePath -&gt; Handle -&gt; m a) -&gt; m a <a href="Ganeti/Utils/Atomic.html#atomicUpdateFile" class="link">Source</a> <a href="#v:atomicUpdateFile" class="selflink">#</a></p><div class="doc"><p>Atomically update a file, by first creating a temporary file, running the
 given action on it, and then renaming it to the old position.
 Usually the action will write to the file and update its permissions.
 The action is allowed to close the file descriptor, but isn't required to do
 so.</p></div></div><div class="top"><p class="src"><a id="v:withLockedFile" class="def">withLockedFile</a> :: (MonadError e m, Error e, MonadBaseControl IO m) =&gt; FilePath -&gt; (Fd -&gt; m a) -&gt; m a <a href="Ganeti/Utils/Atomic.html#withLockedFile" class="link">Source</a> <a href="#v:withLockedFile" class="selflink">#</a></p><div class="doc"><p>Opens a file in a R/W mode, locks it (blocking if needed) and runs
 a given action while the file is locked. Releases the lock and
 closes the file afterwards.</p></div></div><div class="top"><p class="src"><a id="v:atomicUpdateLockedFile" class="def">atomicUpdateLockedFile</a> :: FilePath -&gt; <a href="Ganeti-Utils.html#t:FStat" title="Ganeti.Utils">FStat</a> -&gt; (FilePath -&gt; Handle -&gt; IO a) -&gt; <a href="Ganeti-Errors.html#t:ResultG" title="Ganeti.Errors">ResultG</a> (<a href="Ganeti-Utils.html#t:FStat" title="Ganeti.Utils">FStat</a>, a) <a href="Ganeti/Utils/Atomic.html#atomicUpdateLockedFile" class="link">Source</a> <a href="#v:atomicUpdateLockedFile" class="selflink">#</a></p><div class="doc"><p>Just as <code><a href="Ganeti-Utils-Atomic.html#v:atomicUpdateFile" title="Ganeti.Utils.Atomic">atomicUpdateFile</a></code>, but in addition locks the file during the
 operation using <code><a href="Ganeti-Utils-Atomic.html#v:withLockedFile" title="Ganeti.Utils.Atomic">withLockedFile</a></code> and checks if the file has been modified.
 The action is only run if it hasn't, otherwise an error is thrown.
 The file must exist.
 Returns the new file status after the operation is finished.</p></div></div><div class="top"><p class="src"><a id="v:atomicUpdateLockedFile_" class="def">atomicUpdateLockedFile_</a> :: FilePath -&gt; <a href="Ganeti-Utils.html#t:FStat" title="Ganeti.Utils">FStat</a> -&gt; (FilePath -&gt; Handle -&gt; IO a) -&gt; <a href="Ganeti-Errors.html#t:ResultG" title="Ganeti.Errors">ResultG</a> <a href="Ganeti-Utils.html#t:FStat" title="Ganeti.Utils">FStat</a> <a href="Ganeti/Utils/Atomic.html#atomicUpdateLockedFile_" class="link">Source</a> <a href="#v:atomicUpdateLockedFile_" class="selflink">#</a></p><div class="doc"><p>Just as <code><a href="Ganeti-Utils-Atomic.html#v:atomicUpdateLockedFile" title="Ganeti.Utils.Atomic">atomicUpdateLockedFile</a></code>, but discards the action result.</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.23.0</p></div></body></html>