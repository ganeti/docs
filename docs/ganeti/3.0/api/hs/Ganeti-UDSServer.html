<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Ganeti.UDSServer</title><link href="linuwial.css" rel="stylesheet" type="text/css" title="Linuwial" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { processClass: "mathjax", ignoreClass: ".*" } });</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><span class="caption">ganeti</span><ul class="links" id="page-menu"><li><a href="Ganeti/UDSServer.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr></table><p class="caption">Ganeti.UDSServer</p></div><div id="table-of-contents"><div id="contents-list"><p class="caption" onclick="window.scrollTo(0,0)">Contents</p><ul><li><a href="#g:1">Utility functions</a></li><li><a href="#g:2">Generic protocol functionality</a></li><li><a href="#g:3">Unix sockets</a></li><li><a href="#g:4">Client and server</a></li><li><a href="#g:5">Processing client requests</a></li></ul></div></div><div id="description"><p class="caption">Description</p><div class="doc"><p>Implementation of the Ganeti Unix Domain Socket JSON server interface.</p></div></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><a href="#v:withTimeout">withTimeout</a> :: Int -&gt; String -&gt; IO a -&gt; IO a</li><li class="src short"><span class="keyword">data</span> <a href="#t:RecvResult">RecvResult</a><ul class="subs"><li>= <a href="#v:RecvConnClosed">RecvConnClosed</a></li><li>| <a href="#v:RecvError">RecvError</a> String</li><li>| <a href="#v:RecvOk">RecvOk</a> String</li></ul></li><li class="src short"><a href="#v:eOM">eOM</a> :: Word8</li><li class="src short"><a href="#v:bEOM">bEOM</a> :: ByteString</li><li class="src short"><span class="keyword">data</span> <a href="#t:MsgKeys">MsgKeys</a><ul class="subs"><li>= <a href="#v:Method">Method</a></li><li>| <a href="#v:Args">Args</a></li><li>| <a href="#v:Success">Success</a></li><li>| <a href="#v:Result">Result</a></li></ul></li><li class="src short"><a href="#v:strOfKey">strOfKey</a> :: <a href="Ganeti-UDSServer.html#t:MsgKeys" title="Ganeti.UDSServer">MsgKeys</a> -&gt; String</li><li class="src short"><span class="keyword">data</span> <a href="#t:ServerConfig">ServerConfig</a> = <a href="#v:ServerConfig">ServerConfig</a> {<ul class="subs"><li><a href="#v:connPermissions">connPermissions</a> :: <a href="Ganeti-Utils.html#t:FilePermissions" title="Ganeti.Utils">FilePermissions</a></li><li><a href="#v:connConfig">connConfig</a> :: <a href="Ganeti-UDSServer.html#t:ConnectConfig" title="Ganeti.UDSServer">ConnectConfig</a></li></ul>}</li><li class="src short"><span class="keyword">data</span> <a href="#t:ConnectConfig">ConnectConfig</a> = <a href="#v:ConnectConfig">ConnectConfig</a> {<ul class="subs"><li><a href="#v:recvTmo">recvTmo</a> :: Int</li><li><a href="#v:sendTmo">sendTmo</a> :: Int</li></ul>}</li><li class="src short"><span class="keyword">data</span> <a href="#t:Client">Client</a> = <a href="#v:Client">Client</a> {<ul class="subs"><li><a href="#v:rsocket">rsocket</a> :: Handle</li><li><a href="#v:wsocket">wsocket</a> :: Handle</li><li><a href="#v:rbuf">rbuf</a> :: IORef ByteString</li><li><a href="#v:clientConfig">clientConfig</a> :: <a href="Ganeti-UDSServer.html#t:ConnectConfig" title="Ganeti.UDSServer">ConnectConfig</a></li></ul>}</li><li class="src short"><span class="keyword">data</span> <a href="#t:Server">Server</a> = <a href="#v:Server">Server</a> {<ul class="subs"><li><a href="#v:sSocket">sSocket</a> :: Socket</li><li><a href="#v:sPath">sPath</a> :: FilePath</li><li><a href="#v:serverConfig">serverConfig</a> :: <a href="Ganeti-UDSServer.html#t:ConnectConfig" title="Ganeti.UDSServer">ConnectConfig</a></li></ul>}</li><li class="src short"><a href="#v:openClientSocket">openClientSocket</a> :: Int -&gt; FilePath -&gt; IO Handle</li><li class="src short"><a href="#v:closeClientSocket">closeClientSocket</a> :: Handle -&gt; IO ()</li><li class="src short"><a href="#v:openServerSocket">openServerSocket</a> :: FilePath -&gt; IO Socket</li><li class="src short"><a href="#v:closeServerSocket">closeServerSocket</a> :: Socket -&gt; FilePath -&gt; IO ()</li><li class="src short"><a href="#v:acceptSocket">acceptSocket</a> :: Socket -&gt; IO Handle</li><li class="src short"><a href="#v:connectClient">connectClient</a> :: <a href="Ganeti-UDSServer.html#t:ConnectConfig" title="Ganeti.UDSServer">ConnectConfig</a> -&gt; Int -&gt; FilePath -&gt; IO <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a></li><li class="src short"><a href="#v:connectServer">connectServer</a> :: <a href="Ganeti-UDSServer.html#t:ServerConfig" title="Ganeti.UDSServer">ServerConfig</a> -&gt; Bool -&gt; FilePath -&gt; IO <a href="Ganeti-UDSServer.html#t:Server" title="Ganeti.UDSServer">Server</a></li><li class="src short"><a href="#v:pipeClient">pipeClient</a> :: <a href="Ganeti-UDSServer.html#t:ConnectConfig" title="Ganeti.UDSServer">ConnectConfig</a> -&gt; IO (<a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a>, <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a>)</li><li class="src short"><a href="#v:closeServer">closeServer</a> :: MonadBase IO m =&gt; <a href="Ganeti-UDSServer.html#t:Server" title="Ganeti.UDSServer">Server</a> -&gt; m ()</li><li class="src short"><a href="#v:acceptClient">acceptClient</a> :: <a href="Ganeti-UDSServer.html#t:Server" title="Ganeti.UDSServer">Server</a> -&gt; IO <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a></li><li class="src short"><a href="#v:closeClient">closeClient</a> :: <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a> -&gt; IO ()</li><li class="src short"><a href="#v:clientToFd">clientToFd</a> :: <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a> -&gt; IO (Fd, Fd)</li><li class="src short"><a href="#v:clientToHandle">clientToHandle</a> :: <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a> -&gt; (Handle, Handle)</li><li class="src short"><a href="#v:sendMsg">sendMsg</a> :: <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a> -&gt; String -&gt; IO ()</li><li class="src short"><a href="#v:recvUpdate">recvUpdate</a> :: <a href="Ganeti-UDSServer.html#t:ConnectConfig" title="Ganeti.UDSServer">ConnectConfig</a> -&gt; Handle -&gt; ByteString -&gt; IO (ByteString, ByteString)</li><li class="src short"><a href="#v:recvMsg">recvMsg</a> :: <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a> -&gt; IO String</li><li class="src short"><a href="#v:recvMsgExt">recvMsgExt</a> :: <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a> -&gt; IO <a href="Ganeti-UDSServer.html#t:RecvResult" title="Ganeti.UDSServer">RecvResult</a></li><li class="src short"><a href="#v:buildCall">buildCall</a> :: (JSON mth, JSON args) =&gt; mth -&gt; args -&gt; String</li><li class="src short"><a href="#v:parseCall">parseCall</a> :: (JSON mth, JSON args) =&gt; String -&gt; <a href="Ganeti-BasicTypes.html#t:Result" title="Ganeti.BasicTypes">Result</a> (mth, args)</li><li class="src short"><a href="#v:buildResponse">buildResponse</a> :: Bool -&gt; JSValue -&gt; String</li><li class="src short"><a href="#v:decodeError">decodeError</a> :: JSValue -&gt; <a href="Ganeti-Errors.html#t:ErrorResult" title="Ganeti.Errors">ErrorResult</a> JSValue</li><li class="src short"><a href="#v:parseResponse">parseResponse</a> :: String -&gt; <a href="Ganeti-Errors.html#t:ErrorResult" title="Ganeti.Errors">ErrorResult</a> JSValue</li><li class="src short"><a href="#v:logMsg">logMsg</a> :: (Show e, JSON e, <a href="Ganeti-Logging.html#t:MonadLog" title="Ganeti.Logging">MonadLog</a> m) =&gt; <a href="Ganeti-UDSServer.html#t:Handler" title="Ganeti.UDSServer">Handler</a> i m o -&gt; i -&gt; <a href="Ganeti-BasicTypes.html#t:GenericResult" title="Ganeti.BasicTypes">GenericResult</a> e JSValue -&gt; m ()</li><li class="src short"><a href="#v:prepareMsg">prepareMsg</a> :: JSON e =&gt; <a href="Ganeti-BasicTypes.html#t:GenericResult" title="Ganeti.BasicTypes">GenericResult</a> e JSValue -&gt; (Bool, JSValue)</li><li class="src short"><span class="keyword">type</span> <a href="#t:HandlerResult">HandlerResult</a> m o = m (Bool, <a href="Ganeti-BasicTypes.html#t:GenericResult" title="Ganeti.BasicTypes">GenericResult</a> <a href="Ganeti-Errors.html#t:GanetiException" title="Ganeti.Errors">GanetiException</a> o)</li><li class="src short"><span class="keyword">data</span> <a href="#t:Handler">Handler</a> i m o = <a href="#v:Handler">Handler</a> {<ul class="subs"><li><a href="#v:hParse">hParse</a> :: JSValue -&gt; JSValue -&gt; <a href="Ganeti-BasicTypes.html#t:Result" title="Ganeti.BasicTypes">Result</a> i</li><li><a href="#v:hInputLogShort">hInputLogShort</a> :: i -&gt; String</li><li><a href="#v:hInputLogLong">hInputLogLong</a> :: i -&gt; String</li><li><a href="#v:hExec">hExec</a> :: i -&gt; <a href="Ganeti-UDSServer.html#t:HandlerResult" title="Ganeti.UDSServer">HandlerResult</a> m o</li></ul>}</li><li class="src short"><a href="#v:handleJsonMessage">handleJsonMessage</a> :: (JSON o, Monad m) =&gt; <a href="Ganeti-UDSServer.html#t:Handler" title="Ganeti.UDSServer">Handler</a> i m o -&gt; i -&gt; <a href="Ganeti-UDSServer.html#t:HandlerResult" title="Ganeti.UDSServer">HandlerResult</a> m JSValue</li><li class="src short"><a href="#v:handleRawMessage">handleRawMessage</a> :: (JSON o, <a href="Ganeti-Logging.html#t:MonadLog" title="Ganeti.Logging">MonadLog</a> m) =&gt; <a href="Ganeti-UDSServer.html#t:Handler" title="Ganeti.UDSServer">Handler</a> i m o -&gt; String -&gt; m (Bool, String)</li><li class="src short"><a href="#v:isRisky">isRisky</a> :: <a href="Ganeti-UDSServer.html#t:RecvResult" title="Ganeti.UDSServer">RecvResult</a> -&gt; Bool</li><li class="src short"><a href="#v:handleClient">handleClient</a> :: (JSON o, MonadBase IO m, <a href="Ganeti-Logging.html#t:MonadLog" title="Ganeti.Logging">MonadLog</a> m) =&gt; <a href="Ganeti-UDSServer.html#t:Handler" title="Ganeti.UDSServer">Handler</a> i m o -&gt; <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a> -&gt; m Bool</li><li class="src short"><a href="#v:clientLoop">clientLoop</a> :: (JSON o, MonadBase IO m, <a href="Ganeti-Logging.html#t:MonadLog" title="Ganeti.Logging">MonadLog</a> m) =&gt; <a href="Ganeti-UDSServer.html#t:Handler" title="Ganeti.UDSServer">Handler</a> i m o -&gt; <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a> -&gt; m ()</li><li class="src short"><a href="#v:listener">listener</a> :: (JSON o, MonadBaseControl IO m, <a href="Ganeti-Logging.html#t:MonadLog" title="Ganeti.Logging">MonadLog</a> m) =&gt; <a href="Ganeti-UDSServer.html#t:Handler" title="Ganeti.UDSServer">Handler</a> i m o -&gt; <a href="Ganeti-UDSServer.html#t:Server" title="Ganeti.UDSServer">Server</a> -&gt; m ()</li></ul></details></div><div id="interface"><a href="#g:1" id="g:1"><h1>Utility functions</h1></a><div class="top"><p class="src"><a id="v:withTimeout" class="def">withTimeout</a> :: Int -&gt; String -&gt; IO a -&gt; IO a <a href="Ganeti/UDSServer.html#withTimeout" class="link">Source</a> <a href="#v:withTimeout" class="selflink">#</a></p><div class="doc"><p>Wrapper over System.Timeout.timeout that fails in the IO monad.</p></div></div><a href="#g:2" id="g:2"><h1>Generic protocol functionality</h1></a><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:RecvResult" class="def">RecvResult</a> <a href="Ganeti/UDSServer.html#RecvResult" class="link">Source</a> <a href="#t:RecvResult" class="selflink">#</a></p><div class="doc"><p>Result of receiving a message from the socket.</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:RecvConnClosed" class="def">RecvConnClosed</a></td><td class="doc"><p>Connection closed</p></td></tr><tr><td class="src"><a id="v:RecvError" class="def">RecvError</a> String</td><td class="doc"><p>Any other error</p></td></tr><tr><td class="src"><a id="v:RecvOk" class="def">RecvOk</a> String</td><td class="doc"><p>Successfull receive</p></td></tr></table></div><div class="subs instances"><h4 class="instances details-toggle-control details-toggle" data-details-id="i:RecvResult">Instances</h4><details id="i:RecvResult" open="open"><summary class="hide-when-js-enabled">Instances details</summary><table><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:RecvResult:Eq:1"></span> Eq <a href="Ganeti-UDSServer.html#t:RecvResult" title="Ganeti.UDSServer">RecvResult</a></span> <a href="#t:RecvResult" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:RecvResult:Eq:1"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ganeti-UDSServer.html">Ganeti.UDSServer</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:-61--61-">(==)</a> :: <a href="Ganeti-UDSServer.html#t:RecvResult" title="Ganeti.UDSServer">RecvResult</a> -&gt; <a href="Ganeti-UDSServer.html#t:RecvResult" title="Ganeti.UDSServer">RecvResult</a> -&gt; Bool</p><p class="src"><a href="#v:-47--61-">(/=)</a> :: <a href="Ganeti-UDSServer.html#t:RecvResult" title="Ganeti.UDSServer">RecvResult</a> -&gt; <a href="Ganeti-UDSServer.html#t:RecvResult" title="Ganeti.UDSServer">RecvResult</a> -&gt; Bool</p></div></details></td></tr><tr><td class="src clearfix"><span class="inst-left"><span class="instance details-toggle-control details-toggle" data-details-id="i:id:RecvResult:Show:2"></span> Show <a href="Ganeti-UDSServer.html#t:RecvResult" title="Ganeti.UDSServer">RecvResult</a></span> <a href="#t:RecvResult" class="selflink">#</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><details id="i:id:RecvResult:Show:2"><summary class="hide-when-js-enabled">Instance details</summary><p>Defined in <a href="Ganeti-UDSServer.html">Ganeti.UDSServer</a></p> <div class="subs methods"><p class="caption">Methods</p><p class="src"><a href="#v:showsPrec">showsPrec</a> :: Int -&gt; <a href="Ganeti-UDSServer.html#t:RecvResult" title="Ganeti.UDSServer">RecvResult</a> -&gt; ShowS</p><p class="src"><a href="#v:show">show</a> :: <a href="Ganeti-UDSServer.html#t:RecvResult" title="Ganeti.UDSServer">RecvResult</a> -&gt; String</p><p class="src"><a href="#v:showList">showList</a> :: [<a href="Ganeti-UDSServer.html#t:RecvResult" title="Ganeti.UDSServer">RecvResult</a>] -&gt; ShowS</p></div></details></td></tr></table></details></div></div><div class="top"><p class="src"><a id="v:eOM" class="def">eOM</a> :: Word8 <a href="Ganeti/UDSServer.html#eOM" class="link">Source</a> <a href="#v:eOM" class="selflink">#</a></p><div class="doc"><p>The end-of-message separator.</p></div></div><div class="top"><p class="src"><a id="v:bEOM" class="def">bEOM</a> :: ByteString <a href="Ganeti/UDSServer.html#bEOM" class="link">Source</a> <a href="#v:bEOM" class="selflink">#</a></p><div class="doc"><p>The end-of-message encoded as a ByteString.</p></div></div><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:MsgKeys" class="def">MsgKeys</a> <a href="Ganeti/UDSServer.html#MsgKeys" class="link">Source</a> <a href="#t:MsgKeys" class="selflink">#</a></p><div class="doc"><p>Valid keys in the requests and responses.</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:Method" class="def">Method</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src"><a id="v:Args" class="def">Args</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src"><a id="v:Success" class="def">Success</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src"><a id="v:Result" class="def">Result</a></td><td class="doc empty">&nbsp;</td></tr></table></div></div><div class="top"><p class="src"><a id="v:strOfKey" class="def">strOfKey</a> :: <a href="Ganeti-UDSServer.html#t:MsgKeys" title="Ganeti.UDSServer">MsgKeys</a> -&gt; String <a href="Ganeti/UDSServer.html#strOfKey" class="link">Source</a> <a href="#v:strOfKey" class="selflink">#</a></p><div class="doc"><p>The serialisation of MsgKeys into strings in messages.</p></div></div><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:ServerConfig" class="def">ServerConfig</a> <a href="Ganeti/UDSServer.html#ServerConfig" class="link">Source</a> <a href="#t:ServerConfig" class="selflink">#</a></p><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:ServerConfig" class="def">ServerConfig</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><ul><li><dfn class="src"><a id="v:connPermissions" class="def">connPermissions</a> :: <a href="Ganeti-Utils.html#t:FilePermissions" title="Ganeti.Utils">FilePermissions</a></dfn><div class="doc empty">&nbsp;</div></li><li><dfn class="src"><a id="v:connConfig" class="def">connConfig</a> :: <a href="Ganeti-UDSServer.html#t:ConnectConfig" title="Ganeti.UDSServer">ConnectConfig</a></dfn><div class="doc empty">&nbsp;</div></li></ul></div></td></tr></table></div></div><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:ConnectConfig" class="def">ConnectConfig</a> <a href="Ganeti/UDSServer.html#ConnectConfig" class="link">Source</a> <a href="#t:ConnectConfig" class="selflink">#</a></p><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:ConnectConfig" class="def">ConnectConfig</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><ul><li><dfn class="src"><a id="v:recvTmo" class="def">recvTmo</a> :: Int</dfn><div class="doc empty">&nbsp;</div></li><li><dfn class="src"><a id="v:sendTmo" class="def">sendTmo</a> :: Int</dfn><div class="doc empty">&nbsp;</div></li></ul></div></td></tr></table></div></div><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:Client" class="def">Client</a> <a href="Ganeti/UDSServer.html#Client" class="link">Source</a> <a href="#t:Client" class="selflink">#</a></p><div class="doc"><p>A client encapsulation. Note that it has separate read and write handle.
 For sockets it is the same handle. It is required for bi-directional
 inter-process pipes though.</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:Client" class="def">Client</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><ul><li><dfn class="src"><a id="v:rsocket" class="def">rsocket</a> :: Handle</dfn><div class="doc"><p>The read part of
 the client socket</p></div></li><li><dfn class="src"><a id="v:wsocket" class="def">wsocket</a> :: Handle</dfn><div class="doc"><p>The write part of
 the client socket</p></div></li><li><dfn class="src"><a id="v:rbuf" class="def">rbuf</a> :: IORef ByteString</dfn><div class="doc"><p>Already received buffer</p></div></li><li><dfn class="src"><a id="v:clientConfig" class="def">clientConfig</a> :: <a href="Ganeti-UDSServer.html#t:ConnectConfig" title="Ganeti.UDSServer">ConnectConfig</a></dfn><div class="doc empty">&nbsp;</div></li></ul></div></td></tr></table></div></div><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:Server" class="def">Server</a> <a href="Ganeti/UDSServer.html#Server" class="link">Source</a> <a href="#t:Server" class="selflink">#</a></p><div class="doc"><p>A server encapsulation.</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:Server" class="def">Server</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><ul><li><dfn class="src"><a id="v:sSocket" class="def">sSocket</a> :: Socket</dfn><div class="doc"><p>The bound server socket</p></div></li><li><dfn class="src"><a id="v:sPath" class="def">sPath</a> :: FilePath</dfn><div class="doc"><p>The scoket's path</p></div></li><li><dfn class="src"><a id="v:serverConfig" class="def">serverConfig</a> :: <a href="Ganeti-UDSServer.html#t:ConnectConfig" title="Ganeti.UDSServer">ConnectConfig</a></dfn><div class="doc empty">&nbsp;</div></li></ul></div></td></tr></table></div></div><a href="#g:3" id="g:3"><h1>Unix sockets</h1></a><div class="top"><p class="src"><a id="v:openClientSocket" class="def">openClientSocket</a> <a href="Ganeti/UDSServer.html#openClientSocket" class="link">Source</a> <a href="#v:openClientSocket" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: Int</td><td class="doc"><p>connection timeout</p></td></tr><tr><td class="src">-&gt; FilePath</td><td class="doc"><p>socket path</p></td></tr><tr><td class="src">-&gt; IO Handle</td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Creates a Unix socket and connects it to the specified <code>path</code>,
 where <code>timeout</code> specifies the connection timeout.</p></div></div><div class="top"><p class="src"><a id="v:closeClientSocket" class="def">closeClientSocket</a> :: Handle -&gt; IO () <a href="Ganeti/UDSServer.html#closeClientSocket" class="link">Source</a> <a href="#v:closeClientSocket" class="selflink">#</a></p><div class="doc"><p>Closes the handle.
 Performing the operation on a handle that has already been closed has no
 effect; doing so is not an error.
 All other operations on a closed handle will fail.</p></div></div><div class="top"><p class="src"><a id="v:openServerSocket" class="def">openServerSocket</a> :: FilePath -&gt; IO Socket <a href="Ganeti/UDSServer.html#openServerSocket" class="link">Source</a> <a href="#v:openServerSocket" class="selflink">#</a></p><div class="doc"><p>Creates a Unix socket and binds it to the specified <code>path</code>.</p></div></div><div class="top"><p class="src"><a id="v:closeServerSocket" class="def">closeServerSocket</a> :: Socket -&gt; FilePath -&gt; IO () <a href="Ganeti/UDSServer.html#closeServerSocket" class="link">Source</a> <a href="#v:closeServerSocket" class="selflink">#</a></p></div><div class="top"><p class="src"><a id="v:acceptSocket" class="def">acceptSocket</a> :: Socket -&gt; IO Handle <a href="Ganeti/UDSServer.html#acceptSocket" class="link">Source</a> <a href="#v:acceptSocket" class="selflink">#</a></p></div><a href="#g:4" id="g:4"><h1>Client and server</h1></a><div class="top"><p class="src"><a id="v:connectClient" class="def">connectClient</a> <a href="Ganeti/UDSServer.html#connectClient" class="link">Source</a> <a href="#v:connectClient" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: <a href="Ganeti-UDSServer.html#t:ConnectConfig" title="Ganeti.UDSServer">ConnectConfig</a></td><td class="doc"><p>configuration for the client</p></td></tr><tr><td class="src">-&gt; Int</td><td class="doc"><p>connection timeout</p></td></tr><tr><td class="src">-&gt; FilePath</td><td class="doc"><p>socket path</p></td></tr><tr><td class="src">-&gt; IO <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a></td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Connects to the master daemon and returns a Client.</p></div></div><div class="top"><p class="src"><a id="v:connectServer" class="def">connectServer</a> :: <a href="Ganeti-UDSServer.html#t:ServerConfig" title="Ganeti.UDSServer">ServerConfig</a> -&gt; Bool -&gt; FilePath -&gt; IO <a href="Ganeti-UDSServer.html#t:Server" title="Ganeti.UDSServer">Server</a> <a href="Ganeti/UDSServer.html#connectServer" class="link">Source</a> <a href="#v:connectServer" class="selflink">#</a></p><div class="doc"><p>Creates and returns a server endpoint.</p></div></div><div class="top"><p class="src"><a id="v:pipeClient" class="def">pipeClient</a> :: <a href="Ganeti-UDSServer.html#t:ConnectConfig" title="Ganeti.UDSServer">ConnectConfig</a> -&gt; IO (<a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a>, <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a>) <a href="Ganeti/UDSServer.html#pipeClient" class="link">Source</a> <a href="#v:pipeClient" class="selflink">#</a></p><div class="doc"><p>Creates a new bi-directional client pipe. The two returned clients
 talk to each other through the pipe.</p></div></div><div class="top"><p class="src"><a id="v:closeServer" class="def">closeServer</a> :: MonadBase IO m =&gt; <a href="Ganeti-UDSServer.html#t:Server" title="Ganeti.UDSServer">Server</a> -&gt; m () <a href="Ganeti/UDSServer.html#closeServer" class="link">Source</a> <a href="#v:closeServer" class="selflink">#</a></p><div class="doc"><p>Closes a server endpoint.</p></div></div><div class="top"><p class="src"><a id="v:acceptClient" class="def">acceptClient</a> :: <a href="Ganeti-UDSServer.html#t:Server" title="Ganeti.UDSServer">Server</a> -&gt; IO <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a> <a href="Ganeti/UDSServer.html#acceptClient" class="link">Source</a> <a href="#v:acceptClient" class="selflink">#</a></p><div class="doc"><p>Accepts a client</p></div></div><div class="top"><p class="src"><a id="v:closeClient" class="def">closeClient</a> :: <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a> -&gt; IO () <a href="Ganeti/UDSServer.html#closeClient" class="link">Source</a> <a href="#v:closeClient" class="selflink">#</a></p><div class="doc"><p>Closes the client socket.
 Performing the operation on a client that has already been closed has no
 effect; doing so is not an error.
 All other operations on a closed client will fail with an exception.</p></div></div><div class="top"><p class="src"><a id="v:clientToFd" class="def">clientToFd</a> :: <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a> -&gt; IO (Fd, Fd) <a href="Ganeti/UDSServer.html#clientToFd" class="link">Source</a> <a href="#v:clientToFd" class="selflink">#</a></p><div class="doc"><p>Extracts the read (the first) and the write (the second) file descriptor
 of a client. This closes the underlying <code>Handle</code>s, therefore the original
 client is closed and unusable after the call.</p><p>The purpose of this function is to keep the communication channel open,
 while replacing a <code><a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a></code> with some other means.</p></div></div><div class="top"><p class="src"><a id="v:clientToHandle" class="def">clientToHandle</a> :: <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a> -&gt; (Handle, Handle) <a href="Ganeti/UDSServer.html#clientToHandle" class="link">Source</a> <a href="#v:clientToHandle" class="selflink">#</a></p><div class="doc"><p>Extracts the read (first) and the write (second) handles of a client.
 The purpose of this function is to allow using a client's handles as
 input/output streams elsewhere.</p></div></div><div class="top"><p class="src"><a id="v:sendMsg" class="def">sendMsg</a> :: <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a> -&gt; String -&gt; IO () <a href="Ganeti/UDSServer.html#sendMsg" class="link">Source</a> <a href="#v:sendMsg" class="selflink">#</a></p><div class="doc"><p>Sends a message over a transport.</p></div></div><div class="top"><p class="src"><a id="v:recvUpdate" class="def">recvUpdate</a> :: <a href="Ganeti-UDSServer.html#t:ConnectConfig" title="Ganeti.UDSServer">ConnectConfig</a> -&gt; Handle -&gt; ByteString -&gt; IO (ByteString, ByteString) <a href="Ganeti/UDSServer.html#recvUpdate" class="link">Source</a> <a href="#v:recvUpdate" class="selflink">#</a></p><div class="doc"><p>Given a current buffer and the handle, it will read from the
 network until we get a full message, and it will return that
 message and the leftover buffer contents.</p></div></div><div class="top"><p class="src"><a id="v:recvMsg" class="def">recvMsg</a> :: <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a> -&gt; IO String <a href="Ganeti/UDSServer.html#recvMsg" class="link">Source</a> <a href="#v:recvMsg" class="selflink">#</a></p><div class="doc"><p>Waits for a message over a transport.</p></div></div><div class="top"><p class="src"><a id="v:recvMsgExt" class="def">recvMsgExt</a> :: <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a> -&gt; IO <a href="Ganeti-UDSServer.html#t:RecvResult" title="Ganeti.UDSServer">RecvResult</a> <a href="Ganeti/UDSServer.html#recvMsgExt" class="link">Source</a> <a href="#v:recvMsgExt" class="selflink">#</a></p><div class="doc"><p>Extended wrapper over recvMsg.</p></div></div><div class="top"><p class="src"><a id="v:buildCall" class="def">buildCall</a> <a href="Ganeti/UDSServer.html#buildCall" class="link">Source</a> <a href="#v:buildCall" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: (JSON mth, JSON args)</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">=&gt; mth</td><td class="doc"><p>The method</p></td></tr><tr><td class="src">-&gt; args</td><td class="doc"><p>The arguments</p></td></tr><tr><td class="src">-&gt; String</td><td class="doc"><p>The serialized form</p></td></tr></table></div><div class="doc"><p>Serialize a request to String.</p></div></div><div class="top"><p class="src"><a id="v:parseCall" class="def">parseCall</a> :: (JSON mth, JSON args) =&gt; String -&gt; <a href="Ganeti-BasicTypes.html#t:Result" title="Ganeti.BasicTypes">Result</a> (mth, args) <a href="Ganeti/UDSServer.html#parseCall" class="link">Source</a> <a href="#v:parseCall" class="selflink">#</a></p><div class="doc"><p>Parse the required keys out of a call.</p></div></div><div class="top"><p class="src"><a id="v:buildResponse" class="def">buildResponse</a> <a href="Ganeti/UDSServer.html#buildResponse" class="link">Source</a> <a href="#v:buildResponse" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: Bool</td><td class="doc"><p>Success</p></td></tr><tr><td class="src">-&gt; JSValue</td><td class="doc"><p>The arguments</p></td></tr><tr><td class="src">-&gt; String</td><td class="doc"><p>The serialized form</p></td></tr></table></div><div class="doc"><p>Serialize the response to String.</p></div></div><div class="top"><p class="src"><a id="v:decodeError" class="def">decodeError</a> :: JSValue -&gt; <a href="Ganeti-Errors.html#t:ErrorResult" title="Ganeti.Errors">ErrorResult</a> JSValue <a href="Ganeti/UDSServer.html#decodeError" class="link">Source</a> <a href="#v:decodeError" class="selflink">#</a></p><div class="doc"><p>Try to decode an error from the server response. This function
 will always fail, since it's called only on the error path (when
 status is False).</p></div></div><div class="top"><p class="src"><a id="v:parseResponse" class="def">parseResponse</a> :: String -&gt; <a href="Ganeti-Errors.html#t:ErrorResult" title="Ganeti.Errors">ErrorResult</a> JSValue <a href="Ganeti/UDSServer.html#parseResponse" class="link">Source</a> <a href="#v:parseResponse" class="selflink">#</a></p><div class="doc"><p>Check that luxi responses contain the required keys and that the
 call was successful.</p></div></div><div class="top"><p class="src"><a id="v:logMsg" class="def">logMsg</a> <a href="Ganeti/UDSServer.html#logMsg" class="link">Source</a> <a href="#v:logMsg" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: (Show e, JSON e, <a href="Ganeti-Logging.html#t:MonadLog" title="Ganeti.Logging">MonadLog</a> m)</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">=&gt; <a href="Ganeti-UDSServer.html#t:Handler" title="Ganeti.UDSServer">Handler</a> i m o</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">-&gt; i</td><td class="doc"><p>the received request (used for logging)</p></td></tr><tr><td class="src">-&gt; <a href="Ganeti-BasicTypes.html#t:GenericResult" title="Ganeti.BasicTypes">GenericResult</a> e JSValue</td><td class="doc"><p>A message to be sent</p></td></tr><tr><td class="src">-&gt; m ()</td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Logs an outgoing message.</p></div></div><div class="top"><p class="src"><a id="v:prepareMsg" class="def">prepareMsg</a> <a href="Ganeti/UDSServer.html#prepareMsg" class="link">Source</a> <a href="#v:prepareMsg" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: JSON e</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">=&gt; <a href="Ganeti-BasicTypes.html#t:GenericResult" title="Ganeti.BasicTypes">GenericResult</a> e JSValue</td><td class="doc"><p>A message to be sent</p></td></tr><tr><td class="src">-&gt; (Bool, JSValue)</td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Prepares an outgoing message.</p></div></div><a href="#g:5" id="g:5"><h1>Processing client requests</h1></a><div class="top"><p class="src"><span class="keyword">type</span> <a id="t:HandlerResult" class="def">HandlerResult</a> m o = m (Bool, <a href="Ganeti-BasicTypes.html#t:GenericResult" title="Ganeti.BasicTypes">GenericResult</a> <a href="Ganeti-Errors.html#t:GanetiException" title="Ganeti.Errors">GanetiException</a> o) <a href="Ganeti/UDSServer.html#HandlerResult" class="link">Source</a> <a href="#t:HandlerResult" class="selflink">#</a></p></div><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:Handler" class="def">Handler</a> i m o <a href="Ganeti/UDSServer.html#Handler" class="link">Source</a> <a href="#t:Handler" class="selflink">#</a></p><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:Handler" class="def">Handler</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><ul><li><dfn class="src"><a id="v:hParse" class="def">hParse</a> :: JSValue -&gt; JSValue -&gt; <a href="Ganeti-BasicTypes.html#t:Result" title="Ganeti.BasicTypes">Result</a> i</dfn><div class="doc"><p>parses method and its arguments into the input type</p></div></li><li><dfn class="src"><a id="v:hInputLogShort" class="def">hInputLogShort</a> :: i -&gt; String</dfn><div class="doc"><p>short description of an input, for the INFO logging level</p></div></li><li><dfn class="src"><a id="v:hInputLogLong" class="def">hInputLogLong</a> :: i -&gt; String</dfn><div class="doc"><p>long description of an input, for the DEBUG logging level</p></div></li><li><dfn class="src"><a id="v:hExec" class="def">hExec</a> :: i -&gt; <a href="Ganeti-UDSServer.html#t:HandlerResult" title="Ganeti.UDSServer">HandlerResult</a> m o</dfn><div class="doc"><p>executes the handler on an input</p></div></li></ul></div></td></tr></table></div></div><div class="top"><p class="src"><a id="v:handleJsonMessage" class="def">handleJsonMessage</a> <a href="Ganeti/UDSServer.html#handleJsonMessage" class="link">Source</a> <a href="#v:handleJsonMessage" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: (JSON o, Monad m)</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">=&gt; <a href="Ganeti-UDSServer.html#t:Handler" title="Ganeti.UDSServer">Handler</a> i m o</td><td class="doc"><p>handler</p></td></tr><tr><td class="src">-&gt; i</td><td class="doc"><p>parsed input</p></td></tr><tr><td class="src">-&gt; <a href="Ganeti-UDSServer.html#t:HandlerResult" title="Ganeti.UDSServer">HandlerResult</a> m JSValue</td><td class="doc empty">&nbsp;</td></tr></table></div></div><div class="top"><p class="src"><a id="v:handleRawMessage" class="def">handleRawMessage</a> <a href="Ganeti/UDSServer.html#handleRawMessage" class="link">Source</a> <a href="#v:handleRawMessage" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: (JSON o, <a href="Ganeti-Logging.html#t:MonadLog" title="Ganeti.Logging">MonadLog</a> m)</td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">=&gt; <a href="Ganeti-UDSServer.html#t:Handler" title="Ganeti.UDSServer">Handler</a> i m o</td><td class="doc"><p>handler</p></td></tr><tr><td class="src">-&gt; String</td><td class="doc"><p>raw unparsed input</p></td></tr><tr><td class="src">-&gt; m (Bool, String)</td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Takes a request as a <code>String</code>, parses it, passes it to a handler and
 formats its response.</p></div></div><div class="top"><p class="src"><a id="v:isRisky" class="def">isRisky</a> :: <a href="Ganeti-UDSServer.html#t:RecvResult" title="Ganeti.UDSServer">RecvResult</a> -&gt; Bool <a href="Ganeti/UDSServer.html#isRisky" class="link">Source</a> <a href="#v:isRisky" class="selflink">#</a></p></div><div class="top"><p class="src"><a id="v:handleClient" class="def">handleClient</a> :: (JSON o, MonadBase IO m, <a href="Ganeti-Logging.html#t:MonadLog" title="Ganeti.Logging">MonadLog</a> m) =&gt; <a href="Ganeti-UDSServer.html#t:Handler" title="Ganeti.UDSServer">Handler</a> i m o -&gt; <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a> -&gt; m Bool <a href="Ganeti/UDSServer.html#handleClient" class="link">Source</a> <a href="#v:handleClient" class="selflink">#</a></p><div class="doc"><p>Reads a request, passes it to a handler and sends a response back to the
 client.</p></div></div><div class="top"><p class="src"><a id="v:clientLoop" class="def">clientLoop</a> :: (JSON o, MonadBase IO m, <a href="Ganeti-Logging.html#t:MonadLog" title="Ganeti.Logging">MonadLog</a> m) =&gt; <a href="Ganeti-UDSServer.html#t:Handler" title="Ganeti.UDSServer">Handler</a> i m o -&gt; <a href="Ganeti-UDSServer.html#t:Client" title="Ganeti.UDSServer">Client</a> -&gt; m () <a href="Ganeti/UDSServer.html#clientLoop" class="link">Source</a> <a href="#v:clientLoop" class="selflink">#</a></p><div class="doc"><p>Main client loop: runs one loop of <code><a href="Ganeti-UDSServer.html#v:handleClient" title="Ganeti.UDSServer">handleClient</a></code>, and if that
 doesn't report a finished (closed) connection, restarts itself.</p></div></div><div class="top"><p class="src"><a id="v:listener" class="def">listener</a> :: (JSON o, MonadBaseControl IO m, <a href="Ganeti-Logging.html#t:MonadLog" title="Ganeti.Logging">MonadLog</a> m) =&gt; <a href="Ganeti-UDSServer.html#t:Handler" title="Ganeti.UDSServer">Handler</a> i m o -&gt; <a href="Ganeti-UDSServer.html#t:Server" title="Ganeti.UDSServer">Server</a> -&gt; m () <a href="Ganeti/UDSServer.html#listener" class="link">Source</a> <a href="#v:listener" class="selflink">#</a></p><div class="doc"><p>Main listener loop: accepts clients, forks an I/O thread to handle
 that client.</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.23.0</p></div></body></html>