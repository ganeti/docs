<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" /><title>Ganeti.JQScheduler.Filtering</title><link href="linuwial.css" rel="stylesheet" type="text/css" title="Linuwial" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({ tex2jax: { processClass: "mathjax", ignoreClass: ".*" } });</script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><span class="caption">ganeti</span><ul class="links" id="page-menu"><li><a href="Ganeti/JQScheduler/Filtering.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr></table><p class="caption">Ganeti.JQScheduler.Filtering</p></div><div id="description"><p class="caption">Description</p><div class="doc"><p>Filtering of jobs for the Ganeti job queue.</p></div></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><a href="#v:accessOpCodeField">accessOpCodeField</a> :: <a href="Ganeti-OpCodes.html#t:OpCode" title="Ganeti.OpCodes">OpCode</a> -&gt; String -&gt; <a href="Ganeti-Errors.html#t:ErrorResult" title="Ganeti.Errors">ErrorResult</a> JSValue</li><li class="src short"><a href="#v:opCodesOf">opCodesOf</a> :: <a href="Ganeti-JQueue-Objects.html#t:QueuedJob" title="Ganeti.JQueue.Objects">QueuedJob</a> -&gt; [<a href="Ganeti-OpCodes.html#t:OpCode" title="Ganeti.OpCodes">OpCode</a>]</li><li class="src short"><a href="#v:reasonsOf">reasonsOf</a> :: <a href="Ganeti-JQueue-Objects.html#t:QueuedJob" title="Ganeti.JQueue.Objects">QueuedJob</a> -&gt; [<a href="Ganeti-Types.html#t:ReasonElem" title="Ganeti.Types">ReasonElem</a>]</li><li class="src short"><a href="#v:evaluateFilterComparator">evaluateFilterComparator</a> :: Ord field =&gt; <a href="Ganeti-Query-Language.html#t:Filter" title="Ganeti.Query.Language">Filter</a> field -&gt; (<a href="Ganeti-Query-Filter.html#t:Comparator" title="Ganeti.Query.Filter">Comparator</a> -&gt; field -&gt; <a href="Ganeti-Query-Language.html#t:FilterValue" title="Ganeti.Query.Language">FilterValue</a> -&gt; Maybe Bool) -&gt; Bool</li><li class="src short"><a href="#v:matchPredicate">matchPredicate</a> :: <a href="Ganeti-JQueue-Objects.html#t:QueuedJob" title="Ganeti.JQueue.Objects">QueuedJob</a> -&gt; <a href="Ganeti-Types.html#t:JobId" title="Ganeti.Types">JobId</a> -&gt; <a href="Ganeti-Objects.html#t:FilterPredicate" title="Ganeti.Objects">FilterPredicate</a> -&gt; Bool</li><li class="src short"><a href="#v:matches">matches</a> :: <a href="Ganeti-JQueue-Objects.html#t:QueuedJob" title="Ganeti.JQueue.Objects">QueuedJob</a> -&gt; <a href="Ganeti-Objects.html#t:FilterRule" title="Ganeti.Objects">FilterRule</a> -&gt; Bool</li><li class="src short"><a href="#v:orderFilters">orderFilters</a> :: Set <a href="Ganeti-Objects.html#t:FilterRule" title="Ganeti.Objects">FilterRule</a> -&gt; [<a href="Ganeti-Objects.html#t:FilterRule" title="Ganeti.Objects">FilterRule</a>]</li><li class="src short"><a href="#v:applyingFilter">applyingFilter</a> :: Set <a href="Ganeti-Objects.html#t:FilterRule" title="Ganeti.Objects">FilterRule</a> -&gt; <a href="Ganeti-JQueue-Objects.html#t:QueuedJob" title="Ganeti.JQueue.Objects">QueuedJob</a> -&gt; Maybe <a href="Ganeti-Objects.html#t:FilterRule" title="Ganeti.Objects">FilterRule</a></li><li class="src short"><span class="keyword">type</span> <a href="#t:RateLimitSlotMap">RateLimitSlotMap</a> = <a href="Ganeti-SlotMap.html#t:SlotMap" title="Ganeti.SlotMap">SlotMap</a> ByteString</li><li class="src short"><span class="keyword">data</span> <a href="#t:FilterChainState">FilterChainState</a> = <a href="#v:FilterChainState">FilterChainState</a> {<ul class="subs"><li><a href="#v:rateLimitSlotMap">rateLimitSlotMap</a> :: <a href="Ganeti-JQScheduler-Filtering.html#t:RateLimitSlotMap" title="Ganeti.JQScheduler.Filtering">RateLimitSlotMap</a></li></ul>}</li><li class="src short"><a href="#v:tryFitSlots">tryFitSlots</a> :: <a href="Ganeti-JQScheduler-Filtering.html#t:FilterChainState" title="Ganeti.JQScheduler.Filtering">FilterChainState</a> -&gt; <a href="Ganeti-SlotMap.html#t:CountMap" title="Ganeti.SlotMap">CountMap</a> ByteString -&gt; Maybe <a href="Ganeti-JQScheduler-Filtering.html#t:FilterChainState" title="Ganeti.JQScheduler.Filtering">FilterChainState</a></li><li class="src short"><a href="#v:queueRateLimitSlotMap">queueRateLimitSlotMap</a> :: <a href="Ganeti-JQScheduler-Types.html#t:Queue" title="Ganeti.JQScheduler.Types">Queue</a> -&gt; Set <a href="Ganeti-Objects.html#t:FilterRule" title="Ganeti.Objects">FilterRule</a> -&gt; <a href="Ganeti-JQScheduler-Filtering.html#t:RateLimitSlotMap" title="Ganeti.JQScheduler.Filtering">RateLimitSlotMap</a></li><li class="src short"><a href="#v:jobFiltering">jobFiltering</a> :: <a href="Ganeti-JQScheduler-Types.html#t:Queue" title="Ganeti.JQScheduler.Types">Queue</a> -&gt; Set <a href="Ganeti-Objects.html#t:FilterRule" title="Ganeti.Objects">FilterRule</a> -&gt; [<a href="Ganeti-JQScheduler-Types.html#t:JobWithStat" title="Ganeti.JQScheduler.Types">JobWithStat</a>] -&gt; [<a href="Ganeti-JQScheduler-Types.html#t:JobWithStat" title="Ganeti.JQScheduler.Types">JobWithStat</a>]</li></ul></details></div><div id="interface"><h1>Documentation</h1><div class="top"><p class="src"><a id="v:accessOpCodeField" class="def">accessOpCodeField</a> :: <a href="Ganeti-OpCodes.html#t:OpCode" title="Ganeti.OpCodes">OpCode</a> -&gt; String -&gt; <a href="Ganeti-Errors.html#t:ErrorResult" title="Ganeti.Errors">ErrorResult</a> JSValue <a href="Ganeti/JQScheduler/Filtering.html#accessOpCodeField" class="link">Source</a> <a href="#v:accessOpCodeField" class="selflink">#</a></p><div class="doc"><p>Accesses a field of the JSON representation of an <code><a href="Ganeti-OpCodes.html#t:OpCode" title="Ganeti.OpCodes">OpCode</a></code> using a dotted
 accessor (like <code>&quot;a.b.c&quot;</code>).</p></div></div><div class="top"><p class="src"><a id="v:opCodesOf" class="def">opCodesOf</a> :: <a href="Ganeti-JQueue-Objects.html#t:QueuedJob" title="Ganeti.JQueue.Objects">QueuedJob</a> -&gt; [<a href="Ganeti-OpCodes.html#t:OpCode" title="Ganeti.OpCodes">OpCode</a>] <a href="Ganeti/JQScheduler/Filtering.html#opCodesOf" class="link">Source</a> <a href="#v:opCodesOf" class="selflink">#</a></p><div class="doc"><p>All <code><a href="Ganeti-OpCodes.html#t:OpCode" title="Ganeti.OpCodes">OpCode</a></code>s of a job.</p></div></div><div class="top"><p class="src"><a id="v:reasonsOf" class="def">reasonsOf</a> :: <a href="Ganeti-JQueue-Objects.html#t:QueuedJob" title="Ganeti.JQueue.Objects">QueuedJob</a> -&gt; [<a href="Ganeti-Types.html#t:ReasonElem" title="Ganeti.Types">ReasonElem</a>] <a href="Ganeti/JQScheduler/Filtering.html#reasonsOf" class="link">Source</a> <a href="#v:reasonsOf" class="selflink">#</a></p><div class="doc"><p>All <code><a href="Ganeti-Types.html#t:ReasonElem" title="Ganeti.Types">ReasonElem</a></code>s of a job.</p></div></div><div class="top"><p class="src"><a id="v:evaluateFilterComparator" class="def">evaluateFilterComparator</a> :: Ord field =&gt; <a href="Ganeti-Query-Language.html#t:Filter" title="Ganeti.Query.Language">Filter</a> field -&gt; (<a href="Ganeti-Query-Filter.html#t:Comparator" title="Ganeti.Query.Filter">Comparator</a> -&gt; field -&gt; <a href="Ganeti-Query-Language.html#t:FilterValue" title="Ganeti.Query.Language">FilterValue</a> -&gt; Maybe Bool) -&gt; Bool <a href="Ganeti/JQScheduler/Filtering.html#evaluateFilterComparator" class="link">Source</a> <a href="#v:evaluateFilterComparator" class="selflink">#</a></p><div class="doc"><p>Like <code><a href="Ganeti-Query-Filter.html#v:evaluateFilterM" title="Ganeti.Query.Filter">evaluateFilterM</a></code>, but allowing only <code><a href="Ganeti-Query-Filter.html#t:Comparator" title="Ganeti.Query.Filter">Comparator</a></code> operations;
 all other filter language operations are evaluated as <code>False</code>.</p><p>The passed function is supposed to return `Just True/False` depending
 on whether the comparing operation succeeds or not, and <code>Nothing</code> if
 the comparison itself is invalid (e.g. comparing to a field that doesn't
 exist).</p></div></div><div class="top"><p class="src"><a id="v:matchPredicate" class="def">matchPredicate</a> <a href="Ganeti/JQScheduler/Filtering.html#matchPredicate" class="link">Source</a> <a href="#v:matchPredicate" class="selflink">#</a></p><div class="subs arguments"><p class="caption">Arguments</p><table><tr><td class="src">:: <a href="Ganeti-JQueue-Objects.html#t:QueuedJob" title="Ganeti.JQueue.Objects">QueuedJob</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">-&gt; <a href="Ganeti-Types.html#t:JobId" title="Ganeti.Types">JobId</a></td><td class="doc"><p>the watermark to compare against
   if the predicate references it</p></td></tr><tr><td class="src">-&gt; <a href="Ganeti-Objects.html#t:FilterPredicate" title="Ganeti.Objects">FilterPredicate</a></td><td class="doc empty">&nbsp;</td></tr><tr><td class="src">-&gt; Bool</td><td class="doc empty">&nbsp;</td></tr></table></div><div class="doc"><p>Whether a <code><a href="Ganeti-Objects.html#t:FilterPredicate" title="Ganeti.Objects">FilterPredicate</a></code> is true for a job.</p></div></div><div class="top"><p class="src"><a id="v:matches" class="def">matches</a> :: <a href="Ganeti-JQueue-Objects.html#t:QueuedJob" title="Ganeti.JQueue.Objects">QueuedJob</a> -&gt; <a href="Ganeti-Objects.html#t:FilterRule" title="Ganeti.Objects">FilterRule</a> -&gt; Bool <a href="Ganeti/JQScheduler/Filtering.html#matches" class="link">Source</a> <a href="#v:matches" class="selflink">#</a></p><div class="doc"><p>Whether all predicates of the filter rule are true for the job.</p></div></div><div class="top"><p class="src"><a id="v:orderFilters" class="def">orderFilters</a> :: Set <a href="Ganeti-Objects.html#t:FilterRule" title="Ganeti.Objects">FilterRule</a> -&gt; [<a href="Ganeti-Objects.html#t:FilterRule" title="Ganeti.Objects">FilterRule</a>] <a href="Ganeti/JQScheduler/Filtering.html#orderFilters" class="link">Source</a> <a href="#v:orderFilters" class="selflink">#</a></p><div class="doc"><p>Filters need to be processed in the order as given by the spec;
 see <code><a href="Ganeti-Objects.html#v:filterRuleOrder" title="Ganeti.Objects">filterRuleOrder</a></code>.</p></div></div><div class="top"><p class="src"><a id="v:applyingFilter" class="def">applyingFilter</a> :: Set <a href="Ganeti-Objects.html#t:FilterRule" title="Ganeti.Objects">FilterRule</a> -&gt; <a href="Ganeti-JQueue-Objects.html#t:QueuedJob" title="Ganeti.JQueue.Objects">QueuedJob</a> -&gt; Maybe <a href="Ganeti-Objects.html#t:FilterRule" title="Ganeti.Objects">FilterRule</a> <a href="Ganeti/JQScheduler/Filtering.html#applyingFilter" class="link">Source</a> <a href="#v:applyingFilter" class="selflink">#</a></p><div class="doc"><p>Finds the first filter whose predicates all match the job and whose
 action is not <code><a href="Ganeti-Objects.html#v:Continue" title="Ganeti.Objects">Continue</a></code>. This is the <em>applying</em> filter.</p></div></div><div class="top"><p class="src"><span class="keyword">type</span> <a id="t:RateLimitSlotMap" class="def">RateLimitSlotMap</a> = <a href="Ganeti-SlotMap.html#t:SlotMap" title="Ganeti.SlotMap">SlotMap</a> ByteString <a href="Ganeti/JQScheduler/Filtering.html#RateLimitSlotMap" class="link">Source</a> <a href="#t:RateLimitSlotMap" class="selflink">#</a></p><div class="doc"><p>SlotMap for filter rule rate limiting, having <code><a href="Ganeti-Objects.html#t:FilterRule" title="Ganeti.Objects">FilterRule</a></code> UUIDs as keys.</p></div></div><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:FilterChainState" class="def">FilterChainState</a> <a href="Ganeti/JQScheduler/Filtering.html#FilterChainState" class="link">Source</a> <a href="#t:FilterChainState" class="selflink">#</a></p><div class="doc"><p>State to be accumulated while traversing filters.</p></div><div class="subs constructors"><p class="caption">Constructors</p><table><tr><td class="src"><a id="v:FilterChainState" class="def">FilterChainState</a></td><td class="doc empty">&nbsp;</td></tr><tr><td colspan="2"><div class="subs fields"><p class="caption">Fields</p><ul><li><dfn class="src"><a id="v:rateLimitSlotMap" class="def">rateLimitSlotMap</a> :: <a href="Ganeti-JQScheduler-Filtering.html#t:RateLimitSlotMap" title="Ganeti.JQScheduler.Filtering">RateLimitSlotMap</a></dfn><div class="doc"><p>counts</p></div></li></ul></div></td></tr></table></div></div><div class="top"><p class="src"><a id="v:tryFitSlots" class="def">tryFitSlots</a> :: <a href="Ganeti-JQScheduler-Filtering.html#t:FilterChainState" title="Ganeti.JQScheduler.Filtering">FilterChainState</a> -&gt; <a href="Ganeti-SlotMap.html#t:CountMap" title="Ganeti.SlotMap">CountMap</a> ByteString -&gt; Maybe <a href="Ganeti-JQScheduler-Filtering.html#t:FilterChainState" title="Ganeti.JQScheduler.Filtering">FilterChainState</a> <a href="Ganeti/JQScheduler/Filtering.html#tryFitSlots" class="link">Source</a> <a href="#v:tryFitSlots" class="selflink">#</a></p><div class="doc"><p>Update a <code><a href="Ganeti-JQScheduler-Filtering.html#t:FilterChainState" title="Ganeti.JQScheduler.Filtering">FilterChainState</a></code> if the given <code><a href="Ganeti-SlotMap.html#t:CountMap" title="Ganeti.SlotMap">CountMap</a></code> fits into its
 filtering SlotsMap.</p></div></div><div class="top"><p class="src"><a id="v:queueRateLimitSlotMap" class="def">queueRateLimitSlotMap</a> :: <a href="Ganeti-JQScheduler-Types.html#t:Queue" title="Ganeti.JQScheduler.Types">Queue</a> -&gt; Set <a href="Ganeti-Objects.html#t:FilterRule" title="Ganeti.Objects">FilterRule</a> -&gt; <a href="Ganeti-JQScheduler-Filtering.html#t:RateLimitSlotMap" title="Ganeti.JQScheduler.Filtering">RateLimitSlotMap</a> <a href="Ganeti/JQScheduler/Filtering.html#queueRateLimitSlotMap" class="link">Source</a> <a href="#v:queueRateLimitSlotMap" class="selflink">#</a></p><div class="doc"><p>For a given job queue and set of filters, calculates how many rate
 limiting filter slots are available and how many are taken by running jobs
 in the queue.</p></div></div><div class="top"><p class="src"><a id="v:jobFiltering" class="def">jobFiltering</a> :: <a href="Ganeti-JQScheduler-Types.html#t:Queue" title="Ganeti.JQScheduler.Types">Queue</a> -&gt; Set <a href="Ganeti-Objects.html#t:FilterRule" title="Ganeti.Objects">FilterRule</a> -&gt; [<a href="Ganeti-JQScheduler-Types.html#t:JobWithStat" title="Ganeti.JQScheduler.Types">JobWithStat</a>] -&gt; [<a href="Ganeti-JQScheduler-Types.html#t:JobWithStat" title="Ganeti.JQScheduler.Types">JobWithStat</a>] <a href="Ganeti/JQScheduler/Filtering.html#jobFiltering" class="link">Source</a> <a href="#v:jobFiltering" class="selflink">#</a></p><div class="doc"><p>Implements job filtering as specified in `doc/design-optables.rst`.</p><p>Importantly, the filter that *applies* is the first one of which all
 predicates match; this is implemented in <code><a href="Ganeti-JQScheduler-Filtering.html#v:applyingFilter" title="Ganeti.JQScheduler.Filtering">applyingFilter</a></code>.</p><p>The initial <code><a href="Ganeti-JQScheduler-Filtering.html#t:FilterChainState" title="Ganeti.JQScheduler.Filtering">FilterChainState</a></code> is currently not cached across
 <code>selectJobsToRun</code> invocations because the number of running jobs is
 typically small (&lt; 100).</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.23.0</p></div></body></html>