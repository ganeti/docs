<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>Ganeti.Curl.Multi</title><link href="ocean.css" rel="stylesheet" type="text/css" title="Ocean" /><link rel="stylesheet" type="text/css" href="quick-jump.css" /><script src="haddock-bundle.min.js" async="async" type="text/javascript"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script></head><body><div id="package-header"><ul class="links" id="page-menu"><li><a href="Ganeti/Curl/Multi.html">Source</a></li><li><a href="index.html">Contents</a></li><li><a href="doc-index.html">Index</a></li></ul><p class="caption">ganeti</p></div><div id="content"><div id="module-header"><table class="info"><tr><th>Safe Haskell</th><td>None</td></tr></table><p class="caption">Ganeti.Curl.Multi</p></div><div id="table-of-contents"><p class="caption">Contents</p><ul><li><a href="#g:1">Data types</a></li><li><a href="#g:2">FFI declarations</a></li><li><a href="#g:3">Wrappers over FFI functions</a></li><li><a href="#g:4">Helper functions</a></li><li><a href="#g:5">Main multi-call work function</a></li></ul></div><div id="description"><p class="caption">Description</p><div class="doc"><p>Ganeti-specific implementation of the Curl multi interface
(<a href="http://curl.haxx.se/libcurl/c/libcurl-multi.html">http://curl.haxx.se/libcurl/c/libcurl-multi.html</a>).</p><p>TODO: Evaluate implementing and switching to
curl_multi_socket_action(3) interface, which is deemed to be more
performant for high-numbers of connections (but this is not the case
for Ganeti).</p></div></div><div id="synopsis"><details id="syn"><summary>Synopsis</summary><ul class="details-toggle" data-details-id="syn"><li class="src short"><span class="keyword">data</span> <a href="#t:CurlM_">CurlM_</a></li><li class="src short"><span class="keyword">type</span> <a href="#t:CurlMH">CurlMH</a> = Ptr <a href="Ganeti-Curl-Multi.html#t:CurlM_" title="Ganeti.Curl.Multi">CurlM_</a></li><li class="src short"><span class="keyword">type</span> <a href="#t:HandleMap">HandleMap</a> = Map CurlH (IORef CurlCode)</li><li class="src short"><a href="#v:curl_multi_init">curl_multi_init</a> :: IO <a href="Ganeti-Curl-Multi.html#t:CurlMH" title="Ganeti.Curl.Multi">CurlMH</a></li><li class="src short"><a href="#v:curl_multi_cleanup">curl_multi_cleanup</a> :: <a href="Ganeti-Curl-Multi.html#t:CurlMH" title="Ganeti.Curl.Multi">CurlMH</a> -&gt; IO CInt</li><li class="src short"><a href="#v:curl_multi_add_handle">curl_multi_add_handle</a> :: <a href="Ganeti-Curl-Multi.html#t:CurlMH" title="Ganeti.Curl.Multi">CurlMH</a> -&gt; CurlH -&gt; IO CInt</li><li class="src short"><a href="#v:curl_multi_remove_handle">curl_multi_remove_handle</a> :: <a href="Ganeti-Curl-Multi.html#t:CurlMH" title="Ganeti.Curl.Multi">CurlMH</a> -&gt; CurlH -&gt; IO CInt</li><li class="src short"><a href="#v:curl_multi_perform">curl_multi_perform</a> :: <a href="Ganeti-Curl-Multi.html#t:CurlMH" title="Ganeti.Curl.Multi">CurlMH</a> -&gt; Ptr CInt -&gt; IO CInt</li><li class="src short"><a href="#v:curl_multi_info_read">curl_multi_info_read</a> :: <a href="Ganeti-Curl-Multi.html#t:CurlMH" title="Ganeti.Curl.Multi">CurlMH</a> -&gt; Ptr CInt -&gt; IO (Ptr <a href="Ganeti-Curl-Internal.html#t:CurlMsg" title="Ganeti.Curl.Internal">CurlMsg</a>)</li><li class="src short"><a href="#v:curlMultiAddHandle">curlMultiAddHandle</a> :: <a href="Ganeti-Curl-Multi.html#t:CurlMH" title="Ganeti.Curl.Multi">CurlMH</a> -&gt; Curl -&gt; IO ()</li><li class="src short"><a href="#v:curlMultiInfoRead">curlMultiInfoRead</a> :: <a href="Ganeti-Curl-Multi.html#t:CurlMH" title="Ganeti.Curl.Multi">CurlMH</a> -&gt; IO (Maybe <a href="Ganeti-Curl-Internal.html#t:CurlMsg" title="Ganeti.Curl.Internal">CurlMsg</a>, CInt)</li><li class="src short"><a href="#v:curlMultiPerform">curlMultiPerform</a> :: <a href="Ganeti-Curl-Multi.html#t:CurlMH" title="Ganeti.Curl.Multi">CurlMH</a> -&gt; IO (<a href="Ganeti-Curl-Internal.html#t:CurlMCode" title="Ganeti.Curl.Internal">CurlMCode</a>, CInt)</li><li class="src short"><a href="#v:pollDelayInterval">pollDelayInterval</a> :: Int</li><li class="src short"><a href="#v:writeHandle">writeHandle</a> :: IORef [String] -&gt; Ptr CChar -&gt; CInt -&gt; CInt -&gt; Ptr () -&gt; IO CInt</li><li class="src short"><a href="#v:readMessages">readMessages</a> :: <a href="Ganeti-Curl-Multi.html#t:CurlMH" title="Ganeti.Curl.Multi">CurlMH</a> -&gt; <a href="Ganeti-Curl-Multi.html#t:HandleMap" title="Ganeti.Curl.Multi">HandleMap</a> -&gt; IO ()</li><li class="src short"><a href="#v:performMulti">performMulti</a> :: <a href="Ganeti-Curl-Multi.html#t:CurlMH" title="Ganeti.Curl.Multi">CurlMH</a> -&gt; <a href="Ganeti-Curl-Multi.html#t:HandleMap" title="Ganeti.Curl.Multi">HandleMap</a> -&gt; CInt -&gt; IO ()</li><li class="src short"><a href="#v:errorBuffer">errorBuffer</a> :: String</li><li class="src short"><a href="#v:mallocErrorBuffer">mallocErrorBuffer</a> :: IO CString</li><li class="src short"><a href="#v:makeEasyHandle">makeEasyHandle</a> :: (IORef [String], Ptr CChar, ([CurlOption], URLString)) -&gt; IO Curl</li><li class="src short"><a href="#v:execMultiCall">execMultiCall</a> :: [([CurlOption], String)] -&gt; IO [(CurlCode, String)]</li></ul></details></div><div id="interface"><a href="#g:1" id="g:1"><h1>Data types</h1></a><div class="top"><p class="src"><span class="keyword">data</span> <a id="t:CurlM_" class="def">CurlM_</a> <a href="Ganeti/Curl/Multi.html#CurlM_" class="link">Source</a> <a href="#t:CurlM_" class="selflink">#</a></p><div class="doc"><p>Empty data type denoting a Curl multi handle. Naming is similar to
 <a href="Network-Curl.html">Network.Curl</a> types.</p></div></div><div class="top"><p class="src"><span class="keyword">type</span> <a id="t:CurlMH" class="def">CurlMH</a> = Ptr <a href="Ganeti-Curl-Multi.html#t:CurlM_" title="Ganeti.Curl.Multi">CurlM_</a> <a href="Ganeti/Curl/Multi.html#CurlMH" class="link">Source</a> <a href="#t:CurlMH" class="selflink">#</a></p><div class="doc"><p>Type alias for a pointer to a Curl multi handle.</p></div></div><div class="top"><p class="src"><span class="keyword">type</span> <a id="t:HandleMap" class="def">HandleMap</a> = Map CurlH (IORef CurlCode) <a href="Ganeti/Curl/Multi.html#HandleMap" class="link">Source</a> <a href="#t:HandleMap" class="selflink">#</a></p><div class="doc"><p>Our type alias for maps indexing <code>CurlH</code> handles to the <code>IORef</code>
 for the Curl code.</p></div></div><a href="#g:2" id="g:2"><h1>FFI declarations</h1></a><div class="top"><p class="src"><a id="v:curl_multi_init" class="def">curl_multi_init</a> :: IO <a href="Ganeti-Curl-Multi.html#t:CurlMH" title="Ganeti.Curl.Multi">CurlMH</a> <a href="Ganeti/Curl/Multi.html#curl_multi_init" class="link">Source</a> <a href="#v:curl_multi_init" class="selflink">#</a></p></div><div class="top"><p class="src"><a id="v:curl_multi_cleanup" class="def">curl_multi_cleanup</a> :: <a href="Ganeti-Curl-Multi.html#t:CurlMH" title="Ganeti.Curl.Multi">CurlMH</a> -&gt; IO CInt <a href="Ganeti/Curl/Multi.html#curl_multi_cleanup" class="link">Source</a> <a href="#v:curl_multi_cleanup" class="selflink">#</a></p></div><div class="top"><p class="src"><a id="v:curl_multi_add_handle" class="def">curl_multi_add_handle</a> :: <a href="Ganeti-Curl-Multi.html#t:CurlMH" title="Ganeti.Curl.Multi">CurlMH</a> -&gt; CurlH -&gt; IO CInt <a href="Ganeti/Curl/Multi.html#curl_multi_add_handle" class="link">Source</a> <a href="#v:curl_multi_add_handle" class="selflink">#</a></p></div><div class="top"><p class="src"><a id="v:curl_multi_remove_handle" class="def">curl_multi_remove_handle</a> :: <a href="Ganeti-Curl-Multi.html#t:CurlMH" title="Ganeti.Curl.Multi">CurlMH</a> -&gt; CurlH -&gt; IO CInt <a href="Ganeti/Curl/Multi.html#curl_multi_remove_handle" class="link">Source</a> <a href="#v:curl_multi_remove_handle" class="selflink">#</a></p></div><div class="top"><p class="src"><a id="v:curl_multi_perform" class="def">curl_multi_perform</a> :: <a href="Ganeti-Curl-Multi.html#t:CurlMH" title="Ganeti.Curl.Multi">CurlMH</a> -&gt; Ptr CInt -&gt; IO CInt <a href="Ganeti/Curl/Multi.html#curl_multi_perform" class="link">Source</a> <a href="#v:curl_multi_perform" class="selflink">#</a></p></div><div class="top"><p class="src"><a id="v:curl_multi_info_read" class="def">curl_multi_info_read</a> :: <a href="Ganeti-Curl-Multi.html#t:CurlMH" title="Ganeti.Curl.Multi">CurlMH</a> -&gt; Ptr CInt -&gt; IO (Ptr <a href="Ganeti-Curl-Internal.html#t:CurlMsg" title="Ganeti.Curl.Internal">CurlMsg</a>) <a href="Ganeti/Curl/Multi.html#curl_multi_info_read" class="link">Source</a> <a href="#v:curl_multi_info_read" class="selflink">#</a></p></div><a href="#g:3" id="g:3"><h1>Wrappers over FFI functions</h1></a><div class="top"><p class="src"><a id="v:curlMultiAddHandle" class="def">curlMultiAddHandle</a> :: <a href="Ganeti-Curl-Multi.html#t:CurlMH" title="Ganeti.Curl.Multi">CurlMH</a> -&gt; Curl -&gt; IO () <a href="Ganeti/Curl/Multi.html#curlMultiAddHandle" class="link">Source</a> <a href="#v:curlMultiAddHandle" class="selflink">#</a></p><div class="doc"><p>Adds an easy handle to a multi handle. This is a nicer wrapper
 over <code><a href="Ganeti-Curl-Multi.html#v:curl_multi_add_handle" title="Ganeti.Curl.Multi">curl_multi_add_handle</a></code> that fails for wrong codes.</p></div></div><div class="top"><p class="src"><a id="v:curlMultiInfoRead" class="def">curlMultiInfoRead</a> :: <a href="Ganeti-Curl-Multi.html#t:CurlMH" title="Ganeti.Curl.Multi">CurlMH</a> -&gt; IO (Maybe <a href="Ganeti-Curl-Internal.html#t:CurlMsg" title="Ganeti.Curl.Internal">CurlMsg</a>, CInt) <a href="Ganeti/Curl/Multi.html#curlMultiInfoRead" class="link">Source</a> <a href="#v:curlMultiInfoRead" class="selflink">#</a></p><div class="doc"><p>Nice wrapper over <code><a href="Ganeti-Curl-Multi.html#v:curl_multi_info_read" title="Ganeti.Curl.Multi">curl_multi_info_read</a></code> that massages the
 results into Haskell types.</p></div></div><div class="top"><p class="src"><a id="v:curlMultiPerform" class="def">curlMultiPerform</a> :: <a href="Ganeti-Curl-Multi.html#t:CurlMH" title="Ganeti.Curl.Multi">CurlMH</a> -&gt; IO (<a href="Ganeti-Curl-Internal.html#t:CurlMCode" title="Ganeti.Curl.Internal">CurlMCode</a>, CInt) <a href="Ganeti/Curl/Multi.html#curlMultiPerform" class="link">Source</a> <a href="#v:curlMultiPerform" class="selflink">#</a></p><div class="doc"><p>Nice wrapper over <code><a href="Ganeti-Curl-Multi.html#v:curl_multi_perform" title="Ganeti.Curl.Multi">curl_multi_perform</a></code>.</p></div></div><a href="#g:4" id="g:4"><h1>Helper functions</h1></a><div class="top"><p class="src"><a id="v:pollDelayInterval" class="def">pollDelayInterval</a> :: Int <a href="Ganeti/Curl/Multi.html#pollDelayInterval" class="link">Source</a> <a href="#v:pollDelayInterval" class="selflink">#</a></p><div class="doc"><p>Magical constant for the polling delay. This needs to be chosen such that:</p><ul><li>we don't poll too often; a slower poll allows the RTS to schedule
   other threads, and let them work</li><li>we don't want to pool too slow, so that Curl gets to act on the
   handles that need it</li></ul></div></div><div class="top"><p class="src"><a id="v:writeHandle" class="def">writeHandle</a> :: IORef [String] -&gt; Ptr CChar -&gt; CInt -&gt; CInt -&gt; Ptr () -&gt; IO CInt <a href="Ganeti/Curl/Multi.html#writeHandle" class="link">Source</a> <a href="#v:writeHandle" class="selflink">#</a></p><div class="doc"><p>Writes incoming curl data to a list of strings, stored in an <code>IORef</code>.</p></div></div><div class="top"><p class="src"><a id="v:readMessages" class="def">readMessages</a> :: <a href="Ganeti-Curl-Multi.html#t:CurlMH" title="Ganeti.Curl.Multi">CurlMH</a> -&gt; <a href="Ganeti-Curl-Multi.html#t:HandleMap" title="Ganeti.Curl.Multi">HandleMap</a> -&gt; IO () <a href="Ganeti/Curl/Multi.html#readMessages" class="link">Source</a> <a href="#v:readMessages" class="selflink">#</a></p><div class="doc"><p>Loops and extracts all pending messages from a Curl multi handle.</p></div></div><div class="top"><p class="src"><a id="v:performMulti" class="def">performMulti</a> :: <a href="Ganeti-Curl-Multi.html#t:CurlMH" title="Ganeti.Curl.Multi">CurlMH</a> -&gt; <a href="Ganeti-Curl-Multi.html#t:HandleMap" title="Ganeti.Curl.Multi">HandleMap</a> -&gt; CInt -&gt; IO () <a href="Ganeti/Curl/Multi.html#performMulti" class="link">Source</a> <a href="#v:performMulti" class="selflink">#</a></p><div class="doc"><p>Loops and polls curl until there are no more remaining handles.</p></div></div><div class="top"><p class="src"><a id="v:errorBuffer" class="def">errorBuffer</a> :: String <a href="Ganeti/Curl/Multi.html#errorBuffer" class="link">Source</a> <a href="#v:errorBuffer" class="selflink">#</a></p><div class="doc"><p>Template for the Curl error buffer.</p></div></div><div class="top"><p class="src"><a id="v:mallocErrorBuffer" class="def">mallocErrorBuffer</a> :: IO CString <a href="Ganeti/Curl/Multi.html#mallocErrorBuffer" class="link">Source</a> <a href="#v:mallocErrorBuffer" class="selflink">#</a></p><div class="doc"><p>Allocate a NULL-initialised error buffer.</p></div></div><div class="top"><p class="src"><a id="v:makeEasyHandle" class="def">makeEasyHandle</a> :: (IORef [String], Ptr CChar, ([CurlOption], URLString)) -&gt; IO Curl <a href="Ganeti/Curl/Multi.html#makeEasyHandle" class="link">Source</a> <a href="#v:makeEasyHandle" class="selflink">#</a></p><div class="doc"><p>Initialise a curl handle. This is just a wrapper over the
 <a href="Network-Curl.html">Network.Curl</a> function <code>initialize</code>, plus adding our options.</p></div></div><a href="#g:5" id="g:5"><h1>Main multi-call work function</h1></a><div class="top"><p class="src"><a id="v:execMultiCall" class="def">execMultiCall</a> :: [([CurlOption], String)] -&gt; IO [(CurlCode, String)] <a href="Ganeti/Curl/Multi.html#execMultiCall" class="link">Source</a> <a href="#v:execMultiCall" class="selflink">#</a></p><div class="doc"><p>Perform a multi-call against a list of nodes.</p></div></div></div></div><div id="footer"><p>Produced by <a href="http://www.haskell.org/haddock/">Haddock</a> version 2.20.0</p></div></body></html>